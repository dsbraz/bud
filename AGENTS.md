# Repository Guidelines

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Language Requirements

**IMPORTANT: All user-facing messages, error messages, validation messages, and any text displayed to end users MUST be in Brazilian Portuguese (pt-BR).**

This includes:
- Error messages in controllers and services
- Validation error messages in FluentValidation validators
- API response messages (ProblemDetails, error responses)
- UI text in Blazor components
- Log messages that may be displayed to users
- Comments in code should remain in English for maintainability

## Project Overview

Bud is an ASP.NET Core 10 application with a Blazor WebAssembly frontend, using PostgreSQL as the database. The application manages organizational hierarchies and mission tracking.

## Project Structure

- **Bud.Server** (`src/Bud.Server`): ASP.NET Core API hosting both the API endpoints and the Blazor WebAssembly app
  - `Controllers/`: REST endpoints for organizations, workspaces, teams, collaborators
  - `Models/`: EF Core entities
  - `Data/`: `ApplicationDbContext`, EF Core configuration, and `DbSeeder`
  - `Migrations/`: database migrations
  - `Services/`: business logic layer
  - `Validators/`: FluentValidation validators
  - `Middleware/`: global exception handling and other middleware
  - `MultiTenancy/`: tenant isolation infrastructure (`ITenantProvider`, `JwtTenantProvider`, `TenantSaveChangesInterceptor`, `TenantRequiredMiddleware`)
  - `Settings/`: configuration POCOs (`GlobalAdminSettings`)

- **Bud.Client** (`src/Bud.Client`): Blazor WebAssembly SPA (compiled to static files served by Bud.Server)
  - `Pages/`: Blazor pages with routing
  - `Layout/`: Layout components (MainLayout, AuthLayout, NavMenu, ManagementMenu)
  - `Services/`: ApiClient, AuthState, and `TenantDelegatingHandler` (attaches tenant headers to HTTP requests)

- **Bud.Shared** (`src/Bud.Shared`): Shared models, contracts, and DTOs used by both Client and Server
  - `Models/`: Domain entities
  - `Contracts/`: Request/response DTOs

- **Tests**:
  - `tests/Bud.Server.Tests/`: Unit tests (xUnit, Moq, FluentAssertions)
  - `tests/Bud.Server.IntegrationTests/`: Integration tests with WebApplicationFactory

- **Root**: `docker-compose.yml`, `README.md`, `AGENTS.md`

## Build and Development Commands

### Running with Docker (Recommended)

Development is expected to run via Docker Desktop on macOS. All services (API, UI, PostgreSQL) are containerized.

```bash
# Start all services (API, UI, PostgreSQL)
docker compose up --build

# Stop all services
docker compose down
```

The application runs at `http://localhost:8080` with Swagger available at `http://localhost:8080/swagger` in Development mode.

### Running Tests

```bash
# Run all tests
dotnet test

# Run specific test project
dotnet test tests/Bud.Server.Tests
dotnet test tests/Bud.Server.IntegrationTests

# Run tests with coverage
dotnet test /p:CollectCoverage=true
```

### Migrations

Migrations are automatically applied on startup in Development mode. To manually apply migrations with Docker running:

```bash
docker run --rm -v "$(pwd)/src":/src -w /src/Bud.Server --network bud_default \
  -e ConnectionStrings__DefaultConnection="Host=db;Port=5432;Database=bud;Username=postgres;Password=postgres" \
  mcr.microsoft.com/dotnet/sdk:10.0 \
  bash -lc "dotnet tool install --tool-path /tmp/tools dotnet-ef --version 10.0.2 && /tmp/tools/dotnet-ef database update"
```

To create a new migration:
```bash
dotnet ef migrations add MigrationName --project src/Bud.Server
```

### Local Development without Docker

```bash
# Restore dependencies
dotnet restore

# Build
dotnet build

# Run the server (requires PostgreSQL connection string in appsettings)
dotnet run --project src/Bud.Server
```

## Architecture

### Domain Model Hierarchy

The application follows a strict organizational hierarchy:

```
Organization
  └── Workspace(s)
      └── Team(s)
          ├── Collaborator(s)
          └── SubTeam(s) (recursive)

Mission (can be scoped to Organization, Workspace, Team, or Collaborator)
  └── MissionMetric(s)
```

**Critical cascade behaviors:**
- Organization deletion cascades to Workspaces, Teams, and Collaborators
- SubTeams have `DeleteBehavior.Restrict` on ParentTeam to prevent orphaned hierarchies
- All Mission relationships cascade delete

### Multi-Tenancy

The application uses **row-level tenant isolation** based on `OrganizationId`. Each organization (tenant) sees only its own data.

**Authentication:** The system uses JWT (JSON Web Tokens) for authentication without requiring passwords. Tokens are generated by `AuthService.LoginAsync` and validated by ASP.NET Core JWT Bearer middleware.

**How it works:**

1. **`ITenantEntity`** — marker interface implemented by all tenant-scoped entities (`Workspace`, `Team`, `Collaborator`, `Mission`, `MissionMetric`). Requires a `Guid OrganizationId` property.

2. **`ITenantProvider` / `JwtTenantProvider`** — scoped service that reads user information from validated JWT claims. Determines `TenantId` (from `X-Tenant-Id` header or `organization_id` claim), `CollaboratorId`, and `IsGlobalAdmin` (from `GlobalAdmin` role claim). Optionally accepts `X-Tenant-Id` header for multi-organization users.

3. **Authorization Services** — centralized authorization logic:
   - `TenantAuthorizationService` validates user access to specific tenants
   - `OrganizationAuthorizationService` validates organization ownership and write permissions

4. **EF Core Global Query Filters** — configured in `ApplicationDbContext.OnModelCreating()` on all tenant entities.
   - Filters are applied only when an `ITenantProvider` is available (normal runtime).
   - Global admin bypasses all filters.
   - If `TenantId` is `null` for a non-admin user, the filters return no data.

5. **`TenantSaveChangesInterceptor`** — EF Core `SaveChangesInterceptor` that auto-sets `OrganizationId` on new `ITenantEntity` entities if it's `Guid.Empty`.

6. **`TenantRequiredMiddleware`** — validates JWT authentication and tenant access for `/api/*` requests (except `/api/auth/login`, `/api/auth/logout`, `/api/auth/my-organizations`).
   - Returns 401 for unauthenticated requests.
   - Returns 403 if the user is authenticated but **does not have a tenant selected** and is not a global admin.
   - Returns 403 for unauthorized tenant access.

7. **`TenantDelegatingHandler`** (client) — `DelegatingHandler` that reads `AuthState` and attaches `Authorization: Bearer <token>` header and optional `X-Tenant-Id` header to every HTTP request from the Blazor client.

**Key design decisions:**

- `OrganizationId` is **denormalized** into `Team`, `Collaborator`, `Mission`, and `MissionMetric` for efficient query filtering without joins
- `Mission.OrganizationId` is **non-nullable** (always set as tenant discriminator). Mission scope level is determined by which of `WorkspaceId`/`TeamId`/`CollaboratorId` is set; if none are set, the mission is org-scoped
- Services must populate `OrganizationId` when creating entities (resolved from the parent entity in the hierarchy)

#### Multi-Tenancy Frontend (UI)

The user selects the tenant (organization) through a **combo box at the top of the sidebar menu**. This combo is implemented in [MainLayout.razor](src/Bud.Client/Layout/MainLayout.razor).

**Main components:**

- **OrganizationContext** ([OrganizationContext.cs](src/Bud.Client/Services/OrganizationContext.cs)) - Manages the selected tenant:
  - `SelectedOrganizationId` (Guid?) - ID of the selected organization (null = "TODOS")
  - `AvailableOrganizations` - List of organizations available to the user
  - `ShowAllOrganizations` - Returns true when no specific org is selected
  - `OnOrganizationChanged` - Event fired when selection changes
  - Persists selection in localStorage (`"bud.organization.selected"`)

**"TODOS" option:**

- Allows viewing data from **all organizations** (global admin only)
- Implemented as `SelectedOrganizationId = null`
- When selected, `TenantDelegatingHandler` **does NOT send** the `X-Tenant-Id` header, allowing the backend to return all data
- Displayed as "TODOS" with initials "TD"

**Data flow when changing tenant:**

1. User clicks combo and selects an organization (or "TODOS")
2. `OrganizationContext.SelectOrganizationAsync(orgId)` is called
3. Value is persisted in localStorage
4. `OnOrganizationChanged` event is fired
5. Subscribed components reload their data
6. `TenantDelegatingHandler` intercepts requests and adds `X-Tenant-Id` header (if orgId != null)
7. Backend filters data according to selected tenant

**Pattern for components:**

Components that display tenant-specific data should:
- Inject `OrganizationContext`
- Subscribe to `OnOrganizationChanged` event in `OnInitializedAsync`
- Reload data when event is fired
- Unsubscribe in `Dispose()`

Example (see [Missions.razor](src/Bud.Client/Pages/Missions.razor)):

```csharp
@inject OrganizationContext OrgContext

protected override async Task OnInitializedAsync()
{
    OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    await LoadData();
}

private async void HandleOrganizationChanged()
{
    await InvokeAsync(async () =>
    {
        await LoadData();
        StateHasChanged();
    });
}

public void Dispose()
{
    OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
}
```

**IMPORTANT:**

- **All pages that display tenant-scoped data must react to tenant changes**
- The selection combo is always visible in the sidebar (except on auth pages)
- Global admin can see "TODOS", regular users see only their organizations

### Service Layer Pattern

All business logic lives in services that return `ServiceResult` or `ServiceResult<T>`:

```csharp
public sealed class ServiceResult<T>
{
    public bool IsSuccess { get; }
    public T? Value { get; }
    public string? Error { get; }
    public ServiceErrorType ErrorType { get; } // None, Validation, NotFound, Conflict
}
```

**Important:**
- Controllers must check `result.ErrorType` to return appropriate HTTP status codes:
  - `NotFound` → 404
  - `Validation` → 400
  - `Conflict` → 409
- **All error messages in `ServiceResult.Error` MUST be in Brazilian Portuguese (pt-BR)**

### Controller Pattern

Controllers use primary constructors and follow this pattern:

1. Inject the service interface and FluentValidation validators via primary constructor
2. Validate the request using FluentValidation
3. Call the service method
4. Map `ServiceResult` to appropriate HTTP responses
5. **All error messages in `ProblemDetails` MUST be in Brazilian Portuguese (pt-BR)**

See [OrganizationsController.cs](src/Bud.Server/Controllers/OrganizationsController.cs) as the reference implementation.

### Authorization Pattern (padrão recomendado)

**Objetivo:** centralizar autorização em policies e handlers, reduzindo `if` espalhados em serviços.

**Policies:**
- `TenantSelected` — exige autenticação e tenant selecionado (global admin sempre passa)
- `GlobalAdmin` — exige usuário global admin
- `OrganizationOwner` — exige que o colaborador seja owner da organização
- `OrganizationWrite` — exige permissão de escrita na organização

**Onde aplicar:**
- Controllers devem aplicar `[Authorize(Policy = ...)]`
- `GlobalAdmin` em ações administrativas (ex.: `POST/PUT/DELETE` em organizações)
- `TenantSelected` em endpoints tenant-scoped em geral

**Diretrizes:**
- Evite checagens diretas de `IsGlobalAdmin` e `TenantId` nos serviços quando houver policy equivalente
- Mantenha mensagens de erro em pt-BR
- Para novas regras, crie um `Requirement` + `Handler` e registre no `Program.cs`

### Validation

- **FluentValidation** is used for all request validation
- Validators are in `src/Bud.Server/Validators/`
- Each validator must be registered in DI (see [Program.cs](src/Bud.Server/Program.cs))
- Controllers validate requests before calling services
- **All validation error messages MUST be in Brazilian Portuguese (pt-BR)**

### Data Access

- **Entity Framework Core** with PostgreSQL (Npgsql provider)
- DbContext: [ApplicationDbContext.cs](src/Bud.Server/Data/ApplicationDbContext.cs)
- All entities are in `Bud.Shared.Models`
- All relationship configurations and **Global Query Filters** (multi-tenancy) are in `ApplicationDbContext.OnModelCreating()`
- The DbContext accepts an optional `ITenantProvider` for tenant-aware queries (nullable for migrations and tests)

### Client Architecture

- Blazor WebAssembly with pages in `src/Bud.Client/Pages/`
- API communication through [ApiClient.cs](src/Bud.Client/Services/ApiClient.cs)
- Auth state managed by [AuthState.cs](src/Bud.Client/Services/AuthState.cs)
- Tenant context managed by [OrganizationContext.cs](src/Bud.Client/Services/OrganizationContext.cs)
- Tenant selection UI in sidebar ([MainLayout.razor](src/Bud.Client/Layout/MainLayout.razor))
- Layouts in `src/Bud.Client/Layout/` (MainLayout, AuthLayout)

## Testing Guidelines

### Test-Driven Development (TDD) - MANDATORY

**This project follows TDD as the standard development approach.**

**CRITICAL RULES:**

1. **Write tests BEFORE implementing or changing code** - This is non-negotiable
2. **Every code change requires test adjustments** - Either modify existing tests or create new ones
3. **No code changes without corresponding tests** - Production code and test code must evolve together

**TDD Workflow:**

```
1. Write/Update Test (Red) → 2. Implement/Change Code (Green) → 3. Refactor (if needed)
```

**When making changes:**
- **New feature?** Write new tests first, then implement
- **Bug fix?** Write a failing test that reproduces the bug, then fix it
- **Refactoring?** Ensure existing tests pass, add tests for edge cases if needed
- **Changing behavior?** Update tests to reflect new expected behavior, then change code

**Test coverage expectations:**
- All services must have unit tests
- All validators must have unit tests
- All API endpoints must have integration tests
- All business logic must be tested

### Unit Tests (`tests/Bud.Server.Tests`)

- Use **xUnit**, **Moq**, and **FluentAssertions**
- Test validators, services, and business logic in isolation
- **Database Strategy:**
  - **Validator tests**: No database needed, test FluentValidation logic directly
  - **Service tests**: Use `ApplicationDbContext` with **InMemoryDatabase provider** (EF Core)
    - Create context via `DbContextOptionsBuilder<ApplicationDbContext>().UseInMemoryDatabase()`
    - Each test uses a unique database name (e.g., `Guid.NewGuid().ToString()`)
    - Pass a `TestTenantProvider` (with `IsGlobalAdmin = true`) to the DbContext to bypass query filters
    - Always set `OrganizationId` on tenant entities in test data
- Every feature must include unit tests
- Unit tests must not access external resources (except InMemoryDatabase for service tests)
- Example validator test: [CreateOrganizationValidatorTests.cs](tests/Bud.Server.Tests/Validators/CreateOrganizationValidatorTests.cs)
- Example service test: [TeamServiceTests.cs](tests/Bud.Server.Tests/Services/TeamServiceTests.cs)
- Test tenant helper: [TestTenantProvider.cs](tests/Bud.Server.Tests/Helpers/TestTenantProvider.cs)

### Integration Tests (`tests/Bud.Server.IntegrationTests`)

- Use `WebApplicationFactory<Program>` to spin up the full API
- Test full request/response cycles (HTTP endpoints)
- **Database Strategy:**
  - Use **Testcontainers.PostgreSql** to spin up real PostgreSQL container
  - [CustomWebApplicationFactory.cs](tests/Bud.Server.IntegrationTests/CustomWebApplicationFactory.cs) configures the test container
  - PostgreSQL 16 image with automatic migrations on startup
  - Container lifecycle managed by xUnit's `IAsyncLifetime`
- **Multi-tenancy in integration tests:**
  - Use `factory.CreateAdminClient()` to create an `HttpClient` with admin headers (`X-User-Email: admin@getbud.co`), which bypasses `TenantRequiredMiddleware`
  - When creating entities directly via DbContext (e.g., in `GetOrCreateAdminLeader`), always set `OrganizationId` on `Team` and `Collaborator`
  - Use `IgnoreQueryFilters()` when looking up bootstrap data to avoid tenant filters hiding existing records
- Example: [OrganizationsEndpointsTests.cs](tests/Bud.Server.IntegrationTests/Endpoints/OrganizationsEndpointsTests.cs)

### E2E Tests

- Implement E2E tests when it makes sense for the feature

## Code Style & Naming Conventions

Enforced by `.editorconfig` and `Directory.Build.props`:

- **Indentation:** 4 spaces for C#/Razor, 2 spaces for XML/JSON
- **Line endings:** LF
- **Nullable reference types** enabled
- **Implicit usings** enabled
- Use **primary constructors** for controllers and services (C# 12 feature)
- Use **file-scoped namespaces** where possible
- Follow Microsoft C# naming conventions (PascalCase for public members, camelCase for locals)
- Apply Clean Code principles whenever possible
- Linting: default .NET analyzers

## Important Patterns to Follow

### Adding a New Entity

1. Create the model in `src/Bud.Shared/Models/`
   - If the entity belongs to an organization, implement `ITenantEntity` and add `Guid OrganizationId` + `Organization` nav prop
2. Add `DbSet<TEntity>` to `ApplicationDbContext`
3. Configure relationships in `OnModelCreating()`
   - If tenant-scoped: add FK/index for `OrganizationId` (`DeleteBehavior.Restrict`) and add a `HasQueryFilter` following the existing pattern
4. Create a migration: `dotnet ef migrations add AddEntityName --project src/Bud.Server`
5. Create request/response contracts in `src/Bud.Shared/Contracts/`
6. Create FluentValidation validators in `src/Bud.Server/Validators/`
7. Create service interface and implementation in `src/Bud.Server/Services/`
   - If tenant-scoped: resolve and set `OrganizationId` from the parent entity in `CreateAsync`
8. Register service in [Program.cs](src/Bud.Server/Program.cs) DI configuration
9. Create controller in `src/Bud.Server/Controllers/`
10. Write unit tests in `tests/Bud.Server.Tests/`
11. Write integration tests in `tests/Bud.Server.IntegrationTests/`

### Adding a New Blazor Page

1. Create `.razor` file in `src/Bud.Client/Pages/`
2. Add route with `@page "/route"`
3. Add navigation link in [NavMenu.razor](src/Bud.Client/Layout/NavMenu.razor) or [ManagementMenu.razor](src/Bud.Client/Layout/ManagementMenu.razor)
4. Use `ApiClient` service for API calls
5. Handle loading states and errors in the UI

## Health Checks

The API exposes two health check endpoints:
- `/health/live` - Liveness probe (always returns healthy)
- `/health/ready` - Readiness probe (checks PostgreSQL connection)

Use these for Kubernetes probes or monitoring.

## Configuration

### appsettings

- Development settings: `src/Bud.Server/appsettings.Development.json`
- Connection string key: `ConnectionStrings:DefaultConnection`
- Environment variables override appsettings (useful in Docker)

### Docker Compose

The `docker-compose.yml` configures:
- PostgreSQL on port 5432
- API + UI on port 8080
- Volume mounts for hot reload during development
- Network for service communication

## Commit & Pull Request Guidelines

- Use clear, imperative commit messages (e.g., `Add team filters`, `Fix validation error`)
- PRs should include:
  - Summary of changes
  - Linked issues (if any)
  - Screenshots for UI changes

## Key Files to Reference

- **Service pattern:** [OrganizationService.cs](src/Bud.Server/Services/OrganizationService.cs)
- **Controller pattern:** [OrganizationsController.cs](src/Bud.Server/Controllers/OrganizationsController.cs)
- **Validation pattern:** [OrganizationValidators.cs](src/Bud.Server/Validators/OrganizationValidators.cs)
- **Error handling:** [GlobalExceptionHandler.cs](src/Bud.Server/Middleware/GlobalExceptionHandler.cs)
- **Client API calls:** [ApiClient.cs](src/Bud.Client/Services/ApiClient.cs)
- **Multi-tenancy (backend):** [ITenantProvider.cs](src/Bud.Server/MultiTenancy/ITenantProvider.cs), [JwtTenantProvider.cs](src/Bud.Server/MultiTenancy/JwtTenantProvider.cs), [TenantRequiredMiddleware.cs](src/Bud.Server/MultiTenancy/TenantRequiredMiddleware.cs)
- **Authorization services:** [OrganizationAuthorizationService.cs](src/Bud.Server/Services/OrganizationAuthorizationService.cs), [TenantAuthorizationService.cs](src/Bud.Server/Services/TenantAuthorizationService.cs)
- **Authentication:** [AuthService.cs](src/Bud.Server/Services/AuthService.cs)
- **Multi-tenancy (frontend):** [OrganizationContext.cs](src/Bud.Client/Services/OrganizationContext.cs), [MainLayout.razor](src/Bud.Client/Layout/MainLayout.razor), [TenantDelegatingHandler.cs](src/Bud.Client/Services/TenantDelegatingHandler.cs)
- **Tenant entity marker:** [ITenantEntity.cs](src/Bud.Shared/Models/ITenantEntity.cs)
