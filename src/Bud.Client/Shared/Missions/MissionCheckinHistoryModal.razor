@using Bud.Client.Services

@if (IsOpen && Metric != null)
{
    <Modal Title="Histórico de check-ins" Breadcrumb="@Metric.Name" Size="lg" OnClose="() => OnClose.InvokeAsync()">
        <ChildContent>
            <div class="checkin-history-container">
                <div class="checkin-history-header">
                    <div class="checkin-history-metric-info">
                        <div class="checkin-history-metric-name">@Metric.Name</div>
                        <div class="checkin-history-metric-target">@MissionMetricDisplayHelper.GetTargetLabel(Metric)</div>
                    </div>
                    <button class="button primary" @onclick="() => OnNewCheckin.InvokeAsync()">
                        <span class="button-icon-text">+</span>
                        Novo check-in
                    </button>
                </div>

                @if (IsLoading)
                {
                    <div class="checkin-history-loading">
                        <p class="muted">Carregando check-ins...</p>
                    </div>
                }
                else if (!Checkins.Any())
                {
                    <div class="checkin-history-empty">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                            <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p>Nenhum check-in registrado para esta métrica.</p>
                        <p class="muted">Registre seu primeiro check-in para acompanhar o progresso.</p>
                    </div>
                }
                else
                {
                    <div class="checkin-timeline">
                        @foreach (var checkin in Checkins)
                        {
                            var confidenceClass = checkin.ConfidenceLevel >= 4 ? "high" : checkin.ConfidenceLevel >= 2 ? "medium" : "low";
                            var collaboratorName = checkin.Collaborator?.FullName ?? "Colaborador";
                            <div class="checkin-timeline-item">
                                <div class="checkin-timeline-marker">
                                    <div class="checkin-timeline-dot @confidenceClass"></div>
                                    <div class="checkin-timeline-line"></div>
                                </div>
                                <div class="checkin-timeline-content">
                                    <div class="checkin-timeline-header">
                                        <div class="checkin-timeline-author">
                                            <div class="checkin-timeline-avatar" title="@collaboratorName">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                                                </svg>
                                            </div>
                                            <span class="checkin-timeline-author-name">@collaboratorName</span>
                                        </div>
                                        <div class="checkin-timeline-meta">
                                            <span class="checkin-timeline-date">@checkin.CheckinDate.ToString("dd/MM/yyyy")</span>
                                            <span class="checkin-timeline-confidence" title="Nível de confiança: @checkin.ConfidenceLevel">
                                                @GetConfidenceStarsDisplay(checkin.ConfidenceLevel)
                                            </span>
                                        </div>
                                    </div>
                                    <div class="checkin-timeline-value">
                                        @GetCheckinValueDisplay(checkin)
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(checkin.Note))
                                    {
                                        <div class="checkin-timeline-note">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <span>@checkin.Note</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public MissionMetric? Metric { get; set; }
    [Parameter] public List<MetricCheckin> Checkins { get; set; } = [];
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnNewCheckin { get; set; }

    private static string GetConfidenceStarsDisplay(int level) =>
        new string('\u2605', level) + new string('\u2606', 5 - level);

    private string GetCheckinValueDisplay(MetricCheckin checkin)
    {
        if (checkin.Value.HasValue)
        {
            var unit = Metric?.Unit.HasValue == true ? MissionMetricDisplayHelper.GetUnitLabel(Metric.Unit!.Value) : "";
            return $"{checkin.Value.Value:G} {unit}".Trim();
        }
        if (!string.IsNullOrWhiteSpace(checkin.Text))
        {
            return checkin.Text;
        }
        return "\u2014";
    }
}
