@using Bud.Client.Services

@{
    var progressPercent = (int)(Progress?.OverallProgress ?? 0);
    var circumference = 2 * Math.PI * 19;
    var dashOffset = circumference - (circumference * progressPercent / 100);
}

<div class="mission-card @(IsExpanded ? "expanded" : "") @(Mission.Status == MissionStatus.Planned ? "draft" : "")">
    <div class="mission-card-header" @onclick="() => OnToggleExpand.InvokeAsync()">
        @* Círculo de Progresso *@
        <div class="mission-progress-circle">
            <svg width="44" height="44" viewBox="0 0 44 44">
                <circle class="progress-bg" cx="22" cy="22" r="19" />
                @if (Mission.Status != MissionStatus.Planned)
                {
                    <circle class="progress-value @MissionProgressDisplayHelper.GetMissionProgressStatusClass(Progress)"
                            cx="22" cy="22" r="19"
                            stroke-dasharray="@circumference.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                            stroke-dashoffset="@dashOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)" />
                }
            </svg>
            <div class="mission-progress-text">
                <span class="mission-progress-number">@(Mission.Status == MissionStatus.Planned ? "00" : progressPercent.ToString())</span>
                <span class="mission-progress-percent">%</span>
            </div>
        </div>

        @* Título da Missão *@
        <div class="mission-card-title-wrapper">
            @if (Mission.Status == MissionStatus.Planned)
            {
                <span class="mission-draft-tag">RASCUNHO</span>
            }
            <div class="mission-card-title-row">
                <div class="mission-card-title">@Mission.Name</div>
                @if (Progress != null && Progress.MetricsWithCheckins > 0)
                {
                    <div class="mission-confidence-badge @MissionProgressDisplayHelper.GetConfidenceClass(Progress.AverageConfidence)" title="Nível de confiança: @MissionProgressDisplayHelper.GetConfidenceLabel(Progress.AverageConfidence)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>@((int)Math.Round(Progress.AverageConfidence))</span>
                    </div>
                }
            </div>
        </div>

        @* Ações *@
        <div class="mission-card-actions" @onclick:stopPropagation="true">
            <button class="mission-action-btn" @onclick="() => OnEdit.InvokeAsync()" title="Editar missão">
                <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                    <path d="M22 4L28 10L10 28H4V22L22 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="mission-action-btn @(IsDeleting ? "danger" : "")"
                    @onclick="() => OnDeleteClick.InvokeAsync()"
                    title="@(IsDeleting ? "Confirmar exclusão" : "Excluir")">
                @if (IsDeleting)
                {
                    <span style="font-size: 10px;">OK?</span>
                }
                else
                {
                    <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                        <path d="M4 8H6.66667H28" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10.6667 8V5.33333C10.6667 4.62609 10.9476 3.94781 11.4477 3.44772C11.9478 2.94762 12.6261 2.66667 13.3333 2.66667H18.6667C19.3739 2.66667 20.0522 2.94762 20.5523 3.44772C21.0524 3.94781 21.3333 4.62609 21.3333 5.33333V8M25.3333 8V26.6667C25.3333 27.3739 25.0524 28.0522 24.5523 28.5523C24.0522 29.0524 23.3739 29.3333 22.6667 29.3333H9.33333C8.62609 29.3333 7.94781 29.0524 7.44772 28.5523C6.94762 28.0522 6.66667 27.3739 6.66667 26.6667V8H25.3333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                }
            </button>
            <button class="mission-action-btn" @onclick="() => OnToggleExpand.InvokeAsync()" title="@(IsExpanded ? "Recolher" : "Expandir")">
                <svg class="mission-expand-icon @(IsExpanded ? "expanded" : "")" width="22" height="22" viewBox="0 0 32 32" fill="none">
                    <path d="M8 12L16 20L24 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    @* Conteúdo Expandido - Objetivos e Métricas *@
    @if (IsExpanded)
    {
        <div class="mission-card-content">
            @if (Metrics is null)
            {
                <p class="muted">Carregando...</p>
            }
            else
            {
                var directMetrics = Metrics.Where(m => m.MissionObjectiveId is null).ToList();

                @* Seção de Objetivos *@
                if (Objectives != null && Objectives.Count > 0)
                {
                    foreach (var objective in Objectives)
                    {
                        var objMetrics = Metrics.Where(m => m.MissionObjectiveId == objective.Id).ToList();
                        <MissionObjectiveSection Mission="Mission"
                                                 Objective="objective"
                                                 ObjectiveDimensions="ObjectiveDimensions"
                                                 ObjectiveProgress="@(ObjectiveProgressCache.GetValueOrDefault(objective.Id))"
                                                 MissionProgress="Progress"
                                                 ObjectiveMetrics="objMetrics"
                                                 MetricProgressCache="MetricProgressCache"
                                                 IsExpanded="@(ExpandedObjectives.Contains(objective.Id))"
                                                 OnToggleExpand="() => OnToggleObjectiveExpand.InvokeAsync(objective.Id)"
                                                 OnCheckinClick="OnCheckinClick"
                                                 OnHistoryClick="OnHistoryClick" />
                    }
                }

                @* Métricas diretas (sem objetivo) *@
                if (directMetrics.Count > 0)
                {
                    if (Objectives != null && Objectives.Count > 0)
                    {
                        <div class="direct-metrics-label">Métricas diretas</div>
                    }
                    foreach (var metric in directMetrics)
                    {
                        <MissionMetricRow Mission="Mission"
                                          Metric="metric"
                                          MissionProgress="Progress"
                                          MetricProgress="@(MetricProgressCache.GetValueOrDefault(metric.Id))"
                                          OnCheckinClick="OnCheckinClick"
                                          OnHistoryClick="OnHistoryClick" />
                    }
                }

                if (directMetrics.Count == 0 && (Objectives == null || Objectives.Count == 0))
                {
                    <p class="muted">Nenhuma métrica ou objetivo associado a esta missão.</p>
                }
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public Mission Mission { get; set; } = default!;
    [Parameter] public MissionProgressDto? Progress { get; set; }
    [Parameter] public bool IsExpanded { get; set; }
    [Parameter] public bool IsDeleting { get; set; }
    [Parameter] public List<MissionMetric>? Metrics { get; set; }
    [Parameter] public List<MissionObjective>? Objectives { get; set; }
    [Parameter] public List<ObjectiveDimension> ObjectiveDimensions { get; set; } = [];
    [Parameter] public Dictionary<Guid, MetricProgressDto> MetricProgressCache { get; set; } = new();
    [Parameter] public Dictionary<Guid, ObjectiveProgressDto> ObjectiveProgressCache { get; set; } = new();
    [Parameter] public HashSet<Guid> ExpandedObjectives { get; set; } = new();
    [Parameter] public EventCallback OnToggleExpand { get; set; }
    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback OnDeleteClick { get; set; }
    [Parameter] public EventCallback<Guid> OnToggleObjectiveExpand { get; set; }
    [Parameter] public EventCallback<MissionMetric> OnCheckinClick { get; set; }
    [Parameter] public EventCallback<MissionMetric> OnHistoryClick { get; set; }
}
