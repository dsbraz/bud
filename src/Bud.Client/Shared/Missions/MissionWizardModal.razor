@inject ToastService ToastService

@if (IsOpen)
{
    <Modal Title="@GetModalTitle()" Breadcrumb="@(Mode == WizardMode.Mission ? OrganizationName : null)" Size="lg" OnClose="HandleClose">
        <ChildContent>
            @* Wizard Tabs *@
            <div class="wizard-tabs">
                <button type="button" class="wizard-tab @(wizardStep == 1 ? "active" : "")" @onclick="() => wizardStep = 1">
                    <span class="wizard-tab-number">1</span>
                    <span>Miss√£o</span>
                </button>
                <div class="wizard-tab-separator"></div>
                <button type="button" class="wizard-tab @(wizardStep == 2 ? "active" : "")" @onclick="() => wizardStep = 2">
                    <span class="wizard-tab-number">2</span>
                    <span>M√©tricas</span>
                    @{ var directMetricCount = tempMetrics.Count(m => m.ObjectiveTempId is null); }
                    @if (directMetricCount > 0)
                    {
                        <span class="wizard-tab-badge">@directMetricCount</span>
                    }
                </button>
                <div class="wizard-tab-separator"></div>
                <button type="button" class="wizard-tab @(wizardStep == 3 ? "active" : "")" @onclick="() => wizardStep = 3">
                    <span class="wizard-tab-number">3</span>
                    <span>Objetivos</span>
                    @if (tempObjectives.Count > 0)
                    {
                        <span class="wizard-tab-badge">@tempObjectives.Count</span>
                    }
                </button>
            </div>

            @* Tab 1: Miss√£o / Modelo *@
            @if (wizardStep == 1)
            {
                <div>
                    <div class="mission-header">
                        <input type="text" class="mission-title-input" @bind="name" placeholder="@(Mode == WizardMode.Template ? "Nome do template" : "Nome da miss√£o")" />
                        <input type="text" class="mission-subtitle-input" @bind="description" placeholder="@(Mode == WizardMode.Template ? "Descri√ß√£o do template" : "Adicionar breve descri√ß√£o")" />
                    </div>

                    @if (Mode == WizardMode.Mission)
                    {
                        <div class="chips-container">
                            <div class="chip" @onclick="() => showResponsibleSelector = !showResponsibleSelector">
                                <span class="chip-icon">üë§</span>
                                <span>@GetResponsibleLabel()</span>
                            </div>
                            <div class="chip" @onclick="() => showPeriodSelector = !showPeriodSelector">
                                <span class="chip-icon">üìÖ</span>
                                <span>@GetPeriodLabel()</span>
                            </div>
                            @if (IsEditMode)
                            {
                                <div class="chip" @onclick="() => showStatusSelector = !showStatusSelector">
                                    <span class="chip-icon">üìä</span>
                                    <span>@GetStatusChipLabel()</span>
                                </div>
                            }
                        </div>

                        @if (IsEditMode && showStatusSelector)
                        {
                            <div class="form-row">
                                <label>Status</label>
                                <select class="input" @bind="statusValue">
                                    @foreach (var status in Enum.GetValues<MissionStatus>())
                                    {
                                        <option value="@status">@GetStatusLabel(status)</option>
                                    }
                                </select>
                            </div>
                        }

                        @if (showResponsibleSelector)
                        {
                            <div class="form-row">
                                <label>Escopo</label>
                                <select class="input" value="@scopeTypeValue" @onchange="HandleScopeTypeChanged">
                                    <option value="">Selecione</option>
                                    @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                                    {
                                        <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                                    }
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Refer√™ncia</label>
                                <select class="input" @bind="scopeId">
                                    <option value="">Selecione</option>
                                    @foreach (var option in GetScopeOptions(scopeTypeValue))
                                    {
                                        <option value="@option.Id">@option.Name</option>
                                    }
                                </select>
                            </div>
                        }

                        @if (showPeriodSelector)
                        {
                            <div class="form-row">
                                <label>Data de in√≠cio</label>
                                <input type="date" class="input" @bind="startDate" @bind:format="yyyy-MM-dd" />
                            </div>
                            <div class="form-row">
                                <label>Data de fim</label>
                                <input type="date" class="input" @bind="endDate" @bind:format="yyyy-MM-dd" />
                            </div>
                        }
                    }

                </div>
            }

            @* Tab 2: M√©tricas diretas *@
            @if (wizardStep == 2)
            {
                <div class="wizard-tab-content">
                    <div class="mission-metrics-section">
                        <div class="mission-metrics-section-header">
                            <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 9l-5 5-4-4-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <h3>M√©tricas diretas</h3>
                        </div>

                        @if (tempObjectives.Count > 0)
                        {
                            <p class="wizard-tab-hint">M√©tricas que n√£o pertencem a nenhum objetivo. Para adicionar m√©tricas a um objetivo, use a aba Objetivos.</p>
                        }

                        <MetricFormFields Model="newMetricModel" OnSave="AddMetricFromForm" OnCancel="CancelAddMetricForm" ShowAddButton="true" />

                        @{
                            var directMetrics = tempMetrics
                                .Select((m, idx) => (Metric: m, Index: idx))
                                .Where(x => x.Metric.ObjectiveTempId is null)
                                .ToList();
                        }

                        @if (directMetrics.Any())
                        {
                            <div class="metrics-list">
                                @foreach (var (metric, metricIndex) in directMetrics)
                                {
                                    @if (editingTempMetricIndex == metricIndex)
                                    {
                                        <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                            <MetricFormFields Model="editTempMetricModel" OnSave="SaveTempMetric" OnCancel="CancelTempMetric" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="metric-item">
                                            <div class="metric-info">
                                                <div class="metric-name">@metric.Name</div>
                                                <div class="metric-details">@metric.Details</div>
                                            </div>
                                            <CrudRowActions
                                                EditTitle="Editar m√©trica"
                                                OnEdit="@(() => StartTempMetric(metricIndex))"
                                                IsDeleteConfirming="false"
                                                DeleteTitle="Excluir m√©trica"
                                                OnDelete="@(() => RemoveMetric(metric))" />
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </div>
            }

            @* Tab 3: Objetivos *@
            @if (wizardStep == 3)
            {
                <div class="wizard-tab-content">
                    <div class="mission-metrics-section">
                        <div class="mission-metrics-section-header">
                            <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="6" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="2" stroke-linecap="round"/>
                            </svg>
                            <h3>Objetivos</h3>
                        </div>

                        @if (tempObjectives.Count > 0)
                        {
                            <p class="wizard-tab-hint">Organize as m√©tricas @(Mode == WizardMode.Template ? "do template" : "da miss√£o") em objetivos. Cada objetivo pode ter suas pr√≥prias m√©tricas.</p>
                        }

                        @if (showObjectiveForm)
                        {
                            <div class="wizard-objective-form">
                                <div class="form-row">
                                    <label>Nome do objetivo</label>
                                    <input type="text" class="input" @bind="tempObjectiveName" placeholder="Ex: Aumentar engajamento, Reduzir churn..." maxlength="200" />
                                </div>
                                <div class="form-row">
                                    <label>Descri√ß√£o (opcional)</label>
                                    <textarea class="input" @bind="tempObjectiveDescription" placeholder="Breve descri√ß√£o do objetivo" maxlength="1000" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <label>Dimens√£o (opcional)</label>
                                    <select class="input" @bind="tempObjectiveDimensionId">
                                        <option value="">Sem dimens√£o</option>
                                        @foreach (var dimension in ObjectiveDimensions.OrderBy(d => d.Name))
                                        {
                                            <option value="@dimension.Id">@dimension.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="form-actions" style="margin-top: var(--spacing-3);">
                                    <button type="button" class="button tertiary" @onclick="CancelAddObjective">Cancelar</button>
                                    <button type="button" class="button primary" @onclick="AddTempObjective">Salvar objetivo</button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <button type="button" class="metrics-add-button" @onclick="() => showObjectiveForm = true">
                                <span>Adicionar objetivo</span>
                                <span class="metrics-add-icon">+</span>
                            </button>
                        }

                        @if (tempObjectives.Count > 0)
                        {
                            <div class="metrics-list">
                                @for (var i = 0; i < tempObjectives.Count; i++)
                                {
                                    var index = i;
                                    var obj = tempObjectives[index];

                                    @if (editingTempObjectiveIndex == index)
                                    {
                                        <div class="wizard-objective-card">
                                            <div class="form-row">
                                                <label>Nome</label>
                                                <input type="text" class="input" @bind="editingObjectiveName" maxlength="200" />
                                            </div>
                                            <div class="form-row">
                                                <label>Descri√ß√£o</label>
                                                <textarea class="input" @bind="editingObjectiveDescription" maxlength="1000" rows="2"></textarea>
                                            </div>
                                            <div class="form-row">
                                                <label>Dimens√£o (opcional)</label>
                                                <select class="input" @bind="editingObjectiveDimensionId">
                                                    <option value="">Sem dimens√£o</option>
                                                    @foreach (var dimension in ObjectiveDimensions.OrderBy(d => d.Name))
                                                    {
                                                        <option value="@dimension.Id">@dimension.Name</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                                <button type="button" class="button tertiary" @onclick="CancelEditTempObjective">Cancelar</button>
                                                <button type="button" class="button primary" @onclick="SaveEditTempObjective">Salvar</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="wizard-objective-card">
                                            <div class="wizard-objective-header">
                                                <div class="wizard-objective-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                                                        <circle cx="12" cy="12" r="6" stroke-linecap="round"/>
                                                        <circle cx="12" cy="12" r="2" stroke-linecap="round"/>
                                                    </svg>
                                                </div>
                                                <div class="metric-info">
                                                    <div class="metric-name">@obj.Name</div>
                                                    @if (!string.IsNullOrWhiteSpace(obj.Description))
                                                    {
                                                        <div class="metric-details">@obj.Description</div>
                                                    }
                                                    @if (obj.ObjectiveDimensionId.HasValue)
                                                    {
                                                        var dimensionName = ObjectiveDimensions
                                                            .FirstOrDefault(d => d.Id == obj.ObjectiveDimensionId.Value)
                                                            ?.Name;
                                                        if (!string.IsNullOrWhiteSpace(dimensionName))
                                                        {
                                                            <div class="metric-details">Dimens√£o: @dimensionName</div>
                                                        }
                                                    }
                                                </div>
                                                <CrudRowActions
                                                    EditTitle="Editar objetivo"
                                                    OnEdit="@(() => StartEditTempObjective(index))"
                                                    IsDeleteConfirming="false"
                                                    DeleteTitle="Excluir objetivo"
                                                    OnDelete="@(() => RemoveTempObjective(index))" />
                                            </div>

                                            @* Adicionar m√©trica ao objetivo *@
                                            @if (addingMetricToObjectiveTempId == obj.TempId)
                                            {
                                                <div style="margin-top: var(--spacing-3);">
                                                    <MetricFormFields Model="newMetricModel" OnSave="AddMetricToObjective" OnCancel="CancelAddMetricToObjective" />
                                                </div>
                                            }
                                            else
                                            {
                                                <button type="button" class="metrics-add-button" style="margin-top: var(--spacing-3);" @onclick="() => StartAddMetricToObjective(obj.TempId)">
                                                    <span>Adicionar m√©trica</span>
                                                    <span class="metrics-add-icon">+</span>
                                                </button>
                                            }

                                            @* M√©tricas deste objetivo *@
                                            @{
                                                var objMetrics = tempMetrics
                                                    .Select((m, idx) => (Metric: m, Index: idx))
                                                    .Where(x => x.Metric.ObjectiveTempId == obj.TempId)
                                                    .ToList();
                                            }

                                            @if (objMetrics.Any())
                                            {
                                                <div class="metrics-list" style="margin-top: var(--spacing-3);">
                                                    @foreach (var (metric, metricIndex) in objMetrics)
                                                    {
                                                        @if (editingTempMetricIndex == metricIndex)
                                                        {
                                                            <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                                                <MetricFormFields Model="editTempMetricModel" OnSave="SaveTempMetric" OnCancel="CancelTempMetric" />
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="metric-item">
                                                                <div class="metric-info">
                                                                    <div class="metric-name">@metric.Name</div>
                                                                    <div class="metric-details">@metric.Details</div>
                                                                </div>
                                                                <CrudRowActions
                                                                    EditTitle="Editar m√©trica"
                                                                    OnEdit="@(() => StartTempMetric(metricIndex))"
                                                                    IsDeleteConfirming="false"
                                                                    DeleteTitle="Excluir m√©trica"
                                                                    OnDelete="@(() => RemoveMetric(metric))" />
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="HandleClose">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    @if (wizardStep > 1)
                    {
                        <button class="button tertiary" type="button" @onclick="() => wizardStep--">Voltar</button>
                    }
                    @if (wizardStep < 3)
                    {
                        <button class="button secondary" type="button" @onclick="() => wizardStep++">Pr√≥ximo</button>
                    }
                    else if (IsEditMode)
                    {
                        <button class="button primary" type="button" @onclick="HandleSave">Salvar altera√ß√µes</button>
                    }
                    else if (Mode == WizardMode.Template)
                    {
                        <button class="button primary" type="button" @onclick="HandleSave">Criar</button>
                    }
                    else
                    {
                        <button class="button secondary" type="button" @onclick="HandleSaveDraft">Salvar rascunho</button>
                        <button class="button primary" type="button" @onclick="HandleSave">Criar miss√£o</button>
                    }
                </div>
            </div>
        </Footer>
    </Modal>
}
