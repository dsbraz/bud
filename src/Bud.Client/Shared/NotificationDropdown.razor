@inject ApiClient Api

<div class="notification-dropdown-wrapper" @onclick:stopPropagation="true">
    <button class="topbar-icon-btn" title="Notificações" @onclick="ToggleDropdown">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
            <path d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"/>
        </svg>
        @if (UnreadCount > 0)
        {
            <span class="notification-badge">@(UnreadCount > 99 ? "99+" : UnreadCount.ToString())</span>
        }
    </button>

    @if (isOpen)
    {
        <div class="notification-panel">
            <div class="notification-panel-header">
                <span>Notificações</span>
                @if (UnreadCount > 0)
                {
                    <button class="notification-mark-all-btn" @onclick="HandleMarkAllAsRead">Marcar todas como lidas</button>
                }
            </div>
            <div class="notification-panel-list">
                @if (isLoading)
                {
                    <div class="notification-empty">Carregando...</div>
                }
                else if (notifications.Count == 0)
                {
                    <div class="notification-empty">Nenhuma notificação</div>
                }
                else
                {
                    @foreach (var notification in notifications)
                    {
                        <div class="notification-item @(notification.IsRead ? "" : "unread")"
                             @onclick="() => HandleNotificationClick(notification)">
                            <div class="notification-item-content">
                                <div class="notification-item-title">@notification.Title</div>
                                <div class="notification-item-message">@notification.Message</div>
                                <div class="notification-item-time">@FormatRelativeTime(notification.CreatedAtUtc)</div>
                            </div>
                            @if (!notification.IsRead)
                            {
                                <div class="notification-item-dot"></div>
                            }
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int UnreadCount { get; set; }
    [Parameter] public EventCallback<int> OnCountChanged { get; set; }

    private bool isOpen;
    private bool isLoading;
    private List<Bud.Shared.Contracts.NotificationDto> notifications = new();

    private async Task ToggleDropdown()
    {
        isOpen = !isOpen;
        if (isOpen && notifications.Count == 0)
        {
            await LoadNotifications();
        }
    }

    private async Task LoadNotifications()
    {
        isLoading = true;
        try
        {
            var result = await Api.GetNotificationsAsync(page: 1, pageSize: 20);
            if (result?.Items != null)
            {
                notifications = result.Items.ToList();
            }
        }
        catch
        {
            // Silently handle errors — user can retry by toggling
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleNotificationClick(Bud.Shared.Contracts.NotificationDto notification)
    {
        if (!notification.IsRead)
        {
            try
            {
                await Api.MarkNotificationAsReadAsync(notification.Id);
                notification.IsRead = true;
                notification.ReadAtUtc = DateTime.UtcNow;
                var newCount = Math.Max(0, UnreadCount - 1);
                await OnCountChanged.InvokeAsync(newCount);
            }
            catch
            {
                // Silently handle errors
            }
        }
    }

    private async Task HandleMarkAllAsRead()
    {
        try
        {
            await Api.MarkAllNotificationsAsReadAsync();
            foreach (var n in notifications)
            {
                n.IsRead = true;
                n.ReadAtUtc = DateTime.UtcNow;
            }
            await OnCountChanged.InvokeAsync(0);
        }
        catch
        {
            // Silently handle errors
        }
    }

    private static string FormatRelativeTime(DateTime utcTime)
    {
        var diff = DateTime.UtcNow - utcTime;

        if (diff.TotalMinutes < 1) return "agora";
        if (diff.TotalMinutes < 60) return $"há {(int)diff.TotalMinutes} min";
        if (diff.TotalHours < 24) return $"há {(int)diff.TotalHours}h";
        if (diff.TotalDays < 30) return $"há {(int)diff.TotalDays}d";
        return utcTime.ToString("dd/MM/yyyy");
    }
}
