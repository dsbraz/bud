@page "/organizations"
@implements IDisposable
@inject ApiClient Api
@inject AuthState AuthState
@inject ToastService ToastService
@inject NavigationManager Navigation
@inject OrganizationContext OrgContext

@if (AuthState.Session?.IsGlobalAdmin != true)
{
    <div class="card">
        <p class="muted">Voc√™ n√£o tem permiss√£o para acessar esta p√°gina. Apenas administradores podem gerenciar organiza√ß√µes.</p>
    </div>
}
else
{
    <div class="page-header">
    <div>
        <div class="page-kicker">Gest√£o</div>
        <h1>Organiza√ß√µes</h1>
        <p class="page-subtitle">Crie e liste organiza√ß√µes cadastradas.</p>
    </div>
    @if (AuthState.Session?.IsGlobalAdmin == true)
    {
        <button class="button primary" @onclick="async () => await OpenCreateModal()">
            <span class="button-icon-text">+</span>
            Nova organiza√ß√£o
        </button>
    }
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadOrganizations">Atualizar</button>
        </div>
    </div>

    @if (organizations is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (organizations.Items.Count == 0)
    {
        <p class="muted">Nenhuma organiza√ß√£o encontrada.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Dom√≠nio</th>
                    <th>Propriet√°rio</th>
                    <th>ID</th>
                    <th style="width: 120px; text-align: center;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var org in organizations.Items)
                {
                    var isDeleting = deletingOrganizationId == org.Id;
                    var isProtected = !string.IsNullOrEmpty(org.Name) &&
                                    org.Name.Equals(GlobalAdminOrgName, StringComparison.OrdinalIgnoreCase);
                    <tr style="cursor: pointer;" @onclick="() => OpenDetailsModal(org)">
                        <td>
                            @org.Name
                            @if (isProtected)
                            {
                                <span class="badge protected" title="Organiza√ß√£o protegida">üîí</span>
                            }
                        </td>
                        <td>@(org.Owner?.FullName ?? "‚Äî")</td>
                        <td class="mono">@org.Id</td>
                        <td style="text-align: center;">
                            <div class="table-actions">
                                <button class="button-icon" @onclick="async () => await OpenEditModal(org)" @onclick:stopPropagation="true"
                                        disabled="@isProtected"
                                        title="@(isProtected ? "Esta organiza√ß√£o est√° protegida" : "Editar organiza√ß√£o")">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M11.334 2.00004C11.5091 1.82494 11.7169 1.68605 11.9457 1.59129C12.1745 1.49653 12.4197 1.44775 12.6673 1.44775C12.9149 1.44775 13.1601 1.49653 13.3889 1.59129C13.6177 1.68605 13.8256 1.82494 14.0007 2.00004C14.1758 2.17513 14.3147 2.383 14.4094 2.61178C14.5042 2.84055 14.553 3.08575 14.553 3.33337C14.553 3.58099 14.5042 3.82619 14.4094 4.05497C14.3147 4.28374 14.1758 4.49161 14.0007 4.66671L5.00065 13.6667L1.33398 14.6667L2.33398 11L11.334 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="button-icon @(isDeleting ? "danger" : "")"
                                        @onclick="() => HandleDeleteClick(org.Id)" @onclick:stopPropagation="true"
                                        disabled="@isProtected"
                                        title="@(isProtected ? "Esta organiza√ß√£o est√° protegida" : isDeleting ? "Clique novamente para confirmar" : "Excluir organiza√ß√£o")">
                                    @if (isDeleting)
                                    {
                                        <span style="font-size: 11px; white-space: nowrap;">Confirmar?</span>
                                    }
                                    else
                                    {
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M5.33398 4.00004V2.66671C5.33398 2.31309 5.47446 1.97395 5.72451 1.7239C5.97456 1.47385 6.3137 1.33337 6.66732 1.33337H9.33398C9.6876 1.33337 10.0268 1.47385 10.2768 1.7239C10.5269 1.97395 10.6673 2.31309 10.6673 2.66671V4.00004M12.6673 4.00004V13.3334C12.6673 13.687 12.5269 14.0261 12.2768 14.2762C12.0268 14.5262 11.6876 14.6667 11.334 14.6667H4.66732C4.3137 14.6667 3.97456 14.5262 3.72451 14.2762C3.47446 14.0261 3.33398 13.687 3.33398 13.3334V4.00004H12.6673Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    }
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @organizations.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="@(modalMode == "create" ? "Criar organiza√ß√£o" : "Editar organiza√ß√£o")" OnClose="CloseModal">
        @if (AuthState.Session?.IsGlobalAdmin == true)
        {
            @if (modalMode == "create")
            {
                <EditForm Model="@newOrganization" OnValidSubmit="CreateOrganization">
                    <DataAnnotationsValidator />
                    <div class="form-row">
                        <label>Dom√≠nio</label>
                        <InputText class="input" @bind-Value="newOrganization.Name" placeholder="empresa.com.br" />
                    </div>
                    <div class="form-row">
                        <label>L√≠der (Propriet√°rio) *</label>
                        <InputSelect class="input" @bind-Value="newOrganization.OwnerId">
                            <option value="@Guid.Empty">-- Selecione um l√≠der --</option>
                            @foreach (var leader in leaders)
                            {
                                <option value="@leader.Id">
                                    @leader.FullName - @leader.TeamName (@leader.OrganizationName)
                                </option>
                            }
                        </InputSelect>
                        <small class="form-hint">Apenas colaboradores com fun√ß√£o de L√≠der podem ser propriet√°rios.</small>
                    </div>
                    <div class="form-actions">
                        <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                        <button class="button primary" type="submit" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Salvar</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <EditForm Model="@editOrganization" OnValidSubmit="UpdateOrganization">
                    <DataAnnotationsValidator />
                    <div class="form-row">
                        <label>Dom√≠nio</label>
                        <InputText class="input" @bind-Value="editOrganization.Name" placeholder="empresa.com.br" disabled="@IsProtectedOrganization()" />
                        @if (IsProtectedOrganization())
                        {
                            <small class="form-hint" style="color: var(--color-error);">Esta organiza√ß√£o est√° protegida e n√£o pode ser alterada.</small>
                        }
                    </div>
                    <div class="form-row">
                        <label>L√≠der (Propriet√°rio) *</label>
                        <InputSelect class="input" @bind-Value="editOrganization.OwnerId" disabled="@IsProtectedOrganization()">
                            <option value="@Guid.Empty">-- Selecione um l√≠der --</option>
                            @foreach (var leader in leaders)
                            {
                                <option value="@leader.Id">
                                    @leader.FullName - @leader.TeamName (@leader.OrganizationName)
                                </option>
                            }
                        </InputSelect>
                        <small class="form-hint">O propriet√°rio pode ser alterado para qualquer colaborador com fun√ß√£o de L√≠der.</small>
                    </div>
                    <div class="form-actions">
                        <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                        <button class="button primary" type="submit" disabled="@(isSubmitting || IsProtectedOrganization())">
                            @if (isSubmitting)
                            {
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Salvar altera√ß√µes</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
        }
        else
        {
            <p class="muted">Apenas administradores podem gerenciar organiza√ß√µes.</p>
        }
    </Modal>
}

@if (isDetailsModalOpen && selectedOrganization != null)
{
    <Modal Title="@($"Detalhes: {selectedOrganization.Name}")"
           Size="lg"
           OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Workspaces</h3>
                @if (orgWorkspaces == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (orgWorkspaces.Items.Count == 0)
                {
                    <p class="muted">Nenhum workspace encontrado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var ws in orgWorkspaces.Items.Take(10))
                        {
                            <li class="detail-list-item">
                                <span class="detail-name">@ws.Name</span>
                            </li>
                        }
                    </ul>
                    @if (orgWorkspaces.Total > 10)
                    {
                        <p class="detail-more">e mais @(orgWorkspaces.Total - 10)...</p>
                    }
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Colaboradores</h3>
                @if (orgCollaborators == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (orgCollaborators.Items.Count == 0)
                {
                    <p class="muted">Nenhum colaborador encontrado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var collab in orgCollaborators.Items.Take(10))
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@collab.FullName</span>
                                    <span class="badge @(collab.Role == CollaboratorRole.Leader ? "leader" : "contributor")">
                                        @(collab.Role == CollaboratorRole.Leader ? "L√≠der" : "Contribuidor")
                                    </span>
                                </div>
                                <span class="detail-email">@collab.Email</span>
                                @if (collab.Team != null)
                                {
                                    <span class="detail-team">Time: @collab.Team.Name</span>
                                }
                            </li>
                        }
                    </ul>
                    @if (orgCollaborators.Total > 10)
                    {
                        <p class="detail-more">e mais @(orgCollaborators.Total - 10)...</p>
                    }
                }
            </div>
        </ChildContent>
    </Modal>
}
}

@code {
    private CreateOrganizationRequest newOrganization = new();
    private PagedResult<Organization>? organizations;
    private List<LeaderCollaboratorResponse> leaders = new();
    private string? search;
    private bool isSubmitting = false;
    private bool isModalOpen = false;
    private string modalMode = "create"; // "create" ou "edit"
    private Guid? editingOrganizationId = null;
    private UpdateOrganizationRequest editOrganization = new();
    private Guid? deletingOrganizationId = null;
    private System.Threading.Timer? deleteConfirmTimer;
    private const string GlobalAdminOrgName = "getbud.co"; // Organiza√ß√£o do admin global

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Organization? selectedOrganization = null;
    private PagedResult<Workspace>? orgWorkspaces = null;
    private PagedResult<Collaborator>? orgCollaborators = null;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.EnsureInitializedAsync();
        await LoadOrganizations();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private async void HandleOrganizationChanged()
    {
        await LoadOrganizations();
        StateHasChanged();
    }

    private async Task LoadLeaders(Guid? organizationId = null)
    {
        try
        {
            leaders = await Api.GetLeadersAsync(organizationId) ?? new List<LeaderCollaboratorResponse>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar l√≠deres: {ex.Message}");
            leaders = new List<LeaderCollaboratorResponse>();
        }
    }

    private async Task LoadOrganizations()
    {
        organizations = await Api.GetOrganizationsAsync(search, 1, 20) ?? new PagedResult<Organization>();
    }

    private async Task OpenCreateModal()
    {
        modalMode = "create";
        editingOrganizationId = null;
        newOrganization = new CreateOrganizationRequest();
        // Load leaders based on selected tenant context
        // If a specific org is selected, show only its leaders
        // If "TODOS" is selected (null), show all leaders
        await LoadLeaders(OrgContext.SelectedOrganizationId);
        isModalOpen = true;
    }

    private async Task OpenEditModal(Organization org)
    {
        modalMode = "edit";
        editingOrganizationId = org.Id;
        editOrganization = new UpdateOrganizationRequest
        {
            Name = org.Name,
            OwnerId = org.OwnerId ?? Guid.Empty
        };
        // Load leaders based on selected tenant context
        // If a specific org is selected, show only its leaders
        // If "TODOS" is selected (null), show all leaders
        await LoadLeaders(OrgContext.SelectedOrganizationId);
        isModalOpen = true;
    }

    private bool IsProtectedOrganization()
    {
        if (editingOrganizationId == null) return false;

        var org = organizations?.Items.FirstOrDefault(o => o.Id == editingOrganizationId);
        return org != null &&
               !string.IsNullOrEmpty(org.Name) &&
               org.Name.Equals(GlobalAdminOrgName, StringComparison.OrdinalIgnoreCase);
    }

    private void CloseModal()
    {
        isModalOpen = false;
        modalMode = "create";
        editingOrganizationId = null;
        editOrganization = new UpdateOrganizationRequest();
    }

    private async Task CreateOrganization()
    {
        // Frontend validation
        if (string.IsNullOrWhiteSpace(newOrganization.Name))
        {
            ToastService.ShowError("Erro ao criar organiza√ß√£o", "Por favor, informe o dom√≠nio da organiza√ß√£o.");
            return;
        }

        if (newOrganization.OwnerId == Guid.Empty)
        {
            ToastService.ShowError("Erro ao criar organiza√ß√£o", "Por favor, selecione um l√≠der para a organiza√ß√£o.");
            return;
        }

        isSubmitting = true;

        try
        {
            await Api.CreateOrganizationAsync(newOrganization);
            newOrganization = new CreateOrganizationRequest();
            await LoadOrganizations();

            ToastService.ShowSuccess("Organiza√ß√£o criada com sucesso!", "A organiza√ß√£o foi criada e est√° dispon√≠vel.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao criar organiza√ß√£o", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task UpdateOrganization()
    {
        if (editingOrganizationId == null) return;

        if (string.IsNullOrWhiteSpace(editOrganization.Name))
        {
            ToastService.ShowError("Erro ao atualizar organiza√ß√£o", "Por favor, informe o dom√≠nio da organiza√ß√£o.");
            return;
        }

        if (editOrganization.OwnerId == Guid.Empty)
        {
            ToastService.ShowError("Erro ao atualizar organiza√ß√£o", "Por favor, selecione um l√≠der para a organiza√ß√£o.");
            return;
        }

        isSubmitting = true;

        try
        {
            await Api.UpdateOrganizationAsync(editingOrganizationId.Value, editOrganization);
            await LoadOrganizations();
            ToastService.ShowSuccess("Organiza√ß√£o atualizada com sucesso!", "As altera√ß√µes foram salvas.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao atualizar organiza√ß√£o", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleDeleteClick(Guid organizationId)
    {
        if (deletingOrganizationId == organizationId)
        {
            // Segunda clique - confirma exclus√£o
            _ = DeleteOrganization(organizationId);
        }
        else
        {
            // Primeiro clique - mostra confirma√ß√£o
            deletingOrganizationId = organizationId;

            // Reseta ap√≥s 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    deletingOrganizationId = null;
                    StateHasChanged();
                });
            }, null, 3000, Timeout.Infinite);
        }
    }

    private async Task DeleteOrganization(Guid organizationId)
    {
        deletingOrganizationId = null;
        deleteConfirmTimer?.Dispose();

        var orgName = organizations?.Items.FirstOrDefault(o => o.Id == organizationId)?.Name ?? "organiza√ß√£o";

        try
        {
            await Api.DeleteOrganizationAsync(organizationId);
            await LoadOrganizations();
            ToastService.ShowSuccess("Organiza√ß√£o exclu√≠da", $"A organiza√ß√£o '{orgName}' foi removida com sucesso.");
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao excluir organiza√ß√£o", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }

    private async Task OpenDetailsModal(Organization org)
    {
        selectedOrganization = org;
        isDetailsModalOpen = true;
        orgWorkspaces = null;
        orgCollaborators = null;

        // Carregar dados em paralelo para melhor performance
        await Task.WhenAll(
            LoadOrganizationWorkspaces(org.Id),
            LoadOrganizationCollaborators(org.Id)
        );
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        selectedOrganization = null;
        orgWorkspaces = null;
        orgCollaborators = null;
    }

    private async Task LoadOrganizationWorkspaces(Guid organizationId)
    {
        try
        {
            orgWorkspaces = await Api.GetWorkspacesAsync(organizationId, null, 1, 10);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar workspaces: {ex.Message}");
            ToastService.ShowError("Erro", "N√£o foi poss√≠vel carregar os workspaces.");
            orgWorkspaces = new PagedResult<Workspace> { Items = Array.Empty<Workspace>() };
        }
    }

    private async Task LoadOrganizationCollaborators(Guid organizationId)
    {
        try
        {
            orgCollaborators = await Api.GetOrganizationCollaboratorsAsync(organizationId, 1, 10);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar colaboradores: {ex.Message}");
            ToastService.ShowError("Erro", "N√£o foi poss√≠vel carregar os colaboradores.");
            orgCollaborators = new PagedResult<Collaborator> { Items = Array.Empty<Collaborator>() };
        }
    }

    public void Dispose()
    {
        deleteConfirmTimer?.Dispose();
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
    }
}
