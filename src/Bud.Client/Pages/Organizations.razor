@page "/organizations"
@implements IDisposable
@inject ApiClient Api
@inject AuthState AuthState
@inject ToastService ToastService
@inject NavigationManager Navigation
@inject OrganizationContext OrgContext

@if (AuthState.Session?.IsGlobalAdmin != true)
{
    <div class="card">
        <p class="muted">Voc√™ n√£o tem permiss√£o para acessar esta p√°gina. Apenas administradores podem gerenciar organiza√ß√µes.</p>
    </div>
}
else
{
    <ManagementPageHeader
        Kicker="Gest√£o"
        Title="Organiza√ß√µes"
        Subtitle="Crie e liste organiza√ß√µes cadastradas."
        PrimaryActionText="Nova organiza√ß√£o"
        ShowPrimaryAction="@(AuthState.Session?.IsGlobalAdmin == true)"
        OnPrimaryAction="OpenCreateModal" />

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadOrganizations">Atualizar</button>
        </div>
    </div>

    <PagedTableSection
        IsLoading="@(organizations is null)"
        IsEmpty="@(organizations is not null && organizations.Items.Count == 0)"
        Total="@(organizations?.Total ?? 0)"
        EmptyText="Nenhuma organiza√ß√£o encontrada.">
        <table class="table">
            <thead>
                <tr>
                    <th>Dom√≠nio</th>
                    <th>Propriet√°rio</th>
                    <th>ID</th>
                    <th style="width: 120px; text-align: center;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var org in organizations!.Items)
                {
                    var isDeleting = deletingOrganizationId == org.Id;
                    var isProtected = !string.IsNullOrEmpty(org.Name) &&
                                    org.Name.Equals(GlobalAdminOrgName, StringComparison.OrdinalIgnoreCase);
                    <tr style="cursor: pointer;" @onclick="() => OpenDetailsModal(org)">
                        <td>
                            @org.Name
                            @if (isProtected)
                            {
                                <span class="badge protected" title="Organiza√ß√£o protegida">üîí</span>
                            }
                        </td>
                        <td>@(org.Owner?.FullName ?? "‚Äî")</td>
                        <td class="mono">@org.Id</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditDisabled="@isProtected"
                                EditTitle="@(isProtected ? "Esta organiza√ß√£o est√° protegida" : "Editar organiza√ß√£o")"
                                OnEdit="@(async () => await OpenEditModal(org))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteDisabled="@isProtected"
                                DeleteTitle="@(isProtected ? "Esta organiza√ß√£o est√° protegida" : "Excluir organiza√ß√£o")"
                                OnDelete="@(() => HandleDeleteClick(org.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="@(modalMode == "create" ? "Criar organiza√ß√£o" : "Editar organiza√ß√£o")" OnClose="CloseModal">
        @if (AuthState.Session?.IsGlobalAdmin == true)
        {
            @if (modalMode == "create")
            {
                <EditForm Model="@newOrganization" OnValidSubmit="CreateOrganization">
                    <DataAnnotationsValidator />
                    <div class="form-row">
                        <label>Dom√≠nio</label>
                        <InputText class="input" @bind-Value="newOrganization.Name" placeholder="empresa.com.br" />
                    </div>
                    <div class="form-row">
                        <label>L√≠der (Propriet√°rio) *</label>
                        <InputSelect class="input" @bind-Value="newOrganization.OwnerId">
                            <option value="@Guid.Empty">-- Selecione um l√≠der --</option>
                            @foreach (var leader in leaders)
                            {
                                <option value="@leader.Id">
                                    @leader.FullName - @leader.TeamName (@leader.OrganizationName)
                                </option>
                            }
                        </InputSelect>
                        <small class="form-hint">Apenas colaboradores com fun√ß√£o de L√≠der podem ser propriet√°rios.</small>
                    </div>
                    <div class="form-actions">
                        <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                        <button class="button primary" type="submit" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Salvar</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <EditForm Model="@editOrganization" OnValidSubmit="UpdateOrganization">
                    <DataAnnotationsValidator />
                    <div class="form-row">
                        <label>Dom√≠nio</label>
                        <InputText class="input" @bind-Value="editOrganization.Name" placeholder="empresa.com.br" disabled="@IsProtectedOrganization()" />
                        @if (IsProtectedOrganization())
                        {
                            <small class="form-hint" style="color: var(--color-error);">Esta organiza√ß√£o est√° protegida e n√£o pode ser alterada.</small>
                        }
                    </div>
                    <div class="form-row">
                        <label>L√≠der (Propriet√°rio) *</label>
                        <InputSelect class="input" @bind-Value="editOrganization.OwnerId" disabled="@IsProtectedOrganization()">
                            <option value="@Guid.Empty">-- Selecione um l√≠der --</option>
                            @foreach (var leader in leaders)
                            {
                                <option value="@leader.Id">
                                    @leader.FullName - @leader.TeamName (@leader.OrganizationName)
                                </option>
                            }
                        </InputSelect>
                        <small class="form-hint">O propriet√°rio pode ser alterado para qualquer colaborador com fun√ß√£o de L√≠der.</small>
                    </div>
                    <div class="form-actions">
                        <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                        <button class="button primary" type="submit" disabled="@(isSubmitting || IsProtectedOrganization())">
                            @if (isSubmitting)
                            {
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Salvar altera√ß√µes</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
        }
        else
        {
            <p class="muted">Apenas administradores podem gerenciar organiza√ß√µes.</p>
        }
    </Modal>
}

@if (isDetailsModalOpen && selectedOrganization != null)
{
    <Modal Title="@($"Detalhes: {selectedOrganization.Name}")"
           Size="lg"
           OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Workspaces</h3>
                @if (orgWorkspaces == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (orgWorkspaces.Items.Count == 0)
                {
                    <p class="muted">Nenhum workspace encontrado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var ws in orgWorkspaces.Items.Take(10))
                        {
                            <li class="detail-list-item">
                                <span class="detail-name">@ws.Name</span>
                            </li>
                        }
                    </ul>
                    @if (orgWorkspaces.Total > 10)
                    {
                        <p class="detail-more">e mais @(orgWorkspaces.Total - 10)...</p>
                    }
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Colaboradores</h3>
                @if (orgCollaborators == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (orgCollaborators.Items.Count == 0)
                {
                    <p class="muted">Nenhum colaborador encontrado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var collab in orgCollaborators.Items.Take(10))
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@collab.FullName</span>
                                    <span class="badge @(collab.Role == CollaboratorRole.Leader ? "leader" : "contributor")">
                                        @(collab.Role == CollaboratorRole.Leader ? "L√≠der" : "Contribuidor")
                                    </span>
                                </div>
                                <span class="detail-email">@collab.Email</span>
                                @if (collab.Team != null)
                                {
                                    <span class="detail-team">Time: @collab.Team.Name</span>
                                }
                            </li>
                        }
                    </ul>
                    @if (orgCollaborators.Total > 10)
                    {
                        <p class="detail-more">e mais @(orgCollaborators.Total - 10)...</p>
                    }
                }
            </div>
        </ChildContent>
    </Modal>
}
}

@code {
    private CreateOrganizationRequest newOrganization = new();
    private PagedResult<Organization>? organizations;
    private List<LeaderCollaboratorResponse> leaders = new();
    private string? search;
    private bool isSubmitting = false;
    private bool isModalOpen = false;
    private string modalMode = "create"; // "create" ou "edit"
    private Guid? editingOrganizationId = null;
    private UpdateOrganizationRequest editOrganization = new();
    private Guid? deletingOrganizationId = null;
    private System.Threading.Timer? deleteConfirmTimer;
    private const string GlobalAdminOrgName = "getbud.co"; // Organiza√ß√£o do admin global

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Organization? selectedOrganization = null;
    private PagedResult<Workspace>? orgWorkspaces = null;
    private PagedResult<Collaborator>? orgCollaborators = null;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.EnsureInitializedAsync();
        await LoadOrganizations();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadOrganizations();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar organiza√ß√µes por troca de contexto: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar organiza√ß√µes", "N√£o foi poss√≠vel atualizar a lista de organiza√ß√µes.");
        }
    }

    private async Task LoadLeaders(Guid? organizationId = null)
    {
        try
        {
            leaders = await Api.GetLeadersAsync(organizationId) ?? new List<LeaderCollaboratorResponse>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar l√≠deres: {ex.Message}");
            leaders = new List<LeaderCollaboratorResponse>();
        }
    }

    private async Task LoadOrganizations()
    {
        organizations = await Api.GetOrganizationsAsync(search, 1, 20) ?? new PagedResult<Organization>();
    }

    private async Task OpenCreateModal()
    {
        modalMode = "create";
        editingOrganizationId = null;
        newOrganization = new CreateOrganizationRequest();
        // Load leaders based on selected tenant context
        // If a specific org is selected, show only its leaders
        // If "TODOS" is selected (null), show all leaders
        await LoadLeaders(OrgContext.SelectedOrganizationId);
        isModalOpen = true;
    }

    private async Task OpenEditModal(Organization org)
    {
        modalMode = "edit";
        editingOrganizationId = org.Id;
        editOrganization = new UpdateOrganizationRequest
        {
            Name = org.Name,
            OwnerId = org.OwnerId ?? Guid.Empty
        };
        // Load leaders based on selected tenant context
        // If a specific org is selected, show only its leaders
        // If "TODOS" is selected (null), show all leaders
        await LoadLeaders(OrgContext.SelectedOrganizationId);
        isModalOpen = true;
    }

    private bool IsProtectedOrganization()
    {
        if (editingOrganizationId == null) return false;

        var org = organizations?.Items.FirstOrDefault(o => o.Id == editingOrganizationId);
        return org != null &&
               !string.IsNullOrEmpty(org.Name) &&
               org.Name.Equals(GlobalAdminOrgName, StringComparison.OrdinalIgnoreCase);
    }

    private void CloseModal()
    {
        isModalOpen = false;
        modalMode = "create";
        editingOrganizationId = null;
        editOrganization = new UpdateOrganizationRequest();
    }

    private async Task CreateOrganization()
    {
        // Frontend validation
        if (string.IsNullOrWhiteSpace(newOrganization.Name))
        {
            ToastService.ShowError("Erro ao criar organiza√ß√£o", "Por favor, informe o dom√≠nio da organiza√ß√£o.");
            return;
        }

        if (newOrganization.OwnerId == Guid.Empty)
        {
            ToastService.ShowError("Erro ao criar organiza√ß√£o", "Por favor, selecione um l√≠der para a organiza√ß√£o.");
            return;
        }

        isSubmitting = true;

        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.CreateOrganizationAsync(newOrganization);
                    newOrganization = new CreateOrganizationRequest();
                    await LoadOrganizations();
                    await RefreshAvailableOrganizations();

                    ToastService.ShowSuccess("Organiza√ß√£o criada com sucesso!", "A organiza√ß√£o foi criada e est√° dispon√≠vel.");
                    CloseModal();
                },
                ToastService,
                "Erro ao criar organiza√ß√£o",
                "N√£o foi poss√≠vel criar a organiza√ß√£o. Verifique os dados e tente novamente.",
                operationContext: "cria√ß√£o de organiza√ß√£o",
                unexpectedErrorMessage: "N√£o foi poss√≠vel criar a organiza√ß√£o. Tente novamente.");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task UpdateOrganization()
    {
        if (editingOrganizationId == null) return;

        if (string.IsNullOrWhiteSpace(editOrganization.Name))
        {
            ToastService.ShowError("Erro ao atualizar organiza√ß√£o", "Por favor, informe o dom√≠nio da organiza√ß√£o.");
            return;
        }

        if (editOrganization.OwnerId == Guid.Empty)
        {
            ToastService.ShowError("Erro ao atualizar organiza√ß√£o", "Por favor, selecione um l√≠der para a organiza√ß√£o.");
            return;
        }

        isSubmitting = true;

        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.UpdateOrganizationAsync(editingOrganizationId.Value, editOrganization);
                    await LoadOrganizations();
                    await RefreshAvailableOrganizations();
                    ToastService.ShowSuccess("Organiza√ß√£o atualizada com sucesso!", "As altera√ß√µes foram salvas.");
                    CloseModal();
                },
                ToastService,
                "Erro ao atualizar organiza√ß√£o",
                "N√£o foi poss√≠vel atualizar a organiza√ß√£o. Verifique os dados e tente novamente.",
                operationContext: "atualiza√ß√£o de organiza√ß√£o",
                unexpectedErrorMessage: "N√£o foi poss√≠vel atualizar a organiza√ß√£o. Tente novamente.");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleDeleteClick(Guid organizationId)
    {
        if (deletingOrganizationId == organizationId)
        {
            // Segunda clique - confirma exclus√£o
            _ = DeleteOrganization(organizationId);
        }
        else
        {
            // Primeiro clique - mostra confirma√ß√£o
            deletingOrganizationId = organizationId;

            // Reseta ap√≥s 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    deletingOrganizationId = null;
                    StateHasChanged();
                });
            }, null, 3000, Timeout.Infinite);
        }
    }

    private async Task DeleteOrganization(Guid organizationId)
    {
        deletingOrganizationId = null;
        deleteConfirmTimer?.Dispose();

        var orgName = organizations?.Items.FirstOrDefault(o => o.Id == organizationId)?.Name ?? "organiza√ß√£o";

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.DeleteOrganizationAsync(organizationId);
                await LoadOrganizations();
                await RefreshAvailableOrganizations();
                ToastService.ShowSuccess("Organiza√ß√£o exclu√≠da", $"A organiza√ß√£o '{orgName}' foi removida com sucesso.");
            },
            ToastService,
            "Erro ao excluir organiza√ß√£o",
            "N√£o foi poss√≠vel excluir a organiza√ß√£o. Tente novamente.",
            operationContext: "exclus√£o de organiza√ß√£o",
            unexpectedErrorMessage: "N√£o foi poss√≠vel excluir a organiza√ß√£o. Tente novamente.");
    }

    private async Task OpenDetailsModal(Organization org)
    {
        selectedOrganization = org;
        isDetailsModalOpen = true;
        orgWorkspaces = null;
        orgCollaborators = null;

        // Carregar dados em paralelo para melhor performance
        await Task.WhenAll(
            LoadOrganizationWorkspaces(org.Id),
            LoadOrganizationCollaborators(org.Id)
        );
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        selectedOrganization = null;
        orgWorkspaces = null;
        orgCollaborators = null;
    }

    private async Task LoadOrganizationWorkspaces(Guid organizationId)
    {
        try
        {
            orgWorkspaces = await Api.GetWorkspacesAsync(organizationId, null, 1, 10);
        }
        catch (Exception ex)
        {
            UiErrorHandler.HandleUnexpectedError(
                ToastService,
                "Erro",
                "N√£o foi poss√≠vel carregar os workspaces.",
                ex,
                "carregamento de workspaces da organiza√ß√£o");
            orgWorkspaces = new PagedResult<Workspace> { Items = Array.Empty<Workspace>() };
        }
    }

    private async Task LoadOrganizationCollaborators(Guid organizationId)
    {
        try
        {
            orgCollaborators = await Api.GetOrganizationCollaboratorsAsync(organizationId, 1, 10);
        }
        catch (Exception ex)
        {
            UiErrorHandler.HandleUnexpectedError(
                ToastService,
                "Erro",
                "N√£o foi poss√≠vel carregar os colaboradores.",
                ex,
                "carregamento de colaboradores da organiza√ß√£o");
            orgCollaborators = new PagedResult<Collaborator> { Items = Array.Empty<Collaborator>() };
        }
    }

    private async Task RefreshAvailableOrganizations()
    {
        try
        {
            var organizations = await Api.GetMyOrganizationsAsync();
            if (organizations != null)
            {
                OrgContext.UpdateAvailableOrganizations(organizations);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar lista de organiza√ß√µes: {ex.Message}");
        }
    }

    public void Dispose()
    {
        deleteConfirmTimer?.Dispose();
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
    }
}
