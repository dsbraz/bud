@page "/organizations"
@implements IDisposable
@inject ApiClient Api
@inject AuthState AuthState
@inject ToastService ToastService
@inject NavigationManager Navigation
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps

@if (AuthState.SessionResponse?.IsGlobalAdmin != true)
{
    <div class="card">
        <p class="muted">Voc√™ n√£o tem permiss√£o para acessar esta p√°gina. Apenas administradores podem gerenciar organiza√ß√µes.</p>
    </div>
}
else
{
    <ManagementPageHeader
        Kicker="Gest√£o"
        Title="Organiza√ß√µes"
        Subtitle="Crie e liste organiza√ß√µes cadastradas."
        PrimaryActionText="Nova organiza√ß√£o"
        ShowPrimaryAction="@(AuthState.SessionResponse?.IsGlobalAdmin == true)"
        OnPrimaryAction="OpenCreateModal" />

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadOrganizations">Atualizar</button>
        </div>
    </div>

    <PagedTableSection
        IsLoading="@(organizations is null)"
        IsEmpty="@(organizations is not null && organizations.Items.Count == 0)"
        Total="@(organizations?.Total ?? 0)"
        EmptyText="Nenhuma organiza√ß√£o encontrada.">
        <div class="table-scroll-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Dom√≠nio</th>
                    <th>Propriet√°rio</th>
                    <th>ID</th>
                    <th class="th-actions">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var org in organizations!.Items)
                {
                    var isDeleting = deletingOrganizationId == org.Id;
                    var isProtected = !string.IsNullOrEmpty(org.Name) &&
                                    org.Name.Equals(GlobalAdminOrgName, StringComparison.OrdinalIgnoreCase);
                    <tr style="cursor: pointer;" @onclick="() => OpenDetailsModal(org)">
                        <td>
                            @org.Name
                            @if (isProtected)
                            {
                                <span class="badge protected" title="Organiza√ß√£o protegida">üîí</span>
                            }
                        </td>
                        <td>@(org.Owner?.FullName ?? "‚Äî")</td>
                        <td class="mono">@org.Id</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditDisabled="@isProtected"
                                EditTitle="@(isProtected ? "Esta organiza√ß√£o est√° protegida" : "Editar organiza√ß√£o")"
                                OnEdit="@(async () => await OpenEditModal(org))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteDisabled="@isProtected"
                                DeleteTitle="@(isProtected ? "Esta organiza√ß√£o est√° protegida" : "Excluir organiza√ß√£o")"
                                OnDelete="@(() => HandleDeleteClick(org.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        </div>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="@(modalMode == "create" ? "Criar organiza√ß√£o" : "Editar organiza√ß√£o")" OnClose="CloseModal">
        @if (AuthState.SessionResponse?.IsGlobalAdmin == true)
        {
            @if (modalMode == "create")
            {
                <EditForm Model="@newOrganization" OnValidSubmit="CreateOrganization">
                    <DataAnnotationsValidator />
                    <div class="form-row">
                        <label>Dom√≠nio</label>
                        <InputText class="input" @bind-Value="newOrganization.Name" placeholder="empresa.com.br" />
                    </div>
                    <div class="form-row">
                        <label>L√≠der (Propriet√°rio) *</label>
                        <InputSelect class="input" @bind-Value="newOrganization.OwnerId">
                            <option value="@Guid.Empty">-- Selecione um l√≠der --</option>
                            @foreach (var leader in leaders)
                            {
                                <option value="@leader.Id">
                                    @leader.FullName - @leader.TeamName (@leader.OrganizationName)
                                </option>
                            }
                        </InputSelect>
                        <small class="form-hint">Apenas colaboradores com fun√ß√£o de L√≠der podem ser propriet√°rios.</small>
                    </div>
                    <div class="form-actions">
                        <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                        <button class="button primary" type="submit" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Salvar</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <EditForm Model="@editOrganization" OnValidSubmit="UpdateOrganization">
                    <DataAnnotationsValidator />
                    <div class="form-row">
                        <label>Dom√≠nio</label>
                        <InputText class="input" @bind-Value="editOrganization.Name" placeholder="empresa.com.br" disabled="@IsProtectedOrganization()" />
                        @if (IsProtectedOrganization())
                        {
                            <small class="form-hint" style="color: var(--color-error);">Esta organiza√ß√£o est√° protegida e n√£o pode ser alterada.</small>
                        }
                    </div>
                    <div class="form-row">
                        <label>L√≠der (Propriet√°rio) *</label>
                        <InputSelect class="input" @bind-Value="editOrganization.OwnerId" disabled="@IsProtectedOrganization()">
                            <option value="@Guid.Empty">-- Selecione um l√≠der --</option>
                            @foreach (var leader in leaders)
                            {
                                <option value="@leader.Id">
                                    @leader.FullName - @leader.TeamName (@leader.OrganizationName)
                                </option>
                            }
                        </InputSelect>
                        <small class="form-hint">O propriet√°rio pode ser alterado para qualquer colaborador com fun√ß√£o de L√≠der.</small>
                    </div>
                    <div class="form-actions">
                        <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                        <button class="button primary" type="submit" disabled="@(isSubmitting || IsProtectedOrganization())">
                            @if (isSubmitting)
                            {
                                <span>Salvando...</span>
                            }
                            else
                            {
                                <span>Salvar altera√ß√µes</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
        }
        else
        {
            <p class="muted">Apenas administradores podem gerenciar organiza√ß√µes.</p>
        }
    </Modal>
}

@if (isDetailsModalOpen && selectedOrganization != null)
{
    <Modal Title="@($"Detalhes: {selectedOrganization.Name}")"
           Size="lg"
           OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Espa√ßos de trabalho</h3>
                @if (orgWorkspaces == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (orgWorkspaces.Items.Count == 0)
                {
                    <p class="muted">Nenhum workspace encontrado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var ws in orgWorkspaces.Items.Take(10))
                        {
                            <li class="detail-list-item">
                                <span class="detail-name">@ws.Name</span>
                            </li>
                        }
                    </ul>
                    @if (orgWorkspaces.Total > 10)
                    {
                        <p class="detail-more">e mais @(orgWorkspaces.Total - 10)...</p>
                    }
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Colaboradores</h3>
                @if (orgCollaborators == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (orgCollaborators.Items.Count == 0)
                {
                    <p class="muted">Nenhum colaborador encontrado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var collab in orgCollaborators.Items.Take(10))
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@collab.FullName</span>
                                    <span class="badge @(collab.Role == CollaboratorRole.Leader ? "leader" : "contributor")">
                                        @(collab.Role == CollaboratorRole.Leader ? "L√≠der" : "Contribuidor")
                                    </span>
                                </div>
                                <span class="detail-email">@collab.Email</span>
                                @if (collab.Team != null)
                                {
                                    <span class="detail-team">Time: @collab.Team.Name</span>
                                }
                            </li>
                        }
                    </ul>
                    @if (orgCollaborators.Total > 10)
                    {
                        <p class="detail-more">e mais @(orgCollaborators.Total - 10)...</p>
                    }
                }
            </div>
        </ChildContent>
    </Modal>
}
}

