@page "/missions"
@inject ApiClient Api
@inject OrganizationContext OrgContext
@inject ToastService ToastService
@implements IDisposable

<MissionsMenu />

<div class="missions-page-header">
    <h1 class="missions-page-title">Minhas miss√µes</h1>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Criar miss√£o
    </button>
</div>

@* Barra de Filtros Compacta *@
<div class="missions-filter-bar">
    <div class="missions-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M28 6H4L14 17.6V26L18 28V17.6L28 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Filtrar</span>
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(filterStartDate.HasValue || filterEndDate.HasValue ? "active" : "")" @onclick="ToggleDatePicker">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 4H6C4.89543 4 4 4.89543 4 6V26C4 27.1046 4.89543 28 6 28H26C27.1046 28 28 27.1046 28 26V6C28 4.89543 27.1046 4 26 4Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M22 2V6M10 2V6M4 12H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>@GetDateRangeLabel()</span>
            </button>
            @if (showDatePicker)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Data inicial</label>
                        <input type="date" class="input" value="@filterStartDate?.ToString("yyyy-MM-dd")" @onchange="OnStartDateChanged" />
                    </div>
                    <div class="filter-dropdown-row">
                        <label>Data final</label>
                        <input type="date" class="input" value="@filterEndDate?.ToString("yyyy-MM-dd")" @onchange="OnEndDateChanged" />
                    </div>
                    <button class="button small" @onclick="ApplyDateFilter">Aplicar</button>
                </div>
            }
        </div>
        <button class="filter-chip @(filterActiveOnly ? "active" : "")" @onclick="ToggleActiveFilter">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M16 28C22.6274 28 28 22.6274 28 16C28 9.37258 22.6274 4 16 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 10V16L20 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 16H8M6 12L8 16L6 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>@GetStatusFilterLabel()</span>
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip-clear" @onclick="ClearFilters">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 16L22 12M22 12L18 8M22 12L26 8M22 12L18 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 8L10 28H14L12 18L6 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Limpar filtro</span>
            </button>
        }
    </div>
    <button class="filter-chip" @onclick="ToggleViewMode">
        @if (viewMode == "list")
        {
            @* √çcone de lista (linhas horizontais) *@
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M4 8H28M4 16H28M4 24H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Lista</span>
        }
        else
        {
            @* √çcone de grade (4 quadrados) *@
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <rect x="4" y="6" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="4" y="18" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="20" y="6" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="20" y="18" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>Grade</span>
        }
    </button>
</div>

@* Painel de Filtros Expandido *@
@if (showFilterPanel)
{
    <div class="missions-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Escopo</label>
                <select class="input" value="@filterScopeTypeValue" @onchange="OnFilterScopeTypeChanged">
                    <option value="">Todos</option>
                    @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                    {
                        <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Refer√™ncia</label>
                <select class="input" @bind="filterScopeId" @bind:after="LoadMissions">
                    <option value="">Todas</option>
                    @foreach (var option in GetScopeOptions(filterScopeTypeValue))
                    {
                        <option value="@option.Id">@option.Name</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar miss√µes..." />
            </div>
        </div>
    </div>
}

@* Cards de Resumo *@
<div class="missions-summary">
    <div class="summary-card">
        <div class="summary-card-value">@GetOverallProgressDisplay()%</div>
        <div class="summary-card-label">Esperado @GetExpectedProgressDisplay()%</div>
        <div class="summary-card-progress">
            <div class="summary-progress-bar">
                <div class="summary-progress-fill" style="width: @GetOverallProgressDisplay()%"></div>
            </div>
        </div>
    </div>
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetActiveMissionsCount()</div>
        <div class="summary-card-label">Miss√µes ativas</div>
    </div>
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetOutdatedMetricsCount()</div>
        <div class="summary-card-label">Indicadores desatualizados</div>
    </div>
</div>

@* Lista de Miss√µes em Cards *@
@if (missions is null)
{
    <div class="missions-loading">
        <p class="muted">Carregando...</p>
    </div>
}
else if (missions.Items.Count == 0)
{
    <div class="missions-empty">
        <div class="missions-empty-icon">üìã</div>
        <p class="muted">Nenhuma miss√£o encontrada.</p>
    </div>
}
else
{
    <div class="@(viewMode == "list" ? "missions-list" : "missions-grid")">
        @foreach (var mission in missions.Items)
        {
            var progress = missionProgress.GetValueOrDefault(mission.Id);
            var isExpanded = expandedMissions.Contains(mission.Id);
            var isDeleting = deletingMissionId == mission.Id;
            var progressPercent = (int)(progress?.OverallProgress ?? 0);
            var circumference = 2 * Math.PI * 19;
            var dashOffset = circumference - (circumference * progressPercent / 100);

            <div class="mission-card @(isExpanded ? "expanded" : "") @(mission.Status == MissionStatus.Planned ? "draft" : "")">
                <div class="mission-card-header" @onclick="async () => await ToggleExpand(mission.Id)">
                    @* C√≠rculo de Progresso *@
                    <div class="mission-progress-circle">
                        <svg width="44" height="44" viewBox="0 0 44 44">
                            <circle class="progress-bg" cx="22" cy="22" r="19" />
                            @if (mission.Status != MissionStatus.Planned)
                            {
                                <circle class="progress-value @GetProgressStatusClass(progress)"
                                        cx="22" cy="22" r="19"
                                        stroke-dasharray="@circumference.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                        stroke-dashoffset="@dashOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)" />
                            }
                        </svg>
                        <div class="mission-progress-text">
                            <span class="mission-progress-number">@(mission.Status == MissionStatus.Planned ? "00" : progressPercent.ToString())</span>
                            <span class="mission-progress-percent">%</span>
                        </div>
                    </div>

                    @* T√≠tulo da Miss√£o *@
                    <div class="mission-card-title-wrapper">
                        @if (mission.Status == MissionStatus.Planned)
                        {
                            <span class="mission-draft-tag">RASCUNHO</span>
                        }
                        <div class="mission-card-title">@mission.Name</div>
                    </div>

                    @* A√ß√µes *@
                    <div class="mission-card-actions" @onclick:stopPropagation="true">
                        <button class="mission-action-btn" @onclick="async () => await OpenEditModal(mission)" title="Editar miss√£o">
                            <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                                <path d="M22 4L28 10L10 28H4V22L22 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="mission-action-btn @(isDeleting ? "danger" : "")"
                                @onclick="() => HandleDeleteClick(mission.Id)"
                                title="@(isDeleting ? "Confirmar exclus√£o" : "Excluir")">
                            @if (isDeleting)
                            {
                                <span style="font-size: 10px;">OK?</span>
                            }
                            else
                            {
                                <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                                    <path d="M4 8H6.66667H28" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10.6667 8V5.33333C10.6667 4.62609 10.9476 3.94781 11.4477 3.44772C11.9478 2.94762 12.6261 2.66667 13.3333 2.66667H18.6667C19.3739 2.66667 20.0522 2.94762 20.5523 3.44772C21.0524 3.94781 21.3333 4.62609 21.3333 5.33333V8M25.3333 8V26.6667C25.3333 27.3739 25.0524 28.0522 24.5523 28.5523C24.0522 29.0524 23.3739 29.3333 22.6667 29.3333H9.33333C8.62609 29.3333 7.94781 29.0524 7.44772 28.5523C6.94762 28.0522 6.66667 27.3739 6.66667 26.6667V8H25.3333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            }
                        </button>
                        <button class="mission-action-btn" @onclick="async () => await ToggleExpand(mission.Id)" title="@(isExpanded ? "Recolher" : "Expandir")">
                            <svg class="mission-expand-icon @(isExpanded ? "expanded" : "")" width="22" height="22" viewBox="0 0 32 32" fill="none">
                                <path d="M8 12L16 20L24 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>

                @* Conte√∫do Expandido - M√©tricas *@
                @if (isExpanded)
                {
                    <div class="mission-card-content">
                        @{
                            var metrics = missionMetricsCache.GetValueOrDefault(mission.Id);
                        }
                        @if (metrics is null)
                        {
                            <p class="muted">Carregando m√©tricas...</p>
                        }
                        else if (!metrics.Any())
                        {
                            <p class="muted">Nenhuma m√©trica associada a esta miss√£o.</p>
                        }
                        else
                        {
                            @foreach (var metric in metrics)
                            {
                                var metricProgress = GetMetricProgress(metric);
                                var expectedProgress = progress?.ExpectedProgress ?? 0m;
                                var metricStatusClass = GetMetricStatusClass(metricProgress, expectedProgress);
                                var isMetricOutdated = IsMetricOutdated(metric.Id);
                                <div class="metric-row @(isMetricOutdated ? "outdated" : "")">
                                    <button class="metric-checkin-btn" @onclick="() => OpenCheckinModalForMetric(mission, metric)" title="Novo check-in">
                                        <svg width="18" height="18" viewBox="0 0 32 32" fill="none">
                                            <path d="M16 6V26M6 16H26" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    <div class="metric-row-title">
                                        <div class="metric-row-name">@metric.Name</div>
                                    </div>
                                    <div class="metric-row-period">
                                        <div class="metric-period-label">@GetQuarterLabel(mission)</div>
                                        <div class="metric-period-dates">@mission.StartDate.ToString("dd/MM/yyyy") √† @mission.EndDate.ToString("dd/MM/yyyy")</div>
                                    </div>
                                    <div class="metric-row-progress">
                                        <div class="metric-progress-target">@GetTargetLabel(metric)</div>
                                        <div class="metric-progress-bar">
                                            <div class="metric-progress-fill @metricStatusClass" style="width: @(metricProgress)%"></div>
                                        </div>
                                        <div class="metric-progress-footer">
                                            <span class="metric-progress-status">@GetMetricStatusLabel(metricProgress, expectedProgress, metric)</span>
                                            <span class="metric-progress-value">@(metricProgress)%</span>
                                        </div>
                                    </div>
                                    <div class="metric-row-avatar" title="√öltimo check-in">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                            <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                                        </svg>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
    </div>
    <p class="muted" style="margin-top: var(--spacing-4);">Total: @missions.Total</p>
}

@if (isModalOpen)
{
    <Modal Title="Criar miss√£o" Breadcrumb="@GetSelectedOrganizationName()" Size="lg" OnClose="CloseModal">
        <ChildContent>
            <EditForm Model="@newMission" OnValidSubmit="CreateMission">
                <DataAnnotationsValidator />

                @* Header Section - Mission Title & Description *@
                <div class="mission-header">
                    <InputText class="mission-title-input" @bind-Value="newMission.Name" placeholder="Nome da miss√£o" />
                    <input type="text" class="mission-subtitle-input" @bind="missionDescription" placeholder="Adicionar breve descri√ß√£o" />
                </div>

                @* Metadata Chips *@
                <div class="chips-container">
                    <div class="chip" @onclick="() => showResponsibleSelector = !showResponsibleSelector">
                        <span class="chip-icon">üë§</span>
                        <span>@GetResponsibleLabel()</span>
                    </div>
                    <div class="chip" @onclick="() => showPeriodSelector = !showPeriodSelector">
                        <span class="chip-icon">üìÖ</span>
                        <span>@GetPeriodLabel()</span>
                    </div>
                    <div class="chip chip-more">
                        <span>‚ãØ</span>
                    </div>
                </div>

                @* Responsible Selector (hidden by default) *@
                @if (showResponsibleSelector)
                {
                    <div class="form-row">
                        <label>Escopo</label>
                        <select class="input" value="@createScopeTypeValue" @onchange="OnCreateScopeTypeChanged">
                            <option value="">Selecione</option>
                            @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                            {
                                <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                            }
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Refer√™ncia</label>
                        <select class="input" @bind="createScopeId">
                            <option value="">Selecione</option>
                            @foreach (var option in GetScopeOptions(createScopeTypeValue))
                            {
                                <option value="@option.Id">@option.Name</option>
                            }
                        </select>
                    </div>
                }

                @* Period Selector (hidden by default) *@
                @if (showPeriodSelector)
                {
                    <div class="form-row">
                        <label>Data de in√≠cio</label>
                        <InputDate class="input" @bind-Value="newMission.StartDate" />
                    </div>
                    <div class="form-row">
                        <label>Data de fim</label>
                        <InputDate class="input" @bind-Value="newMission.EndDate" />
                    </div>
                }

                @* Metrics Section *@
                <div class="mission-metrics-section">
                    <button type="button" class="metrics-add-button" @onclick="AddMetricOrOpenForm">
                        <span>Adicionar item</span>
                        @if (showMetricForm)
                        {
                            <svg class="metrics-add-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        }
                        else
                        {
                            <span class="metrics-add-icon">+</span>
                        }
                    </button>

                    @if (showMetricForm)
                    {
                        <div class="metrics-form-container" style="margin-top: var(--spacing-4);">
                            <div class="metrics-form-header">
                                <div class="form-row">
                                    <label>Nome da m√©trica</label>
                                    <input type="text" class="input" @bind="newMetricName" placeholder="Ex: Taxa de convers√£o, NPS, etc." />
                                </div>
                            </div>

                            <div class="metrics-form-selectors">
                                <div class="metrics-selector-btn">
                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                    </svg>
                                    <select @bind="newMetricType">
                                        <option value="">Tipo de m√©trica</option>
                                        <option value="Quantitative">Quantitativa</option>
                                        <option value="Qualitative">Qualitativa</option>
                                    </select>
                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                    </svg>
                                </div>

                                @if (newMetricType == "Quantitative")
                                {
                                    <div class="metrics-selector-btn">
                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                        </svg>
                                        <select @bind="newMetricQuantitativeType">
                                            <option value="">Modo de mensura√ß√£o</option>
                                            <option value="KeepAbove">‚Üë Manter acima</option>
                                            <option value="KeepBelow">‚Üì Manter abaixo</option>
                                            <option value="KeepBetween">‚Üï Manter entre</option>
                                            <option value="Achieve">‚Üí Atingir</option>
                                            <option value="Reduce">‚Üò Reduzir</option>
                                        </select>
                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                        </svg>
                                    </div>
                                }
                            </div>

                            @if (newMetricType == "Qualitative")
                            {
                                <div class="form-row">
                                    <label>Descri√ß√£o do objetivo</label>
                                    <input type="text" class="input" @bind="newMetricTargetText" placeholder="Descreva o objetivo qualitativo desta m√©trica" />
                                </div>
                            }

                            @if (newMetricType == "Quantitative" && !string.IsNullOrEmpty(newMetricQuantitativeType))
                            {
                                <div class="metrics-form-inputs">
                                    <div class="metrics-input-field">
                                        <select @bind="newMetricUnit">
                                            <option value="">Unidade de medida</option>
                                            <option value="Integer">Inteiro</option>
                                            <option value="Decimal">Decimal</option>
                                            <option value="Percentage">Percentual</option>
                                            <option value="Hours">Horas</option>
                                            <option value="Points">Pontos</option>
                                        </select>
                                    </div>

                                    @if (newMetricQuantitativeType == "KeepAbove" || newMetricQuantitativeType == "KeepBetween")
                                    {
                                        <div class="metrics-input-field">
                                            <input type="number" @bind="newMetricMinValue" placeholder="Valor m√≠nimo" />
                                        </div>
                                    }

                                    @if (newMetricQuantitativeType == "KeepBelow" || newMetricQuantitativeType == "KeepBetween" || newMetricQuantitativeType == "Achieve" || newMetricQuantitativeType == "Reduce")
                                    {
                                        <div class="metrics-input-field">
                                            <input type="number" @bind="newMetricMaxValue" placeholder="@GetMaxValuePlaceholder(newMetricQuantitativeType)" />
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @if (tempMetrics.Any())
                    {
                        <div class="metrics-list">
                            @foreach (var metric in tempMetrics)
                            {
                                <div class="metric-item">
                                    <div class="metric-info">
                                        <div class="metric-name">@metric.Name</div>
                                        <div class="metric-details">@metric.Details</div>
                                    </div>
                                    <button type="button" class="metric-remove" @onclick="() => RemoveMetric(metric)">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </EditForm>
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    <button class="button secondary" type="button" @onclick="SaveDraft">
                        <span class="chip-icon">üíæ</span>
                        Salvar rascunho
                    </button>
                    <button class="button primary" type="button" @onclick="CreateMission">Criar miss√£o</button>
                </div>
            </div>
        </Footer>
    </Modal>
}

@if (isEditModalOpen && selectedMission != null)
{
    <Modal Title="Editar miss√£o" Breadcrumb="@GetSelectedOrganizationName()" Size="lg" OnClose="CloseEditModal">
        <ChildContent>
            <EditForm Model="@editMission" OnValidSubmit="UpdateMission">
                <DataAnnotationsValidator />

                <div class="form-row">
                    <label>Nome</label>
                    <InputText class="input" @bind-Value="editMission.Name" />
                </div>
                <div class="form-row">
                    <label>Data de in√≠cio</label>
                    <InputDate class="input" @bind-Value="editMission.StartDate" />
                </div>
                <div class="form-row">
                    <label>Data de fim</label>
                    <InputDate class="input" @bind-Value="editMission.EndDate" />
                </div>
                <div class="form-row">
                    <label>Status</label>
                    <select class="input" @bind="editStatusValue">
                        @foreach (var status in Enum.GetValues<MissionStatus>())
                        {
                            <option value="@status">@GetStatusLabel(status)</option>
                        }
                    </select>
                </div>

                @* M√©tricas da miss√£o *@
                <div class="mission-metrics-section">
                    <div class="mission-metrics-section-header">
                        <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18 9l-5 5-4-4-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h3>M√©tricas da miss√£o</h3>
                    </div>

                    @if (!editMissionMetrics.Any())
                    {
                        <p class="muted">Nenhuma m√©trica associada a esta miss√£o.</p>
                    }
                    else
                    {
                        <div class="metrics-list">
                            @foreach (var metric in editMissionMetrics)
                            {
                                @if (editingMetricId == metric.Id)
                                {
                                    @* Formul√°rio inline para edi√ß√£o da m√©trica *@
                                    <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                        <div class="metrics-form-container">
                                            <div class="form-row">
                                                <label>Nome da m√©trica</label>
                                                <input type="text" class="input" @bind="editMetric.Name" />
                                            </div>

                                            <div class="metrics-form-selectors">
                                                <div class="metrics-selector-btn">
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                                    </svg>
                                                    <select value="@editMetricTypeValue" @onchange="OnEditMetricTypeChanged">
                                                        <option value="">Tipo de m√©trica</option>
                                                        @foreach (var mt in Enum.GetValues<MetricType>())
                                                        {
                                                            <option value="@mt">@GetMetricTypeLabel(mt)</option>
                                                        }
                                                    </select>
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                    </svg>
                                                </div>

                                                @if (editMetricTypeValue == nameof(MetricType.Quantitative))
                                                {
                                                    <div class="metrics-selector-btn">
                                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                                        </svg>
                                                        <select @bind="editMetricQuantitativeTypeValue">
                                                            <option value="">Modo de mensura√ß√£o</option>
                                                            @foreach (var qType in Enum.GetValues<QuantitativeMetricType>())
                                                            {
                                                                <option value="@qType">@GetQuantitativeTypeIcon(qType) @GetQuantitativeTypeLabel(qType)</option>
                                                            }
                                                        </select>
                                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                        </svg>
                                                    </div>
                                                }
                                            </div>

                                            @if (editMetricTypeValue == nameof(MetricType.Qualitative))
                                            {
                                                <div class="form-row">
                                                    <label>Descri√ß√£o do objetivo</label>
                                                    <input type="text" class="input" @bind="editMetric.TargetText" />
                                                </div>
                                            }

                                            @if (editMetricTypeValue == nameof(MetricType.Quantitative) && !string.IsNullOrEmpty(editMetricQuantitativeTypeValue))
                                            {
                                                <div class="metrics-form-inputs">
                                                    <div class="metrics-input-field">
                                                        <select @bind="editMetricUnitValue">
                                                            <option value="">Unidade de medida</option>
                                                            @foreach (var unit in Enum.GetValues<MetricUnit>())
                                                            {
                                                                <option value="@unit">@GetUnitLabel(unit)</option>
                                                            }
                                                        </select>
                                                    </div>

                                                    @if (editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepAbove) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween))
                                                    {
                                                        <div class="metrics-input-field">
                                                            <InputNumber @bind-Value="editMetric.MinValue" placeholder="Valor m√≠nimo" />
                                                        </div>
                                                    }

                                                    @if (editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBelow) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.Achieve) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.Reduce))
                                                    {
                                                        <div class="metrics-input-field">
                                                            <InputNumber @bind-Value="editMetric.MaxValue" placeholder="@GetMaxValuePlaceholder(editMetricQuantitativeTypeValue)" />
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                                <button type="button" class="button tertiary" @onclick="CancelEditingMetric">Cancelar</button>
                                                <button type="button" class="button primary" @onclick="SaveEditingMetric">Salvar m√©trica</button>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    var isDeletingMetric = deletingMetricId == metric.Id;
                                    <div class="metric-item">
                                        <div class="metric-info">
                                            <div class="metric-name">@metric.Name</div>
                                            <div class="metric-details">@GetTargetLabel(metric)</div>
                                        </div>
                                        <div class="table-actions">
                                            <button type="button" class="button-icon" @onclick="() => StartEditingMetric(metric)" title="Editar m√©trica">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                    <path d="M11.334 2.00004C11.5091 1.82494 11.7169 1.68605 11.9457 1.59129C12.1745 1.49653 12.4197 1.44775 12.6673 1.44775C12.9149 1.44775 13.1601 1.49653 13.3889 1.59129C13.6177 1.68605 13.8256 1.82494 14.0007 2.00004C14.1758 2.17513 14.3147 2.383 14.4094 2.61178C14.5042 2.84055 14.553 3.08575 14.553 3.33337C14.553 3.58099 14.5042 3.82619 14.4094 4.05497C14.3147 4.28374 14.1758 4.49161 14.0007 4.66671L5.00065 13.6667L1.33398 14.6667L2.33398 11L11.334 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                            <button type="button" class="button-icon @(isDeletingMetric ? "danger" : "")"
                                                    @onclick="() => HandleDeleteMetricClick(metric.Id)"
                                                    title="@(isDeletingMetric ? "Clique novamente para confirmar" : "Excluir m√©trica")">
                                                @if (isDeletingMetric)
                                                {
                                                    <span style="font-size: 11px; white-space: nowrap;">Confirmar?</span>
                                                }
                                                else
                                                {
                                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                        <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                        <path d="M5.33398 4.00004V2.66671C5.33398 2.31309 5.47446 1.97395 5.72451 1.7239C5.97456 1.47385 6.3137 1.33337 6.66732 1.33337H9.33398C9.6876 1.33337 10.0268 1.47385 10.2768 1.7239C10.5269 1.97395 10.6673 2.31309 10.6673 2.66671V4.00004M12.6673 4.00004V13.3334C12.6673 13.687 12.5269 14.0261 12.2768 14.2762C12.0268 14.5262 11.6876 14.6667 11.334 14.6667H4.66732C4.3137 14.6667 3.97456 14.5262 3.72451 14.2762C3.47446 14.0261 3.33398 13.687 3.33398 13.3334V4.00004H12.6673Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                }
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>

                <div class="form-actions" style="margin-top: var(--spacing-6);">
                    <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                    <button class="button primary" type="submit">Salvar altera√ß√µes</button>
                </div>
            </EditForm>
        </ChildContent>
    </Modal>
}

@* Modal de Check-in *@
@if (isCheckinModalOpen && checkinMission != null && selectedCheckinMetric != null)
{
    <Modal Title="Novo check-in" Breadcrumb="@selectedCheckinMetric.Name" Size="md" OnClose="CloseCheckinModal">
        <ChildContent>
            <div class="metrics-form-container">
                @if (selectedCheckinMetric.Type == MetricType.Quantitative)
                {
                    <div class="form-row">
                        <label>Valor atual @GetCheckinTargetHint(selectedCheckinMetric)</label>
                        <InputNumber class="input" @bind-Value="newCheckin.Value" placeholder="Ex: 42" />
                    </div>
                }
                else
                {
                    <div class="form-row">
                        <label>Texto de progresso</label>
                        <InputText class="input" @bind-Value="newCheckin.Text" placeholder="Descreva o progresso atual" />
                    </div>
                }

                <div class="form-row">
                    <label>N√≠vel de confian√ßa</label>
                    <div class="confidence-selector">
                        @for (int i = 1; i <= 5; i++)
                        {
                            var level = i;
                            <button type="button"
                                    class="confidence-btn @(newCheckin.ConfidenceLevel >= level ? "active" : "")"
                                    @onclick="() => newCheckin.ConfidenceLevel = level">
                                @level
                            </button>
                        }
                    </div>
                </div>

                <div class="form-row">
                    <label>Nota (opcional)</label>
                    <InputText class="input" @bind-Value="newCheckin.Note" placeholder="Contexto adicional sobre o progresso" />
                </div>
            </div>

            <div class="form-actions" style="margin-top: var(--spacing-6);">
                <button class="button tertiary" type="button" @onclick="CloseCheckinModal">Cancelar</button>
                <button class="button primary" @onclick="CreateCheckin">Criar check-in</button>
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private sealed record ScopeOption(string Id, string Name);
    private sealed record TempMetric(string Name, string Type, string Details, string? QuantitativeType = null, decimal? MinValue = null, decimal? MaxValue = null, string? TargetText = null, string? Unit = null);

    private CreateMissionRequest newMission = new();
    private PagedResult<Mission>? missions;
    private Dictionary<Guid, MissionProgressDto> missionProgress = new();
    private List<Organization> organizations = new();
    private List<Workspace> workspaces = new();
    private List<Team> teams = new();
    private List<Collaborator> collaborators = new();
    private string? createScopeTypeValue;
    private string? createScopeId;
    private string? filterScopeTypeValue;
    private string? filterScopeId;
    private string? search;
    private string viewMode = "list"; // "list" ou "grid"
    private bool isModalOpen = false;
    private bool showResponsibleSelector = false;
    private bool showPeriodSelector = false;
    private string? missionDescription;
    private bool showMetricForm = false;
    private string? newMetricName;
    private string? newMetricType;
    private string? newMetricQuantitativeType;
    private decimal? newMetricMinValue;
    private decimal? newMetricMaxValue;
    private string? newMetricTargetText;
    private string? newMetricUnit;
    private List<TempMetric> tempMetrics = new();

    // Card expansion state
    private HashSet<Guid> expandedMissions = new();
    private Dictionary<Guid, List<MissionMetric>> missionMetricsCache = new();
    private Dictionary<Guid, MetricProgressDto> metricProgressCache = new();

    // Checkin modal state
    private bool isCheckinModalOpen = false;
    private Mission? checkinMission = null;
    private List<MissionMetric> checkinMetrics = new();
    private string? checkinMetricId;
    private MissionMetric? selectedCheckinMetric;
    private CreateMetricCheckinRequest newCheckin = new();
    private DateOnly checkinDate = DateOnly.FromDateTime(DateTime.Today);

    // Edit modal state
    private bool isEditModalOpen = false;
    private Mission? selectedMission = null;
    private UpdateMissionRequest editMission = new();
    private string? editStatusValue;

    // Metrics within edit modal
    private List<MissionMetric> editMissionMetrics = new();
    private Guid? editingMetricId = null;
    private UpdateMissionMetricRequest editMetric = new();
    private string? editMetricTypeValue;
    private string? editMetricQuantitativeTypeValue;
    private string? editMetricUnitValue;

    // Delete confirmation state
    private Guid? deletingMissionId = null;
    private System.Threading.Timer? deleteConfirmTimer;
    private Guid? deletingMetricId = null;
    private System.Threading.Timer? deleteMetricConfirmTimer;

    // Filter panel state
    private bool showFilterPanel = false;
    private bool filterActiveOnly = true;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private bool showDatePicker = false;

    protected override async Task OnInitializedAsync()
    {
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };

        // Subscribe to organization changes
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;

        // Aguardar inicializa√ß√£o do OrgContext (MainLayout pode ainda estar carregando)
        var maxWait = 50; // 50 * 100ms = 5 segundos m√°ximo
        while (!OrgContext.IsInitialized && maxWait > 0)
        {
            await Task.Delay(100);
            maxWait--;
        }

        await LoadReferenceData();
        await LoadMissions();
    }

    private async void HandleOrganizationChanged()
    {
        await InvokeAsync(async () =>
        {
            filterScopeTypeValue = null;
            filterScopeId = null;
            await LoadReferenceData();
            await LoadMissions();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
        deleteMetricConfirmTimer?.Dispose();
    }

    private async Task LoadReferenceData()
    {
        // Filtrar dados pelo tenant selecionado
        var orgId = OrgContext.SelectedOrganizationId;

        var orgsResult = await Api.GetOrganizationsAsync(null, 1, 200);
        organizations = orgsResult?.Items.ToList() ?? new List<Organization>();

        var workspacesResult = await Api.GetWorkspacesAsync(orgId, null, 1, 200);
        workspaces = workspacesResult?.Items.ToList() ?? new List<Workspace>();

        var teamsResult = await Api.GetTeamsAsync(null, null, null, 1, 200);
        teams = teamsResult?.Items.ToList() ?? new List<Team>();

        var collaboratorsResult = await Api.GetCollaboratorsAsync(null, null, 1, 200);
        collaborators = collaboratorsResult?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task LoadMissions()
    {
        var scopeType = ParseScopeType(filterScopeTypeValue);
        var scopeId = Guid.TryParse(filterScopeId, out var parsedScopeId)
            ? parsedScopeId
            : (Guid?)null;

        var result = await Api.GetMissionsAsync(scopeType, scopeId, search, 1, 100) ?? new PagedResult<Mission>();

        // Apply client-side filters
        var filteredItems = result.Items.AsEnumerable();

        // Filter by active status
        if (filterActiveOnly)
        {
            filteredItems = filteredItems.Where(m => m.Status == MissionStatus.Active);
        }

        // Filter by date range
        if (filterStartDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.EndDate >= filterStartDate.Value);
        }
        if (filterEndDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.StartDate <= filterEndDate.Value);
        }

        var filteredList = filteredItems.ToList();
        missions = new PagedResult<Mission>
        {
            Items = filteredList,
            Total = filteredList.Count,
            Page = 1,
            PageSize = filteredList.Count
        };

        await LoadProgress();
    }

    private async Task LoadProgress()
    {
        if (missions is null || missions.Items.Count == 0)
        {
            missionProgress = new();
            return;
        }

        try
        {
            var ids = missions.Items.Select(m => m.Id).ToList();
            var progressList = await Api.GetMissionProgressAsync(ids);
            missionProgress = progressList?.ToDictionary(p => p.MissionId) ?? new();
        }
        catch
        {
            missionProgress = new();
        }
    }

    private async Task OnCreateScopeTypeChanged(ChangeEventArgs e)
    {
        createScopeTypeValue = e.Value?.ToString();
        createScopeId = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFilterScopeTypeChanged(ChangeEventArgs e)
    {
        filterScopeTypeValue = e.Value?.ToString();
        filterScopeId = null;
        await LoadMissions();
    }

    private void ToggleFilterPanel()
    {
        showFilterPanel = !showFilterPanel;
    }

    private void ToggleViewMode()
    {
        viewMode = viewMode == "list" ? "grid" : "list";
    }

    private async Task ClearFilters()
    {
        filterScopeTypeValue = null;
        filterScopeId = null;
        search = null;
        filterActiveOnly = false;
        filterStartDate = null;
        filterEndDate = null;
        showDatePicker = false;
        await LoadMissions();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(filterScopeTypeValue)
            || !string.IsNullOrEmpty(search)
            || filterActiveOnly
            || filterStartDate.HasValue
            || filterEndDate.HasValue;
    }

    private void ToggleDatePicker()
    {
        showDatePicker = !showDatePicker;
    }

    private void OnStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            filterStartDate = date;
        }
        else
        {
            filterStartDate = null;
        }
    }

    private void OnEndDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            filterEndDate = date;
        }
        else
        {
            filterEndDate = null;
        }
    }

    private async Task ApplyDateFilter()
    {
        showDatePicker = false;
        await LoadMissions();
    }

    private async Task ToggleActiveFilter()
    {
        filterActiveOnly = !filterActiveOnly;
        await LoadMissions();
    }

    private string GetDateRangeLabel()
    {
        if (filterStartDate.HasValue && filterEndDate.HasValue)
        {
            return $"{filterStartDate:dd/MM} - {filterEndDate:dd/MM/yyyy}";
        }
        if (filterStartDate.HasValue)
        {
            return $"A partir de {filterStartDate:dd/MM/yyyy}";
        }
        if (filterEndDate.HasValue)
        {
            return $"At√© {filterEndDate:dd/MM/yyyy}";
        }
        return "Selecionar per√≠odo";
    }

    private string GetStatusFilterLabel()
    {
        return filterActiveOnly ? "Status ativo" : "Todos os status";
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadMissions();
        }
    }

    private void OpenCreateModal()
    {
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        missionDescription = null;
        showResponsibleSelector = false;
        showPeriodSelector = false;
        showMetricForm = false;
        tempMetrics.Clear();
        ClearMetricForm();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private string GetSelectedOrganizationName()
    {
        return organizations.FirstOrDefault()?.Name ?? "Organiza√ß√£o";
    }

    private string GetResponsibleLabel()
    {
        if (!string.IsNullOrEmpty(createScopeId) && Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            var option = GetScopeOptions(createScopeTypeValue).FirstOrDefault(o => o.Id == createScopeId);
            if (option != null)
            {
                return $"Respons√°vel: {option.Name}";
            }
        }
        return "Respons√°vel";
    }

    private string GetPeriodLabel()
    {
        if (newMission.StartDate != DateTime.MinValue && newMission.EndDate != DateTime.MinValue)
        {
            return $"Per√≠odo de in√≠cio e fim: {newMission.StartDate:dd/MM/yyyy} - {newMission.EndDate:dd/MM/yyyy}";
        }
        return "Per√≠odo de in√≠cio e fim";
    }

    private async Task SaveDraft()
    {
        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            ToastService.ShowError("Erro ao salvar rascunho", "Selecione o escopo.");
            return;
        }

        if (!Guid.TryParse(createScopeId, out var scopeId))
        {
            ToastService.ShowError("Erro ao salvar rascunho", "Selecione a refer√™ncia do escopo.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            ToastService.ShowError("Erro ao salvar rascunho", "Informe o nome da miss√£o.");
            return;
        }

        if (newMission.EndDate < newMission.StartDate)
        {
            ToastService.ShowError("Erro ao salvar rascunho", "A data de fim precisa ser igual ou maior que a data de in√≠cio.");
            return;
        }

        FlushPendingMetric();

        newMission.ScopeType = scopeType;
        newMission.ScopeId = scopeId;
        newMission.Description = missionDescription;
        newMission.Status = MissionStatus.Planned;

        var createdMission = await Api.CreateMissionAsync(newMission);

        // Create metrics for the mission
        await CreateMetricsForMission(createdMission);

        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        await LoadMissions();

        ToastService.ShowSuccess("Rascunho salvo com sucesso!", "A miss√£o foi salva como rascunho.");
        CloseModal();
    }

    private void FlushPendingMetric()
    {
        if (showMetricForm && !string.IsNullOrWhiteSpace(newMetricName) && !string.IsNullOrWhiteSpace(newMetricType))
        {
            var details = newMetricType == "Quantitative"
                ? BuildQuantitativeDetails()
                : newMetricTargetText ?? "";

            tempMetrics.Add(new TempMetric(
                newMetricName,
                newMetricType,
                details,
                newMetricQuantitativeType,
                newMetricMinValue,
                newMetricMaxValue,
                newMetricTargetText,
                newMetricUnit
            ));

            ClearMetricForm();
        }
    }

    private async Task CreateMetricsForMission(Mission? createdMission)
    {
        if (createdMission is null || !tempMetrics.Any())
        {
            return;
        }

        var failedCount = 0;
        foreach (var tempMetric in tempMetrics)
        {
            var metricRequest = new CreateMissionMetricRequest
            {
                MissionId = createdMission.Id,
                Name = tempMetric.Name,
                Type = Enum.Parse<MetricType>(tempMetric.Type)
            };

            if (tempMetric.Type == "Quantitative")
            {
                if (!string.IsNullOrEmpty(tempMetric.QuantitativeType))
                {
                    metricRequest.QuantitativeType = Enum.Parse<QuantitativeMetricType>(tempMetric.QuantitativeType);
                }
                metricRequest.MinValue = tempMetric.MinValue;
                metricRequest.MaxValue = tempMetric.MaxValue;
                if (!string.IsNullOrEmpty(tempMetric.Unit))
                {
                    metricRequest.Unit = Enum.Parse<MetricUnit>(tempMetric.Unit);
                }
            }
            else
            {
                metricRequest.TargetText = tempMetric.TargetText;
            }

            try
            {
                await Api.CreateMissionMetricAsync(metricRequest);
            }
            catch (Exception)
            {
                failedCount++;
            }
        }

        if (failedCount > 0)
        {
            ToastService.ShowError("Erro ao salvar m√©tricas", $"{failedCount} m√©trica(s) n√£o puderam ser salvas.");
        }
    }

    private void AddMetricOrOpenForm()
    {
        // Se o formul√°rio n√£o est√° aberto, apenas abre
        if (!showMetricForm)
        {
            showMetricForm = true;
            return;
        }

        // Se o formul√°rio est√° aberto mas n√£o preenchido, n√£o faz nada
        if (string.IsNullOrWhiteSpace(newMetricName) || string.IsNullOrWhiteSpace(newMetricType))
        {
            return;
        }

        // Se o formul√°rio est√° aberto e preenchido, adiciona a m√©trica
        var details = newMetricType == "Quantitative"
            ? BuildQuantitativeDetails()
            : newMetricTargetText ?? "";

        tempMetrics.Add(new TempMetric(
            newMetricName,
            newMetricType,
            details,
            newMetricQuantitativeType,
            newMetricMinValue,
            newMetricMaxValue,
            newMetricTargetText,
            newMetricUnit
        ));

        // Limpa o formul√°rio mas mant√©m aberto para adicionar mais m√©tricas
        ClearMetricForm();
    }

    private void RemoveMetric(TempMetric metric)
    {
        tempMetrics.Remove(metric);
    }

    private void ClearMetricForm()
    {
        newMetricName = null;
        newMetricType = null;
        newMetricQuantitativeType = null;
        newMetricMinValue = null;
        newMetricMaxValue = null;
        newMetricTargetText = null;
        newMetricUnit = null;
    }

    private string BuildQuantitativeDetails()
    {
        var unit = GetUnitLabelShort(newMetricUnit);
        return newMetricQuantitativeType switch
        {
            "KeepAbove" => $"Acima de {newMetricMinValue} {unit}",
            "KeepBelow" => $"Abaixo de {newMetricMaxValue} {unit}",
            "KeepBetween" => $"Entre {newMetricMinValue} e {newMetricMaxValue} {unit}",
            "Achieve" => $"Atingir {newMetricMaxValue} {unit}",
            "Reduce" => $"Reduzir para {newMetricMaxValue} {unit}",
            _ => ""
        };
    }

    private string GetUnitLabelShort(string? unit) => unit switch
    {
        "Integer" => "un",
        "Decimal" => "un",
        "Percentage" => "%",
        "Hours" => "h",
        "Points" => "pts",
        _ => ""
    };

    private async Task CreateMission()
    {
        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            ToastService.ShowError("Erro ao criar miss√£o", "Selecione o escopo.");
            return;
        }

        if (!Guid.TryParse(createScopeId, out var scopeId))
        {
            ToastService.ShowError("Erro ao criar miss√£o", "Selecione a refer√™ncia do escopo.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            ToastService.ShowError("Erro ao criar miss√£o", "Informe o nome da miss√£o.");
            return;
        }

        if (newMission.EndDate < newMission.StartDate)
        {
            ToastService.ShowError("Erro ao criar miss√£o", "A data de fim precisa ser igual ou maior que a data de in√≠cio.");
            return;
        }

        FlushPendingMetric();

        newMission.ScopeType = scopeType;
        newMission.ScopeId = scopeId;
        newMission.Description = missionDescription;
        newMission.Status = MissionStatus.Active;

        var createdMission = await Api.CreateMissionAsync(newMission);

        // Create metrics for the mission
        await CreateMetricsForMission(createdMission);

        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        await LoadMissions();

        ToastService.ShowSuccess("Miss√£o criada com sucesso!", $"A miss√£o '{createdMission?.Name}' foi criada e est√° ativa.");
        CloseModal();
    }

    private IEnumerable<ScopeOption> GetScopeOptions(string? scopeTypeValue)
    {
        if (!Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType))
        {
            return Enumerable.Empty<ScopeOption>();
        }

        return scopeType switch
        {
            MissionScopeType.Organization => organizations.Select(o => new ScopeOption(o.Id.ToString(), o.Name)),
            MissionScopeType.Workspace => workspaces.Select(w => new ScopeOption(w.Id.ToString(), w.Name)),
            MissionScopeType.Team => teams.Select(t => new ScopeOption(t.Id.ToString(), t.Name)),
            MissionScopeType.Collaborator => collaborators.Select(c => new ScopeOption(c.Id.ToString(), c.FullName)),
            _ => Enumerable.Empty<ScopeOption>()
        };
    }

    private MissionScopeType? ParseScopeType(string? scopeTypeValue)
    {
        return Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType) ? scopeType : null;
    }

    private string GetMissionScopeName(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
        {
            return collaborators.FirstOrDefault(c => c.Id == mission.CollaboratorId.Value)?.FullName ?? "‚Äî";
        }

        if (mission.TeamId.HasValue)
        {
            return teams.FirstOrDefault(t => t.Id == mission.TeamId.Value)?.Name ?? "‚Äî";
        }

        if (mission.WorkspaceId.HasValue)
        {
            return workspaces.FirstOrDefault(w => w.Id == mission.WorkspaceId.Value)?.Name ?? "‚Äî";
        }

        // Org-scoped: no other scope FK is set, OrganizationId is always present
        return organizations.FirstOrDefault(o => o.Id == mission.OrganizationId)?.Name ?? "‚Äî";
    }

    private static string GetScopeLabel(MissionScopeType scopeType) => scopeType switch
    {
        MissionScopeType.Organization => "Organiza√ß√£o",
        MissionScopeType.Workspace => "Workspace",
        MissionScopeType.Team => "Equipe",
        MissionScopeType.Collaborator => "Colaborador",
        _ => scopeType.ToString()
    };

    private static string GetStatusLabel(MissionStatus status) => status switch
    {
        MissionStatus.Planned => "Planejada",
        MissionStatus.Active => "Ativa",
        MissionStatus.Completed => "Conclu√≠da",
        MissionStatus.Cancelled => "Cancelada",
        _ => status.ToString()
    };

    // ---- Card Expansion Methods ----

    private async Task ToggleExpand(Guid missionId)
    {
        if (expandedMissions.Contains(missionId))
        {
            expandedMissions.Remove(missionId);
        }
        else
        {
            expandedMissions.Add(missionId);
            if (!missionMetricsCache.ContainsKey(missionId))
            {
                var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(missionId);
                var metrics = metricsResult?.Items.ToList() ?? new List<MissionMetric>();
                missionMetricsCache[missionId] = metrics;

                // Load progress for each metric
                if (metrics.Count > 0)
                {
                    var metricIds = metrics.Select(m => m.Id).ToList();
                    var progressList = await Api.GetMetricProgressAsync(metricIds);
                    if (progressList != null)
                    {
                        foreach (var progress in progressList)
                        {
                            metricProgressCache[progress.MetricId] = progress;
                        }
                    }
                    StateHasChanged();
                }
            }
        }
    }

    // ---- Summary Card Methods ----

    private int GetOverallProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.TotalMetrics > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.OverallProgress);
    }

    private int GetExpectedProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.ExpectedProgress > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.ExpectedProgress);
    }

    private int GetActiveMissionsCount()
    {
        return missions?.Items.Count(m => m.Status == MissionStatus.Active) ?? 0;
    }

    private int GetOutdatedMetricsCount()
    {
        return missionProgress.Values.Sum(p => p.OutdatedMetrics);
    }

    // ---- Metric Display Methods ----

    private int GetMetricProgress(MissionMetric metric)
    {
        if (metricProgressCache.TryGetValue(metric.Id, out var progress))
        {
            return (int)progress.Progress;
        }
        return 0;
    }

    private bool IsMetricOutdated(Guid metricId)
    {
        if (metricProgressCache.TryGetValue(metricId, out var progress))
        {
            return progress.IsOutdated;
        }
        // No progress data means no check-ins, which is outdated
        return true;
    }

    private static string GetMetricStatusClass(int progress, decimal expectedProgress)
    {
        // Se ainda n√£o h√° progresso esperado (miss√£o n√£o iniciou), considera on-track
        if (expectedProgress <= 0)
        {
            return "on-track";
        }

        // Compara progresso real com esperado
        if (progress >= (int)expectedProgress)
        {
            return "on-track";
        }

        if (progress >= (int)(expectedProgress * 0.7m))
        {
            return "at-risk";
        }

        return "off-track";
    }

    private static string GetMetricStatusLabel(int progress, decimal expectedProgress, MissionMetric metric)
    {
        if (metric.Type == MetricType.Qualitative) return "Qualitativo";

        // Se ainda n√£o h√° progresso esperado (miss√£o n√£o iniciou), considera on-track
        if (expectedProgress <= 0)
        {
            return "Dentro do previsto";
        }

        // Compara progresso real com esperado
        if (progress >= (int)expectedProgress)
        {
            return "Dentro do previsto";
        }

        if (progress >= (int)(expectedProgress * 0.7m))
        {
            return "Aten√ß√£o";
        }

        return "Em risco";
    }

    private MarkupString GetMetricIcon(MetricType type)
    {
        return type switch
        {
            MetricType.Quantitative => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><path d=""M16 4V28M4 16H28"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round""/></svg>"),
            MetricType.Qualitative => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><path d=""M16 4L20 12L28 14L22 20L24 28L16 24L8 28L10 20L4 14L12 12L16 4Z"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round"" stroke-linejoin=""round""/></svg>"),
            _ => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><circle cx=""16"" cy=""16"" r=""10"" stroke=""currentColor"" stroke-width=""2""/></svg>")
        };
    }

    private string GetQuarterLabel(Mission mission)
    {
        var quarter = (mission.StartDate.Month - 1) / 3 + 1;
        return $"Q{quarter} {mission.StartDate.Year}";
    }

    // ---- Checkin Modal Methods ----

    private void OpenCheckinModalForMetric(Mission mission, MissionMetric metric)
    {
        checkinMission = mission;
        checkinMetrics = missionMetricsCache.GetValueOrDefault(mission.Id) ?? new List<MissionMetric>();
        checkinMetricId = metric.Id.ToString();
        selectedCheckinMetric = metric;
        newCheckin = new CreateMetricCheckinRequest { ConfidenceLevel = 3 };
        checkinDate = DateOnly.FromDateTime(DateTime.Today);
        isCheckinModalOpen = true;
    }

    private void CloseCheckinModal()
    {
        isCheckinModalOpen = false;
        checkinMission = null;
        checkinMetrics = new();
        checkinMetricId = null;
        selectedCheckinMetric = null;
    }

    private void OnCheckinMetricChanged()
    {
        if (Guid.TryParse(checkinMetricId, out var metricId))
        {
            selectedCheckinMetric = checkinMetrics.FirstOrDefault(m => m.Id == metricId);
        }
        else
        {
            selectedCheckinMetric = null;
        }
    }

    private async Task CreateCheckin()
    {
        if (selectedCheckinMetric is null)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione uma m√©trica.");
            return;
        }

        if (newCheckin.ConfidenceLevel < 1 || newCheckin.ConfidenceLevel > 5)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione o n√≠vel de confian√ßa (1-5).");
            return;
        }

        newCheckin.MissionMetricId = selectedCheckinMetric.Id;
        newCheckin.CheckinDate = DateTime.UtcNow;

        try
        {
            await Api.CreateMetricCheckinAsync(newCheckin);
            ToastService.ShowSuccess("Check-in criado", "O check-in foi registrado com sucesso.");
            CloseCheckinModal();
            await LoadProgress();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao criar check-in", ex.Message);
        }
    }

    private static string GetCheckinTargetHint(MissionMetric metric)
    {
        if (metric.Type != MetricType.Quantitative || !metric.QuantitativeType.HasValue) return "";

        var unit = metric.Unit.HasValue ? GetUnitLabel(metric.Unit.Value) : "";

        return metric.QuantitativeType switch
        {
            QuantitativeMetricType.KeepAbove => $"(manter acima de {metric.MinValue} {unit})",
            QuantitativeMetricType.KeepBelow => $"(manter abaixo de {metric.MaxValue} {unit})",
            QuantitativeMetricType.KeepBetween => $"(manter entre {metric.MinValue} e {metric.MaxValue} {unit})",
            QuantitativeMetricType.Achieve => $"(atingir {metric.MaxValue} {unit})",
            QuantitativeMetricType.Reduce => $"(reduzir para {metric.MaxValue} {unit})",
            _ => ""
        };
    }

    private static string GetMaxValuePlaceholder(string? quantitativeType) => quantitativeType switch
    {
        "KeepBelow" or nameof(QuantitativeMetricType.KeepBelow) => "Valor m√°ximo",
        "KeepBetween" or nameof(QuantitativeMetricType.KeepBetween) => "Valor m√°ximo",
        "Achieve" or nameof(QuantitativeMetricType.Achieve) => "Valor alvo",
        "Reduce" or nameof(QuantitativeMetricType.Reduce) => "Valor alvo",
        _ => "Valor m√°ximo"
    };

    // ---- Mission Edit/Delete Methods ----

    private async Task OpenEditModal(Mission mission)
    {
        selectedMission = mission;
        editMission = new UpdateMissionRequest
        {
            Name = mission.Name,
            StartDate = mission.StartDate,
            EndDate = mission.EndDate,
            Status = mission.Status
        };
        editStatusValue = mission.Status.ToString();

        var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(mission.Id);
        editMissionMetrics = metricsResult?.Items.ToList() ?? new List<MissionMetric>();

        editingMetricId = null;
        editMetric = new();
        deletingMetricId = null;

        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedMission = null;
        editMission = new();
        editMissionMetrics = new();
        editingMetricId = null;
        editMetric = new();
        editMetricTypeValue = null;
        editMetricQuantitativeTypeValue = null;
        editMetricUnitValue = null;
        deletingMetricId = null;
    }

    private async Task UpdateMission()
    {
        if (selectedMission == null) return;

        if (Enum.TryParse<MissionStatus>(editStatusValue, out var status))
        {
            editMission.Status = status;
        }

        try
        {
            await Api.UpdateMissionAsync(selectedMission.Id, editMission);
            ToastService.ShowSuccess("Miss√£o atualizada", "As altera√ß√µes foram salvas com sucesso.");
            CloseEditModal();
            await LoadMissions();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao atualizar", ex.Message);
        }
    }

    private async Task HandleDeleteClick(Guid missionId)
    {
        if (deletingMissionId == missionId)
        {
            await DeleteMission(missionId);
        }
        else
        {
            deletingMissionId = missionId;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingMissionId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteMission(Guid missionId)
    {
        try
        {
            await Api.DeleteMissionAsync(missionId);
            ToastService.ShowSuccess("Miss√£o exclu√≠da", "A miss√£o foi removida com sucesso.");
            await LoadMissions();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao excluir", ex.Message);
        }
        finally
        {
            deletingMissionId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }

    // ---- Inline Metric Edit/Delete Methods ----

    private void StartEditingMetric(MissionMetric metric)
    {
        editingMetricId = metric.Id;
        editMetric = new UpdateMissionMetricRequest
        {
            Name = metric.Name,
            Type = metric.Type,
            QuantitativeType = metric.QuantitativeType,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            Unit = metric.Unit,
            TargetText = metric.TargetText
        };
        editMetricTypeValue = metric.Type.ToString();
        editMetricQuantitativeTypeValue = metric.QuantitativeType?.ToString();
        editMetricUnitValue = metric.Unit?.ToString();
    }

    private void CancelEditingMetric()
    {
        editingMetricId = null;
        editMetric = new();
        editMetricTypeValue = null;
        editMetricQuantitativeTypeValue = null;
        editMetricUnitValue = null;
    }

    private async Task SaveEditingMetric()
    {
        if (editingMetricId is null || selectedMission is null) return;

        if (!Enum.TryParse<MetricType>(editMetricTypeValue, out var metricType))
        {
            ToastService.ShowError("Erro ao atualizar m√©trica", "Selecione o tipo da m√©trica.");
            return;
        }

        editMetric.Type = metricType;

        if (metricType == MetricType.Quantitative)
        {
            if (Enum.TryParse<QuantitativeMetricType>(editMetricQuantitativeTypeValue, out var qType))
                editMetric.QuantitativeType = qType;
            if (Enum.TryParse<MetricUnit>(editMetricUnitValue, out var unit))
                editMetric.Unit = unit;
        }

        try
        {
            await Api.UpdateMissionMetricAsync(editingMetricId.Value, editMetric);
            ToastService.ShowSuccess("M√©trica atualizada", "A m√©trica foi salva com sucesso.");

            var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(selectedMission.Id);
            editMissionMetrics = metricsResult?.Items.ToList() ?? new();

            CancelEditingMetric();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao atualizar m√©trica", ex.Message);
        }
    }

    private async Task OnEditMetricTypeChanged(ChangeEventArgs e)
    {
        editMetricTypeValue = e.Value?.ToString();
        editMetric.TargetText = null;
        editMetric.MinValue = null;
        editMetric.MaxValue = null;
        editMetric.QuantitativeType = null;
        editMetricQuantitativeTypeValue = null;
        editMetricUnitValue = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleDeleteMetricClick(Guid metricId)
    {
        if (deletingMetricId == metricId)
        {
            await DeleteMetric(metricId);
        }
        else
        {
            deletingMetricId = metricId;
            deleteMetricConfirmTimer?.Dispose();
            deleteMetricConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingMetricId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteMetric(Guid metricId)
    {
        try
        {
            await Api.DeleteMissionMetricAsync(metricId);
            ToastService.ShowSuccess("M√©trica exclu√≠da", "A m√©trica foi removida com sucesso.");

            if (selectedMission != null)
            {
                var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(selectedMission.Id);
                editMissionMetrics = metricsResult?.Items.ToList() ?? new();
            }
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao excluir m√©trica", ex.Message);
        }
        finally
        {
            deletingMetricId = null;
            deleteMetricConfirmTimer?.Dispose();
            deleteMetricConfirmTimer = null;
        }
    }

    // ---- Progress & Confidence Helpers ----

    private static string GetProgressStatusClass(MissionProgressDto progress)
    {
        if (progress.MetricsWithCheckins == 0)
        {
            return "no-data";
        }

        if (progress.ExpectedProgress <= 0)
        {
            return "on-track";
        }

        if (progress.OverallProgress >= progress.ExpectedProgress)
        {
            return "on-track";
        }

        if (progress.OverallProgress >= progress.ExpectedProgress * 0.7m)
        {
            return "at-risk";
        }

        return "off-track";
    }

    private static (string statusClass, string label) GetConfidenceDisplay(decimal averageConfidence)
    {
        return averageConfidence switch
        {
            >= 4m => ("on-track", "No caminho"),
            >= 2m => ("at-risk", "Aten√ß√£o"),
            _ => ("off-track", "Em risco")
        };
    }

    private static string GetConfidenceStarsText(decimal confidence)
    {
        var full = (int)Math.Round(confidence);
        return new string('‚òÖ', full) + new string('‚òÜ', 5 - full);
    }

    // ---- Metric Display Helpers ----

    private static string GetMetricTypeLabel(MetricType type) => type switch
    {
        MetricType.Qualitative => "Qualitativa",
        MetricType.Quantitative => "Quantitativa",
        _ => type.ToString()
    };

    private static string GetQuantitativeTypeLabel(QuantitativeMetricType type) => type switch
    {
        QuantitativeMetricType.KeepAbove => "Manter acima",
        QuantitativeMetricType.KeepBelow => "Manter abaixo",
        QuantitativeMetricType.KeepBetween => "Manter entre",
        QuantitativeMetricType.Achieve => "Atingir",
        QuantitativeMetricType.Reduce => "Reduzir",
        _ => type.ToString()
    };

    private static string GetQuantitativeTypeIcon(QuantitativeMetricType type) => type switch
    {
        QuantitativeMetricType.KeepAbove => "‚Üë",
        QuantitativeMetricType.KeepBelow => "‚Üì",
        QuantitativeMetricType.KeepBetween => "‚Üï",
        QuantitativeMetricType.Achieve => "‚Üí",
        QuantitativeMetricType.Reduce => "‚Üò",
        _ => ""
    };

    private static string GetUnitLabel(MetricUnit unit) => unit switch
    {
        MetricUnit.Integer => "Inteiro",
        MetricUnit.Decimal => "Decimal",
        MetricUnit.Percentage => "Percentual",
        MetricUnit.Hours => "Horas",
        MetricUnit.Points => "Pontos",
        _ => unit.ToString()
    };

    private static string GetTargetLabel(MissionMetric metric)
    {
        if (metric.Type == MetricType.Qualitative)
        {
            return metric.TargetText ?? "‚Äî";
        }

        var unit = metric.Unit.HasValue ? GetUnitLabel(metric.Unit.Value) : "";
        var quantType = metric.QuantitativeType.HasValue ? GetQuantitativeTypeLabel(metric.QuantitativeType.Value) : "‚Äî";

        return metric.QuantitativeType switch
        {
            QuantitativeMetricType.KeepAbove => $"{quantType} {metric.MinValue} {unit}",
            QuantitativeMetricType.KeepBelow => $"{quantType} {metric.MaxValue} {unit}",
            QuantitativeMetricType.KeepBetween => $"{quantType} {metric.MinValue} e {metric.MaxValue} {unit}",
            QuantitativeMetricType.Achieve => $"{quantType} {metric.MaxValue} {unit}",
            QuantitativeMetricType.Reduce => $"{quantType} para {metric.MaxValue} {unit}",
            _ => "‚Äî"
        };
    }

}
