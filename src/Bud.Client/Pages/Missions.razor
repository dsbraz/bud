@page "/missions"
@inject ApiClient Api
@inject OrganizationContext OrgContext
@inject AuthState AuthState
@inject ToastService ToastService
@inject UiOperationService UiOps
@implements IDisposable

<MissionsMenu />

<ManagementPageHeader
    Kicker="Miss√µes"
    Title="@(showMyMissions ? "Minhas miss√µes" : "Todas as miss√µes")"
    PrimaryActionText="Criar miss√£o"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros Compacta *@
<div class="missions-filter-bar">
    <div class="missions-filter-left">
        <div class="filter-chip-group">
            <button class="filter-chip @(showMyMissions ? "active" : "")" @onclick="() => SetMissionViewMode(true)">
                <span>Minhas miss√µes</span>
            </button>
            <button class="filter-chip @(!showMyMissions ? "active" : "")" @onclick="() => SetMissionViewMode(false)">
                <span>Todas as miss√µes</span>
            </button>
        </div>
        @if (!showMyMissions)
        {
            <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M28 6H4L14 17.6V26L18 28V17.6L28 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Filtrar</span>
            </button>
        }
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(filterStartDate.HasValue || filterEndDate.HasValue ? "active" : "")" @onclick="ToggleDatePicker">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 4H6C4.89543 4 4 4.89543 4 6V26C4 27.1046 4.89543 28 6 28H26C27.1046 28 28 27.1046 28 26V6C28 4.89543 27.1046 4 26 4Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M22 2V6M10 2V6M4 12H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>@GetDateRangeLabel()</span>
            </button>
            @if (showDatePicker)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Data inicial</label>
                        <input type="date" class="input" value="@filterStartDate?.ToString("yyyy-MM-dd")" @onchange="OnStartDateChanged" />
                    </div>
                    <div class="filter-dropdown-row">
                        <label>Data final</label>
                        <input type="date" class="input" value="@filterEndDate?.ToString("yyyy-MM-dd")" @onchange="OnEndDateChanged" />
                    </div>
                    <button class="button small" @onclick="ApplyDateFilter">Aplicar</button>
                </div>
            }
        </div>
        <button class="filter-chip @(filterActiveOnly ? "active" : "")" @onclick="ToggleActiveFilter">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M16 28C22.6274 28 28 22.6274 28 16C28 9.37258 22.6274 4 16 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 10V16L20 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 16H8M6 12L8 16L6 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>@GetStatusFilterLabel()</span>
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip-clear" @onclick="ClearFilters">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 16L22 12M22 12L18 8M22 12L26 8M22 12L18 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 8L10 28H14L12 18L6 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Limpar filtro</span>
            </button>
        }
    </div>
    <button class="filter-chip" @onclick="ToggleViewMode">
        @if (viewMode == "list")
        {
            @* √çcone de lista (linhas horizontais) *@
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M4 8H28M4 16H28M4 24H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Lista</span>
        }
        else
        {
            @* √çcone de grade (4 quadrados) *@
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <rect x="4" y="6" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="4" y="18" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="20" y="6" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="20" y="18" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>Grade</span>
        }
    </button>
</div>

@* Painel de Filtros Expandido *@
@if (showFilterPanel && !showMyMissions)
{
    <div class="missions-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Escopo</label>
                <select class="input" value="@filterScopeTypeValue" @onchange="OnFilterScopeTypeChanged">
                    <option value="">Todos</option>
                    @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                    {
                        <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Refer√™ncia</label>
                <select class="input" @bind="filterScopeId" @bind:after="LoadMissions">
                    <option value="">Todas</option>
                    @foreach (var option in GetScopeOptions(filterScopeTypeValue))
                    {
                        <option value="@option.Id">@option.Name</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar miss√µes..." />
            </div>
        </div>
    </div>
}

@* Cards de Resumo *@
<SummaryCards CssClass="missions-summary">
    <StatCard Value="@($"{GetOverallProgressDisplay()}%")" Label="@($"Esperado {GetExpectedProgressDisplay()}%")" ShowProgress="true" Progress="GetOverallProgressDisplay()" ExpectedProgress="GetExpectedProgressDisplay()" />
    <StatCard Value="@GetActiveMissionsCount().ToString()" Label="Miss√µes ativas" />
    <StatCard Value="@GetOutdatedMetricsCount().ToString()" Label="Indicadores desatualizados" />
</SummaryCards>

@* Lista de Miss√µes em Cards *@
@if (missions is null)
{
    <div class="missions-loading">
        <p class="muted">Carregando...</p>
    </div>
}
else if (missions.Items.Count == 0)
{
    <div class="missions-empty">
        <div class="missions-empty-icon">üìã</div>
        <p class="muted">Nenhuma miss√£o encontrada.</p>
    </div>
}
else
{
    <div class="@(viewMode == "list" ? "missions-list" : "missions-grid")">
        @foreach (var mission in missions.Items)
        {
            var progress = missionProgress.GetValueOrDefault(mission.Id);
            var isExpanded = expandedMissions.Contains(mission.Id);
            var isDeleting = deletingMissionId == mission.Id;
            var progressPercent = (int)(progress?.OverallProgress ?? 0);
            var circumference = 2 * Math.PI * 19;
            var dashOffset = circumference - (circumference * progressPercent / 100);

            <div class="mission-card @(isExpanded ? "expanded" : "") @(mission.Status == MissionStatus.Planned ? "draft" : "")">
                <div class="mission-card-header" @onclick="async () => await ToggleExpand(mission.Id)">
                    @* C√≠rculo de Progresso *@
                    <div class="mission-progress-circle">
                        <svg width="44" height="44" viewBox="0 0 44 44">
                            <circle class="progress-bg" cx="22" cy="22" r="19" />
                            @if (mission.Status != MissionStatus.Planned)
                            {
                                <circle class="progress-value @GetProgressStatusClass(progress)"
                                        cx="22" cy="22" r="19"
                                        stroke-dasharray="@circumference.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                        stroke-dashoffset="@dashOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)" />
                            }
                        </svg>
                        <div class="mission-progress-text">
                            <span class="mission-progress-number">@(mission.Status == MissionStatus.Planned ? "00" : progressPercent.ToString())</span>
                            <span class="mission-progress-percent">%</span>
                        </div>
                    </div>

                    @* T√≠tulo da Miss√£o *@
                    <div class="mission-card-title-wrapper">
                        @if (mission.Status == MissionStatus.Planned)
                        {
                            <span class="mission-draft-tag">RASCUNHO</span>
                        }
                        <div class="mission-card-title-row">
                            <div class="mission-card-title">@mission.Name</div>
                            @if (progress != null && progress.MetricsWithCheckins > 0)
                            {
                                <div class="mission-confidence-badge @GetConfidenceClass(progress.AverageConfidence)" title="N√≠vel de confian√ßa: @GetConfidenceLabel(progress.AverageConfidence)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>@((int)Math.Round(progress.AverageConfidence))</span>
                                </div>
                            }
                        </div>
                    </div>

                    @* A√ß√µes *@
                    <div class="mission-card-actions" @onclick:stopPropagation="true">
                        <button class="mission-action-btn" @onclick="async () => await OpenEditWizard(mission)" title="Editar miss√£o">
                            <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                                <path d="M22 4L28 10L10 28H4V22L22 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="mission-action-btn @(isDeleting ? "danger" : "")"
                                @onclick="() => HandleDeleteClick(mission.Id)"
                                title="@(isDeleting ? "Confirmar exclus√£o" : "Excluir")">
                            @if (isDeleting)
                            {
                                <span style="font-size: 10px;">OK?</span>
                            }
                            else
                            {
                                <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                                    <path d="M4 8H6.66667H28" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10.6667 8V5.33333C10.6667 4.62609 10.9476 3.94781 11.4477 3.44772C11.9478 2.94762 12.6261 2.66667 13.3333 2.66667H18.6667C19.3739 2.66667 20.0522 2.94762 20.5523 3.44772C21.0524 3.94781 21.3333 4.62609 21.3333 5.33333V8M25.3333 8V26.6667C25.3333 27.3739 25.0524 28.0522 24.5523 28.5523C24.0522 29.0524 23.3739 29.3333 22.6667 29.3333H9.33333C8.62609 29.3333 7.94781 29.0524 7.44772 28.5523C6.94762 28.0522 6.66667 27.3739 6.66667 26.6667V8H25.3333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            }
                        </button>
                        <button class="mission-action-btn" @onclick="async () => await ToggleExpand(mission.Id)" title="@(isExpanded ? "Recolher" : "Expandir")">
                            <svg class="mission-expand-icon @(isExpanded ? "expanded" : "")" width="22" height="22" viewBox="0 0 32 32" fill="none">
                                <path d="M8 12L16 20L24 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>

                @* Conte√∫do Expandido - Objetivos e M√©tricas *@
                @if (isExpanded)
                {
                    <div class="mission-card-content">
                        @{
                            var metrics = missionMetricsCache.GetValueOrDefault(mission.Id);
                            var objectives = missionObjectivesCache.GetValueOrDefault(mission.Id);
                            var directMetrics = metrics?.Where(m => m.MissionObjectiveId is null).ToList();
                        }
                        @if (metrics is null)
                        {
                            <p class="muted">Carregando...</p>
                        }
                        else
                        {
                            @* Se√ß√£o de Objetivos *@
                            @if (objectives != null && objectives.Count > 0)
                            {
                                @foreach (var objective in objectives)
                                {
                                    var objProgress = objectiveProgressCache.GetValueOrDefault(objective.Id);
                                    var objProgressPercent = (int)(objProgress?.OverallProgress ?? 0);
                                    var isObjExpanded = expandedObjectives.Contains(objective.Id);
                                    var objMetrics = metrics.Where(m => m.MissionObjectiveId == objective.Id).ToList();

                                    <div class="objective-section @(isObjExpanded ? "expanded" : "")">
                                        <div class="objective-header" @onclick="() => ToggleObjectiveExpand(objective.Id)" @onclick:stopPropagation="true">
                                            <svg class="objective-expand-icon @(isObjExpanded ? "expanded" : "")" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <div class="objective-header-info">
                                                <div class="objective-name">@objective.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(objective.Description))
                                                {
                                                    <div class="objective-description">@objective.Description</div>
                                                }
                                            </div>
                                            <div class="objective-progress-inline">
                                                <div class="metric-progress-bar">
                                                    <div class="metric-progress-fill @GetProgressStatusClassFromPercent(objProgressPercent, progress?.ExpectedProgress ?? 0m)" style="width: @(objProgressPercent)%"></div>
                                                </div>
                                                <span class="objective-progress-value">@(objProgressPercent)%</span>
                                            </div>
                                        </div>
                                        @if (isObjExpanded)
                                        {
                                            <div class="objective-metrics">
                                                @foreach (var metric in objMetrics)
                                                {
                                                    @RenderMetricRow(mission, metric, progress)
                                                }
                                                @if (objMetrics.Count == 0)
                                                {
                                                    <p class="muted" style="padding: var(--spacing-2) var(--spacing-4); font-size: var(--font-size-xs);">Nenhuma m√©trica neste objetivo.</p>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            }

                            @* M√©tricas diretas (sem objetivo) *@
                            @if (directMetrics != null && directMetrics.Count > 0)
                            {
                                @if (objectives != null && objectives.Count > 0)
                                {
                                    <div class="direct-metrics-label">M√©tricas diretas</div>
                                }
                                @foreach (var metric in directMetrics)
                                {
                                    @RenderMetricRow(mission, metric, progress)
                                }
                            }

                            @if ((directMetrics == null || directMetrics.Count == 0) && (objectives == null || objectives.Count == 0))
                            {
                                <p class="muted">Nenhuma m√©trica ou objetivo associado a esta miss√£o.</p>
                            }
                        }
                    </div>
                }
            </div>
        }
    </div>
    <p class="muted" style="margin-top: var(--spacing-4);">Total: @missions.Total</p>
}

@if (isTemplatePickerOpen)
{
    <Modal Title="Como deseja criar sua miss√£o?" Size="lg" OnClose="() => isTemplatePickerOpen = false">
        <ChildContent>
            <div class="template-picker-grid">
                <div class="template-picker-card" @onclick="OpenCreateModalFromScratch">
                    <div class="template-picker-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                            <path d="M8 4H20L26 10V28H8V4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M20 4V10H26" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="template-picker-name">Come√ßar do zero</div>
                    <div class="template-picker-description">Crie uma miss√£o em branco e configure tudo manualmente.</div>
                </div>
                @foreach (var template in availableTemplates)
                {
                    <div class="template-picker-card" @onclick="() => OpenCreateModalFromTemplate(template)">
                        <div class="template-picker-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M6 6H26V26H6V6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M11 12H21M11 16H21M11 20H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="template-picker-name">@template.Name</div>
                        <div class="template-picker-description">@(template.Description ?? "Sem descri√ß√£o")</div>
                        <div class="template-picker-badge">@template.Metrics.Count m√©trica(s)</div>
                    </div>
                }
            </div>
        </ChildContent>
    </Modal>
}

@if (isModalOpen)
{
    <Modal Title="@(isEditMode ? "Editar miss√£o" : "Criar miss√£o")" Breadcrumb="@GetSelectedOrganizationName()" Size="lg" OnClose="CloseModal">
        <ChildContent>
            @* Wizard Tabs *@
            <div class="wizard-tabs">
                <button type="button" class="wizard-tab @(wizardStep == 1 ? "active" : "")" @onclick="() => wizardStep = 1">
                    <span class="wizard-tab-number">1</span>
                    <span>Miss√£o</span>
                </button>
                <div class="wizard-tab-separator"></div>
                <button type="button" class="wizard-tab @(wizardStep == 2 ? "active" : "")" @onclick="() => wizardStep = 2">
                    <span class="wizard-tab-number">2</span>
                    <span>M√©tricas</span>
                    @{ var directMetricCount = tempMetrics.Count(m => m.ObjectiveTempId is null); }
                    @if (directMetricCount > 0)
                    {
                        <span class="wizard-tab-badge">@directMetricCount</span>
                    }
                </button>
                <div class="wizard-tab-separator"></div>
                <button type="button" class="wizard-tab @(wizardStep == 3 ? "active" : "")" @onclick="() => wizardStep = 3">
                    <span class="wizard-tab-number">3</span>
                    <span>Objetivos</span>
                    @if (tempObjectives.Count > 0)
                    {
                        <span class="wizard-tab-badge">@tempObjectives.Count</span>
                    }
                </button>
            </div>

            @* Tab 1: Miss√£o *@
            @if (wizardStep == 1)
            {
                <EditForm Model="@newMission">
                    <div class="mission-header">
                        <InputText class="mission-title-input" @bind-Value="newMission.Name" placeholder="Nome da miss√£o" />
                        <input type="text" class="mission-subtitle-input" @bind="missionDescription" placeholder="Adicionar breve descri√ß√£o" />
                    </div>

                    <div class="chips-container">
                        <div class="chip" @onclick="() => showResponsibleSelector = !showResponsibleSelector">
                            <span class="chip-icon">üë§</span>
                            <span>@GetResponsibleLabel()</span>
                        </div>
                        <div class="chip" @onclick="() => showPeriodSelector = !showPeriodSelector">
                            <span class="chip-icon">üìÖ</span>
                            <span>@GetPeriodLabel()</span>
                        </div>
                        @if (isEditMode)
                        {
                            <div class="chip" @onclick="() => showStatusSelector = !showStatusSelector">
                                <span class="chip-icon">üìä</span>
                                <span>@GetStatusChipLabel()</span>
                            </div>
                        }
                    </div>

                    @if (isEditMode && showStatusSelector)
                    {
                        <div class="form-row">
                            <label>Status</label>
                            <select class="input" @bind="editStatusValue">
                                @foreach (var status in Enum.GetValues<MissionStatus>())
                                {
                                    <option value="@status">@GetStatusLabel(status)</option>
                                }
                            </select>
                        </div>
                    }

                    @if (showResponsibleSelector)
                    {
                        <div class="form-row">
                            <label>Escopo</label>
                            <select class="input" value="@createScopeTypeValue" @onchange="OnCreateScopeTypeChanged">
                                <option value="">Selecione</option>
                                @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                                {
                                    <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                                }
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Refer√™ncia</label>
                            <select class="input" @bind="createScopeId">
                                <option value="">Selecione</option>
                                @foreach (var option in GetScopeOptions(createScopeTypeValue))
                                {
                                    <option value="@option.Id">@option.Name</option>
                                }
                            </select>
                        </div>
                    }

                    @if (showPeriodSelector)
                    {
                        <div class="form-row">
                            <label>Data de in√≠cio</label>
                            <InputDate class="input" @bind-Value="newMission.StartDate" />
                        </div>
                        <div class="form-row">
                            <label>Data de fim</label>
                            <InputDate class="input" @bind-Value="newMission.EndDate" />
                        </div>
                    }
                </EditForm>
            }

            @* Tab 2: M√©tricas diretas *@
            @if (wizardStep == 2)
            {
                <div class="wizard-tab-content">
                    <div class="mission-metrics-section">
                        <div class="mission-metrics-section-header">
                            <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 9l-5 5-4-4-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <h3>M√©tricas diretas</h3>
                        </div>

                        @if (tempObjectives.Count > 0)
                        {
                            <p class="wizard-tab-hint">M√©tricas que n√£o pertencem a nenhum objetivo. Para adicionar m√©tricas a um objetivo, use a aba Objetivos.</p>
                        }

                        <MetricFormFields Model="newMetricModel" OnSave="AddMetricFromForm" OnCancel="CancelAddMetricForm" ShowAddButton="true" />

                        @{
                            var directMetrics = tempMetrics
                                .Select((m, idx) => (Metric: m, Index: idx))
                                .Where(x => x.Metric.ObjectiveTempId is null)
                                .ToList();
                        }

                        @if (directMetrics.Any())
                        {
                            <div class="metrics-list">
                                @foreach (var (metric, metricIndex) in directMetrics)
                                {
                                    @if (editingTempMetricIndex == metricIndex)
                                    {
                                        <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                            <MetricFormFields Model="editTempMetricModel" OnSave="SaveTempMetric" OnCancel="CancelTempMetric" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="metric-item">
                                            <div class="metric-info">
                                                <div class="metric-name">@metric.Name</div>
                                                <div class="metric-details">@metric.Details</div>
                                            </div>
                                            <CrudRowActions
                                                EditTitle="Editar m√©trica"
                                                OnEdit="@(() => StartTempMetric(metricIndex))"
                                                IsDeleteConfirming="false"
                                                DeleteTitle="Excluir m√©trica"
                                                OnDelete="@(() => RemoveMetric(metric))" />
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </div>
            }

            @* Tab 3: Objetivos *@
            @if (wizardStep == 3)
            {
                <div class="wizard-tab-content">
                    <div class="mission-metrics-section">
                        <div class="mission-metrics-section-header">
                            <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="6" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="2" stroke-linecap="round"/>
                            </svg>
                            <h3>Objetivos</h3>
                        </div>

                        @if (tempObjectives.Count > 0)
                        {
                            <p class="wizard-tab-hint">Organize as m√©tricas da miss√£o em objetivos. Cada objetivo pode ter suas pr√≥prias m√©tricas.</p>
                        }

                        @if (showObjectiveForm)
                        {
                            <div class="wizard-objective-form">
                                <div class="form-row">
                                    <label>Nome do objetivo</label>
                                    <input type="text" class="input" @bind="tempObjectiveName" placeholder="Ex: Aumentar engajamento, Reduzir churn..." maxlength="200" />
                                </div>
                                <div class="form-row">
                                    <label>Descri√ß√£o (opcional)</label>
                                    <textarea class="input" @bind="tempObjectiveDescription" placeholder="Breve descri√ß√£o do objetivo" maxlength="1000" rows="2"></textarea>
                                </div>
                                <div class="form-actions" style="margin-top: var(--spacing-3);">
                                    <button type="button" class="button tertiary" @onclick="CancelAddObjective">Cancelar</button>
                                    <button type="button" class="button primary" @onclick="AddTempObjective">Salvar objetivo</button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <button type="button" class="metrics-add-button" @onclick="() => showObjectiveForm = true">
                                <span>Adicionar objetivo</span>
                                <span class="metrics-add-icon">+</span>
                            </button>
                        }

                        @if (tempObjectives.Count > 0)
                        {
                            <div class="metrics-list">
                                @for (var i = 0; i < tempObjectives.Count; i++)
                                {
                                    var index = i;
                                    var obj = tempObjectives[index];

                                    @if (editingTempObjectiveIndex == index)
                                    {
                                        <div class="wizard-objective-card">
                                            <div class="form-row">
                                                <label>Nome</label>
                                                <input type="text" class="input" @bind="editingObjectiveName" maxlength="200" />
                                            </div>
                                            <div class="form-row">
                                                <label>Descri√ß√£o</label>
                                                <textarea class="input" @bind="editingObjectiveDescription" maxlength="1000" rows="2"></textarea>
                                            </div>
                                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                                <button type="button" class="button tertiary" @onclick="CancelEditTempObjective">Cancelar</button>
                                                <button type="button" class="button primary" @onclick="SaveEditTempObjective">Salvar</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="wizard-objective-card">
                                            <div class="wizard-objective-header">
                                                <div class="wizard-objective-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                                                        <circle cx="12" cy="12" r="6" stroke-linecap="round"/>
                                                        <circle cx="12" cy="12" r="2" stroke-linecap="round"/>
                                                    </svg>
                                                </div>
                                                <div class="metric-info">
                                                    <div class="metric-name">@obj.Name</div>
                                                    @if (!string.IsNullOrWhiteSpace(obj.Description))
                                                    {
                                                        <div class="metric-details">@obj.Description</div>
                                                    }
                                                </div>
                                                <CrudRowActions
                                                    EditTitle="Editar objetivo"
                                                    OnEdit="@(() => StartEditTempObjective(index))"
                                                    IsDeleteConfirming="false"
                                                    DeleteTitle="Excluir objetivo"
                                                    OnDelete="@(() => RemoveTempObjective(index))" />
                                            </div>

                                            @* Adicionar m√©trica ao objetivo *@
                                            @if (addingMetricToObjectiveTempId == obj.TempId)
                                            {
                                                <div style="margin-top: var(--spacing-3);">
                                                    <MetricFormFields Model="newMetricModel" OnSave="AddMetricToObjective" OnCancel="CancelAddMetricToObjective" />
                                                </div>
                                            }
                                            else
                                            {
                                                <button type="button" class="metrics-add-button" style="margin-top: var(--spacing-3);" @onclick="() => StartAddMetricToObjective(obj.TempId)">
                                                    <span>Adicionar m√©trica</span>
                                                    <span class="metrics-add-icon">+</span>
                                                </button>
                                            }

                                            @* M√©tricas deste objetivo *@
                                            @{
                                                var objMetrics = tempMetrics
                                                    .Select((m, idx) => (Metric: m, Index: idx))
                                                    .Where(x => x.Metric.ObjectiveTempId == obj.TempId)
                                                    .ToList();
                                            }

                                            @if (objMetrics.Any())
                                            {
                                                <div class="metrics-list" style="margin-top: var(--spacing-3);">
                                                    @foreach (var (metric, metricIndex) in objMetrics)
                                                    {
                                                        @if (editingTempMetricIndex == metricIndex)
                                                        {
                                                            <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                                                <MetricFormFields Model="editTempMetricModel" OnSave="SaveTempMetric" OnCancel="CancelTempMetric" />
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="metric-item">
                                                                <div class="metric-info">
                                                                    <div class="metric-name">@metric.Name</div>
                                                                    <div class="metric-details">@metric.Details</div>
                                                                </div>
                                                                <CrudRowActions
                                                                    EditTitle="Editar m√©trica"
                                                                    OnEdit="@(() => StartTempMetric(metricIndex))"
                                                                    IsDeleteConfirming="false"
                                                                    DeleteTitle="Excluir m√©trica"
                                                                    OnDelete="@(() => RemoveMetric(metric))" />
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    @if (wizardStep > 1)
                    {
                        <button class="button tertiary" type="button" @onclick="() => wizardStep--">Voltar</button>
                    }
                    @if (wizardStep < 3)
                    {
                        <button class="button secondary" type="button" @onclick="() => wizardStep++">Pr√≥ximo</button>
                    }
                    else
                    {
                        @if (isEditMode)
                        {
                            <button class="button primary" type="button" @onclick="UpdateMissionFromWizard">Salvar altera√ß√µes</button>
                        }
                        else
                        {
                            <button class="button secondary" type="button" @onclick="SaveDraft">Salvar rascunho</button>
                            <button class="button primary" type="button" @onclick="CreateMission">Criar miss√£o</button>
                        }
                    }
                </div>
            </div>
        </Footer>
    </Modal>
}


@* Modal de Check-in *@
@if (isCheckinModalOpen && checkinMission != null && selectedCheckinMetric != null)
{
    <Modal Title="Novo check-in" Breadcrumb="@selectedCheckinMetric.Name" Size="md" OnClose="CloseCheckinModal">
        <ChildContent>
            <div class="metrics-form-container">
                @if (selectedCheckinMetric.Type == MetricType.Quantitative)
                {
                    <div class="form-row">
                        <label>Valor atual @GetCheckinTargetHint(selectedCheckinMetric)</label>
                        <InputNumber class="input" @bind-Value="newCheckin.Value" placeholder="Ex: 42" />
                    </div>
                }
                else
                {
                    <div class="form-row">
                        <label>Texto de progresso</label>
                        <InputText class="input" @bind-Value="newCheckin.Text" placeholder="Descreva o progresso atual" />
                    </div>
                }

                <div class="form-row">
                    <label>N√≠vel de confian√ßa</label>
                    <div class="confidence-selector">
                        @for (int i = 1; i <= 5; i++)
                        {
                            var level = i;
                            <button type="button"
                                    class="confidence-btn @(newCheckin.ConfidenceLevel >= level ? "active" : "")"
                                    @onclick="() => newCheckin.ConfidenceLevel = level">
                                @level
                            </button>
                        }
                    </div>
                </div>

                <div class="form-row">
                    <label>Nota (opcional)</label>
                    <InputText class="input" @bind-Value="newCheckin.Note" placeholder="Contexto adicional sobre o progresso" />
                </div>
            </div>

            <div class="form-actions" style="margin-top: var(--spacing-6);">
                <button class="button tertiary" type="button" @onclick="CloseCheckinModal">Cancelar</button>
                <button class="button primary" @onclick="CreateCheckin">Criar check-in</button>
            </div>
        </ChildContent>
    </Modal>
}

@if (isCheckinHistoryModalOpen && historyMetric != null && historyMission != null)
{
    <Modal Title="Hist√≥rico de check-ins" Breadcrumb="@historyMetric.Name" Size="lg" OnClose="CloseCheckinHistoryModal">
        <ChildContent>
            <div class="checkin-history-container">
                <div class="checkin-history-header">
                    <div class="checkin-history-metric-info">
                        <div class="checkin-history-metric-name">@historyMetric.Name</div>
                        <div class="checkin-history-metric-target">@GetTargetLabel(historyMetric)</div>
                    </div>
                    <button class="button primary" @onclick="OpenCheckinFromHistory">
                        <span class="button-icon-text">+</span>
                        Novo check-in
                    </button>
                </div>

                @if (isLoadingCheckins)
                {
                    <div class="checkin-history-loading">
                        <p class="muted">Carregando check-ins...</p>
                    </div>
                }
                else if (!metricCheckins.Any())
                {
                    <div class="checkin-history-empty">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                            <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p>Nenhum check-in registrado para esta m√©trica.</p>
                        <p class="muted">Registre seu primeiro check-in para acompanhar o progresso.</p>
                    </div>
                }
                else
                {
                    <div class="checkin-timeline">
                        @foreach (var checkin in metricCheckins)
                        {
                            var confidenceClass = checkin.ConfidenceLevel >= 4 ? "high" : checkin.ConfidenceLevel >= 2 ? "medium" : "low";
                            var collaboratorName = checkin.Collaborator?.FullName ?? "Colaborador";
                            <div class="checkin-timeline-item">
                                <div class="checkin-timeline-marker">
                                    <div class="checkin-timeline-dot @confidenceClass"></div>
                                    <div class="checkin-timeline-line"></div>
                                </div>
                                <div class="checkin-timeline-content">
                                    <div class="checkin-timeline-header">
                                        <div class="checkin-timeline-author">
                                            <div class="checkin-timeline-avatar" title="@collaboratorName">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                                                </svg>
                                            </div>
                                            <span class="checkin-timeline-author-name">@collaboratorName</span>
                                        </div>
                                        <div class="checkin-timeline-meta">
                                            <span class="checkin-timeline-date">@checkin.CheckinDate.ToString("dd/MM/yyyy")</span>
                                            <span class="checkin-timeline-confidence" title="N√≠vel de confian√ßa: @checkin.ConfidenceLevel">
                                                @GetConfidenceStarsDisplay(checkin.ConfidenceLevel)
                                            </span>
                                        </div>
                                    </div>
                                    <div class="checkin-timeline-value">
                                        @GetCheckinValueDisplay(checkin, historyMetric)
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(checkin.Note))
                                    {
                                        <div class="checkin-timeline-note">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <span>@checkin.Note</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </ChildContent>
    </Modal>
}


@code {
    private sealed record ScopeOption(string Id, string Name);
    private sealed record TempMetric(Guid? OriginalId, string Name, string Type, string Details, string? QuantitativeType = null, decimal? MinValue = null, decimal? MaxValue = null, string? TargetText = null, string? Unit = null, string? ObjectiveTempId = null);
    private sealed record TempObjective(string TempId, string Name, string? Description, Guid? OriginalId = null);

    private CreateMissionRequest newMission = new();
    private PagedResult<Mission>? missions;
    private Dictionary<Guid, MissionProgressDto> missionProgress = new();
    private List<Organization> organizations = new();
    private List<Workspace> workspaces = new();
    private List<Team> teams = new();
    private List<Collaborator> collaborators = new();
    private string? createScopeTypeValue;
    private string? createScopeId;
    private string? filterScopeTypeValue;
    private string? filterScopeId;
    private string? search;
    private string viewMode = "list"; // "list" ou "grid"
    private bool isModalOpen = false;
    private bool showResponsibleSelector = false;
    private bool showPeriodSelector = false;
    private string? missionDescription;
    private MetricFormFields.MetricFormModel newMetricModel = new();
    private List<TempMetric> tempMetrics = new();

    // Wizard state
    private int wizardStep = 1;
    private List<TempObjective> tempObjectives = new();
    private string tempObjectiveName = "";
    private string? tempObjectiveDescription;
    private int? editingTempObjectiveIndex;
    private string editingObjectiveName = "";
    private string? editingObjectiveDescription;
    private string? addingMetricToObjectiveTempId;
    private bool showObjectiveForm;

    // Temp metric edit state
    private int? editingTempMetricIndex;
    private MetricFormFields.MetricFormModel editTempMetricModel = new();

    // Card expansion state
    private HashSet<Guid> expandedMissions = new();
    private Dictionary<Guid, List<MissionMetric>> missionMetricsCache = new();
    private Dictionary<Guid, MetricProgressDto> metricProgressCache = new();
    private Dictionary<Guid, List<MissionObjective>> missionObjectivesCache = new();
    private Dictionary<Guid, ObjectiveProgressDto> objectiveProgressCache = new();
    private HashSet<Guid> expandedObjectives = new();

    // Checkin modal state
    private bool isCheckinModalOpen = false;
    private Mission? checkinMission = null;
    private List<MissionMetric> checkinMetrics = new();
    private string? checkinMetricId;
    private MissionMetric? selectedCheckinMetric;
    private CreateMetricCheckinRequest newCheckin = new();
    private DateOnly checkinDate = DateOnly.FromDateTime(DateTime.Today);

    // Edit mode state (unified wizard)
    private bool isEditMode;
    private Guid? editingMissionId;
    private string? editStatusValue;
    private bool showStatusSelector = false;
    private HashSet<Guid> deletedMetricIds = new();
    private HashSet<Guid> deletedObjectiveIds = new();
    private List<TempMetric> originalTempMetrics = new();
    private List<TempObjective> originalTempObjectives = new();

    // Delete confirmation state
    private Guid? deletingMissionId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    // Template picker state
    private bool isTemplatePickerOpen = false;
    private List<MissionTemplate> availableTemplates = new();

    // Mission view mode
    private bool showMyMissions = true;

    // Filter panel state
    private bool showFilterPanel = false;
    private bool filterActiveOnly = true;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private bool showDatePicker = false;

    // Checkin history modal state
    private bool isCheckinHistoryModalOpen = false;
    private MissionMetric? historyMetric = null;
    private Mission? historyMission = null;
    private List<MetricCheckin> metricCheckins = new();
    private bool isLoadingCheckins = false;

    protected override async Task OnInitializedAsync()
    {
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };

        // Subscribe to organization changes
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;

        // Aguardar inicializa√ß√£o do OrgContext (MainLayout pode ainda estar carregando)
        var maxWait = 50; // 50 * 100ms = 5 segundos m√°ximo
        while (!OrgContext.IsInitialized && maxWait > 0)
        {
            await Task.Delay(100);
            maxWait--;
        }

        await AuthState.EnsureInitializedAsync();
        await LoadReferenceData();
        await LoadMissions();
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                filterScopeTypeValue = null;
                filterScopeId = null;
                await LoadReferenceData();
                await LoadMissions();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar miss√µes por troca de organiza√ß√£o: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar miss√µes", "N√£o foi poss√≠vel atualizar os dados da organiza√ß√£o selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadReferenceData()
    {
        // Filtrar dados pelo tenant selecionado
        var orgId = OrgContext.SelectedOrganizationId;

        var orgsResult = await Api.GetOrganizationsAsync(null, 1, 100);
        organizations = orgsResult?.Items.ToList() ?? new List<Organization>();

        var workspacesResult = await Api.GetWorkspacesAsync(orgId, null, 1, 100);
        workspaces = workspacesResult?.Items.ToList() ?? new List<Workspace>();

        var teamsResult = await Api.GetTeamsAsync(null, null, null, 1, 100);
        teams = teamsResult?.Items.ToList() ?? new List<Team>();

        var collaboratorsResult = await Api.GetCollaboratorsAsync(null, null, 1, 100);
        collaborators = collaboratorsResult?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task SetMissionViewMode(bool myMissions)
    {
        if (showMyMissions == myMissions)
        {
            return;
        }

        showMyMissions = myMissions;

        if (showMyMissions)
        {
            filterScopeTypeValue = null;
            filterScopeId = null;
            showFilterPanel = false;
        }

        await LoadMissions();
    }

    private async Task LoadMissions()
    {
        PagedResult<Mission> result;

        if (showMyMissions)
        {
            var collaboratorId = AuthState.Session?.CollaboratorId;
            if (collaboratorId.HasValue)
            {
                result = await Api.GetMyMissionsAsync(collaboratorId.Value, search, 1, 100) ?? new PagedResult<Mission>();
            }
            else
            {
                // Global admin without CollaboratorId ‚Äî fallback to all missions
                result = await Api.GetMissionsAsync(null, null, search, 1, 100) ?? new PagedResult<Mission>();
            }
        }
        else
        {
            var scopeType = ParseScopeType(filterScopeTypeValue);
            var scopeId = Guid.TryParse(filterScopeId, out var parsedScopeId)
                ? parsedScopeId
                : (Guid?)null;

            result = await Api.GetMissionsAsync(scopeType, scopeId, search, 1, 100) ?? new PagedResult<Mission>();
        }

        // Apply client-side filters
        var filteredItems = result.Items.AsEnumerable();

        // Filter by active status
        if (filterActiveOnly)
        {
            filteredItems = filteredItems.Where(m => m.Status == MissionStatus.Active);
        }

        // Filter by date range
        if (filterStartDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.EndDate >= filterStartDate.Value);
        }
        if (filterEndDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.StartDate <= filterEndDate.Value);
        }

        var filteredList = filteredItems.ToList();
        missions = new PagedResult<Mission>
        {
            Items = filteredList,
            Total = filteredList.Count,
            Page = 1,
            PageSize = filteredList.Count
        };

        await LoadProgress();
    }

    private async Task LoadProgress()
    {
        if (missions is null || missions.Items.Count == 0)
        {
            missionProgress = new();
            return;
        }

        try
        {
            var ids = missions.Items.Select(m => m.Id).ToList();
            var progressList = await Api.GetMissionProgressAsync(ids);
            missionProgress = progressList?.ToDictionary(p => p.MissionId) ?? new();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar progresso das miss√µes: {ex.Message}");
            missionProgress = new();
        }
    }

    private async Task LoadMetricProgress(Guid missionId)
    {
        if (!missionMetricsCache.TryGetValue(missionId, out var metrics) || metrics.Count == 0)
            return;

        try
        {
            var metricIds = metrics.Select(m => m.Id).ToList();
            var progressList = await Api.GetMetricProgressAsync(metricIds);
            if (progressList != null)
            {
                foreach (var progress in progressList)
                {
                    metricProgressCache[progress.MetricId] = progress;
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar progresso das m√©tricas: {ex.Message}");
        }
    }

    private async Task OnCreateScopeTypeChanged(ChangeEventArgs e)
    {
        createScopeTypeValue = e.Value?.ToString();
        createScopeId = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFilterScopeTypeChanged(ChangeEventArgs e)
    {
        filterScopeTypeValue = e.Value?.ToString();
        filterScopeId = null;
        await LoadMissions();
    }

    private void ToggleFilterPanel()
    {
        showFilterPanel = !showFilterPanel;
    }

    private void ToggleViewMode()
    {
        viewMode = viewMode == "list" ? "grid" : "list";
    }

    private async Task ClearFilters()
    {
        filterScopeTypeValue = null;
        filterScopeId = null;
        search = null;
        filterActiveOnly = false;
        filterStartDate = null;
        filterEndDate = null;
        showDatePicker = false;
        await LoadMissions();
    }

    private bool HasActiveFilters()
    {
        return (!showMyMissions && !string.IsNullOrEmpty(filterScopeTypeValue))
            || !string.IsNullOrEmpty(search)
            || filterStartDate.HasValue
            || filterEndDate.HasValue;
    }

    private void ToggleDatePicker()
    {
        showDatePicker = !showDatePicker;
    }

    private void OnStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            filterStartDate = date;
        }
        else
        {
            filterStartDate = null;
        }
    }

    private void OnEndDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            filterEndDate = date;
        }
        else
        {
            filterEndDate = null;
        }
    }

    private async Task ApplyDateFilter()
    {
        showDatePicker = false;
        await LoadMissions();
    }

    private async Task ToggleActiveFilter()
    {
        filterActiveOnly = !filterActiveOnly;
        await LoadMissions();
    }

    private string GetDateRangeLabel()
    {
        if (filterStartDate.HasValue && filterEndDate.HasValue)
        {
            return $"{filterStartDate:dd/MM} - {filterEndDate:dd/MM/yyyy}";
        }
        if (filterStartDate.HasValue)
        {
            return $"A partir de {filterStartDate:dd/MM/yyyy}";
        }
        if (filterEndDate.HasValue)
        {
            return $"At√© {filterEndDate:dd/MM/yyyy}";
        }
        return "Selecionar per√≠odo";
    }

    private string GetStatusFilterLabel()
    {
        return filterActiveOnly ? "Status ativo" : "Todos os status";
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadMissions();
        }
    }

    private async Task OpenCreateModal()
    {
        // Load available templates and open the picker
        try
        {
            var result = await Api.GetMissionTemplatesAsync(null, 1, 50);
            availableTemplates = result?.Items
                .Where(t => t.IsActive)
                .ToList() ?? new();
        }
        catch
        {
            availableTemplates = new();
        }

        isTemplatePickerOpen = true;
    }

    private void OpenCreateModalFromScratch()
    {
        isTemplatePickerOpen = false;
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        missionDescription = null;
        showResponsibleSelector = false;
        showPeriodSelector = false;
        tempMetrics.Clear();
        tempObjectives.Clear();
        newMetricModel.Clear();
        wizardStep = 1;
        tempObjectiveName = "";
        tempObjectiveDescription = null;
        editingTempObjectiveIndex = null;
        addingMetricToObjectiveTempId = null;
        isModalOpen = true;
    }

    private void OpenCreateModalFromTemplate(MissionTemplate template)
    {
        isTemplatePickerOpen = false;
        newMission = new CreateMissionRequest
        {
            Name = template.MissionNamePattern ?? string.Empty,
            Description = template.MissionDescriptionPattern,
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(90),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        missionDescription = template.MissionDescriptionPattern;
        showResponsibleSelector = false;
        showPeriodSelector = false;

        // Pre-fill metrics from template
        tempMetrics = template.Metrics
            .OrderBy(m => m.OrderIndex)
            .Select(m => new TempMetric(
                null,
                m.Name,
                m.Type.ToString(),
                GetTemplateMetricDetails(m),
                m.QuantitativeType?.ToString(),
                m.MinValue,
                m.MaxValue,
                m.TargetText,
                m.Unit?.ToString()))
            .ToList();

        newMetricModel.Clear();
        tempObjectives.Clear();
        wizardStep = 1;
        tempObjectiveName = "";
        tempObjectiveDescription = null;
        editingTempObjectiveIndex = null;
        addingMetricToObjectiveTempId = null;
        isModalOpen = true;
    }

    private static string GetTemplateMetricDetails(MissionTemplateMetric metric)
    {
        if (metric.Type == MetricType.Qualitative)
            return $"Qualitativa ‚Äî {metric.TargetText}";

        var parts = new List<string> { "Quantitativa" };
        if (metric.QuantitativeType.HasValue)
            parts.Add(metric.QuantitativeType.Value.ToString());
        if (metric.Unit.HasValue)
            parts.Add(metric.Unit.Value.ToString());
        if (metric.MinValue.HasValue)
            parts.Add($"Min: {metric.MinValue}");
        if (metric.MaxValue.HasValue)
            parts.Add($"Max: {metric.MaxValue}");
        return string.Join(" ‚Äî ", parts);
    }

    private void CloseModal()
    {
        isModalOpen = false;
        wizardStep = 1;
        tempObjectives.Clear();
        tempMetrics.Clear();
        tempObjectiveName = "";
        tempObjectiveDescription = null;
        editingTempObjectiveIndex = null;
        addingMetricToObjectiveTempId = null;
        showObjectiveForm = false;
        isEditMode = false;
        editingMissionId = null;
        editStatusValue = null;
        showStatusSelector = false;
        deletedMetricIds.Clear();
        deletedObjectiveIds.Clear();
        originalTempMetrics.Clear();
        originalTempObjectives.Clear();
    }

    private string GetSelectedOrganizationName()
    {
        return organizations.FirstOrDefault()?.Name ?? "Organiza√ß√£o";
    }

    private string GetResponsibleLabel()
    {
        if (!string.IsNullOrEmpty(createScopeId) && Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            var option = GetScopeOptions(createScopeTypeValue).FirstOrDefault(o => o.Id == createScopeId);
            if (option != null)
            {
                return $"Respons√°vel: {option.Name}";
            }
        }
        return "Respons√°vel";
    }

    private string GetPeriodLabel()
    {
        if (newMission.StartDate != DateTime.MinValue && newMission.EndDate != DateTime.MinValue)
        {
            return $"Per√≠odo de in√≠cio e fim: {newMission.StartDate:dd/MM/yyyy} - {newMission.EndDate:dd/MM/yyyy}";
        }
        return "Per√≠odo de in√≠cio e fim";
    }

    private async Task SaveDraft()
    {
        if (!TryValidateMissionCreation("Erro ao salvar rascunho", out var scopeType, out var scopeId))
        {
            return;
        }

        await CreateMissionWithStatusAsync(
            scopeType,
            scopeId,
            MissionStatus.Planned,
            "Rascunho salvo com sucesso!",
            _ => "A miss√£o foi salva como rascunho.",
            "Erro ao salvar rascunho",
            "N√£o foi poss√≠vel salvar o rascunho da miss√£o. Verifique os dados e tente novamente.");
    }

    private void FlushPendingMetric()
    {
        if (!string.IsNullOrWhiteSpace(newMetricModel.Name) && !string.IsNullOrWhiteSpace(newMetricModel.TypeValue))
        {
            var details = newMetricModel.TypeValue == "Quantitative"
                ? BuildQuantitativeDetailsFrom(newMetricModel.QuantitativeTypeValue, newMetricModel.MinValue, newMetricModel.MaxValue, newMetricModel.UnitValue)
                : newMetricModel.TargetText ?? "";

            tempMetrics.Add(new TempMetric(
                null,
                newMetricModel.Name,
                newMetricModel.TypeValue,
                details,
                newMetricModel.QuantitativeTypeValue,
                newMetricModel.MinValue,
                newMetricModel.MaxValue,
                newMetricModel.TargetText,
                newMetricModel.UnitValue
            ));

            newMetricModel.Clear();
        }
    }

    private async Task CreateObjectivesAndMetricsForMission(Mission? createdMission)
    {
        if (createdMission is null)
        {
            return;
        }

        var failedCount = 0;

        // Phase 1: Create objectives and build TempId ‚Üí real Guid mapping
        var objectiveIdMap = new Dictionary<string, Guid>();
        foreach (var tempObj in tempObjectives)
        {
            try
            {
                var created = await Api.CreateMissionObjectiveAsync(new CreateMissionObjectiveRequest
                {
                    MissionId = createdMission.Id,
                    Name = tempObj.Name,
                    Description = tempObj.Description
                });

                if (created != null)
                {
                    objectiveIdMap[tempObj.TempId] = created.Id;
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erro ao criar objetivo '{tempObj.Name}' para miss√£o {createdMission.Id}: {ex.Message}");
                failedCount++;
            }
        }

        // Phase 2: Create metrics with resolved objective IDs
        foreach (var tempMetric in tempMetrics)
        {
            if (!EnumParsingHelper.TryParseEnum<MetricType>(tempMetric.Type, out var metricType))
            {
                failedCount++;
                continue;
            }

            var metricRequest = new CreateMissionMetricRequest
            {
                MissionId = createdMission.Id,
                Name = tempMetric.Name,
                Type = metricType
            };

            // Resolve objective reference
            if (tempMetric.ObjectiveTempId is not null && objectiveIdMap.TryGetValue(tempMetric.ObjectiveTempId, out var realObjectiveId))
            {
                metricRequest.MissionObjectiveId = realObjectiveId;
            }

            if (tempMetric.Type == "Quantitative")
            {
                if (!string.IsNullOrEmpty(tempMetric.QuantitativeType))
                {
                    if (EnumParsingHelper.TryParseEnum<QuantitativeMetricType>(tempMetric.QuantitativeType, out var quantitativeType))
                    {
                        metricRequest.QuantitativeType = quantitativeType;
                    }
                    else
                    {
                        failedCount++;
                        continue;
                    }
                }
                metricRequest.MinValue = tempMetric.MinValue;
                metricRequest.MaxValue = tempMetric.MaxValue;
                if (!string.IsNullOrEmpty(tempMetric.Unit))
                {
                    if (EnumParsingHelper.TryParseEnum<MetricUnit>(tempMetric.Unit, out var unit))
                    {
                        metricRequest.Unit = unit;
                    }
                    else
                    {
                        failedCount++;
                        continue;
                    }
                }
            }
            else
            {
                metricRequest.TargetText = tempMetric.TargetText;
            }

            try
            {
                await Api.CreateMissionMetricAsync(metricRequest);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erro ao criar m√©trica '{tempMetric.Name}' para miss√£o {createdMission.Id}: {ex.Message}");
                failedCount++;
            }
        }

        if (failedCount > 0)
        {
            ToastService.ShowError("Erro ao salvar", $"{failedCount} item(ns) n√£o puderam ser salvos.");
        }
    }

    private void CancelAddMetricForm()
    {
        newMetricModel.Clear();
    }

    private void AddMetricFromForm()
    {
        if (!ValidateMetricModel(newMetricModel)) return;

        var details = newMetricModel.TypeValue == "Quantitative"
            ? BuildQuantitativeDetailsFrom(newMetricModel.QuantitativeTypeValue, newMetricModel.MinValue, newMetricModel.MaxValue, newMetricModel.UnitValue)
            : newMetricModel.TargetText ?? "";

        tempMetrics.Add(new TempMetric(
            null,
            newMetricModel.Name,
            newMetricModel.TypeValue!,
            details,
            newMetricModel.QuantitativeTypeValue,
            newMetricModel.MinValue,
            newMetricModel.MaxValue,
            newMetricModel.TargetText,
            newMetricModel.UnitValue
        ));

        newMetricModel.Clear();
    }

    private void RemoveMetric(TempMetric metric)
    {
        tempMetrics.Remove(metric);
        if (isEditMode && metric.OriginalId.HasValue)
        {
            deletedMetricIds.Add(metric.OriginalId.Value);
        }
    }

    private void StartAddMetricToObjective(string objectiveTempId)
    {
        addingMetricToObjectiveTempId = objectiveTempId;
        newMetricModel.Clear();
    }

    private void AddMetricToObjective()
    {
        if (!ValidateMetricModel(newMetricModel)) return;

        var details = newMetricModel.TypeValue == "Quantitative"
            ? BuildQuantitativeDetailsFrom(newMetricModel.QuantitativeTypeValue, newMetricModel.MinValue, newMetricModel.MaxValue, newMetricModel.UnitValue)
            : newMetricModel.TargetText ?? "";

        tempMetrics.Add(new TempMetric(
            null,
            newMetricModel.Name,
            newMetricModel.TypeValue!,
            details,
            newMetricModel.QuantitativeTypeValue,
            newMetricModel.MinValue,
            newMetricModel.MaxValue,
            newMetricModel.TargetText,
            newMetricModel.UnitValue,
            addingMetricToObjectiveTempId
        ));

        newMetricModel.Clear();
        addingMetricToObjectiveTempId = null;
    }

    private void CancelAddMetricToObjective()
    {
        addingMetricToObjectiveTempId = null;
        newMetricModel.Clear();
    }

    private void StartTempMetric(int index)
    {
        var metric = tempMetrics[index];
        editingTempMetricIndex = index;
        editTempMetricModel = new MetricFormFields.MetricFormModel
        {
            Name = metric.Name,
            TypeValue = metric.Type,
            QuantitativeTypeValue = metric.QuantitativeType,
            UnitValue = metric.Unit,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };
    }

    private void CancelTempMetric()
    {
        editingTempMetricIndex = null;
        editTempMetricModel.Clear();
    }

    private void SaveTempMetric()
    {
        if (editingTempMetricIndex is null) return;

        if (!ValidateMetricModel(editTempMetricModel)) return;

        var details = editTempMetricModel.TypeValue == "Quantitative"
            ? BuildQuantitativeDetailsFrom(editTempMetricModel.QuantitativeTypeValue, editTempMetricModel.MinValue, editTempMetricModel.MaxValue, editTempMetricModel.UnitValue)
            : editTempMetricModel.TargetText ?? "";

        var existing = tempMetrics[editingTempMetricIndex.Value];

        tempMetrics[editingTempMetricIndex.Value] = new TempMetric(
            existing.OriginalId,
            editTempMetricModel.Name,
            editTempMetricModel.TypeValue!,
            details,
            editTempMetricModel.QuantitativeTypeValue,
            editTempMetricModel.MinValue,
            editTempMetricModel.MaxValue,
            editTempMetricModel.TargetText,
            editTempMetricModel.UnitValue,
            existing.ObjectiveTempId
        );

        CancelTempMetric();
    }

    private string BuildQuantitativeDetailsFrom(string? quantitativeType, decimal? minValue, decimal? maxValue, string? unit)
    {
        var unitLabel = GetUnitLabelShort(unit);
        return quantitativeType switch
        {
            "KeepAbove" => $"Acima de {minValue} {unitLabel}",
            "KeepBelow" => $"Abaixo de {maxValue} {unitLabel}",
            "KeepBetween" => $"Entre {minValue} e {maxValue} {unitLabel}",
            "Achieve" => $"Atingir {maxValue} {unitLabel}",
            "Reduce" => $"Reduzir para {maxValue} {unitLabel}",
            _ => ""
        };
    }

    private string GetUnitLabelShort(string? unit) => unit switch
    {
        "Integer" => "un",
        "Decimal" => "un",
        "Percentage" => "%",
        "Hours" => "h",
        "Points" => "pts",
        _ => ""
    };

    private async Task CreateMission()
    {
        if (!TryValidateMissionCreation("Erro ao criar miss√£o", out var scopeType, out var scopeId))
        {
            return;
        }

        await CreateMissionWithStatusAsync(
            scopeType,
            scopeId,
            MissionStatus.Active,
            "Miss√£o criada com sucesso!",
            createdMission => $"A miss√£o '{createdMission?.Name}' foi criada e est√° ativa.",
            "Erro ao criar miss√£o",
            "N√£o foi poss√≠vel criar a miss√£o. Verifique os dados e tente novamente.");
    }

    private bool ValidateMetricModel(MetricFormFields.MetricFormModel model)
    {
        if (string.IsNullOrWhiteSpace(model.Name) || string.IsNullOrWhiteSpace(model.TypeValue))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome e tipo da m√©trica.");
            return false;
        }

        return true;
    }

    private bool TryValidateMissionCreation(string errorTitle, out MissionScopeType scopeType, out Guid scopeId)
    {
        scopeType = default;
        scopeId = Guid.Empty;

        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out scopeType))
        {
            ToastService.ShowError(errorTitle, "Selecione o escopo.");
            return false;
        }

        if (!Guid.TryParse(createScopeId, out scopeId))
        {
            ToastService.ShowError(errorTitle, "Selecione a refer√™ncia do escopo.");
            return false;
        }

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            ToastService.ShowError(errorTitle, "Informe o nome da miss√£o.");
            return false;
        }

        if (newMission.EndDate < newMission.StartDate)
        {
            ToastService.ShowError(errorTitle, "A data de fim precisa ser igual ou maior que a data de in√≠cio.");
            return false;
        }

        return true;
    }

    private async Task CreateMissionWithStatusAsync(
        MissionScopeType scopeType,
        Guid scopeId,
        MissionStatus status,
        string successTitle,
        Func<Mission?, string> successMessageFactory,
        string errorTitle,
        string errorMessage)
    {
        FlushPendingMetric();

        await UiOps.RunAsync(
            async () =>
            {
                newMission.ScopeType = scopeType;
                newMission.ScopeId = scopeId;
                newMission.Description = missionDescription;
                newMission.Status = status;

                var createdMission = await Api.CreateMissionAsync(newMission);
                await CreateObjectivesAndMetricsForMission(createdMission);

                newMission = new CreateMissionRequest
                {
                    StartDate = DateTime.Today,
                    EndDate = DateTime.Today.AddDays(7),
                    Status = MissionStatus.Planned
                };
                createScopeTypeValue = null;
                createScopeId = null;

                await LoadMissions();

                ToastService.ShowSuccess(successTitle, successMessageFactory(createdMission));
                CloseModal();
            },
            errorTitle,
            errorMessage);
    }

    private IEnumerable<ScopeOption> GetScopeOptions(string? scopeTypeValue)
    {
        if (!Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType))
        {
            return Enumerable.Empty<ScopeOption>();
        }

        return scopeType switch
        {
            MissionScopeType.Organization => organizations.Select(o => new ScopeOption(o.Id.ToString(), o.Name)),
            MissionScopeType.Workspace => workspaces.Select(w => new ScopeOption(w.Id.ToString(), w.Name)),
            MissionScopeType.Team => teams.Select(t => new ScopeOption(t.Id.ToString(), t.Name)),
            MissionScopeType.Collaborator => collaborators.Select(c => new ScopeOption(c.Id.ToString(), c.FullName)),
            _ => Enumerable.Empty<ScopeOption>()
        };
    }

    private MissionScopeType? ParseScopeType(string? scopeTypeValue)
    {
        return Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType) ? scopeType : null;
    }

    private string GetMissionScopeName(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
        {
            return collaborators.FirstOrDefault(c => c.Id == mission.CollaboratorId.Value)?.FullName ?? "‚Äî";
        }

        if (mission.TeamId.HasValue)
        {
            return teams.FirstOrDefault(t => t.Id == mission.TeamId.Value)?.Name ?? "‚Äî";
        }

        if (mission.WorkspaceId.HasValue)
        {
            return workspaces.FirstOrDefault(w => w.Id == mission.WorkspaceId.Value)?.Name ?? "‚Äî";
        }

        // Org-scoped: no other scope FK is set, OrganizationId is always present
        return organizations.FirstOrDefault(o => o.Id == mission.OrganizationId)?.Name ?? "‚Äî";
    }

    private static string GetScopeLabel(MissionScopeType scopeType) => scopeType switch
    {
        MissionScopeType.Organization => "Organiza√ß√£o",
        MissionScopeType.Workspace => "Espa√ßo de trabalho",
        MissionScopeType.Team => "Equipe",
        MissionScopeType.Collaborator => "Colaborador",
        _ => scopeType.ToString()
    };

    private static string GetStatusLabel(MissionStatus status) => status switch
    {
        MissionStatus.Planned => "Planejada",
        MissionStatus.Active => "Ativa",
        MissionStatus.Completed => "Conclu√≠da",
        MissionStatus.Cancelled => "Cancelada",
        _ => status.ToString()
    };

    // ---- Card Expansion Methods ----

    private async Task ToggleExpand(Guid missionId)
    {
        if (expandedMissions.Contains(missionId))
        {
            expandedMissions.Remove(missionId);
        }
        else
        {
            expandedMissions.Add(missionId);
            if (!missionMetricsCache.ContainsKey(missionId))
            {
                var metricsTask = Api.GetMissionMetricsByMissionIdAsync(missionId);
                var objectivesTask = Api.GetMissionObjectivesAsync(missionId);
                await Task.WhenAll(metricsTask, objectivesTask);

                var metrics = metricsTask.Result?.Items.ToList() ?? new List<MissionMetric>();
                missionMetricsCache[missionId] = metrics;

                var objectives = objectivesTask.Result?.Items.ToList() ?? new List<MissionObjective>();
                missionObjectivesCache[missionId] = objectives;

                // Load progress for metrics and objectives in parallel
                var metricProgressTask = Task.CompletedTask;
                var objectiveProgressTask = Task.CompletedTask;

                if (metrics.Count > 0)
                {
                    metricProgressTask = LoadMetricProgressForIds(metrics.Select(m => m.Id).ToList());
                }

                if (objectives.Count > 0)
                {
                    objectiveProgressTask = LoadObjectiveProgress(objectives.Select(o => o.Id).ToList());
                }

                await Task.WhenAll(metricProgressTask, objectiveProgressTask);
                StateHasChanged();
            }
        }
    }

    private async Task LoadObjectiveProgress(List<Guid> objectiveIds)
    {
        var progressList = await Api.GetObjectiveProgressAsync(objectiveIds);
        if (progressList != null)
        {
            foreach (var progress in progressList)
            {
                objectiveProgressCache[progress.ObjectiveId] = progress;
            }
        }
    }

    private async Task LoadMetricProgressForIds(List<Guid> metricIds)
    {
        var progressList = await Api.GetMetricProgressAsync(metricIds);
        if (progressList != null)
        {
            foreach (var progress in progressList)
            {
                metricProgressCache[progress.MetricId] = progress;
            }
        }
    }

    // ---- Checkin History Modal Methods ----

    private async Task OpenCheckinHistoryModal(Mission mission, MissionMetric metric)
    {
        historyMission = mission;
        historyMetric = metric;
        isCheckinHistoryModalOpen = true;
        isLoadingCheckins = true;
        metricCheckins = new List<MetricCheckin>();
        StateHasChanged();

        try
        {
            var result = await Api.GetMetricCheckinsAsync(metric.Id, null, 1, 50);
            metricCheckins = result?.Items.OrderByDescending(c => c.CheckinDate).ToList() ?? new List<MetricCheckin>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar hist√≥rico de check-ins da m√©trica {metric.Id}: {ex.Message}");
            metricCheckins = new List<MetricCheckin>();
            ToastService.ShowError("Erro ao carregar hist√≥rico", "N√£o foi poss√≠vel carregar o hist√≥rico de check-ins desta m√©trica.");
        }
        finally
        {
            isLoadingCheckins = false;
            StateHasChanged();
        }
    }

    private void CloseCheckinHistoryModal()
    {
        isCheckinHistoryModalOpen = false;
        historyMetric = null;
        historyMission = null;
        metricCheckins = new List<MetricCheckin>();
    }

    private void OpenCheckinFromHistory()
    {
        // Capture values before closing the history modal
        var mission = historyMission;
        var metric = historyMetric;

        // Close history modal first
        isCheckinHistoryModalOpen = false;
        historyMetric = null;
        historyMission = null;
        metricCheckins = new List<MetricCheckin>();

        // Now open checkin modal with captured values
        if (mission != null && metric != null)
        {
            OpenCheckinModalForMetric(mission, metric);
        }
    }

    private static string GetConfidenceStarsDisplay(int level)
    {
        return new string('‚òÖ', level) + new string('‚òÜ', 5 - level);
    }

    private static string GetCheckinValueDisplay(MetricCheckin checkin, MissionMetric? metric)
    {
        if (checkin.Value.HasValue)
        {
            var unit = metric?.Unit.HasValue == true ? GetUnitLabel(metric.Unit!.Value) : "";
            return $"{checkin.Value.Value:G} {unit}".Trim();
        }
        if (!string.IsNullOrWhiteSpace(checkin.Text))
        {
            return checkin.Text;
        }
        return "‚Äî";
    }

    // ---- Summary Card Methods ----

    private int GetOverallProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.TotalMetrics > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.OverallProgress);
    }

    private int GetExpectedProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.ExpectedProgress > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.ExpectedProgress);
    }

    private int GetActiveMissionsCount()
    {
        return missions?.Items.Count(m => m.Status == MissionStatus.Active) ?? 0;
    }

    private int GetOutdatedMetricsCount()
    {
        return missionProgress.Values.Sum(p => p.OutdatedMetrics);
    }

    // ---- Metric Display Methods ----

    private static string GetInitials(string fullName)
    {
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return "?";
        if (parts.Length == 1) return parts[0][..1].ToUpperInvariant();
        return $"{parts[0][..1]}{parts[^1][..1]}".ToUpperInvariant();
    }

    private int GetMetricProgress(MissionMetric metric)
    {
        if (metricProgressCache.TryGetValue(metric.Id, out var progress))
        {
            return (int)progress.Progress;
        }
        return 0;
    }

    private bool IsMetricOutdated(Guid metricId)
    {
        if (metricProgressCache.TryGetValue(metricId, out var progress))
        {
            return progress.IsOutdated;
        }
        // No progress data means no check-ins, which is outdated
        return true;
    }

    private static string GetMetricStatusClass(int progress, decimal expectedProgress)
    {
        // Se ainda n√£o h√° progresso esperado (miss√£o n√£o iniciou), considera on-track
        if (expectedProgress <= 0)
        {
            return "on-track";
        }

        // Compara progresso real com esperado
        if (progress >= (int)expectedProgress)
        {
            return "on-track";
        }

        if (progress >= (int)(expectedProgress * 0.7m))
        {
            return "at-risk";
        }

        return "off-track";
    }

    private static string GetMetricStatusLabel(int progress, decimal expectedProgress, MissionMetric metric)
    {
        if (metric.Type == MetricType.Qualitative) return "Qualitativo";

        // Se ainda n√£o h√° progresso esperado (miss√£o n√£o iniciou), considera on-track
        if (expectedProgress <= 0)
        {
            return "Dentro do previsto";
        }

        // Compara progresso real com esperado
        if (progress >= (int)expectedProgress)
        {
            return "Dentro do previsto";
        }

        if (progress >= (int)(expectedProgress * 0.7m))
        {
            return "Aten√ß√£o";
        }

        return "Em risco";
    }

    private MarkupString GetMetricIcon(MetricType type)
    {
        return type switch
        {
            MetricType.Quantitative => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><path d=""M16 4V28M4 16H28"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round""/></svg>"),
            MetricType.Qualitative => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><path d=""M16 4L20 12L28 14L22 20L24 28L16 24L8 28L10 20L4 14L12 12L16 4Z"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round"" stroke-linejoin=""round""/></svg>"),
            _ => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><circle cx=""16"" cy=""16"" r=""10"" stroke=""currentColor"" stroke-width=""2""/></svg>")
        };
    }

    private string GetQuarterLabel(Mission mission)
    {
        var quarter = (mission.StartDate.Month - 1) / 3 + 1;
        return $"Q{quarter} {mission.StartDate.Year}";
    }

    // ---- Checkin Modal Methods ----

    private void OpenCheckinModalForMetric(Mission mission, MissionMetric metric)
    {
        checkinMission = mission;
        checkinMetrics = missionMetricsCache.GetValueOrDefault(mission.Id) ?? new List<MissionMetric>();
        checkinMetricId = metric.Id.ToString();
        selectedCheckinMetric = metric;
        newCheckin = new CreateMetricCheckinRequest { ConfidenceLevel = 3 };
        checkinDate = DateOnly.FromDateTime(DateTime.Today);
        isCheckinModalOpen = true;
    }

    private void CloseCheckinModal()
    {
        isCheckinModalOpen = false;
        checkinMission = null;
        checkinMetrics = new();
        checkinMetricId = null;
        selectedCheckinMetric = null;
    }

    private void OnCheckinMetricChanged()
    {
        if (Guid.TryParse(checkinMetricId, out var metricId))
        {
            selectedCheckinMetric = checkinMetrics.FirstOrDefault(m => m.Id == metricId);
        }
        else
        {
            selectedCheckinMetric = null;
        }
    }

    private async Task CreateCheckin()
    {
        if (selectedCheckinMetric is null)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione uma m√©trica.");
            return;
        }

        if (newCheckin.ConfidenceLevel < 1 || newCheckin.ConfidenceLevel > 5)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione o n√≠vel de confian√ßa (1-5).");
            return;
        }

        newCheckin.MissionMetricId = selectedCheckinMetric.Id;
        newCheckin.CheckinDate = DateTime.UtcNow;

        await UiOps.RunAsync(
            async () =>
            {
                await Api.CreateMetricCheckinAsync(newCheckin);
                ToastService.ShowSuccess("Check-in criado", "O check-in foi registrado com sucesso.");
                var missionId = checkinMission?.Id;
                CloseCheckinModal();
                await LoadProgress();
                if (missionId.HasValue)
                {
                    await LoadMetricProgress(missionId.Value);
                }
            },
            "Erro ao criar check-in",
            "N√£o foi poss√≠vel criar o check-in. Verifique os dados e tente novamente.");
    }

    private static string GetCheckinTargetHint(MissionMetric metric) => MissionMetricDisplayHelper.GetCheckinTargetHint(metric);

    // ---- Mission Edit/Delete Methods ----

    private (MissionScopeType scopeType, Guid scopeId) GetMissionScope(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
            return (MissionScopeType.Collaborator, mission.CollaboratorId.Value);
        if (mission.TeamId.HasValue)
            return (MissionScopeType.Team, mission.TeamId.Value);
        if (mission.WorkspaceId.HasValue)
            return (MissionScopeType.Workspace, mission.WorkspaceId.Value);
        return (MissionScopeType.Organization, mission.OrganizationId);
    }

    private async Task OpenEditWizard(Mission mission)
    {
        isEditMode = true;
        editingMissionId = mission.Id;

        var (scopeType, scopeId) = GetMissionScope(mission);
        createScopeTypeValue = scopeType.ToString();
        createScopeId = scopeId.ToString();
        missionDescription = mission.Description;
        editStatusValue = mission.Status.ToString();

        newMission = new CreateMissionRequest
        {
            Name = mission.Name,
            StartDate = mission.StartDate,
            EndDate = mission.EndDate,
            Status = mission.Status
        };

        showResponsibleSelector = false;
        showPeriodSelector = false;
        showStatusSelector = false;

        // Load metrics and objectives in parallel
        var metricsTask = Api.GetMissionMetricsByMissionIdAsync(mission.Id);
        var objectivesTask = Api.GetMissionObjectivesAsync(mission.Id);
        await Task.WhenAll(metricsTask, objectivesTask);

        var apiMetrics = metricsTask.Result?.Items.ToList() ?? new List<MissionMetric>();
        var apiObjectives = objectivesTask.Result?.Items.ToList() ?? new List<MissionObjective>();

        // Convert objectives to TempObjective with OriginalId
        tempObjectives = apiObjectives.Select(o => new TempObjective(
            TempId: Guid.NewGuid().ToString(),
            Name: o.Name,
            Description: o.Description,
            OriginalId: o.Id
        )).ToList();

        // Build a map from original objective ID to TempId
        var objectiveIdToTempId = tempObjectives
            .Where(o => o.OriginalId.HasValue)
            .ToDictionary(o => o.OriginalId!.Value, o => o.TempId);

        // Convert metrics to TempMetric with OriginalId and resolved ObjectiveTempId
        tempMetrics = apiMetrics.Select(m =>
        {
            string? objTempId = null;
            if (m.MissionObjectiveId.HasValue && objectiveIdToTempId.TryGetValue(m.MissionObjectiveId.Value, out var tid))
            {
                objTempId = tid;
            }

            return new TempMetric(
                OriginalId: m.Id,
                Name: m.Name,
                Type: m.Type.ToString(),
                Details: GetMetricDetailsFromModel(m),
                QuantitativeType: m.QuantitativeType?.ToString(),
                MinValue: m.MinValue,
                MaxValue: m.MaxValue,
                TargetText: m.TargetText,
                Unit: m.Unit?.ToString(),
                ObjectiveTempId: objTempId
            );
        }).ToList();

        // Store originals for diff
        originalTempMetrics = tempMetrics.ToList();
        originalTempObjectives = tempObjectives.ToList();

        // Reset tracking
        deletedMetricIds.Clear();
        deletedObjectiveIds.Clear();
        editingTempMetricIndex = null;
        editTempMetricModel.Clear();
        newMetricModel.Clear();
        tempObjectiveName = "";
        tempObjectiveDescription = null;
        editingTempObjectiveIndex = null;
        addingMetricToObjectiveTempId = null;

        wizardStep = 1;
        isModalOpen = true;
    }

    private async Task UpdateMissionFromWizard()
    {
        if (!editingMissionId.HasValue) return;

        var missionId = editingMissionId.Value;

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            ToastService.ShowError("Erro ao salvar", "Informe o nome da miss√£o.");
            return;
        }

        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            ToastService.ShowError("Erro ao salvar", "Selecione o escopo.");
            return;
        }

        if (!Guid.TryParse(createScopeId, out var scopeId))
        {
            ToastService.ShowError("Erro ao salvar", "Selecione a refer√™ncia do escopo.");
            return;
        }

        FlushPendingMetric();

        await UiOps.RunAsync(
            async () =>
            {
                // 1. Update mission
                var updateRequest = new UpdateMissionRequest
                {
                    Name = newMission.Name,
                    Description = missionDescription,
                    StartDate = newMission.StartDate,
                    EndDate = newMission.EndDate,
                    ScopeType = scopeType,
                    ScopeId = scopeId
                };

                if (Enum.TryParse<MissionStatus>(editStatusValue, out var status))
                {
                    updateRequest.Status = status;
                }

                await Api.UpdateMissionAsync(missionId, updateRequest);

                var failedCount = 0;

                // 2. Process objectives: delete, update, create
                foreach (var id in deletedObjectiveIds)
                {
                    try { await Api.DeleteMissionObjectiveAsync(id); }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao excluir objetivo {id}: {ex.Message}");
                        failedCount++;
                    }
                }

                // Map TempId ‚Üí real Guid for objectives
                var objectiveIdMap = new Dictionary<string, Guid>();

                // Update existing objectives
                foreach (var obj in tempObjectives.Where(o => o.OriginalId.HasValue))
                {
                    objectiveIdMap[obj.TempId] = obj.OriginalId!.Value;

                    var original = originalTempObjectives.FirstOrDefault(o => o.OriginalId == obj.OriginalId);
                    if (original != null && obj.Name == original.Name && obj.Description == original.Description) continue;

                    try
                    {
                        await Api.UpdateMissionObjectiveAsync(obj.OriginalId!.Value, new UpdateMissionObjectiveRequest
                        {
                            Name = obj.Name,
                            Description = obj.Description
                        });
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao atualizar objetivo {obj.OriginalId}: {ex.Message}");
                        failedCount++;
                    }
                }

                // Create new objectives
                foreach (var obj in tempObjectives.Where(o => !o.OriginalId.HasValue))
                {
                    try
                    {
                        var created = await Api.CreateMissionObjectiveAsync(new CreateMissionObjectiveRequest
                        {
                            MissionId = missionId,
                            Name = obj.Name,
                            Description = obj.Description
                        });
                        if (created != null)
                        {
                            objectiveIdMap[obj.TempId] = created.Id;
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao criar objetivo '{obj.Name}': {ex.Message}");
                        failedCount++;
                    }
                }

                // 3. Process metrics: delete, update, create
                foreach (var id in deletedMetricIds)
                {
                    try { await Api.DeleteMissionMetricAsync(id); }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao excluir m√©trica {id}: {ex.Message}");
                        failedCount++;
                    }
                }

                // Update existing metrics
                foreach (var metric in tempMetrics.Where(m => m.OriginalId.HasValue))
                {
                    var original = originalTempMetrics.FirstOrDefault(o => o.OriginalId == metric.OriginalId);
                    if (original != null && metric == original) continue;

                    try
                    {
                        var request = BuildUpdateMetricRequest(metric);
                        if (request != null)
                        {
                            await Api.UpdateMissionMetricAsync(metric.OriginalId!.Value, request);
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao atualizar m√©trica {metric.OriginalId}: {ex.Message}");
                        failedCount++;
                    }
                }

                // Create new metrics (with resolved objective IDs)
                foreach (var metric in tempMetrics.Where(m => !m.OriginalId.HasValue))
                {
                    try
                    {
                        var request = BuildCreateMetricRequest(missionId, metric);
                        if (request != null)
                        {
                            // Resolve objective reference
                            if (metric.ObjectiveTempId is not null && objectiveIdMap.TryGetValue(metric.ObjectiveTempId, out var realObjectiveId))
                            {
                                request.MissionObjectiveId = realObjectiveId;
                            }

                            await Api.CreateMissionMetricAsync(request);
                        }
                        else
                        {
                            failedCount++;
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao criar m√©trica '{metric.Name}': {ex.Message}");
                        failedCount++;
                    }
                }

                if (failedCount > 0)
                {
                    ToastService.ShowError("Erro ao salvar", $"{failedCount} item(ns) n√£o puderam ser salvos.");
                }

                // Invalidate caches
                missionMetricsCache.Remove(missionId);
                missionObjectivesCache.Remove(missionId);
                await LoadMissions();

                // Reload expanded card if open
                if (expandedMissions.Contains(missionId))
                {
                    var reloadMetricsTask = Api.GetMissionMetricsByMissionIdAsync(missionId);
                    var reloadObjectivesTask = Api.GetMissionObjectivesAsync(missionId);
                    await Task.WhenAll(reloadMetricsTask, reloadObjectivesTask);

                    missionMetricsCache[missionId] = reloadMetricsTask.Result?.Items.ToList() ?? new List<MissionMetric>();
                    missionObjectivesCache[missionId] = reloadObjectivesTask.Result?.Items.ToList() ?? new List<MissionObjective>();

                    if (missionMetricsCache[missionId].Count > 0)
                    {
                        await LoadMetricProgress(missionId);
                    }

                    var objIds = missionObjectivesCache[missionId].Select(o => o.Id).ToList();
                    if (objIds.Count > 0)
                    {
                        await LoadObjectiveProgress(objIds);
                    }
                }

                ToastService.ShowSuccess("Miss√£o atualizada", "As altera√ß√µes foram salvas com sucesso.");
                CloseModal();
            },
            "Erro ao atualizar",
            "N√£o foi poss√≠vel atualizar a miss√£o. Verifique os dados e tente novamente.");
    }

    private string GetStatusChipLabel()
    {
        if (Enum.TryParse<MissionStatus>(editStatusValue, out var status))
        {
            return $"Status: {GetStatusLabel(status)}";
        }
        return "Status";
    }

    private async Task HandleDeleteClick(Guid missionId)
    {
        if (deletingMissionId == missionId)
        {
            await DeleteMission(missionId);
        }
        else
        {
            ArmMissionDeleteConfirmation(missionId);
        }
    }

    private async Task DeleteMission(Guid missionId)
    {
        try
        {
            await UiOps.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionAsync(missionId);
                    ToastService.ShowSuccess("Miss√£o exclu√≠da", "A miss√£o foi removida com sucesso.");
                    await LoadMissions();
                },
            "Erro ao excluir",
            "N√£o foi poss√≠vel excluir a miss√£o. Tente novamente.");
        }
        finally
        {
            ClearMissionDeleteConfirmation();
        }
    }

    private string GetMetricDetailsFromModel(MissionMetric m)
        => m.Type == MetricType.Qualitative
            ? m.TargetText ?? ""
            : BuildQuantitativeDetailsFrom(m.QuantitativeType?.ToString(), m.MinValue, m.MaxValue, m.Unit?.ToString());

    private CreateMissionMetricRequest? BuildCreateMetricRequest(Guid missionId, TempMetric metric)
    {
        if (!EnumParsingHelper.TryParseEnum<MetricType>(metric.Type, out var metricType))
            return null;

        var request = new CreateMissionMetricRequest
        {
            MissionId = missionId,
            Name = metric.Name,
            Type = metricType,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };

        if (metricType == MetricType.Quantitative)
        {
            if (!string.IsNullOrEmpty(metric.QuantitativeType) &&
                EnumParsingHelper.TryParseEnum<QuantitativeMetricType>(metric.QuantitativeType, out var qType))
                request.QuantitativeType = qType;
            if (!string.IsNullOrEmpty(metric.Unit) &&
                EnumParsingHelper.TryParseEnum<MetricUnit>(metric.Unit, out var unit))
                request.Unit = unit;
        }

        return request;
    }

    private UpdateMissionMetricRequest? BuildUpdateMetricRequest(TempMetric metric)
    {
        if (!EnumParsingHelper.TryParseEnum<MetricType>(metric.Type, out var metricType))
            return null;

        var request = new UpdateMissionMetricRequest
        {
            Name = metric.Name,
            Type = metricType,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };

        if (metricType == MetricType.Quantitative)
        {
            if (!string.IsNullOrEmpty(metric.QuantitativeType) &&
                EnumParsingHelper.TryParseEnum<QuantitativeMetricType>(metric.QuantitativeType, out var qType))
                request.QuantitativeType = qType;
            if (!string.IsNullOrEmpty(metric.Unit) &&
                EnumParsingHelper.TryParseEnum<MetricUnit>(metric.Unit, out var unit))
                request.Unit = unit;
        }

        return request;
    }

    private void ArmMissionDeleteConfirmation(Guid missionId)
    {
        deletingMissionId = missionId;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = new System.Threading.Timer(
            _ => InvokeAsync(() =>
            {
                deletingMissionId = null;
                StateHasChanged();
            }),
            null,
            3000,
            Timeout.Infinite);
    }

    private void ClearMissionDeleteConfirmation()
    {
        deletingMissionId = null;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = null;
    }

    // ---- Progress & Confidence Helpers ----

    private static string GetProgressStatusClass(MissionProgressDto? progress) => MissionProgressDisplayHelper.GetMissionProgressStatusClass(progress);

    private static (string statusClass, string label) GetConfidenceDisplay(decimal averageConfidence) => MissionProgressDisplayHelper.GetConfidenceDisplay(averageConfidence);

    private static string GetConfidenceClass(decimal confidence) => MissionProgressDisplayHelper.GetConfidenceClass(confidence);

    private static string GetConfidenceLabel(decimal confidence) => MissionProgressDisplayHelper.GetConfidenceLabel(confidence);

    private static string GetConfidenceStarsText(decimal confidence) => MissionProgressDisplayHelper.GetConfidenceStarsText(confidence);

    // ---- Metric Display Helpers ----

    private static string GetMetricTypeLabel(MetricType type) => MissionMetricDisplayHelper.GetMetricTypeLabel(type);

    private static string GetQuantitativeTypeLabel(QuantitativeMetricType type) => MissionMetricDisplayHelper.GetQuantitativeTypeLabel(type);

    private static string GetQuantitativeTypeIcon(QuantitativeMetricType type) => MissionMetricDisplayHelper.GetQuantitativeTypeIcon(type);

    private static string GetUnitLabel(MetricUnit unit) => MissionMetricDisplayHelper.GetUnitLabel(unit);

    private static string GetTargetLabel(MissionMetric metric) => MissionMetricDisplayHelper.GetTargetLabel(metric);

    // ---- Metric Row Rendering ----

    private RenderFragment RenderMetricRow(Mission mission, MissionMetric metric, MissionProgressDto? progress) => __builder =>
    {
        var metricProgress = GetMetricProgress(metric);
        var expectedProgress = progress?.ExpectedProgress ?? 0m;
        var metricStatusClass = GetMetricStatusClass(metricProgress, expectedProgress);
        var isMetricOutdated = IsMetricOutdated(metric.Id);
        <div class="metric-row clickable @(isMetricOutdated ? "outdated" : "")" @onclick="() => OpenCheckinHistoryModal(mission, metric)">
            <button class="metric-checkin-btn" @onclick="() => OpenCheckinModalForMetric(mission, metric)" @onclick:stopPropagation="true" title="Novo check-in">
                <svg width="18" height="18" viewBox="0 0 32 32" fill="none">
                    <path d="M16 6V26M6 16H26" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="metric-row-title">
                <div class="metric-row-name">@metric.Name</div>
            </div>
            <div class="metric-row-period">
                <div class="metric-period-label">@GetQuarterLabel(mission)</div>
                <div class="metric-period-dates">@mission.StartDate.ToString("dd/MM/yyyy") √† @mission.EndDate.ToString("dd/MM/yyyy")</div>
            </div>
            <div class="metric-row-progress">
                <div class="metric-progress-target">@GetTargetLabel(metric)</div>
                <div class="metric-progress-bar">
                    <div class="metric-progress-fill @metricStatusClass" style="width: @(metricProgress)%"></div>
                </div>
                <div class="metric-progress-footer">
                    <span class="metric-progress-status">@GetMetricStatusLabel(metricProgress, expectedProgress, metric)</span>
                    <span class="metric-progress-value">@(metricProgress)%</span>
                </div>
            </div>
            @{
                var hasLastCheckinAuthor = metricProgressCache.TryGetValue(metric.Id, out var mp)
                    && mp.LastCheckinCollaboratorName is not null;
                var lastCheckinAuthorName = hasLastCheckinAuthor ? mp!.LastCheckinCollaboratorName! : "√öltimo check-in";
            }
            <div class="metric-row-avatar" title="@lastCheckinAuthorName">
                @if (hasLastCheckinAuthor)
                {
                    <span class="metric-row-avatar-initials">@GetInitials(lastCheckinAuthorName)</span>
                }
                else
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                    </svg>
                }
            </div>
        </div>
    };

    private static string GetProgressStatusClassFromPercent(int progressPercent, decimal expectedProgress)
    {
        if (progressPercent >= (int)expectedProgress) return "on-track";
        if (progressPercent >= (int)(expectedProgress * 0.7m)) return "at-risk";
        return "off-track";
    }

    // ---- Wizard Temp Objective Methods ----

    private void AddTempObjective()
    {
        if (string.IsNullOrWhiteSpace(tempObjectiveName))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome do objetivo.");
            return;
        }

        tempObjectives.Add(new TempObjective(
            TempId: Guid.NewGuid().ToString(),
            Name: tempObjectiveName.Trim(),
            Description: string.IsNullOrWhiteSpace(tempObjectiveDescription) ? null : tempObjectiveDescription.Trim()
        ));

        tempObjectiveName = "";
        tempObjectiveDescription = null;
        showObjectiveForm = false;
    }

    private void CancelAddObjective()
    {
        tempObjectiveName = "";
        tempObjectiveDescription = null;
        showObjectiveForm = false;
    }

    private void StartEditTempObjective(int index)
    {
        var obj = tempObjectives[index];
        editingTempObjectiveIndex = index;
        editingObjectiveName = obj.Name;
        editingObjectiveDescription = obj.Description;
    }

    private void CancelEditTempObjective()
    {
        editingTempObjectiveIndex = null;
        editingObjectiveName = "";
        editingObjectiveDescription = null;
    }

    private void SaveEditTempObjective()
    {
        if (editingTempObjectiveIndex is null || string.IsNullOrWhiteSpace(editingObjectiveName)) return;

        var existing = tempObjectives[editingTempObjectiveIndex.Value];
        tempObjectives[editingTempObjectiveIndex.Value] = new TempObjective(
            TempId: existing.TempId,
            Name: editingObjectiveName.Trim(),
            Description: string.IsNullOrWhiteSpace(editingObjectiveDescription) ? null : editingObjectiveDescription.Trim(),
            OriginalId: existing.OriginalId
        );

        CancelEditTempObjective();
    }

    private void RemoveTempObjective(int index)
    {
        var obj = tempObjectives[index];
        var removedTempId = obj.TempId;
        tempObjectives.RemoveAt(index);

        // Track deleted objective for edit mode
        if (isEditMode && obj.OriginalId.HasValue)
        {
            deletedObjectiveIds.Add(obj.OriginalId.Value);
        }

        // Also track and remove metrics that belonged to this objective
        var metricsToRemove = tempMetrics.Where(m => m.ObjectiveTempId == removedTempId).ToList();
        foreach (var metric in metricsToRemove)
        {
            if (isEditMode && metric.OriginalId.HasValue)
            {
                deletedMetricIds.Add(metric.OriginalId.Value);
            }
            tempMetrics.Remove(metric);
        }

        if (editingTempObjectiveIndex.HasValue)
        {
            if (editingTempObjectiveIndex.Value == index)
            {
                CancelEditTempObjective();
            }
            else if (editingTempObjectiveIndex.Value > index)
            {
                editingTempObjectiveIndex--;
            }
        }
    }

    // ---- Objective Methods ----

    private void ToggleObjectiveExpand(Guid objectiveId)
    {
        if (!expandedObjectives.Add(objectiveId))
        {
            expandedObjectives.Remove(objectiveId);
        }
    }

}
