@page "/missions"
@inject ApiClient Api
@inject OrganizationContext OrgContext
@inject ToastService ToastService
@implements IDisposable

<MissionsMenu />

<MissionsPageHeader Title="Minhas miss√µes" OnCreate="OpenCreateModal" />

@* Barra de Filtros Compacta *@
<div class="missions-filter-bar">
    <div class="missions-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M28 6H4L14 17.6V26L18 28V17.6L28 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Filtrar</span>
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(filterStartDate.HasValue || filterEndDate.HasValue ? "active" : "")" @onclick="ToggleDatePicker">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 4H6C4.89543 4 4 4.89543 4 6V26C4 27.1046 4.89543 28 6 28H26C27.1046 28 28 27.1046 28 26V6C28 4.89543 27.1046 4 26 4Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M22 2V6M10 2V6M4 12H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>@GetDateRangeLabel()</span>
            </button>
            @if (showDatePicker)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Data inicial</label>
                        <input type="date" class="input" value="@filterStartDate?.ToString("yyyy-MM-dd")" @onchange="OnStartDateChanged" />
                    </div>
                    <div class="filter-dropdown-row">
                        <label>Data final</label>
                        <input type="date" class="input" value="@filterEndDate?.ToString("yyyy-MM-dd")" @onchange="OnEndDateChanged" />
                    </div>
                    <button class="button small" @onclick="ApplyDateFilter">Aplicar</button>
                </div>
            }
        </div>
        <button class="filter-chip @(filterActiveOnly ? "active" : "")" @onclick="ToggleActiveFilter">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M16 28C22.6274 28 28 22.6274 28 16C28 9.37258 22.6274 4 16 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 10V16L20 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 16H8M6 12L8 16L6 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>@GetStatusFilterLabel()</span>
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip-clear" @onclick="ClearFilters">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 16L22 12M22 12L18 8M22 12L26 8M22 12L18 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 8L10 28H14L12 18L6 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Limpar filtro</span>
            </button>
        }
    </div>
    <button class="filter-chip" @onclick="ToggleViewMode">
        @if (viewMode == "list")
        {
            @* √çcone de lista (linhas horizontais) *@
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M4 8H28M4 16H28M4 24H28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Lista</span>
        }
        else
        {
            @* √çcone de grade (4 quadrados) *@
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <rect x="4" y="6" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="4" y="18" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="20" y="6" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                <rect x="20" y="18" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>Grade</span>
        }
    </button>
</div>

@* Painel de Filtros Expandido *@
@if (showFilterPanel)
{
    <div class="missions-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Escopo</label>
                <select class="input" value="@filterScopeTypeValue" @onchange="OnFilterScopeTypeChanged">
                    <option value="">Todos</option>
                    @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                    {
                        <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Refer√™ncia</label>
                <select class="input" @bind="filterScopeId" @bind:after="LoadMissions">
                    <option value="">Todas</option>
                    @foreach (var option in GetScopeOptions(filterScopeTypeValue))
                    {
                        <option value="@option.Id">@option.Name</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar miss√µes..." />
            </div>
        </div>
    </div>
}

@* Cards de Resumo *@
<MissionsSummaryCards
    OverallProgress="GetOverallProgressDisplay()"
    ExpectedProgress="GetExpectedProgressDisplay()"
    ActiveMissions="GetActiveMissionsCount()"
    OutdatedMetrics="GetOutdatedMetricsCount()" />

@* Lista de Miss√µes em Cards *@
@if (missions is null)
{
    <div class="missions-loading">
        <p class="muted">Carregando...</p>
    </div>
}
else if (missions.Items.Count == 0)
{
    <div class="missions-empty">
        <div class="missions-empty-icon">üìã</div>
        <p class="muted">Nenhuma miss√£o encontrada.</p>
    </div>
}
else
{
    <div class="@(viewMode == "list" ? "missions-list" : "missions-grid")">
        @foreach (var mission in missions.Items)
        {
            var progress = missionProgress.GetValueOrDefault(mission.Id);
            var isExpanded = expandedMissions.Contains(mission.Id);
            var isDeleting = deletingMissionId == mission.Id;
            var progressPercent = (int)(progress?.OverallProgress ?? 0);
            var circumference = 2 * Math.PI * 19;
            var dashOffset = circumference - (circumference * progressPercent / 100);

            <div class="mission-card @(isExpanded ? "expanded" : "") @(mission.Status == MissionStatus.Planned ? "draft" : "")">
                <div class="mission-card-header" @onclick="async () => await ToggleExpand(mission.Id)">
                    @* C√≠rculo de Progresso *@
                    <div class="mission-progress-circle">
                        <svg width="44" height="44" viewBox="0 0 44 44">
                            <circle class="progress-bg" cx="22" cy="22" r="19" />
                            @if (mission.Status != MissionStatus.Planned)
                            {
                                <circle class="progress-value @GetProgressStatusClass(progress)"
                                        cx="22" cy="22" r="19"
                                        stroke-dasharray="@circumference.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                        stroke-dashoffset="@dashOffset.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)" />
                            }
                        </svg>
                        <div class="mission-progress-text">
                            <span class="mission-progress-number">@(mission.Status == MissionStatus.Planned ? "00" : progressPercent.ToString())</span>
                            <span class="mission-progress-percent">%</span>
                        </div>
                    </div>

                    @* T√≠tulo da Miss√£o *@
                    <div class="mission-card-title-wrapper">
                        @if (mission.Status == MissionStatus.Planned)
                        {
                            <span class="mission-draft-tag">RASCUNHO</span>
                        }
                        <div class="mission-card-title-row">
                            <div class="mission-card-title">@mission.Name</div>
                            @if (progress != null && progress.MetricsWithCheckins > 0)
                            {
                                <div class="mission-confidence-badge @GetConfidenceClass(progress.AverageConfidence)" title="N√≠vel de confian√ßa: @GetConfidenceLabel(progress.AverageConfidence)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>@((int)Math.Round(progress.AverageConfidence))</span>
                                </div>
                            }
                        </div>
                    </div>

                    @* A√ß√µes *@
                    <div class="mission-card-actions" @onclick:stopPropagation="true">
                        <button class="mission-action-btn" @onclick="async () => await OpenEditModal(mission)" title="Editar miss√£o">
                            <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                                <path d="M22 4L28 10L10 28H4V22L22 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="mission-action-btn @(isDeleting ? "danger" : "")"
                                @onclick="() => HandleDeleteClick(mission.Id)"
                                title="@(isDeleting ? "Confirmar exclus√£o" : "Excluir")">
                            @if (isDeleting)
                            {
                                <span style="font-size: 10px;">OK?</span>
                            }
                            else
                            {
                                <svg width="22" height="22" viewBox="0 0 32 32" fill="none">
                                    <path d="M4 8H6.66667H28" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10.6667 8V5.33333C10.6667 4.62609 10.9476 3.94781 11.4477 3.44772C11.9478 2.94762 12.6261 2.66667 13.3333 2.66667H18.6667C19.3739 2.66667 20.0522 2.94762 20.5523 3.44772C21.0524 3.94781 21.3333 4.62609 21.3333 5.33333V8M25.3333 8V26.6667C25.3333 27.3739 25.0524 28.0522 24.5523 28.5523C24.0522 29.0524 23.3739 29.3333 22.6667 29.3333H9.33333C8.62609 29.3333 7.94781 29.0524 7.44772 28.5523C6.94762 28.0522 6.66667 27.3739 6.66667 26.6667V8H25.3333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            }
                        </button>
                        <button class="mission-action-btn" @onclick="async () => await ToggleExpand(mission.Id)" title="@(isExpanded ? "Recolher" : "Expandir")">
                            <svg class="mission-expand-icon @(isExpanded ? "expanded" : "")" width="22" height="22" viewBox="0 0 32 32" fill="none">
                                <path d="M8 12L16 20L24 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>

                @* Conte√∫do Expandido - M√©tricas *@
                @if (isExpanded)
                {
                    <div class="mission-card-content">
                        @{
                            var metrics = missionMetricsCache.GetValueOrDefault(mission.Id);
                        }
                        @if (metrics is null)
                        {
                            <p class="muted">Carregando m√©tricas...</p>
                        }
                        else if (!metrics.Any())
                        {
                            <p class="muted">Nenhuma m√©trica associada a esta miss√£o.</p>
                        }
                        else
                        {
                            @foreach (var metric in metrics)
                            {
                                var metricProgress = GetMetricProgress(metric);
                                var expectedProgress = progress?.ExpectedProgress ?? 0m;
                                var metricStatusClass = GetMetricStatusClass(metricProgress, expectedProgress);
                                var isMetricOutdated = IsMetricOutdated(metric.Id);
                                <div class="metric-row clickable @(isMetricOutdated ? "outdated" : "")" @onclick="() => OpenCheckinHistoryModal(mission, metric)" title="Ver hist√≥rico de check-ins">
                                    <button class="metric-checkin-btn" @onclick="() => OpenCheckinModalForMetric(mission, metric)" @onclick:stopPropagation="true" title="Novo check-in">
                                        <svg width="18" height="18" viewBox="0 0 32 32" fill="none">
                                            <path d="M16 6V26M6 16H26" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    <div class="metric-row-title">
                                        <div class="metric-row-name">@metric.Name</div>
                                    </div>
                                    <div class="metric-row-period">
                                        <div class="metric-period-label">@GetQuarterLabel(mission)</div>
                                        <div class="metric-period-dates">@mission.StartDate.ToString("dd/MM/yyyy") √† @mission.EndDate.ToString("dd/MM/yyyy")</div>
                                    </div>
                                    <div class="metric-row-progress">
                                        <div class="metric-progress-target">@GetTargetLabel(metric)</div>
                                        <div class="metric-progress-bar">
                                            <div class="metric-progress-fill @metricStatusClass" style="width: @(metricProgress)%"></div>
                                        </div>
                                        <div class="metric-progress-footer">
                                            <span class="metric-progress-status">@GetMetricStatusLabel(metricProgress, expectedProgress, metric)</span>
                                            <span class="metric-progress-value">@(metricProgress)%</span>
                                        </div>
                                    </div>
                                    <div class="metric-row-avatar" title="√öltimo check-in">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                            <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                                        </svg>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
    </div>
    <p class="muted" style="margin-top: var(--spacing-4);">Total: @missions.Total</p>
}

@if (isTemplatePickerOpen)
{
    <Modal Title="Como deseja criar sua miss√£o?" Size="lg" OnClose="() => isTemplatePickerOpen = false">
        <ChildContent>
            <div class="template-picker-grid">
                <div class="template-picker-card" @onclick="OpenCreateModalFromScratch">
                    <div class="template-picker-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                            <path d="M8 4H20L26 10V28H8V4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            <path d="M20 4V10H26" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="template-picker-name">Come√ßar do zero</div>
                    <div class="template-picker-description">Crie uma miss√£o em branco e configure tudo manualmente.</div>
                </div>
                @foreach (var template in availableTemplates)
                {
                    <div class="template-picker-card" @onclick="() => OpenCreateModalFromTemplate(template)">
                        <div class="template-picker-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M6 6H26V26H6V6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M11 12H21M11 16H21M11 20H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="template-picker-name">@template.Name</div>
                        <div class="template-picker-description">@(template.Description ?? "Sem descri√ß√£o")</div>
                        <div class="template-picker-badge">@template.Metrics.Count m√©trica(s)</div>
                    </div>
                }
            </div>
        </ChildContent>
    </Modal>
}

@if (isModalOpen)
{
    <Modal Title="Criar miss√£o" Breadcrumb="@GetSelectedOrganizationName()" Size="lg" OnClose="CloseModal">
        <ChildContent>
            <EditForm Model="@newMission" OnValidSubmit="CreateMission">
                <DataAnnotationsValidator />

                @* Header Section - Mission Title & Description *@
                <div class="mission-header">
                    <InputText class="mission-title-input" @bind-Value="newMission.Name" placeholder="Nome da miss√£o" />
                    <input type="text" class="mission-subtitle-input" @bind="missionDescription" placeholder="Adicionar breve descri√ß√£o" />
                </div>

                @* Metadata Chips *@
                <div class="chips-container">
                    <div class="chip" @onclick="() => showResponsibleSelector = !showResponsibleSelector">
                        <span class="chip-icon">üë§</span>
                        <span>@GetResponsibleLabel()</span>
                    </div>
                    <div class="chip" @onclick="() => showPeriodSelector = !showPeriodSelector">
                        <span class="chip-icon">üìÖ</span>
                        <span>@GetPeriodLabel()</span>
                    </div>
                </div>

                @* Responsible Selector (hidden by default) *@
                @if (showResponsibleSelector)
                {
                    <div class="form-row">
                        <label>Escopo</label>
                        <select class="input" value="@createScopeTypeValue" @onchange="OnCreateScopeTypeChanged">
                            <option value="">Selecione</option>
                            @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                            {
                                <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                            }
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Refer√™ncia</label>
                        <select class="input" @bind="createScopeId">
                            <option value="">Selecione</option>
                            @foreach (var option in GetScopeOptions(createScopeTypeValue))
                            {
                                <option value="@option.Id">@option.Name</option>
                            }
                        </select>
                    </div>
                }

                @* Period Selector (hidden by default) *@
                @if (showPeriodSelector)
                {
                    <div class="form-row">
                        <label>Data de in√≠cio</label>
                        <InputDate class="input" @bind-Value="newMission.StartDate" />
                    </div>
                    <div class="form-row">
                        <label>Data de fim</label>
                        <InputDate class="input" @bind-Value="newMission.EndDate" />
                    </div>
                }

                @* Metrics Section *@
                <div class="mission-metrics-section">
                    @if (!showMetricForm)
                    {
                        <button type="button" class="metrics-add-button" @onclick="() => showMetricForm = true">
                            <span>Adicionar item</span>
                            <span class="metrics-add-icon">+</span>
                        </button>
                    }
                    else
                    {
                        <div class="metrics-form-container">
                            <div class="metrics-form-header">
                                <div class="form-row">
                                    <label>Nome da m√©trica</label>
                                    <input type="text" class="input" @bind="newMetricName" placeholder="Ex: Taxa de convers√£o, NPS, etc." />
                                </div>
                            </div>

                            <div class="metrics-form-selectors">
                                <div class="metrics-selector-btn">
                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                    </svg>
                                    <select @bind="newMetricType">
                                        <option value="">Tipo de m√©trica</option>
                                        <option value="Quantitative">Quantitativa</option>
                                        <option value="Qualitative">Qualitativa</option>
                                    </select>
                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                    </svg>
                                </div>

                                @if (newMetricType == "Quantitative")
                                {
                                    <div class="metrics-selector-btn">
                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                        </svg>
                                        <select @bind="newMetricQuantitativeType">
                                            <option value="">Modo de mensura√ß√£o</option>
                                            <option value="KeepAbove">‚Üë Manter acima</option>
                                            <option value="KeepBelow">‚Üì Manter abaixo</option>
                                            <option value="KeepBetween">‚Üï Manter entre</option>
                                            <option value="Achieve">‚Üí Atingir</option>
                                            <option value="Reduce">‚Üò Reduzir</option>
                                        </select>
                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                        </svg>
                                    </div>
                                }
                            </div>

                            @if (newMetricType == "Qualitative")
                            {
                                <div class="form-row">
                                    <label>Descri√ß√£o do objetivo</label>
                                    <input type="text" class="input" @bind="newMetricTargetText" placeholder="Descreva o objetivo qualitativo desta m√©trica" />
                                </div>
                            }

                            @if (newMetricType == "Quantitative" && !string.IsNullOrEmpty(newMetricQuantitativeType))
                            {
                                <div class="metrics-form-inputs">
                                    <div class="metrics-input-field">
                                        <select @bind="newMetricUnit">
                                            <option value="">Unidade de medida</option>
                                            <option value="Integer">Inteiro</option>
                                            <option value="Decimal">Decimal</option>
                                            <option value="Percentage">Percentual</option>
                                            <option value="Hours">Horas</option>
                                            <option value="Points">Pontos</option>
                                        </select>
                                    </div>

                                    @if (newMetricQuantitativeType == "KeepAbove" || newMetricQuantitativeType == "KeepBetween")
                                    {
                                        <div class="metrics-input-field">
                                            <input type="number" @bind="newMetricMinValue" placeholder="Valor m√≠nimo" />
                                        </div>
                                    }

                                    @if (newMetricQuantitativeType == "KeepBelow" || newMetricQuantitativeType == "KeepBetween" || newMetricQuantitativeType == "Achieve" || newMetricQuantitativeType == "Reduce")
                                    {
                                        <div class="metrics-input-field">
                                            <input type="number" @bind="newMetricMaxValue" placeholder="@GetMaxValuePlaceholder(newMetricQuantitativeType)" />
                                        </div>
                                    }
                                </div>
                            }

                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                <button type="button" class="button tertiary" @onclick="CancelAddMetricForm">Cancelar</button>
                                <button type="button" class="button primary" @onclick="AddMetricFromForm">Salvar m√©trica</button>
                            </div>
                        </div>
                    }

                    @if (tempMetrics.Any())
                    {
                        <div class="metrics-list">
                            @for (var i = 0; i < tempMetrics.Count; i++)
                            {
                                var index = i;
                                var metric = tempMetrics[index];

                                @if (editingTempMetricIndex == index)
                                {
                                    @* Inline edit form *@
                                    <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                        <div class="metrics-form-container">
                                            <div class="form-row">
                                                <label>Nome da m√©trica</label>
                                                <input type="text" class="input" @bind="editTempMetricName" placeholder="Nome da m√©trica" />
                                            </div>

                                            <div class="metrics-form-selectors">
                                                <div class="metrics-selector-btn">
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                                    </svg>
                                                    <select value="@editTempMetricType" @onchange="OnEditTempMetricTypeChanged">
                                                        <option value="">Tipo de m√©trica</option>
                                                        <option value="Quantitative">Quantitativa</option>
                                                        <option value="Qualitative">Qualitativa</option>
                                                    </select>
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                    </svg>
                                                </div>

                                                @if (editTempMetricType == "Quantitative")
                                                {
                                                    <div class="metrics-selector-btn">
                                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                                        </svg>
                                                        <select @bind="editTempMetricQuantitativeType">
                                                            <option value="">Modo de mensura√ß√£o</option>
                                                            <option value="KeepAbove">‚Üë Manter acima</option>
                                                            <option value="KeepBelow">‚Üì Manter abaixo</option>
                                                            <option value="KeepBetween">‚Üï Manter entre</option>
                                                            <option value="Achieve">‚Üí Atingir</option>
                                                            <option value="Reduce">‚Üò Reduzir</option>
                                                        </select>
                                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                        </svg>
                                                    </div>
                                                }
                                            </div>

                                            @if (editTempMetricType == "Qualitative")
                                            {
                                                <div class="form-row">
                                                    <label>Descri√ß√£o do objetivo</label>
                                                    <input type="text" class="input" @bind="editTempMetricTargetText" placeholder="Descreva o objetivo qualitativo desta m√©trica" />
                                                </div>
                                            }

                                            @if (editTempMetricType == "Quantitative" && !string.IsNullOrEmpty(editTempMetricQuantitativeType))
                                            {
                                                <div class="metrics-form-inputs">
                                                    <div class="metrics-input-field">
                                                        <select @bind="editTempMetricUnit">
                                                            <option value="">Unidade de medida</option>
                                                            <option value="Integer">Inteiro</option>
                                                            <option value="Decimal">Decimal</option>
                                                            <option value="Percentage">Percentual</option>
                                                            <option value="Hours">Horas</option>
                                                            <option value="Points">Pontos</option>
                                                        </select>
                                                    </div>

                                                    @if (editTempMetricQuantitativeType == "KeepAbove" || editTempMetricQuantitativeType == "KeepBetween")
                                                    {
                                                        <div class="metrics-input-field">
                                                            <input type="number" @bind="editTempMetricMinValue" placeholder="Valor m√≠nimo" />
                                                        </div>
                                                    }

                                                    @if (editTempMetricQuantitativeType == "KeepBelow" || editTempMetricQuantitativeType == "KeepBetween" || editTempMetricQuantitativeType == "Achieve" || editTempMetricQuantitativeType == "Reduce")
                                                    {
                                                        <div class="metrics-input-field">
                                                            <input type="number" @bind="editTempMetricMaxValue" placeholder="@GetMaxValuePlaceholder(editTempMetricQuantitativeType)" />
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                                <button type="button" class="button tertiary" @onclick="CancelEditTempMetric">Cancelar</button>
                                                <button type="button" class="button primary" @onclick="SaveEditTempMetric">Salvar m√©trica</button>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="metric-item">
                                        <div class="metric-info">
                                            <div class="metric-name">@metric.Name</div>
                                            <div class="metric-details">@metric.Details</div>
                                        </div>
                                        <CrudRowActions
                                            EditTitle="Editar m√©trica"
                                            OnEdit="@(() => StartEditTempMetric(index))"
                                            IsDeleteConfirming="false"
                                            DeleteTitle="Excluir m√©trica"
                                            OnDelete="@(() => RemoveMetric(metric))" />
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            </EditForm>
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    <button class="button secondary" type="button" @onclick="SaveDraft">
                        <span class="chip-icon">üíæ</span>
                        Salvar rascunho
                    </button>
                    <button class="button primary" type="button" @onclick="CreateMission">Criar miss√£o</button>
                </div>
            </div>
        </Footer>
    </Modal>
}

@if (isEditModalOpen && selectedMission != null)
{
    <Modal Title="Editar miss√£o" Breadcrumb="@GetSelectedOrganizationName()" Size="lg" OnClose="CloseEditModal">
        <ChildContent>
            <EditForm Model="@editMission" OnValidSubmit="UpdateMission">
                <DataAnnotationsValidator />

                @* Header Section - Mission Title & Description *@
                <div class="mission-header">
                    <InputText class="mission-title-input" @bind-Value="editMission.Name" placeholder="Nome da miss√£o" />
                    <input type="text" class="mission-subtitle-input" @bind="editMissionDescription" placeholder="Adicionar breve descri√ß√£o" />
                </div>

                @* Metadata Chips *@
                <div class="chips-container">
                    <div class="chip" @onclick="() => showEditResponsibleSelector = !showEditResponsibleSelector">
                        <span class="chip-icon">üë§</span>
                        <span>@GetEditResponsibleLabel()</span>
                    </div>
                    <div class="chip" @onclick="() => showEditPeriodSelector = !showEditPeriodSelector">
                        <span class="chip-icon">üìÖ</span>
                        <span>@GetEditPeriodLabel()</span>
                    </div>
                    <div class="chip" @onclick="() => showEditStatusSelector = !showEditStatusSelector">
                        <span class="chip-icon">üìä</span>
                        <span>@GetStatusLabel(editMission.Status)</span>
                    </div>
                </div>

                @* Responsible Selector (hidden by default) *@
                @if (showEditResponsibleSelector)
                {
                    <div class="form-row">
                        <label>Escopo</label>
                        <select class="input" value="@editScopeTypeValue" @onchange="OnEditScopeTypeChanged">
                            <option value="">Selecione</option>
                            @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                            {
                                <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                            }
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Refer√™ncia</label>
                        <select class="input" @bind="editScopeId">
                            <option value="">Selecione</option>
                            @foreach (var option in GetScopeOptions(editScopeTypeValue))
                            {
                                <option value="@option.Id">@option.Name</option>
                            }
                        </select>
                    </div>
                }

                @* Period Selector (hidden by default) *@
                @if (showEditPeriodSelector)
                {
                    <div class="form-row">
                        <label>Data de in√≠cio</label>
                        <InputDate class="input" @bind-Value="editMission.StartDate" />
                    </div>
                    <div class="form-row">
                        <label>Data de fim</label>
                        <InputDate class="input" @bind-Value="editMission.EndDate" />
                    </div>
                }

                @* Status Selector (hidden by default) *@
                @if (showEditStatusSelector)
                {
                    <div class="form-row">
                        <label>Status</label>
                        <select class="input" @bind="editStatusValue">
                            @foreach (var status in Enum.GetValues<MissionStatus>())
                            {
                                <option value="@status">@GetStatusLabel(status)</option>
                            }
                        </select>
                    </div>
                }

                @* M√©tricas da miss√£o *@
                <div class="mission-metrics-section">
                    <div class="mission-metrics-section-header">
                        <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18 9l-5 5-4-4-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h3>M√©tricas da miss√£o</h3>
                    </div>

                    @if (!editMissionMetrics.Any())
                    {
                        <p class="muted">Nenhuma m√©trica associada a esta miss√£o.</p>
                    }
                    else
                    {
                        <div class="metrics-list">
                            @foreach (var metric in editMissionMetrics)
                            {
                                @if (editingMetricId == metric.Id)
                                {
                                    @* Formul√°rio inline para edi√ß√£o da m√©trica *@
                                    <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                        <div class="metrics-form-container">
                                            <div class="form-row">
                                                <label>Nome da m√©trica</label>
                                                <input type="text" class="input" @bind="editMetric.Name" />
                                            </div>

                                            <div class="metrics-form-selectors">
                                                <div class="metrics-selector-btn">
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                                    </svg>
                                                    <select value="@editMetricTypeValue" @onchange="OnEditMetricTypeChanged">
                                                        <option value="">Tipo de m√©trica</option>
                                                        @foreach (var mt in Enum.GetValues<MetricType>())
                                                        {
                                                            <option value="@mt">@GetMetricTypeLabel(mt)</option>
                                                        }
                                                    </select>
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                    </svg>
                                                </div>

                                                @if (editMetricTypeValue == nameof(MetricType.Quantitative))
                                                {
                                                    <div class="metrics-selector-btn">
                                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                                        </svg>
                                                        <select @bind="editMetricQuantitativeTypeValue">
                                                            <option value="">Modo de mensura√ß√£o</option>
                                                            @foreach (var qType in Enum.GetValues<QuantitativeMetricType>())
                                                            {
                                                                <option value="@qType">@GetQuantitativeTypeIcon(qType) @GetQuantitativeTypeLabel(qType)</option>
                                                            }
                                                        </select>
                                                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                        </svg>
                                                    </div>
                                                }
                                            </div>

                                            @if (editMetricTypeValue == nameof(MetricType.Qualitative))
                                            {
                                                <div class="form-row">
                                                    <label>Descri√ß√£o do objetivo</label>
                                                    <input type="text" class="input" @bind="editMetric.TargetText" />
                                                </div>
                                            }

                                            @if (editMetricTypeValue == nameof(MetricType.Quantitative) && !string.IsNullOrEmpty(editMetricQuantitativeTypeValue))
                                            {
                                                <div class="metrics-form-inputs">
                                                    <div class="metrics-input-field">
                                                        <select @bind="editMetricUnitValue">
                                                            <option value="">Unidade de medida</option>
                                                            @foreach (var unit in Enum.GetValues<MetricUnit>())
                                                            {
                                                                <option value="@unit">@GetUnitLabel(unit)</option>
                                                            }
                                                        </select>
                                                    </div>

                                                    @if (editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepAbove) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween))
                                                    {
                                                        <div class="metrics-input-field">
                                                            <InputNumber @bind-Value="editMetric.MinValue" placeholder="Valor m√≠nimo" />
                                                        </div>
                                                    }

                                                    @if (editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBelow) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.Achieve) ||
                                                         editMetricQuantitativeTypeValue == nameof(QuantitativeMetricType.Reduce))
                                                    {
                                                        <div class="metrics-input-field">
                                                            <InputNumber @bind-Value="editMetric.MaxValue" placeholder="@GetMaxValuePlaceholder(editMetricQuantitativeTypeValue)" />
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                                <button type="button" class="button tertiary" @onclick="CancelEditingMetric">Cancelar</button>
                                                <button type="button" class="button primary" @onclick="SaveEditingMetric">Salvar m√©trica</button>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    var isDeletingMetric = deletingMetricId == metric.Id;
                                    <div class="metric-item">
                                        <div class="metric-info">
                                            <div class="metric-name">@metric.Name</div>
                                            <div class="metric-details">@GetTargetLabel(metric)</div>
                                        </div>
                                        <CrudRowActions
                                            EditTitle="Editar m√©trica"
                                            OnEdit="@(() => StartEditingMetric(metric))"
                                            IsDeleteConfirming="@isDeletingMetric"
                                            DeleteTitle="Excluir m√©trica"
                                            OnDelete="@(() => HandleDeleteMetricClick(metric.Id))" />
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>

                <div class="form-actions" style="margin-top: var(--spacing-6);">
                    <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                    <button class="button primary" type="submit">Salvar altera√ß√µes</button>
                </div>
            </EditForm>
        </ChildContent>
    </Modal>
}

@* Modal de Check-in *@
@if (isCheckinModalOpen && checkinMission != null && selectedCheckinMetric != null)
{
    <Modal Title="Novo check-in" Breadcrumb="@selectedCheckinMetric.Name" Size="md" OnClose="CloseCheckinModal">
        <ChildContent>
            <div class="metrics-form-container">
                @if (selectedCheckinMetric.Type == MetricType.Quantitative)
                {
                    <div class="form-row">
                        <label>Valor atual @GetCheckinTargetHint(selectedCheckinMetric)</label>
                        <InputNumber class="input" @bind-Value="newCheckin.Value" placeholder="Ex: 42" />
                    </div>
                }
                else
                {
                    <div class="form-row">
                        <label>Texto de progresso</label>
                        <InputText class="input" @bind-Value="newCheckin.Text" placeholder="Descreva o progresso atual" />
                    </div>
                }

                <div class="form-row">
                    <label>N√≠vel de confian√ßa</label>
                    <div class="confidence-selector">
                        @for (int i = 1; i <= 5; i++)
                        {
                            var level = i;
                            <button type="button"
                                    class="confidence-btn @(newCheckin.ConfidenceLevel >= level ? "active" : "")"
                                    @onclick="() => newCheckin.ConfidenceLevel = level">
                                @level
                            </button>
                        }
                    </div>
                </div>

                <div class="form-row">
                    <label>Nota (opcional)</label>
                    <InputText class="input" @bind-Value="newCheckin.Note" placeholder="Contexto adicional sobre o progresso" />
                </div>
            </div>

            <div class="form-actions" style="margin-top: var(--spacing-6);">
                <button class="button tertiary" type="button" @onclick="CloseCheckinModal">Cancelar</button>
                <button class="button primary" @onclick="CreateCheckin">Criar check-in</button>
            </div>
        </ChildContent>
    </Modal>
}

@if (isCheckinHistoryModalOpen && historyMetric != null && historyMission != null)
{
    <Modal Title="Hist√≥rico de check-ins" Breadcrumb="@historyMetric.Name" Size="lg" OnClose="CloseCheckinHistoryModal">
        <ChildContent>
            <div class="checkin-history-container">
                <div class="checkin-history-header">
                    <div class="checkin-history-metric-info">
                        <div class="checkin-history-metric-name">@historyMetric.Name</div>
                        <div class="checkin-history-metric-target">@GetTargetLabel(historyMetric)</div>
                    </div>
                    <button class="button primary" @onclick="OpenCheckinFromHistory">
                        <span class="button-icon-text">+</span>
                        Novo check-in
                    </button>
                </div>

                @if (isLoadingCheckins)
                {
                    <div class="checkin-history-loading">
                        <p class="muted">Carregando check-ins...</p>
                    </div>
                }
                else if (!metricCheckins.Any())
                {
                    <div class="checkin-history-empty">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                            <path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p>Nenhum check-in registrado para esta m√©trica.</p>
                        <p class="muted">Registre seu primeiro check-in para acompanhar o progresso.</p>
                    </div>
                }
                else
                {
                    <div class="checkin-timeline">
                        @foreach (var checkin in metricCheckins)
                        {
                            var confidenceClass = checkin.ConfidenceLevel >= 4 ? "high" : checkin.ConfidenceLevel >= 2 ? "medium" : "low";
                            var collaboratorName = checkin.Collaborator?.FullName ?? "Colaborador";
                            <div class="checkin-timeline-item">
                                <div class="checkin-timeline-marker">
                                    <div class="checkin-timeline-dot @confidenceClass"></div>
                                    <div class="checkin-timeline-line"></div>
                                </div>
                                <div class="checkin-timeline-content">
                                    <div class="checkin-timeline-header">
                                        <div class="checkin-timeline-author">
                                            <div class="checkin-timeline-avatar" title="@collaboratorName">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                                                </svg>
                                            </div>
                                            <span class="checkin-timeline-author-name">@collaboratorName</span>
                                        </div>
                                        <div class="checkin-timeline-meta">
                                            <span class="checkin-timeline-date">@checkin.CheckinDate.ToString("dd/MM/yyyy")</span>
                                            <span class="checkin-timeline-confidence" title="N√≠vel de confian√ßa: @checkin.ConfidenceLevel">
                                                @GetConfidenceStarsDisplay(checkin.ConfidenceLevel)
                                            </span>
                                        </div>
                                    </div>
                                    <div class="checkin-timeline-value">
                                        @GetCheckinValueDisplay(checkin, historyMetric)
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(checkin.Note))
                                    {
                                        <div class="checkin-timeline-note">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <span>@checkin.Note</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </ChildContent>
    </Modal>
}


@code {
    private sealed record ScopeOption(string Id, string Name);
    private sealed record TempMetric(string Name, string Type, string Details, string? QuantitativeType = null, decimal? MinValue = null, decimal? MaxValue = null, string? TargetText = null, string? Unit = null);

    private CreateMissionRequest newMission = new();
    private PagedResult<Mission>? missions;
    private Dictionary<Guid, MissionProgressDto> missionProgress = new();
    private List<Organization> organizations = new();
    private List<Workspace> workspaces = new();
    private List<Team> teams = new();
    private List<Collaborator> collaborators = new();
    private string? createScopeTypeValue;
    private string? createScopeId;
    private string? filterScopeTypeValue;
    private string? filterScopeId;
    private string? search;
    private string viewMode = "list"; // "list" ou "grid"
    private bool isModalOpen = false;
    private bool showResponsibleSelector = false;
    private bool showPeriodSelector = false;
    private string? missionDescription;
    private bool showMetricForm = false;
    private string? newMetricName;
    private string? newMetricType;
    private string? newMetricQuantitativeType;
    private decimal? newMetricMinValue;
    private decimal? newMetricMaxValue;
    private string? newMetricTargetText;
    private string? newMetricUnit;
    private List<TempMetric> tempMetrics = new();

    // Temp metric edit state
    private int? editingTempMetricIndex;
    private string editTempMetricName = string.Empty;
    private string? editTempMetricType;
    private string? editTempMetricQuantitativeType;
    private string? editTempMetricUnit;
    private decimal? editTempMetricMinValue;
    private decimal? editTempMetricMaxValue;
    private string? editTempMetricTargetText;

    // Card expansion state
    private HashSet<Guid> expandedMissions = new();
    private Dictionary<Guid, List<MissionMetric>> missionMetricsCache = new();
    private Dictionary<Guid, MetricProgressDto> metricProgressCache = new();

    // Checkin modal state
    private bool isCheckinModalOpen = false;
    private Mission? checkinMission = null;
    private List<MissionMetric> checkinMetrics = new();
    private string? checkinMetricId;
    private MissionMetric? selectedCheckinMetric;
    private CreateMetricCheckinRequest newCheckin = new();
    private DateOnly checkinDate = DateOnly.FromDateTime(DateTime.Today);

    // Edit modal state
    private bool isEditModalOpen = false;
    private Mission? selectedMission = null;
    private UpdateMissionRequest editMission = new();
    private string? editStatusValue;
    private string? editScopeTypeValue;
    private string? editScopeId;
    private string? editMissionDescription;
    private bool showEditResponsibleSelector = false;
    private bool showEditPeriodSelector = false;
    private bool showEditStatusSelector = false;

    // Metrics within edit modal
    private List<MissionMetric> editMissionMetrics = new();
    private Guid? editingMetricId = null;
    private UpdateMissionMetricRequest editMetric = new();
    private string? editMetricTypeValue;
    private string? editMetricQuantitativeTypeValue;
    private string? editMetricUnitValue;

    // Delete confirmation state
    private Guid? deletingMissionId = null;
    private System.Threading.Timer? deleteConfirmTimer;
    private Guid? deletingMetricId = null;
    private System.Threading.Timer? deleteMetricConfirmTimer;

    // Template picker state
    private bool isTemplatePickerOpen = false;
    private List<MissionTemplate> availableTemplates = new();

    // Filter panel state
    private bool showFilterPanel = false;
    private bool filterActiveOnly = true;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private bool showDatePicker = false;

    // Checkin history modal state
    private bool isCheckinHistoryModalOpen = false;
    private MissionMetric? historyMetric = null;
    private Mission? historyMission = null;
    private List<MetricCheckin> metricCheckins = new();
    private bool isLoadingCheckins = false;

    protected override async Task OnInitializedAsync()
    {
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };

        // Subscribe to organization changes
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;

        // Aguardar inicializa√ß√£o do OrgContext (MainLayout pode ainda estar carregando)
        var maxWait = 50; // 50 * 100ms = 5 segundos m√°ximo
        while (!OrgContext.IsInitialized && maxWait > 0)
        {
            await Task.Delay(100);
            maxWait--;
        }

        await LoadReferenceData();
        await LoadMissions();
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                filterScopeTypeValue = null;
                filterScopeId = null;
                await LoadReferenceData();
                await LoadMissions();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar miss√µes por troca de organiza√ß√£o: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar miss√µes", "N√£o foi poss√≠vel atualizar os dados da organiza√ß√£o selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
        deleteMetricConfirmTimer?.Dispose();
    }

    private async Task LoadReferenceData()
    {
        // Filtrar dados pelo tenant selecionado
        var orgId = OrgContext.SelectedOrganizationId;

        var orgsResult = await Api.GetOrganizationsAsync(null, 1, 100);
        organizations = orgsResult?.Items.ToList() ?? new List<Organization>();

        var workspacesResult = await Api.GetWorkspacesAsync(orgId, null, 1, 100);
        workspaces = workspacesResult?.Items.ToList() ?? new List<Workspace>();

        var teamsResult = await Api.GetTeamsAsync(null, null, null, 1, 100);
        teams = teamsResult?.Items.ToList() ?? new List<Team>();

        var collaboratorsResult = await Api.GetCollaboratorsAsync(null, null, 1, 100);
        collaborators = collaboratorsResult?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task LoadMissions()
    {
        var scopeType = ParseScopeType(filterScopeTypeValue);
        var scopeId = Guid.TryParse(filterScopeId, out var parsedScopeId)
            ? parsedScopeId
            : (Guid?)null;

        var result = await Api.GetMissionsAsync(scopeType, scopeId, search, 1, 100) ?? new PagedResult<Mission>();

        // Apply client-side filters
        var filteredItems = result.Items.AsEnumerable();

        // Filter by active status
        if (filterActiveOnly)
        {
            filteredItems = filteredItems.Where(m => m.Status == MissionStatus.Active);
        }

        // Filter by date range
        if (filterStartDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.EndDate >= filterStartDate.Value);
        }
        if (filterEndDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.StartDate <= filterEndDate.Value);
        }

        var filteredList = filteredItems.ToList();
        missions = new PagedResult<Mission>
        {
            Items = filteredList,
            Total = filteredList.Count,
            Page = 1,
            PageSize = filteredList.Count
        };

        await LoadProgress();
    }

    private async Task LoadProgress()
    {
        if (missions is null || missions.Items.Count == 0)
        {
            missionProgress = new();
            return;
        }

        try
        {
            var ids = missions.Items.Select(m => m.Id).ToList();
            var progressList = await Api.GetMissionProgressAsync(ids);
            missionProgress = progressList?.ToDictionary(p => p.MissionId) ?? new();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar progresso das miss√µes: {ex.Message}");
            missionProgress = new();
        }
    }

    private async Task OnCreateScopeTypeChanged(ChangeEventArgs e)
    {
        createScopeTypeValue = e.Value?.ToString();
        createScopeId = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFilterScopeTypeChanged(ChangeEventArgs e)
    {
        filterScopeTypeValue = e.Value?.ToString();
        filterScopeId = null;
        await LoadMissions();
    }

    private async Task OnEditScopeTypeChanged(ChangeEventArgs e)
    {
        editScopeTypeValue = e.Value?.ToString();
        editScopeId = null;
        await InvokeAsync(StateHasChanged);
    }

    private void ToggleFilterPanel()
    {
        showFilterPanel = !showFilterPanel;
    }

    private void ToggleViewMode()
    {
        viewMode = viewMode == "list" ? "grid" : "list";
    }

    private async Task ClearFilters()
    {
        filterScopeTypeValue = null;
        filterScopeId = null;
        search = null;
        filterActiveOnly = false;
        filterStartDate = null;
        filterEndDate = null;
        showDatePicker = false;
        await LoadMissions();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(filterScopeTypeValue)
            || !string.IsNullOrEmpty(search)
            || filterActiveOnly
            || filterStartDate.HasValue
            || filterEndDate.HasValue;
    }

    private void ToggleDatePicker()
    {
        showDatePicker = !showDatePicker;
    }

    private void OnStartDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            filterStartDate = date;
        }
        else
        {
            filterStartDate = null;
        }
    }

    private void OnEndDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            filterEndDate = date;
        }
        else
        {
            filterEndDate = null;
        }
    }

    private async Task ApplyDateFilter()
    {
        showDatePicker = false;
        await LoadMissions();
    }

    private async Task ToggleActiveFilter()
    {
        filterActiveOnly = !filterActiveOnly;
        await LoadMissions();
    }

    private string GetDateRangeLabel()
    {
        if (filterStartDate.HasValue && filterEndDate.HasValue)
        {
            return $"{filterStartDate:dd/MM} - {filterEndDate:dd/MM/yyyy}";
        }
        if (filterStartDate.HasValue)
        {
            return $"A partir de {filterStartDate:dd/MM/yyyy}";
        }
        if (filterEndDate.HasValue)
        {
            return $"At√© {filterEndDate:dd/MM/yyyy}";
        }
        return "Selecionar per√≠odo";
    }

    private string GetStatusFilterLabel()
    {
        return filterActiveOnly ? "Status ativo" : "Todos os status";
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadMissions();
        }
    }

    private async Task OpenCreateModal()
    {
        // Load available templates and open the picker
        try
        {
            var result = await Api.GetMissionTemplatesAsync(null, 1, 50);
            availableTemplates = result?.Items
                .Where(t => t.IsActive)
                .ToList() ?? new();
        }
        catch
        {
            availableTemplates = new();
        }

        isTemplatePickerOpen = true;
    }

    private void OpenCreateModalFromScratch()
    {
        isTemplatePickerOpen = false;
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        missionDescription = null;
        showResponsibleSelector = false;
        showPeriodSelector = false;
        showMetricForm = false;
        tempMetrics.Clear();
        ClearMetricForm();
        isModalOpen = true;
    }

    private void OpenCreateModalFromTemplate(MissionTemplate template)
    {
        isTemplatePickerOpen = false;
        newMission = new CreateMissionRequest
        {
            Name = template.MissionNamePattern ?? string.Empty,
            Description = template.MissionDescriptionPattern,
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(90),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        missionDescription = template.MissionDescriptionPattern;
        showResponsibleSelector = false;
        showPeriodSelector = false;
        showMetricForm = false;

        // Pre-fill metrics from template
        tempMetrics = template.Metrics
            .OrderBy(m => m.OrderIndex)
            .Select(m => new TempMetric(
                m.Name,
                m.Type.ToString(),
                GetTemplateMetricDetails(m),
                m.QuantitativeType?.ToString(),
                m.MinValue,
                m.MaxValue,
                m.TargetText,
                m.Unit?.ToString()))
            .ToList();

        ClearMetricForm();
        isModalOpen = true;
    }

    private static string GetTemplateMetricDetails(MissionTemplateMetric metric)
    {
        if (metric.Type == MetricType.Qualitative)
            return $"Qualitativa ‚Äî {metric.TargetText}";

        var parts = new List<string> { "Quantitativa" };
        if (metric.QuantitativeType.HasValue)
            parts.Add(metric.QuantitativeType.Value.ToString());
        if (metric.Unit.HasValue)
            parts.Add(metric.Unit.Value.ToString());
        if (metric.MinValue.HasValue)
            parts.Add($"Min: {metric.MinValue}");
        if (metric.MaxValue.HasValue)
            parts.Add($"Max: {metric.MaxValue}");
        return string.Join(" ‚Äî ", parts);
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private string GetSelectedOrganizationName()
    {
        return organizations.FirstOrDefault()?.Name ?? "Organiza√ß√£o";
    }

    private string GetResponsibleLabel()
    {
        if (!string.IsNullOrEmpty(createScopeId) && Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            var option = GetScopeOptions(createScopeTypeValue).FirstOrDefault(o => o.Id == createScopeId);
            if (option != null)
            {
                return $"Respons√°vel: {option.Name}";
            }
        }
        return "Respons√°vel";
    }

    private string GetPeriodLabel()
    {
        if (newMission.StartDate != DateTime.MinValue && newMission.EndDate != DateTime.MinValue)
        {
            return $"Per√≠odo de in√≠cio e fim: {newMission.StartDate:dd/MM/yyyy} - {newMission.EndDate:dd/MM/yyyy}";
        }
        return "Per√≠odo de in√≠cio e fim";
    }

    private string GetEditResponsibleLabel()
    {
        if (!string.IsNullOrEmpty(editScopeId) && Enum.TryParse<MissionScopeType>(editScopeTypeValue, out var scopeType))
        {
            var option = GetScopeOptions(editScopeTypeValue).FirstOrDefault(o => o.Id == editScopeId);
            if (option != null)
            {
                return $"Respons√°vel: {option.Name}";
            }
        }
        return "Respons√°vel";
    }

    private string GetEditPeriodLabel()
    {
        if (editMission.StartDate != DateTime.MinValue && editMission.EndDate != DateTime.MinValue)
        {
            return $"Per√≠odo: {editMission.StartDate:dd/MM/yyyy} - {editMission.EndDate:dd/MM/yyyy}";
        }
        return "Per√≠odo de in√≠cio e fim";
    }

    private async Task SaveDraft()
    {
        if (!TryValidateMissionCreation("Erro ao salvar rascunho", out var scopeType, out var scopeId))
        {
            return;
        }

        await CreateMissionWithStatusAsync(
            scopeType,
            scopeId,
            MissionStatus.Planned,
            "Rascunho salvo com sucesso!",
            _ => "A miss√£o foi salva como rascunho.",
            "Erro ao salvar rascunho",
            "N√£o foi poss√≠vel salvar o rascunho da miss√£o. Verifique os dados e tente novamente.",
            "salvamento de rascunho de miss√£o");
    }

    private void FlushPendingMetric()
    {
        if (showMetricForm && !string.IsNullOrWhiteSpace(newMetricName) && !string.IsNullOrWhiteSpace(newMetricType))
        {
            var details = newMetricType == "Quantitative"
                ? BuildQuantitativeDetails()
                : newMetricTargetText ?? "";

            tempMetrics.Add(new TempMetric(
                newMetricName,
                newMetricType,
                details,
                newMetricQuantitativeType,
                newMetricMinValue,
                newMetricMaxValue,
                newMetricTargetText,
                newMetricUnit
            ));

            ClearMetricForm();
        }
    }

    private async Task CreateMetricsForMission(Mission? createdMission)
    {
        if (createdMission is null || !tempMetrics.Any())
        {
            return;
        }

        var failedCount = 0;
        foreach (var tempMetric in tempMetrics)
        {
            if (!EnumParsingHelper.TryParseEnum<MetricType>(tempMetric.Type, out var metricType))
            {
                failedCount++;
                continue;
            }

            var metricRequest = new CreateMissionMetricRequest
            {
                MissionId = createdMission.Id,
                Name = tempMetric.Name,
                Type = metricType
            };

            if (tempMetric.Type == "Quantitative")
            {
                if (!string.IsNullOrEmpty(tempMetric.QuantitativeType))
                {
                    if (EnumParsingHelper.TryParseEnum<QuantitativeMetricType>(tempMetric.QuantitativeType, out var quantitativeType))
                    {
                        metricRequest.QuantitativeType = quantitativeType;
                    }
                    else
                    {
                        failedCount++;
                        continue;
                    }
                }
                metricRequest.MinValue = tempMetric.MinValue;
                metricRequest.MaxValue = tempMetric.MaxValue;
                if (!string.IsNullOrEmpty(tempMetric.Unit))
                {
                    if (EnumParsingHelper.TryParseEnum<MetricUnit>(tempMetric.Unit, out var unit))
                    {
                        metricRequest.Unit = unit;
                    }
                    else
                    {
                        failedCount++;
                        continue;
                    }
                }
            }
            else
            {
                metricRequest.TargetText = tempMetric.TargetText;
            }

            try
            {
                await Api.CreateMissionMetricAsync(metricRequest);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erro ao criar m√©trica tempor√°ria para miss√£o {createdMission.Id}: {ex.Message}");
                failedCount++;
            }
        }

        if (failedCount > 0)
        {
            ToastService.ShowError("Erro ao salvar m√©tricas", $"{failedCount} m√©trica(s) n√£o puderam ser salvas.");
        }
    }

    private void CancelAddMetricForm()
    {
        showMetricForm = false;
        ClearMetricForm();
    }

    private void AddMetricFromForm()
    {
        if (string.IsNullOrWhiteSpace(newMetricName) || string.IsNullOrWhiteSpace(newMetricType))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome e tipo da m√©trica.");
            return;
        }

        var details = newMetricType == "Quantitative"
            ? BuildQuantitativeDetails()
            : newMetricTargetText ?? "";

        tempMetrics.Add(new TempMetric(
            newMetricName,
            newMetricType,
            details,
            newMetricQuantitativeType,
            newMetricMinValue,
            newMetricMaxValue,
            newMetricTargetText,
            newMetricUnit
        ));

        showMetricForm = false;
        ClearMetricForm();
    }

    private void RemoveMetric(TempMetric metric)
    {
        tempMetrics.Remove(metric);
    }

    private void StartEditTempMetric(int index)
    {
        var metric = tempMetrics[index];
        editingTempMetricIndex = index;
        editTempMetricName = metric.Name;
        editTempMetricType = metric.Type;
        editTempMetricQuantitativeType = metric.QuantitativeType;
        editTempMetricUnit = metric.Unit;
        editTempMetricMinValue = metric.MinValue;
        editTempMetricMaxValue = metric.MaxValue;
        editTempMetricTargetText = metric.TargetText;
    }

    private void CancelEditTempMetric()
    {
        editingTempMetricIndex = null;
        editTempMetricName = string.Empty;
        editTempMetricType = null;
        editTempMetricQuantitativeType = null;
        editTempMetricUnit = null;
        editTempMetricMinValue = null;
        editTempMetricMaxValue = null;
        editTempMetricTargetText = null;
    }

    private void SaveEditTempMetric()
    {
        if (editingTempMetricIndex is null) return;

        if (string.IsNullOrWhiteSpace(editTempMetricName) || string.IsNullOrEmpty(editTempMetricType))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome e tipo da m√©trica.");
            return;
        }

        var details = editTempMetricType == "Quantitative"
            ? BuildQuantitativeDetailsFrom(editTempMetricQuantitativeType, editTempMetricMinValue, editTempMetricMaxValue, editTempMetricUnit)
            : editTempMetricTargetText ?? "";

        tempMetrics[editingTempMetricIndex.Value] = new TempMetric(
            editTempMetricName,
            editTempMetricType,
            details,
            editTempMetricQuantitativeType,
            editTempMetricMinValue,
            editTempMetricMaxValue,
            editTempMetricTargetText,
            editTempMetricUnit
        );

        CancelEditTempMetric();
    }

    private void OnEditTempMetricTypeChanged(ChangeEventArgs e)
    {
        editTempMetricType = e.Value?.ToString();
        editTempMetricTargetText = null;
        editTempMetricMinValue = null;
        editTempMetricMaxValue = null;
        editTempMetricQuantitativeType = null;
        editTempMetricUnit = null;
    }

    private string BuildQuantitativeDetailsFrom(string? quantitativeType, decimal? minValue, decimal? maxValue, string? unit)
    {
        var unitLabel = GetUnitLabelShort(unit);
        return quantitativeType switch
        {
            "KeepAbove" => $"Acima de {minValue} {unitLabel}",
            "KeepBelow" => $"Abaixo de {maxValue} {unitLabel}",
            "KeepBetween" => $"Entre {minValue} e {maxValue} {unitLabel}",
            "Achieve" => $"Atingir {maxValue} {unitLabel}",
            "Reduce" => $"Reduzir para {maxValue} {unitLabel}",
            _ => ""
        };
    }

    private void ClearMetricForm()
    {
        newMetricName = null;
        newMetricType = null;
        newMetricQuantitativeType = null;
        newMetricMinValue = null;
        newMetricMaxValue = null;
        newMetricTargetText = null;
        newMetricUnit = null;
    }

    private string BuildQuantitativeDetails()
    {
        var unit = GetUnitLabelShort(newMetricUnit);
        return newMetricQuantitativeType switch
        {
            "KeepAbove" => $"Acima de {newMetricMinValue} {unit}",
            "KeepBelow" => $"Abaixo de {newMetricMaxValue} {unit}",
            "KeepBetween" => $"Entre {newMetricMinValue} e {newMetricMaxValue} {unit}",
            "Achieve" => $"Atingir {newMetricMaxValue} {unit}",
            "Reduce" => $"Reduzir para {newMetricMaxValue} {unit}",
            _ => ""
        };
    }

    private string GetUnitLabelShort(string? unit) => unit switch
    {
        "Integer" => "un",
        "Decimal" => "un",
        "Percentage" => "%",
        "Hours" => "h",
        "Points" => "pts",
        _ => ""
    };

    private async Task CreateMission()
    {
        if (!TryValidateMissionCreation("Erro ao criar miss√£o", out var scopeType, out var scopeId))
        {
            return;
        }

        await CreateMissionWithStatusAsync(
            scopeType,
            scopeId,
            MissionStatus.Active,
            "Miss√£o criada com sucesso!",
            createdMission => $"A miss√£o '{createdMission?.Name}' foi criada e est√° ativa.",
            "Erro ao criar miss√£o",
            "N√£o foi poss√≠vel criar a miss√£o. Verifique os dados e tente novamente.",
            "cria√ß√£o de miss√£o");
    }

    private bool TryValidateMissionCreation(string errorTitle, out MissionScopeType scopeType, out Guid scopeId)
    {
        scopeType = default;
        scopeId = Guid.Empty;

        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out scopeType))
        {
            ToastService.ShowError(errorTitle, "Selecione o escopo.");
            return false;
        }

        if (!Guid.TryParse(createScopeId, out scopeId))
        {
            ToastService.ShowError(errorTitle, "Selecione a refer√™ncia do escopo.");
            return false;
        }

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            ToastService.ShowError(errorTitle, "Informe o nome da miss√£o.");
            return false;
        }

        if (newMission.EndDate < newMission.StartDate)
        {
            ToastService.ShowError(errorTitle, "A data de fim precisa ser igual ou maior que a data de in√≠cio.");
            return false;
        }

        return true;
    }

    private async Task CreateMissionWithStatusAsync(
        MissionScopeType scopeType,
        Guid scopeId,
        MissionStatus status,
        string successTitle,
        Func<Mission?, string> successMessageFactory,
        string errorTitle,
        string errorMessage,
        string operationContext)
    {
        FlushPendingMetric();

        await UiOperationRunner.RunAsync(
            async () =>
            {
                newMission.ScopeType = scopeType;
                newMission.ScopeId = scopeId;
                newMission.Description = missionDescription;
                newMission.Status = status;

                var createdMission = await Api.CreateMissionAsync(newMission);
                await CreateMetricsForMission(createdMission);

                newMission = new CreateMissionRequest
                {
                    StartDate = DateTime.Today,
                    EndDate = DateTime.Today.AddDays(7),
                    Status = MissionStatus.Planned
                };
                createScopeTypeValue = null;
                createScopeId = null;

                await LoadMissions();

                ToastService.ShowSuccess(successTitle, successMessageFactory(createdMission));
                CloseModal();
            },
            ToastService,
            errorTitle,
            errorMessage,
            operationContext);
    }

    private IEnumerable<ScopeOption> GetScopeOptions(string? scopeTypeValue)
    {
        if (!Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType))
        {
            return Enumerable.Empty<ScopeOption>();
        }

        return scopeType switch
        {
            MissionScopeType.Organization => organizations.Select(o => new ScopeOption(o.Id.ToString(), o.Name)),
            MissionScopeType.Workspace => workspaces.Select(w => new ScopeOption(w.Id.ToString(), w.Name)),
            MissionScopeType.Team => teams.Select(t => new ScopeOption(t.Id.ToString(), t.Name)),
            MissionScopeType.Collaborator => collaborators.Select(c => new ScopeOption(c.Id.ToString(), c.FullName)),
            _ => Enumerable.Empty<ScopeOption>()
        };
    }

    private MissionScopeType? ParseScopeType(string? scopeTypeValue)
    {
        return Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType) ? scopeType : null;
    }

    private string GetMissionScopeName(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
        {
            return collaborators.FirstOrDefault(c => c.Id == mission.CollaboratorId.Value)?.FullName ?? "‚Äî";
        }

        if (mission.TeamId.HasValue)
        {
            return teams.FirstOrDefault(t => t.Id == mission.TeamId.Value)?.Name ?? "‚Äî";
        }

        if (mission.WorkspaceId.HasValue)
        {
            return workspaces.FirstOrDefault(w => w.Id == mission.WorkspaceId.Value)?.Name ?? "‚Äî";
        }

        // Org-scoped: no other scope FK is set, OrganizationId is always present
        return organizations.FirstOrDefault(o => o.Id == mission.OrganizationId)?.Name ?? "‚Äî";
    }

    private static string GetScopeLabel(MissionScopeType scopeType) => scopeType switch
    {
        MissionScopeType.Organization => "Organiza√ß√£o",
        MissionScopeType.Workspace => "Workspace",
        MissionScopeType.Team => "Equipe",
        MissionScopeType.Collaborator => "Colaborador",
        _ => scopeType.ToString()
    };

    private static string GetStatusLabel(MissionStatus status) => status switch
    {
        MissionStatus.Planned => "Planejada",
        MissionStatus.Active => "Ativa",
        MissionStatus.Completed => "Conclu√≠da",
        MissionStatus.Cancelled => "Cancelada",
        _ => status.ToString()
    };

    // ---- Card Expansion Methods ----

    private async Task ToggleExpand(Guid missionId)
    {
        if (expandedMissions.Contains(missionId))
        {
            expandedMissions.Remove(missionId);
        }
        else
        {
            expandedMissions.Add(missionId);
            if (!missionMetricsCache.ContainsKey(missionId))
            {
                var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(missionId);
                var metrics = metricsResult?.Items.ToList() ?? new List<MissionMetric>();
                missionMetricsCache[missionId] = metrics;

                // Load progress for each metric
                if (metrics.Count > 0)
                {
                    var metricIds = metrics.Select(m => m.Id).ToList();
                    var progressList = await Api.GetMetricProgressAsync(metricIds);
                    if (progressList != null)
                    {
                        foreach (var progress in progressList)
                        {
                            metricProgressCache[progress.MetricId] = progress;
                        }
                    }
                    StateHasChanged();
                }
            }
        }
    }

    // ---- Checkin History Modal Methods ----

    private async Task OpenCheckinHistoryModal(Mission mission, MissionMetric metric)
    {
        historyMission = mission;
        historyMetric = metric;
        isCheckinHistoryModalOpen = true;
        isLoadingCheckins = true;
        metricCheckins = new List<MetricCheckin>();
        StateHasChanged();

        try
        {
            var result = await Api.GetMetricCheckinsAsync(metric.Id, null, 1, 50);
            metricCheckins = result?.Items.OrderByDescending(c => c.CheckinDate).ToList() ?? new List<MetricCheckin>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar hist√≥rico de check-ins da m√©trica {metric.Id}: {ex.Message}");
            metricCheckins = new List<MetricCheckin>();
            ToastService.ShowError("Erro ao carregar hist√≥rico", "N√£o foi poss√≠vel carregar o hist√≥rico de check-ins desta m√©trica.");
        }
        finally
        {
            isLoadingCheckins = false;
            StateHasChanged();
        }
    }

    private void CloseCheckinHistoryModal()
    {
        isCheckinHistoryModalOpen = false;
        historyMetric = null;
        historyMission = null;
        metricCheckins = new List<MetricCheckin>();
    }

    private void OpenCheckinFromHistory()
    {
        // Capture values before closing the history modal
        var mission = historyMission;
        var metric = historyMetric;

        // Close history modal first
        isCheckinHistoryModalOpen = false;
        historyMetric = null;
        historyMission = null;
        metricCheckins = new List<MetricCheckin>();

        // Now open checkin modal with captured values
        if (mission != null && metric != null)
        {
            OpenCheckinModalForMetric(mission, metric);
        }
    }

    private static string GetConfidenceStarsDisplay(int level)
    {
        return new string('‚òÖ', level) + new string('‚òÜ', 5 - level);
    }

    private static string GetCheckinValueDisplay(MetricCheckin checkin, MissionMetric? metric)
    {
        if (checkin.Value.HasValue)
        {
            var unit = metric?.Unit.HasValue == true ? GetUnitLabel(metric.Unit!.Value) : "";
            return $"{checkin.Value.Value:G} {unit}".Trim();
        }
        if (!string.IsNullOrWhiteSpace(checkin.Text))
        {
            return checkin.Text;
        }
        return "‚Äî";
    }

    // ---- Summary Card Methods ----

    private int GetOverallProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.TotalMetrics > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.OverallProgress);
    }

    private int GetExpectedProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.ExpectedProgress > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.ExpectedProgress);
    }

    private int GetActiveMissionsCount()
    {
        return missions?.Items.Count(m => m.Status == MissionStatus.Active) ?? 0;
    }

    private int GetOutdatedMetricsCount()
    {
        return missionProgress.Values.Sum(p => p.OutdatedMetrics);
    }

    // ---- Metric Display Methods ----

    private int GetMetricProgress(MissionMetric metric)
    {
        if (metricProgressCache.TryGetValue(metric.Id, out var progress))
        {
            return (int)progress.Progress;
        }
        return 0;
    }

    private bool IsMetricOutdated(Guid metricId)
    {
        if (metricProgressCache.TryGetValue(metricId, out var progress))
        {
            return progress.IsOutdated;
        }
        // No progress data means no check-ins, which is outdated
        return true;
    }

    private static string GetMetricStatusClass(int progress, decimal expectedProgress)
    {
        // Se ainda n√£o h√° progresso esperado (miss√£o n√£o iniciou), considera on-track
        if (expectedProgress <= 0)
        {
            return "on-track";
        }

        // Compara progresso real com esperado
        if (progress >= (int)expectedProgress)
        {
            return "on-track";
        }

        if (progress >= (int)(expectedProgress * 0.7m))
        {
            return "at-risk";
        }

        return "off-track";
    }

    private static string GetMetricStatusLabel(int progress, decimal expectedProgress, MissionMetric metric)
    {
        if (metric.Type == MetricType.Qualitative) return "Qualitativo";

        // Se ainda n√£o h√° progresso esperado (miss√£o n√£o iniciou), considera on-track
        if (expectedProgress <= 0)
        {
            return "Dentro do previsto";
        }

        // Compara progresso real com esperado
        if (progress >= (int)expectedProgress)
        {
            return "Dentro do previsto";
        }

        if (progress >= (int)(expectedProgress * 0.7m))
        {
            return "Aten√ß√£o";
        }

        return "Em risco";
    }

    private MarkupString GetMetricIcon(MetricType type)
    {
        return type switch
        {
            MetricType.Quantitative => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><path d=""M16 4V28M4 16H28"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round""/></svg>"),
            MetricType.Qualitative => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><path d=""M16 4L20 12L28 14L22 20L24 28L16 24L8 28L10 20L4 14L12 12L16 4Z"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round"" stroke-linejoin=""round""/></svg>"),
            _ => new MarkupString(@"<svg width=""24"" height=""24"" viewBox=""0 0 32 32"" fill=""none""><circle cx=""16"" cy=""16"" r=""10"" stroke=""currentColor"" stroke-width=""2""/></svg>")
        };
    }

    private string GetQuarterLabel(Mission mission)
    {
        var quarter = (mission.StartDate.Month - 1) / 3 + 1;
        return $"Q{quarter} {mission.StartDate.Year}";
    }

    // ---- Checkin Modal Methods ----

    private void OpenCheckinModalForMetric(Mission mission, MissionMetric metric)
    {
        checkinMission = mission;
        checkinMetrics = missionMetricsCache.GetValueOrDefault(mission.Id) ?? new List<MissionMetric>();
        checkinMetricId = metric.Id.ToString();
        selectedCheckinMetric = metric;
        newCheckin = new CreateMetricCheckinRequest { ConfidenceLevel = 3 };
        checkinDate = DateOnly.FromDateTime(DateTime.Today);
        isCheckinModalOpen = true;
    }

    private void CloseCheckinModal()
    {
        isCheckinModalOpen = false;
        checkinMission = null;
        checkinMetrics = new();
        checkinMetricId = null;
        selectedCheckinMetric = null;
    }

    private void OnCheckinMetricChanged()
    {
        if (Guid.TryParse(checkinMetricId, out var metricId))
        {
            selectedCheckinMetric = checkinMetrics.FirstOrDefault(m => m.Id == metricId);
        }
        else
        {
            selectedCheckinMetric = null;
        }
    }

    private async Task CreateCheckin()
    {
        if (selectedCheckinMetric is null)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione uma m√©trica.");
            return;
        }

        if (newCheckin.ConfidenceLevel < 1 || newCheckin.ConfidenceLevel > 5)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione o n√≠vel de confian√ßa (1-5).");
            return;
        }

        newCheckin.MissionMetricId = selectedCheckinMetric.Id;
        newCheckin.CheckinDate = DateTime.UtcNow;

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.CreateMetricCheckinAsync(newCheckin);
                ToastService.ShowSuccess("Check-in criado", "O check-in foi registrado com sucesso.");
                CloseCheckinModal();
                await LoadProgress();
            },
            ToastService,
            "Erro ao criar check-in",
            "N√£o foi poss√≠vel criar o check-in. Verifique os dados e tente novamente.",
            "cria√ß√£o de check-in em miss√£o");
    }

    private static string GetCheckinTargetHint(MissionMetric metric) => MissionMetricDisplayHelper.GetCheckinTargetHint(metric);

    private static string GetMaxValuePlaceholder(string? quantitativeType) => quantitativeType switch
    {
        "KeepBelow" or nameof(QuantitativeMetricType.KeepBelow) => "Valor m√°ximo",
        "KeepBetween" or nameof(QuantitativeMetricType.KeepBetween) => "Valor m√°ximo",
        "Achieve" or nameof(QuantitativeMetricType.Achieve) => "Valor alvo",
        "Reduce" or nameof(QuantitativeMetricType.Reduce) => "Valor alvo",
        _ => "Valor m√°ximo"
    };

    // ---- Mission Edit/Delete Methods ----

    private async Task OpenEditModal(Mission mission)
    {
        selectedMission = mission;

        var (scopeType, scopeId) = GetMissionScope(mission);
        editScopeTypeValue = scopeType.ToString();
        editScopeId = scopeId.ToString();
        editMissionDescription = mission.Description;

        editMission = new UpdateMissionRequest
        {
            Name = mission.Name,
            StartDate = mission.StartDate,
            EndDate = mission.EndDate,
            Status = mission.Status,
            ScopeType = scopeType,
            ScopeId = scopeId
        };
        editStatusValue = mission.Status.ToString();

        var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(mission.Id);
        editMissionMetrics = metricsResult?.Items.ToList() ?? new List<MissionMetric>();

        editingMetricId = null;
        editMetric = new();
        deletingMetricId = null;

        isEditModalOpen = true;
    }

    private (MissionScopeType scopeType, Guid scopeId) GetMissionScope(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
            return (MissionScopeType.Collaborator, mission.CollaboratorId.Value);
        if (mission.TeamId.HasValue)
            return (MissionScopeType.Team, mission.TeamId.Value);
        if (mission.WorkspaceId.HasValue)
            return (MissionScopeType.Workspace, mission.WorkspaceId.Value);
        return (MissionScopeType.Organization, mission.OrganizationId);
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedMission = null;
        editMission = new();
        editMissionMetrics = new();
        editingMetricId = null;
        editMetric = new();
        editMetricTypeValue = null;
        editMetricQuantitativeTypeValue = null;
        editMetricUnitValue = null;
        deletingMetricId = null;
        editScopeTypeValue = null;
        editScopeId = null;
        editMissionDescription = null;
        showEditResponsibleSelector = false;
        showEditPeriodSelector = false;
        showEditStatusSelector = false;
    }

    private async Task UpdateMission()
    {
        if (selectedMission == null) return;

        if (Enum.TryParse<MissionStatus>(editStatusValue, out var status))
        {
            editMission.Status = status;
        }

        if (Enum.TryParse<MissionScopeType>(editScopeTypeValue, out var scopeType) &&
            Guid.TryParse(editScopeId, out var scopeId))
        {
            editMission.ScopeType = scopeType;
            editMission.ScopeId = scopeId;
        }

        editMission.Description = editMissionDescription;

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.UpdateMissionAsync(selectedMission.Id, editMission);
                ToastService.ShowSuccess("Miss√£o atualizada", "As altera√ß√µes foram salvas com sucesso.");
                CloseEditModal();
                await LoadMissions();
            },
            ToastService,
            "Erro ao atualizar",
            "N√£o foi poss√≠vel atualizar a miss√£o. Verifique os dados e tente novamente.",
            "atualiza√ß√£o de miss√£o");
    }

    private async Task HandleDeleteClick(Guid missionId)
    {
        if (deletingMissionId == missionId)
        {
            await DeleteMission(missionId);
        }
        else
        {
            ArmMissionDeleteConfirmation(missionId);
        }
    }

    private async Task DeleteMission(Guid missionId)
    {
        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionAsync(missionId);
                    ToastService.ShowSuccess("Miss√£o exclu√≠da", "A miss√£o foi removida com sucesso.");
                    await LoadMissions();
                },
                ToastService,
                "Erro ao excluir",
                "N√£o foi poss√≠vel excluir a miss√£o. Tente novamente.",
                "exclus√£o de miss√£o");
        }
        finally
        {
            ClearMissionDeleteConfirmation();
        }
    }

    // ---- Inline Metric Edit/Delete Methods ----

    private void StartEditingMetric(MissionMetric metric)
    {
        editingMetricId = metric.Id;
        editMetric = new UpdateMissionMetricRequest
        {
            Name = metric.Name,
            Type = metric.Type,
            QuantitativeType = metric.QuantitativeType,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            Unit = metric.Unit,
            TargetText = metric.TargetText
        };
        editMetricTypeValue = metric.Type.ToString();
        editMetricQuantitativeTypeValue = metric.QuantitativeType?.ToString();
        editMetricUnitValue = metric.Unit?.ToString();
    }

    private void CancelEditingMetric()
    {
        editingMetricId = null;
        editMetric = new();
        editMetricTypeValue = null;
        editMetricQuantitativeTypeValue = null;
        editMetricUnitValue = null;
    }

    private async Task SaveEditingMetric()
    {
        if (editingMetricId is null || selectedMission is null) return;

        if (!Enum.TryParse<MetricType>(editMetricTypeValue, out var metricType))
        {
            ToastService.ShowError("Erro ao atualizar m√©trica", "Selecione o tipo da m√©trica.");
            return;
        }

        editMetric.Type = metricType;

        if (metricType == MetricType.Quantitative)
        {
            if (Enum.TryParse<QuantitativeMetricType>(editMetricQuantitativeTypeValue, out var qType))
                editMetric.QuantitativeType = qType;
            if (Enum.TryParse<MetricUnit>(editMetricUnitValue, out var unit))
                editMetric.Unit = unit;
        }

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.UpdateMissionMetricAsync(editingMetricId.Value, editMetric);
                ToastService.ShowSuccess("M√©trica atualizada", "A m√©trica foi salva com sucesso.");

                var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(selectedMission.Id);
                editMissionMetrics = metricsResult?.Items.ToList() ?? new();

                CancelEditingMetric();
            },
            ToastService,
            "Erro ao atualizar m√©trica",
            "N√£o foi poss√≠vel atualizar a m√©trica. Verifique os dados e tente novamente.",
            "atualiza√ß√£o de m√©trica da miss√£o");
    }

    private async Task OnEditMetricTypeChanged(ChangeEventArgs e)
    {
        editMetricTypeValue = e.Value?.ToString();
        editMetric.TargetText = null;
        editMetric.MinValue = null;
        editMetric.MaxValue = null;
        editMetric.QuantitativeType = null;
        editMetricQuantitativeTypeValue = null;
        editMetricUnitValue = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleDeleteMetricClick(Guid metricId)
    {
        if (deletingMetricId == metricId)
        {
            await DeleteMetric(metricId);
        }
        else
        {
            ArmMetricDeleteConfirmation(metricId);
        }
    }

    private async Task DeleteMetric(Guid metricId)
    {
        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionMetricAsync(metricId);
                    ToastService.ShowSuccess("M√©trica exclu√≠da", "A m√©trica foi removida com sucesso.");

                    if (selectedMission != null)
                    {
                        var metricsResult = await Api.GetMissionMetricsByMissionIdAsync(selectedMission.Id);
                        editMissionMetrics = metricsResult?.Items.ToList() ?? new();
                    }
                },
                ToastService,
                "Erro ao excluir m√©trica",
                "N√£o foi poss√≠vel excluir a m√©trica. Tente novamente.",
                "exclus√£o de m√©trica da miss√£o");
        }
        finally
        {
            ClearMetricDeleteConfirmation();
        }
    }

    private void ArmMissionDeleteConfirmation(Guid missionId)
    {
        deletingMissionId = missionId;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = new System.Threading.Timer(
            _ => InvokeAsync(() =>
            {
                deletingMissionId = null;
                StateHasChanged();
            }),
            null,
            3000,
            Timeout.Infinite);
    }

    private void ClearMissionDeleteConfirmation()
    {
        deletingMissionId = null;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = null;
    }

    private void ArmMetricDeleteConfirmation(Guid metricId)
    {
        deletingMetricId = metricId;
        deleteMetricConfirmTimer?.Dispose();
        deleteMetricConfirmTimer = new System.Threading.Timer(
            _ => InvokeAsync(() =>
            {
                deletingMetricId = null;
                StateHasChanged();
            }),
            null,
            3000,
            Timeout.Infinite);
    }

    private void ClearMetricDeleteConfirmation()
    {
        deletingMetricId = null;
        deleteMetricConfirmTimer?.Dispose();
        deleteMetricConfirmTimer = null;
    }

    // ---- Progress & Confidence Helpers ----

    private static string GetProgressStatusClass(MissionProgressDto? progress) => MissionProgressDisplayHelper.GetMissionProgressStatusClass(progress);

    private static (string statusClass, string label) GetConfidenceDisplay(decimal averageConfidence) => MissionProgressDisplayHelper.GetConfidenceDisplay(averageConfidence);

    private static string GetConfidenceClass(decimal confidence) => MissionProgressDisplayHelper.GetConfidenceClass(confidence);

    private static string GetConfidenceLabel(decimal confidence) => MissionProgressDisplayHelper.GetConfidenceLabel(confidence);

    private static string GetConfidenceStarsText(decimal confidence) => MissionProgressDisplayHelper.GetConfidenceStarsText(confidence);

    // ---- Metric Display Helpers ----

    private static string GetMetricTypeLabel(MetricType type) => MissionMetricDisplayHelper.GetMetricTypeLabel(type);

    private static string GetQuantitativeTypeLabel(QuantitativeMetricType type) => MissionMetricDisplayHelper.GetQuantitativeTypeLabel(type);

    private static string GetQuantitativeTypeIcon(QuantitativeMetricType type) => MissionMetricDisplayHelper.GetQuantitativeTypeIcon(type);

    private static string GetUnitLabel(MetricUnit unit) => MissionMetricDisplayHelper.GetUnitLabel(unit);

    private static string GetTargetLabel(MissionMetric metric) => MissionMetricDisplayHelper.GetTargetLabel(metric);

}
