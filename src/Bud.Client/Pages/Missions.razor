@page "/missions"
@inject ApiClient Api
@inject OrganizationContext OrgContext
@inject AuthState AuthState
@inject ToastService ToastService
@inject UiOperationService UiOps
@implements IDisposable

<MissionsMenu />

<ManagementPageHeader
    Kicker="MissÃµes"
    Title="@(showMyMissions ? "Minhas missÃµes" : "Todas as missÃµes")"
    PrimaryActionText="Criar missÃ£o"
    OnPrimaryAction="OpenCreateModal" />

<MissionsFilterBar ShowMyMissions="showMyMissions"
                   ViewMode="viewMode"
                   FilterActiveOnly="filterActiveOnly"
                   FilterStartDate="filterStartDate"
                   FilterEndDate="filterEndDate"
                   FilterScopeTypeValue="filterScopeTypeValue"
                   FilterScopeId="filterScopeId"
                   Search="search"
                   GetScopeOptions="GetScopeOptions"
                   OnSetMyMissions="SetMissionViewMode"
                   OnToggleViewMode="HandleToggleViewMode"
                   OnToggleActiveFilter="HandleToggleActiveFilter"
                   OnDateFilterApplied="HandleDateFilterApplied"
                   OnScopeTypeChanged="HandleFilterScopeTypeChanged"
                   OnScopeIdChanged="HandleFilterScopeIdChanged"
                   OnSearchSubmit="HandleSearchSubmit"
                   OnClearFilters="HandleClearFilters" />

@* Cards de Resumo *@
<SummaryCards CssClass="missions-summary">
    <StatCard Value="@($"{GetOverallProgressDisplay()}%")" Label="@($"Esperado {GetExpectedProgressDisplay()}%")" ShowProgress="true" Progress="GetOverallProgressDisplay()" ExpectedProgress="GetExpectedProgressDisplay()" />
    <StatCard Value="@GetActiveMissionsCount().ToString()" Label="MissÃµes ativas" />
    <StatCard Value="@GetOutdatedMetricsCount().ToString()" Label="Indicadores desatualizados" />
</SummaryCards>

@* Lista de MissÃµes em Cards *@
@if (missions is null)
{
    <div class="missions-loading">
        <p class="muted">Carregando...</p>
    </div>
}
else if (missions.Items.Count == 0)
{
    <div class="missions-empty">
        <div class="missions-empty-icon">ðŸ“‹</div>
        <p class="muted">Nenhuma missÃ£o encontrada.</p>
    </div>
}
else
{
    <div class="@(viewMode == "list" ? "missions-list" : "missions-grid")">
        @foreach (var mission in missions.Items)
        {
            <MissionCard Mission="mission"
                         Progress="@(missionProgress.GetValueOrDefault(mission.Id))"
                         IsExpanded="@(expandedMissions.Contains(mission.Id))"
                         IsDeleting="@(deletingMissionId == mission.Id)"
                         Metrics="@(missionMetricsCache.GetValueOrDefault(mission.Id))"
                         Objectives="@(missionObjectivesCache.GetValueOrDefault(mission.Id))"
                         MetricProgressCache="metricProgressCache"
                         ObjectiveProgressCache="objectiveProgressCache"
                         ExpandedObjectives="expandedObjectives"
                         OnToggleExpand="async () => await ToggleExpand(mission.Id)"
                         OnEdit="async () => await OpenEditWizard(mission)"
                         OnDeleteClick="() => HandleDeleteClick(mission.Id)"
                         OnToggleObjectiveExpand="ToggleObjectiveExpand"
                         OnCheckinClick="m => OpenCheckinModalForMetric(mission, m)"
                         OnHistoryClick="m => OpenCheckinHistoryModal(mission, m)" />
        }
    </div>
    <p class="muted" style="margin-top: var(--spacing-4);">Total: @missions.Total</p>
}

<MissionTemplatePicker IsOpen="isTemplatePickerOpen"
                       Templates="availableTemplates"
                       OnClose="() => isTemplatePickerOpen = false"
                       OnCreateFromScratch="OpenCreateModalFromScratch"
                       OnSelectTemplate="OpenCreateModalFromTemplate" />

<MissionWizardModal IsOpen="isWizardOpen"
                    IsEditMode="isEditMode"
                    OrganizationName="@GetSelectedOrganizationName()"
                    InitialModel="wizardInitialModel"
                    GetScopeOptions="GetScopeOptions"
                    OnClose="CloseWizard"
                    OnSave="HandleWizardSave"
                    OnSaveDraft="HandleWizardSaveDraft" />


<MissionCheckinModal IsOpen="@(isCheckinModalOpen && selectedCheckinMetric != null)"
                     Metric="selectedCheckinMetric"
                     OnClose="CloseCheckinModal"
                     OnSubmit="HandleCheckinSubmit" />

<MissionCheckinHistoryModal IsOpen="@(isCheckinHistoryModalOpen && historyMetric != null)"
                            Metric="historyMetric"
                            Checkins="metricCheckins"
                            IsLoading="isLoadingCheckins"
                            OnClose="CloseCheckinHistoryModal"
                            OnNewCheckin="OpenCheckinFromHistory" />


