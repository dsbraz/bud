@page "/missions"
@inject ApiClient Api

<MissionsMenu />

<div class="page-header">
    <div>
        <div class="page-kicker">Gest√£o</div>
        <h1>Miss√µes</h1>
        <p class="page-subtitle">Defina miss√µes por escopo e acompanhe status.</p>
    </div>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Nova miss√£o
    </button>
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Escopo</label>
            <select class="input" value="@filterScopeTypeValue" @onchange="OnFilterScopeTypeChanged">
                <option value="">Todos</option>
                @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                {
                    <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Refer√™ncia</label>
            <select class="input" @bind="filterScopeId" @bind:after="LoadMissions">
                <option value="">Todas</option>
                @foreach (var option in GetScopeOptions(filterScopeTypeValue))
                {
                    <option value="@option.Id">@option.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadMissions">Atualizar</button>
        </div>
    </div>

    @if (missions is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (missions.Items.Count == 0)
    {
        <p class="muted">Nenhuma miss√£o encontrada.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Escopo</th>
                    <th>Per√≠odo</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var mission in missions.Items)
                {
                    <tr>
                        <td>@mission.Name</td>
                        <td>@GetMissionScopeName(mission)</td>
                        <td>@mission.StartDate.ToString("yyyy-MM-dd") - @mission.EndDate.ToString("yyyy-MM-dd")</td>
                        <td>@GetStatusLabel(mission.Status)</td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @missions.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar miss√£o" Breadcrumb="@GetSelectedOrganizationName()" Size="lg" OnClose="CloseModal">
        <ChildContent>
            <EditForm Model="@newMission" OnValidSubmit="CreateMission">
                <DataAnnotationsValidator />

                @* Header Section - Mission Title & Description *@
                <div class="mission-header">
                    <InputText class="mission-title-input" @bind-Value="newMission.Name" placeholder="Nome da miss√£o" />
                    <input type="text" class="mission-subtitle-input" @bind="missionDescription" placeholder="Adicionar breve descri√ß√£o" />
                </div>

                @* Metadata Chips *@
                <div class="chips-container">
                    <div class="chip" @onclick="() => showResponsibleSelector = !showResponsibleSelector">
                        <span class="chip-icon">üë§</span>
                        <span>@GetResponsibleLabel()</span>
                    </div>
                    <div class="chip" @onclick="() => showPeriodSelector = !showPeriodSelector">
                        <span class="chip-icon">üìÖ</span>
                        <span>@GetPeriodLabel()</span>
                    </div>
                    <div class="chip chip-more">
                        <span>‚ãØ</span>
                    </div>
                </div>

                @* Responsible Selector (hidden by default) *@
                @if (showResponsibleSelector)
                {
                    <div class="form-row">
                        <label>Escopo</label>
                        <select class="input" value="@createScopeTypeValue" @onchange="OnCreateScopeTypeChanged">
                            <option value="">Selecione</option>
                            @foreach (var scopeType in Enum.GetValues<MissionScopeType>())
                            {
                                <option value="@scopeType">@GetScopeLabel(scopeType)</option>
                            }
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Refer√™ncia</label>
                        <select class="input" @bind="createScopeId">
                            <option value="">Selecione</option>
                            @foreach (var option in GetScopeOptions(createScopeTypeValue))
                            {
                                <option value="@option.Id">@option.Name</option>
                            }
                        </select>
                    </div>
                }

                @* Period Selector (hidden by default) *@
                @if (showPeriodSelector)
                {
                    <div class="form-row">
                        <label>Data de in√≠cio</label>
                        <InputDate class="input" @bind-Value="newMission.StartDate" />
                    </div>
                    <div class="form-row">
                        <label>Data de fim</label>
                        <InputDate class="input" @bind-Value="newMission.EndDate" />
                    </div>
                }

                @* Metrics Section *@
                <div class="mission-metrics-section">
                    <button type="button" class="metrics-add-button" @onclick="AddMetricOrOpenForm">
                        <span>@(showMetricForm ? "Adicionar item" : "Adicionar item")</span>
                        <span class="metrics-add-icon">+</span>
                    </button>

                    @if (showMetricForm)
                    {
                        <div style="margin-top: var(--spacing-4);">
                            <div class="form-row">
                                <label>Nome da m√©trica</label>
                                <input type="text" class="input" @bind="newMetricName" placeholder="Ex: Vendas mensais" />
                            </div>
                            <div class="form-row">
                                <label>Tipo</label>
                                <select class="input" @bind="newMetricType">
                                    <option value="">Selecione</option>
                                    <option value="Quantitative">Quantitativa</option>
                                    <option value="Qualitative">Qualitativa</option>
                                </select>
                            </div>
                            @if (newMetricType == "Quantitative")
                            {
                                <div class="form-row">
                                    <label>Tipo</label>
                                    <select class="input" @bind="newMetricQuantitativeType">
                                        <option value="">Selecione</option>
                                        <option value="KeepAbove">Manter acima</option>
                                        <option value="KeepBelow">Manter abaixo</option>
                                        <option value="KeepBetween">Manter entre</option>
                                    </select>
                                </div>
                                @if (newMetricQuantitativeType == "KeepAbove")
                                {
                                    <div class="form-row">
                                        <label>Valor m√≠nimo</label>
                                        <input type="number" class="input" @bind="newMetricMinValue" placeholder="Ex: 1000" />
                                    </div>
                                }
                                @if (newMetricQuantitativeType == "KeepBelow")
                                {
                                    <div class="form-row">
                                        <label>Valor m√°ximo</label>
                                        <input type="number" class="input" @bind="newMetricMaxValue" placeholder="Ex: 1000" />
                                    </div>
                                }
                                @if (newMetricQuantitativeType == "KeepBetween")
                                {
                                    <div class="form-row">
                                        <label>Valor m√≠nimo</label>
                                        <input type="number" class="input" @bind="newMetricMinValue" placeholder="Ex: 100" />
                                    </div>
                                    <div class="form-row">
                                        <label>Valor m√°ximo</label>
                                        <input type="number" class="input" @bind="newMetricMaxValue" placeholder="Ex: 1000" />
                                    </div>
                                }
                                <div class="form-row">
                                    <label>Unidade</label>
                                    <select class="input" @bind="newMetricUnit">
                                        <option value="">Selecione</option>
                                        <option value="Integer">Inteiro</option>
                                        <option value="Decimal">Decimal</option>
                                        <option value="Percentage">Percentual</option>
                                        <option value="Hours">Horas</option>
                                        <option value="Points">Pontos</option>
                                    </select>
                                </div>
                            }
                            @if (newMetricType == "Qualitative")
                            {
                                <div class="form-row">
                                    <label>Texto alvo</label>
                                    <input type="text" class="input" @bind="newMetricTargetText" placeholder="Ex: Muito satisfeito" />
                                </div>
                            }
                        </div>
                    }

                    @if (tempMetrics.Any())
                    {
                        <div class="metrics-list">
                            @foreach (var metric in tempMetrics)
                            {
                                <div class="metric-item">
                                    <div class="metric-info">
                                        <div class="metric-name">@metric.Name</div>
                                        <div class="metric-details">@metric.Details</div>
                                    </div>
                                    <button type="button" class="metric-remove" @onclick="() => RemoveMetric(metric)">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(formMessage))
                {
                    <p class="form-message @(formMessage.Contains("sucesso") ? "" : "error")">@formMessage</p>
                }
            </EditForm>
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    <button class="button secondary" type="button" @onclick="SaveDraft">
                        <span class="chip-icon">üíæ</span>
                        Salvar rascunho
                    </button>
                    <button class="button primary" type="button" @onclick="CreateMission">Criar miss√£o</button>
                </div>
            </div>
        </Footer>
    </Modal>
}

@code {
    private sealed record ScopeOption(string Id, string Name);
    private sealed record TempMetric(string Name, string Type, string Details, string? QuantitativeType = null, decimal? MinValue = null, decimal? MaxValue = null, string? TargetText = null, string? Unit = null);

    private CreateMissionRequest newMission = new();
    private PagedResult<Mission>? missions;
    private List<Organization> organizations = new();
    private List<Workspace> workspaces = new();
    private List<Team> teams = new();
    private List<Collaborator> collaborators = new();
    private string? createScopeTypeValue;
    private string? createScopeId;
    private string? filterScopeTypeValue;
    private string? filterScopeId;
    private string? search;
    private string? formMessage;
    private bool isModalOpen = false;
    private bool showResponsibleSelector = false;
    private bool showPeriodSelector = false;
    private string? missionDescription;
    private bool showMetricForm = false;
    private string? newMetricName;
    private string? newMetricType;
    private string? newMetricQuantitativeType;
    private decimal? newMetricMinValue;
    private decimal? newMetricMaxValue;
    private string? newMetricTargetText;
    private string? newMetricUnit;
    private List<TempMetric> tempMetrics = new();

    protected override async Task OnInitializedAsync()
    {
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };

        await LoadReferenceData();
        await LoadMissions();
    }

    private async Task LoadReferenceData()
    {
        var orgsResult = await Api.GetOrganizationsAsync(null, 1, 200);
        organizations = orgsResult?.Items.ToList() ?? new List<Organization>();

        var workspacesResult = await Api.GetWorkspacesAsync(null, null, 1, 200);
        workspaces = workspacesResult?.Items.ToList() ?? new List<Workspace>();

        var teamsResult = await Api.GetTeamsAsync(null, null, null, 1, 200);
        teams = teamsResult?.Items.ToList() ?? new List<Team>();

        var collaboratorsResult = await Api.GetCollaboratorsAsync(null, null, 1, 200);
        collaborators = collaboratorsResult?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task LoadMissions()
    {
        var scopeType = ParseScopeType(filterScopeTypeValue);
        var scopeId = Guid.TryParse(filterScopeId, out var parsedScopeId)
            ? parsedScopeId
            : (Guid?)null;

        missions = await Api.GetMissionsAsync(scopeType, scopeId, search, 1, 20) ?? new PagedResult<Mission>();
    }

    private async Task OnCreateScopeTypeChanged(ChangeEventArgs e)
    {
        createScopeTypeValue = e.Value?.ToString();
        createScopeId = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnFilterScopeTypeChanged(ChangeEventArgs e)
    {
        filterScopeTypeValue = e.Value?.ToString();
        filterScopeId = null;
        await InvokeAsync(StateHasChanged);
    }

    private void OpenCreateModal()
    {
        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        formMessage = null;
        missionDescription = null;
        showResponsibleSelector = false;
        showPeriodSelector = false;
        showMetricForm = false;
        tempMetrics.Clear();
        ClearMetricForm();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
        formMessage = null;
    }

    private string GetSelectedOrganizationName()
    {
        return organizations.FirstOrDefault()?.Name ?? "Organiza√ß√£o";
    }

    private string GetResponsibleLabel()
    {
        if (!string.IsNullOrEmpty(createScopeId) && Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            var option = GetScopeOptions(createScopeTypeValue).FirstOrDefault(o => o.Id == createScopeId);
            if (option != null)
            {
                return $"Respons√°vel: {option.Name}";
            }
        }
        return "Respons√°vel";
    }

    private string GetPeriodLabel()
    {
        if (newMission.StartDate != DateTime.MinValue && newMission.EndDate != DateTime.MinValue)
        {
            return $"Per√≠odo de in√≠cio e fim: {newMission.StartDate:dd/MM/yyyy} - {newMission.EndDate:dd/MM/yyyy}";
        }
        return "Per√≠odo de in√≠cio e fim";
    }

    private async Task SaveDraft()
    {
        formMessage = null;

        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            formMessage = "Selecione o escopo.";
            return;
        }

        if (!Guid.TryParse(createScopeId, out var scopeId))
        {
            formMessage = "Selecione a refer√™ncia do escopo.";
            return;
        }

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            formMessage = "Informe o nome da miss√£o.";
            return;
        }

        if (newMission.EndDate < newMission.StartDate)
        {
            formMessage = "A data de fim precisa ser igual ou maior que a data de in√≠cio.";
            return;
        }

        newMission.ScopeType = scopeType;
        newMission.ScopeId = scopeId;
        newMission.Description = missionDescription;
        newMission.Status = MissionStatus.Planned;

        var createdMission = await Api.CreateMissionAsync(newMission);

        // Create metrics for the mission
        if (createdMission != null && tempMetrics.Any())
        {
            foreach (var tempMetric in tempMetrics)
            {
                var metricRequest = new CreateMissionMetricRequest
                {
                    MissionId = createdMission.Id,
                    Name = tempMetric.Name,
                    Type = Enum.Parse<MetricType>(tempMetric.Type)
                };

                if (tempMetric.Type == "Quantitative")
                {
                    if (!string.IsNullOrEmpty(tempMetric.QuantitativeType))
                    {
                        metricRequest.QuantitativeType = Enum.Parse<QuantitativeMetricType>(tempMetric.QuantitativeType);
                    }
                    metricRequest.MinValue = tempMetric.MinValue;
                    metricRequest.MaxValue = tempMetric.MaxValue;
                    if (!string.IsNullOrEmpty(tempMetric.Unit))
                    {
                        metricRequest.Unit = Enum.Parse<MetricUnit>(tempMetric.Unit);
                    }
                }
                else
                {
                    metricRequest.TargetText = tempMetric.TargetText;
                }

                await Api.CreateMissionMetricAsync(metricRequest);
            }
        }

        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        await LoadMissions();
        formMessage = "Rascunho salvo com sucesso.";

        await Task.Delay(1500);
        CloseModal();
    }

    private void AddMetricOrOpenForm()
    {
        // Se o formul√°rio n√£o est√° aberto, apenas abre
        if (!showMetricForm)
        {
            showMetricForm = true;
            return;
        }

        // Se o formul√°rio est√° aberto mas n√£o preenchido, n√£o faz nada
        if (string.IsNullOrWhiteSpace(newMetricName) || string.IsNullOrWhiteSpace(newMetricType))
        {
            return;
        }

        // Se o formul√°rio est√° aberto e preenchido, adiciona a m√©trica
        var details = newMetricType == "Quantitative"
            ? BuildQuantitativeDetails()
            : newMetricTargetText ?? "";

        tempMetrics.Add(new TempMetric(
            newMetricName,
            newMetricType,
            details,
            newMetricQuantitativeType,
            newMetricMinValue,
            newMetricMaxValue,
            newMetricTargetText,
            newMetricUnit
        ));

        // Limpa o formul√°rio mas mant√©m aberto para adicionar mais m√©tricas
        ClearMetricForm();
    }

    private void RemoveMetric(TempMetric metric)
    {
        tempMetrics.Remove(metric);
    }

    private void ClearMetricForm()
    {
        newMetricName = null;
        newMetricType = null;
        newMetricQuantitativeType = null;
        newMetricMinValue = null;
        newMetricMaxValue = null;
        newMetricTargetText = null;
        newMetricUnit = null;
    }

    private string BuildQuantitativeDetails()
    {
        var unit = GetUnitLabelShort(newMetricUnit);
        return newMetricQuantitativeType switch
        {
            "KeepAbove" => $"Acima de {newMetricMinValue} {unit}",
            "KeepBelow" => $"Abaixo de {newMetricMaxValue} {unit}",
            "KeepBetween" => $"Entre {newMetricMinValue} e {newMetricMaxValue} {unit}",
            _ => ""
        };
    }

    private string GetUnitLabelShort(string? unit) => unit switch
    {
        "Integer" => "un",
        "Decimal" => "un",
        "Percentage" => "%",
        "Hours" => "h",
        "Points" => "pts",
        _ => ""
    };

    private async Task CreateMission()
    {
        formMessage = null;

        if (!Enum.TryParse<MissionScopeType>(createScopeTypeValue, out var scopeType))
        {
            formMessage = "Selecione o escopo.";
            return;
        }

        if (!Guid.TryParse(createScopeId, out var scopeId))
        {
            formMessage = "Selecione a refer√™ncia do escopo.";
            return;
        }

        if (string.IsNullOrWhiteSpace(newMission.Name))
        {
            formMessage = "Informe o nome da miss√£o.";
            return;
        }

        if (newMission.EndDate < newMission.StartDate)
        {
            formMessage = "A data de fim precisa ser igual ou maior que a data de in√≠cio.";
            return;
        }

        newMission.ScopeType = scopeType;
        newMission.ScopeId = scopeId;
        newMission.Description = missionDescription;
        newMission.Status = MissionStatus.Active;

        var createdMission = await Api.CreateMissionAsync(newMission);

        // Create metrics for the mission
        if (createdMission != null && tempMetrics.Any())
        {
            foreach (var tempMetric in tempMetrics)
            {
                var metricRequest = new CreateMissionMetricRequest
                {
                    MissionId = createdMission.Id,
                    Name = tempMetric.Name,
                    Type = Enum.Parse<MetricType>(tempMetric.Type)
                };

                if (tempMetric.Type == "Quantitative")
                {
                    if (!string.IsNullOrEmpty(tempMetric.QuantitativeType))
                    {
                        metricRequest.QuantitativeType = Enum.Parse<QuantitativeMetricType>(tempMetric.QuantitativeType);
                    }
                    metricRequest.MinValue = tempMetric.MinValue;
                    metricRequest.MaxValue = tempMetric.MaxValue;
                    if (!string.IsNullOrEmpty(tempMetric.Unit))
                    {
                        metricRequest.Unit = Enum.Parse<MetricUnit>(tempMetric.Unit);
                    }
                }
                else
                {
                    metricRequest.TargetText = tempMetric.TargetText;
                }

                await Api.CreateMissionMetricAsync(metricRequest);
            }
        }

        newMission = new CreateMissionRequest
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7),
            Status = MissionStatus.Planned
        };
        createScopeTypeValue = null;
        createScopeId = null;
        await LoadMissions();
        formMessage = "Miss√£o criada com sucesso.";

        // Auto-close modal after 1.5 seconds on success
        await Task.Delay(1500);
        CloseModal();
    }

    private IEnumerable<ScopeOption> GetScopeOptions(string? scopeTypeValue)
    {
        if (!Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType))
        {
            return Enumerable.Empty<ScopeOption>();
        }

        return scopeType switch
        {
            MissionScopeType.Organization => organizations.Select(o => new ScopeOption(o.Id.ToString(), o.Name)),
            MissionScopeType.Workspace => workspaces.Select(w => new ScopeOption(w.Id.ToString(), w.Name)),
            MissionScopeType.Team => teams.Select(t => new ScopeOption(t.Id.ToString(), t.Name)),
            MissionScopeType.Collaborator => collaborators.Select(c => new ScopeOption(c.Id.ToString(), c.FullName)),
            _ => Enumerable.Empty<ScopeOption>()
        };
    }

    private MissionScopeType? ParseScopeType(string? scopeTypeValue)
    {
        return Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType) ? scopeType : null;
    }

    private string GetMissionScopeName(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
        {
            return collaborators.FirstOrDefault(c => c.Id == mission.CollaboratorId.Value)?.FullName ?? "‚Äî";
        }

        if (mission.TeamId.HasValue)
        {
            return teams.FirstOrDefault(t => t.Id == mission.TeamId.Value)?.Name ?? "‚Äî";
        }

        if (mission.WorkspaceId.HasValue)
        {
            return workspaces.FirstOrDefault(w => w.Id == mission.WorkspaceId.Value)?.Name ?? "‚Äî";
        }

        // Org-scoped: no other scope FK is set, OrganizationId is always present
        return organizations.FirstOrDefault(o => o.Id == mission.OrganizationId)?.Name ?? "‚Äî";
    }

    private static string GetScopeLabel(MissionScopeType scopeType) => scopeType switch
    {
        MissionScopeType.Organization => "Organiza√ß√£o",
        MissionScopeType.Workspace => "Workspace",
        MissionScopeType.Team => "Equipe",
        MissionScopeType.Collaborator => "Colaborador",
        _ => scopeType.ToString()
    };

    private static string GetStatusLabel(MissionStatus status) => status switch
    {
        MissionStatus.Planned => "Planejada",
        MissionStatus.Active => "Ativa",
        MissionStatus.Completed => "Conclu√≠da",
        MissionStatus.Cancelled => "Cancelada",
        _ => status.ToString()
    };
}
