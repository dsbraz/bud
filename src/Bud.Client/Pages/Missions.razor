@page "/missions"
@inject ApiClient Api
@inject OrganizationContext OrgContext
@inject AuthState AuthState
@inject ToastService ToastService
@inject UiOperationService UiOps
@implements IDisposable

<ManagementPageHeader
    Kicker="MissÃµes"
    Title="@(_showMyMissions ? "Minhas missÃµes" : "Todas as missÃµes")"
    PrimaryActionText="Criar missÃ£o"
    OnPrimaryAction="OpenCreateModal" />

<MissionsFilterBar ShowMyMissions="_showMyMissions"
                   ViewMode="@_viewMode"
                   FilterActiveOnly="_filterActiveOnly"
                   FilterStartDate="_filterStartDate"
                   FilterEndDate="_filterEndDate"
                   FilterScopeTypeValue="@_filterScopeTypeValue"
                   FilterScopeId="@_filterScopeId"
                   Search="@_search"
                   GetScopeOptions="GetScopeOptions"
                   OnSetMyMissions="SetMissionViewMode"
                   OnToggleViewMode="HandleToggleViewMode"
                   OnToggleActiveFilter="HandleToggleActiveFilter"
                   OnDateFilterApplied="HandleDateFilterApplied"
                   OnScopeTypeChanged="HandleFilterScopeTypeChanged"
                   OnScopeIdChanged="HandleFilterScopeIdChanged"
                   OnSearchSubmit="HandleSearchSubmit"
                   OnClearFilters="HandleClearFilters" />

@* Cards de Resumo *@
<SummaryCards CssClass="missions-summary">
    <StatCard Value="@($"{GetOverallProgressDisplay()}%")" Label="@($"Esperado {GetExpectedProgressDisplay()}%")" ShowProgress="true" Progress="GetOverallProgressDisplay()" ExpectedProgress="GetExpectedProgressDisplay()" />
    <StatCard Value="@GetActiveMissionsCount().ToString()" Label="MissÃµes ativas" />
    <StatCard Value="@GetOutdatedMetricsCount().ToString()" Label="Indicadores desatualizados" />
</SummaryCards>

@* Lista de MissÃµes em Cards *@
@if (_missions is null)
{
    <div class="missions-loading">
        <p class="muted">Carregando...</p>
    </div>
}
else if (_missions.Items.Count == 0)
{
    <div class="missions-empty">
        <div class="missions-empty-icon">ðŸ“‹</div>
        <p class="muted">Nenhuma missÃ£o encontrada.</p>
    </div>
}
else
{
    <div class="@(_viewMode == "list" ? "missions-list" : "missions-grid")">
        @foreach (var mission in _missions.Items)
        {
            <MissionCard Mission="mission"
                         Progress="@(_missionProgress.GetValueOrDefault(mission.Id))"
                         IsExpanded="@(_expandedMissions.Contains(mission.Id))"
                         IsDeleting="@(_deletingMissionId == mission.Id)"
                         Metrics="@(_missionMetricsCache.GetValueOrDefault(mission.Id))"
                         Objectives="@(_missionObjectivesCache.GetValueOrDefault(mission.Id))"
                         ObjectiveDimensions="_objectiveDimensions"
                         MetricProgressCache="_metricProgressCache"
                         ObjectiveProgressCache="_objectiveProgressCache"
                         ExpandedObjectives="_expandedObjectives"
                         OnToggleExpand="async () => await ToggleExpand(mission.Id)"
                         OnEdit="async () => await OpenEditWizard(mission)"
                         OnDeleteClick="() => HandleDeleteClick(mission.Id)"
                         OnToggleObjectiveExpand="ToggleObjectiveExpand"
                         OnCheckinClick="m => OpenCheckinModalForMetric(mission, m)"
                         OnHistoryClick="m => OpenCheckinHistoryModal(mission, m)" />
        }
    </div>
    <p class="muted" style="margin-top: var(--spacing-4);">Total: @_missions.Total</p>
}

<MissionTemplatePicker IsOpen="_isTemplatePickerOpen"
                       Templates="_availableTemplates"
                       OnClose="() => _isTemplatePickerOpen = false"
                       OnCreateFromScratch="OpenCreateModalFromScratch"
                       OnSelectTemplate="OpenCreateModalFromTemplate" />

<MissionWizardModal IsOpen="_isWizardOpen"
                    IsEditMode="_isEditMode"
                    OrganizationName="@GetSelectedOrganizationName()"
                    InitialModel="_wizardInitialModel"
                    ObjectiveDimensions="_objectiveDimensions"
                    GetScopeOptions="GetScopeOptions"
                    OnClose="CloseWizard"
                    OnSave="HandleWizardSave"
                    OnSaveDraft="HandleWizardSaveDraft" />


<MissionCheckinModal IsOpen="@(_isCheckinModalOpen && _selectedCheckinMetric != null)"
                     Metric="_selectedCheckinMetric"
                     OnClose="CloseCheckinModal"
                     OnSubmit="HandleCheckinSubmit" />

<MissionCheckinHistoryModal IsOpen="@(_isCheckinHistoryModalOpen && _historyMetric != null)"
                            Metric="_historyMetric"
                            Checkins="_metricCheckins"
                            IsLoading="_isLoadingCheckins"
                            OnClose="CloseCheckinHistoryModal"
                            OnNewCheckin="OpenCheckinFromHistory" />
