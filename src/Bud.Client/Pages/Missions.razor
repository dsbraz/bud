@page "/missions"
@inject ApiClient Api
@inject OrganizationContext OrgContext
@inject AuthState AuthState
@inject ToastService ToastService
@inject UiOperationService UiOps
@implements IDisposable

<MissionsMenu />

<ManagementPageHeader
    Kicker="Miss√µes"
    Title="@(showMyMissions ? "Minhas miss√µes" : "Todas as miss√µes")"
    PrimaryActionText="Criar miss√£o"
    OnPrimaryAction="OpenCreateModal" />

<MissionsFilterBar ShowMyMissions="showMyMissions"
                   ViewMode="viewMode"
                   FilterActiveOnly="filterActiveOnly"
                   FilterStartDate="filterStartDate"
                   FilterEndDate="filterEndDate"
                   FilterScopeTypeValue="filterScopeTypeValue"
                   FilterScopeId="filterScopeId"
                   Search="search"
                   GetScopeOptions="GetScopeOptions"
                   OnSetMyMissions="SetMissionViewMode"
                   OnToggleViewMode="HandleToggleViewMode"
                   OnToggleActiveFilter="HandleToggleActiveFilter"
                   OnDateFilterApplied="HandleDateFilterApplied"
                   OnScopeTypeChanged="HandleFilterScopeTypeChanged"
                   OnScopeIdChanged="HandleFilterScopeIdChanged"
                   OnSearchSubmit="HandleSearchSubmit"
                   OnClearFilters="HandleClearFilters" />

@* Cards de Resumo *@
<SummaryCards CssClass="missions-summary">
    <StatCard Value="@($"{GetOverallProgressDisplay()}%")" Label="@($"Esperado {GetExpectedProgressDisplay()}%")" ShowProgress="true" Progress="GetOverallProgressDisplay()" ExpectedProgress="GetExpectedProgressDisplay()" />
    <StatCard Value="@GetActiveMissionsCount().ToString()" Label="Miss√µes ativas" />
    <StatCard Value="@GetOutdatedMetricsCount().ToString()" Label="Indicadores desatualizados" />
</SummaryCards>

@* Lista de Miss√µes em Cards *@
@if (missions is null)
{
    <div class="missions-loading">
        <p class="muted">Carregando...</p>
    </div>
}
else if (missions.Items.Count == 0)
{
    <div class="missions-empty">
        <div class="missions-empty-icon">üìã</div>
        <p class="muted">Nenhuma miss√£o encontrada.</p>
    </div>
}
else
{
    <div class="@(viewMode == "list" ? "missions-list" : "missions-grid")">
        @foreach (var mission in missions.Items)
        {
            <MissionCard Mission="mission"
                         Progress="@(missionProgress.GetValueOrDefault(mission.Id))"
                         IsExpanded="@(expandedMissions.Contains(mission.Id))"
                         IsDeleting="@(deletingMissionId == mission.Id)"
                         Metrics="@(missionMetricsCache.GetValueOrDefault(mission.Id))"
                         Objectives="@(missionObjectivesCache.GetValueOrDefault(mission.Id))"
                         MetricProgressCache="metricProgressCache"
                         ObjectiveProgressCache="objectiveProgressCache"
                         ExpandedObjectives="expandedObjectives"
                         OnToggleExpand="async () => await ToggleExpand(mission.Id)"
                         OnEdit="async () => await OpenEditWizard(mission)"
                         OnDeleteClick="() => HandleDeleteClick(mission.Id)"
                         OnToggleObjectiveExpand="ToggleObjectiveExpand"
                         OnCheckinClick="m => OpenCheckinModalForMetric(mission, m)"
                         OnHistoryClick="m => OpenCheckinHistoryModal(mission, m)" />
        }
    </div>
    <p class="muted" style="margin-top: var(--spacing-4);">Total: @missions.Total</p>
}

<MissionTemplatePicker IsOpen="isTemplatePickerOpen"
                       Templates="availableTemplates"
                       OnClose="() => isTemplatePickerOpen = false"
                       OnCreateFromScratch="OpenCreateModalFromScratch"
                       OnSelectTemplate="OpenCreateModalFromTemplate" />

<MissionWizardModal IsOpen="isWizardOpen"
                    IsEditMode="isEditMode"
                    OrganizationName="@GetSelectedOrganizationName()"
                    InitialModel="wizardInitialModel"
                    GetScopeOptions="GetScopeOptions"
                    OnClose="CloseWizard"
                    OnSave="HandleWizardSave"
                    OnSaveDraft="HandleWizardSaveDraft" />


<MissionCheckinModal IsOpen="@(isCheckinModalOpen && selectedCheckinMetric != null)"
                     Metric="selectedCheckinMetric"
                     OnClose="CloseCheckinModal"
                     OnSubmit="HandleCheckinSubmit" />

<MissionCheckinHistoryModal IsOpen="@(isCheckinHistoryModalOpen && historyMetric != null)"
                            Metric="historyMetric"
                            Checkins="metricCheckins"
                            IsLoading="isLoadingCheckins"
                            OnClose="CloseCheckinHistoryModal"
                            OnNewCheckin="OpenCheckinFromHistory" />


@code {
    // Data
    private PagedResult<Mission>? missions;
    private Dictionary<Guid, MissionProgressDto> missionProgress = new();
    private List<Organization> organizations = new();
    private List<Workspace> workspaces = new();
    private List<Team> teams = new();
    private List<Collaborator> collaborators = new();

    // Filter state
    private string? filterScopeTypeValue;
    private string? filterScopeId;
    private string? search;
    private string viewMode = "list";
    private bool showMyMissions = true;
    private bool filterActiveOnly = true;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    // Card expansion state
    private HashSet<Guid> expandedMissions = new();
    private Dictionary<Guid, List<MissionMetric>> missionMetricsCache = new();
    private Dictionary<Guid, MetricProgressDto> metricProgressCache = new();
    private Dictionary<Guid, List<MissionObjective>> missionObjectivesCache = new();
    private Dictionary<Guid, ObjectiveProgressDto> objectiveProgressCache = new();
    private HashSet<Guid> expandedObjectives = new();

    // Wizard state
    private bool isWizardOpen;
    private bool isEditMode;
    private Guid? editingMissionId;
    private MissionWizardModel? wizardInitialModel;

    // Template picker state
    private bool isTemplatePickerOpen = false;
    private List<MissionTemplate> availableTemplates = new();

    // Checkin modal state
    private bool isCheckinModalOpen = false;
    private Mission? checkinMission = null;
    private MissionMetric? selectedCheckinMetric;

    // Checkin history modal state
    private bool isCheckinHistoryModalOpen = false;
    private MissionMetric? historyMetric = null;
    private Mission? historyMission = null;
    private List<MetricCheckin> metricCheckins = new();
    private bool isLoadingCheckins = false;

    // Delete confirmation state
    private Guid? deletingMissionId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to organization changes
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;

        // Aguardar inicializa√ß√£o do OrgContext (MainLayout pode ainda estar carregando)
        var maxWait = 50; // 50 * 100ms = 5 segundos m√°ximo
        while (!OrgContext.IsInitialized && maxWait > 0)
        {
            await Task.Delay(100);
            maxWait--;
        }

        await AuthState.EnsureInitializedAsync();
        await LoadReferenceData();
        await LoadMissions();
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                filterScopeTypeValue = null;
                filterScopeId = null;
                await LoadReferenceData();
                await LoadMissions();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar miss√µes por troca de organiza√ß√£o: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar miss√µes", "N√£o foi poss√≠vel atualizar os dados da organiza√ß√£o selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadReferenceData()
    {
        // Filtrar dados pelo tenant selecionado
        var orgId = OrgContext.SelectedOrganizationId;

        var orgsResult = await Api.GetOrganizationsAsync(null, 1, 100);
        organizations = orgsResult?.Items.ToList() ?? new List<Organization>();

        var workspacesResult = await Api.GetWorkspacesAsync(orgId, null, 1, 100);
        workspaces = workspacesResult?.Items.ToList() ?? new List<Workspace>();

        var teamsResult = await Api.GetTeamsAsync(null, null, null, 1, 100);
        teams = teamsResult?.Items.ToList() ?? new List<Team>();

        var collaboratorsResult = await Api.GetCollaboratorsAsync(null, null, 1, 100);
        collaborators = collaboratorsResult?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task SetMissionViewMode(bool myMissions)
    {
        if (showMyMissions == myMissions)
        {
            return;
        }

        showMyMissions = myMissions;

        if (showMyMissions)
        {
            filterScopeTypeValue = null;
            filterScopeId = null;
        }

        await LoadMissions();
    }

    private async Task LoadMissions()
    {
        PagedResult<Mission> result;

        if (showMyMissions)
        {
            var collaboratorId = AuthState.Session?.CollaboratorId;
            if (collaboratorId.HasValue)
            {
                result = await Api.GetMyMissionsAsync(collaboratorId.Value, search, 1, 100) ?? new PagedResult<Mission>();
            }
            else
            {
                // Global admin without CollaboratorId ‚Äî fallback to all missions
                result = await Api.GetMissionsAsync(null, null, search, 1, 100) ?? new PagedResult<Mission>();
            }
        }
        else
        {
            var scopeType = ParseScopeType(filterScopeTypeValue);
            var scopeId = Guid.TryParse(filterScopeId, out var parsedScopeId)
                ? parsedScopeId
                : (Guid?)null;

            result = await Api.GetMissionsAsync(scopeType, scopeId, search, 1, 100) ?? new PagedResult<Mission>();
        }

        // Apply client-side filters
        var filteredItems = result.Items.AsEnumerable();

        // Filter by active status
        if (filterActiveOnly)
        {
            filteredItems = filteredItems.Where(m => m.Status == MissionStatus.Active);
        }

        // Filter by date range
        if (filterStartDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.EndDate >= filterStartDate.Value);
        }
        if (filterEndDate.HasValue)
        {
            filteredItems = filteredItems.Where(m => m.StartDate <= filterEndDate.Value);
        }

        var filteredList = filteredItems.ToList();
        missions = new PagedResult<Mission>
        {
            Items = filteredList,
            Total = filteredList.Count,
            Page = 1,
            PageSize = filteredList.Count
        };

        await LoadProgress();
    }

    private async Task LoadProgress()
    {
        if (missions is null || missions.Items.Count == 0)
        {
            missionProgress = new();
            return;
        }

        try
        {
            var ids = missions.Items.Select(m => m.Id).ToList();
            var progressList = await Api.GetMissionProgressAsync(ids);
            missionProgress = progressList?.ToDictionary(p => p.MissionId) ?? new();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar progresso das miss√µes: {ex.Message}");
            missionProgress = new();
        }
    }

    private async Task LoadMetricProgress(Guid missionId)
    {
        if (!missionMetricsCache.TryGetValue(missionId, out var metrics) || metrics.Count == 0)
            return;

        try
        {
            var metricIds = metrics.Select(m => m.Id).ToList();
            var progressList = await Api.GetMetricProgressAsync(metricIds);
            if (progressList != null)
            {
                foreach (var progress in progressList)
                {
                    metricProgressCache[progress.MetricId] = progress;
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar progresso das m√©tricas: {ex.Message}");
        }
    }



    private void HandleToggleViewMode()
    {
        viewMode = viewMode == "list" ? "grid" : "list";
    }

    private async Task HandleToggleActiveFilter()
    {
        filterActiveOnly = !filterActiveOnly;
        await LoadMissions();
    }

    private async Task HandleDateFilterApplied((DateTime?, DateTime?) dates)
    {
        filterStartDate = dates.Item1;
        filterEndDate = dates.Item2;
        await LoadMissions();
    }

    private async Task HandleFilterScopeTypeChanged(string? value)
    {
        filterScopeTypeValue = value;
        filterScopeId = null;
        await LoadMissions();
    }

    private async Task HandleFilterScopeIdChanged(string? value)
    {
        filterScopeId = value;
        await LoadMissions();
    }

    private async Task HandleSearchSubmit(string? value)
    {
        search = value;
        await LoadMissions();
    }

    private async Task HandleClearFilters()
    {
        filterScopeTypeValue = null;
        filterScopeId = null;
        search = null;
        filterActiveOnly = false;
        filterStartDate = null;
        filterEndDate = null;
        await LoadMissions();
    }

    private async Task OpenCreateModal()
    {
        // Load available templates and open the picker
        try
        {
            var result = await Api.GetMissionTemplatesAsync(null, 1, 50);
            availableTemplates = result?.Items
                .Where(t => t.IsActive)
                .ToList() ?? new();
        }
        catch
        {
            availableTemplates = new();
        }

        isTemplatePickerOpen = true;
    }

    private void OpenCreateModalFromScratch()
    {
        isTemplatePickerOpen = false;
        wizardInitialModel = new MissionWizardModel
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(7)
        };
        isEditMode = false;
        editingMissionId = null;
        isWizardOpen = true;
    }

    private void OpenCreateModalFromTemplate(MissionTemplate template)
    {
        isTemplatePickerOpen = false;
        wizardInitialModel = new MissionWizardModel
        {
            Name = template.MissionNamePattern,
            Description = template.MissionDescriptionPattern,
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(90),
            Metrics = template.Metrics
                .OrderBy(m => m.OrderIndex)
                .Select(m => new TempMetric(
                    null, m.Name, m.Type.ToString(), GetTemplateMetricDetails(m),
                    m.QuantitativeType?.ToString(), m.MinValue, m.MaxValue, m.TargetText, m.Unit?.ToString()))
                .ToList()
        };
        isEditMode = false;
        editingMissionId = null;
        isWizardOpen = true;
    }

    private static string GetTemplateMetricDetails(MissionTemplateMetric metric)
    {
        if (metric.Type == MetricType.Qualitative)
            return $"Qualitativa ‚Äî {metric.TargetText}";

        var parts = new List<string> { "Quantitativa" };
        if (metric.QuantitativeType.HasValue)
            parts.Add(metric.QuantitativeType.Value.ToString());
        if (metric.Unit.HasValue)
            parts.Add(metric.Unit.Value.ToString());
        if (metric.MinValue.HasValue)
            parts.Add($"Min: {metric.MinValue}");
        if (metric.MaxValue.HasValue)
            parts.Add($"Max: {metric.MaxValue}");
        return string.Join(" ‚Äî ", parts);
    }

    private void CloseWizard()
    {
        isWizardOpen = false;
        isEditMode = false;
        editingMissionId = null;
        wizardInitialModel = null;
    }

    private string GetSelectedOrganizationName()
    {
        return organizations.FirstOrDefault()?.Name ?? "Organiza√ß√£o";
    }

    // ---- Wizard Handlers ----

    private async Task HandleWizardSave(MissionWizardResult result)
    {
        if (isEditMode && editingMissionId.HasValue)
        {
            await UpdateMissionFromResult(editingMissionId.Value, result);
        }
        else
        {
            await CreateMissionFromResult(result, MissionStatus.Active,
                "Miss√£o criada com sucesso!",
                m => $"A miss√£o '{m?.Name}' foi criada e est√° ativa.",
                "Erro ao criar miss√£o",
                "N√£o foi poss√≠vel criar a miss√£o. Verifique os dados e tente novamente.");
        }
    }

    private async Task HandleWizardSaveDraft(MissionWizardResult result)
    {
        await CreateMissionFromResult(result, MissionStatus.Planned,
            "Rascunho salvo com sucesso!",
            _ => "A miss√£o foi salva como rascunho.",
            "Erro ao salvar rascunho",
            "N√£o foi poss√≠vel salvar o rascunho da miss√£o. Verifique os dados e tente novamente.");
    }

    private async Task CreateMissionFromResult(
        MissionWizardResult result,
        MissionStatus status,
        string successTitle,
        Func<Mission?, string> successMessageFactory,
        string errorTitle,
        string errorMessage)
    {
        if (!Enum.TryParse<MissionScopeType>(result.ScopeTypeValue, out var scopeType)) return;
        if (!Guid.TryParse(result.ScopeId, out var scopeId)) return;

        await UiOps.RunAsync(
            async () =>
            {
                var request = new CreateMissionRequest
                {
                    Name = result.Name,
                    Description = result.Description,
                    StartDate = result.StartDate,
                    EndDate = result.EndDate,
                    ScopeType = scopeType,
                    ScopeId = scopeId,
                    Status = status
                };

                var createdMission = await Api.CreateMissionAsync(request);
                await CreateObjectivesAndMetricsForMission(createdMission, result.Objectives, result.Metrics);

                await LoadMissions();
                ToastService.ShowSuccess(successTitle, successMessageFactory(createdMission));
                CloseWizard();
            },
            errorTitle,
            errorMessage);
    }

    private async Task CreateObjectivesAndMetricsForMission(Mission? createdMission, List<TempObjective> objectives, List<TempMetric> metrics)
    {
        if (createdMission is null) return;

        var failedCount = 0;

        // Phase 1: Create objectives and build TempId ‚Üí real Guid mapping
        var objectiveIdMap = new Dictionary<string, Guid>();
        foreach (var tempObj in objectives)
        {
            try
            {
                var created = await Api.CreateMissionObjectiveAsync(new CreateMissionObjectiveRequest
                {
                    MissionId = createdMission.Id,
                    Name = tempObj.Name,
                    Description = tempObj.Description
                });
                if (created != null)
                {
                    objectiveIdMap[tempObj.TempId] = created.Id;
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erro ao criar objetivo '{tempObj.Name}' para miss√£o {createdMission.Id}: {ex.Message}");
                failedCount++;
            }
        }

        // Phase 2: Create metrics with resolved objective IDs
        foreach (var tempMetric in metrics)
        {
            var request = BuildCreateMetricRequest(createdMission.Id, tempMetric);
            if (request is null) { failedCount++; continue; }

            if (tempMetric.ObjectiveTempId is not null && objectiveIdMap.TryGetValue(tempMetric.ObjectiveTempId, out var realObjectiveId))
            {
                request.MissionObjectiveId = realObjectiveId;
            }

            try { await Api.CreateMissionMetricAsync(request); }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erro ao criar m√©trica '{tempMetric.Name}' para miss√£o {createdMission.Id}: {ex.Message}");
                failedCount++;
            }
        }

        if (failedCount > 0)
        {
            ToastService.ShowError("Erro ao salvar", $"{failedCount} item(ns) n√£o puderam ser salvos.");
        }
    }

    private IEnumerable<ScopeOption> GetScopeOptions(string? scopeTypeValue)
    {
        if (!Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType))
        {
            return Enumerable.Empty<ScopeOption>();
        }

        return scopeType switch
        {
            MissionScopeType.Organization => organizations.Select(o => new ScopeOption(o.Id.ToString(), o.Name)),
            MissionScopeType.Workspace => workspaces.Select(w => new ScopeOption(w.Id.ToString(), w.Name)),
            MissionScopeType.Team => teams.Select(t => new ScopeOption(t.Id.ToString(), t.Name)),
            MissionScopeType.Collaborator => collaborators.Select(c => new ScopeOption(c.Id.ToString(), c.FullName)),
            _ => Enumerable.Empty<ScopeOption>()
        };
    }

    private MissionScopeType? ParseScopeType(string? scopeTypeValue)
    {
        return Enum.TryParse<MissionScopeType>(scopeTypeValue, out var scopeType) ? scopeType : null;
    }


    // ---- Card Expansion Methods ----

    private async Task ToggleExpand(Guid missionId)
    {
        if (expandedMissions.Contains(missionId))
        {
            expandedMissions.Remove(missionId);
        }
        else
        {
            expandedMissions.Add(missionId);
            if (!missionMetricsCache.ContainsKey(missionId))
            {
                var metricsTask = Api.GetMissionMetricsByMissionIdAsync(missionId);
                var objectivesTask = Api.GetMissionObjectivesAsync(missionId);
                await Task.WhenAll(metricsTask, objectivesTask);

                var metrics = metricsTask.Result?.Items.ToList() ?? new List<MissionMetric>();
                missionMetricsCache[missionId] = metrics;

                var objectives = objectivesTask.Result?.Items.ToList() ?? new List<MissionObjective>();
                missionObjectivesCache[missionId] = objectives;

                // Load progress for metrics and objectives in parallel
                var metricProgressTask = Task.CompletedTask;
                var objectiveProgressTask = Task.CompletedTask;

                if (metrics.Count > 0)
                {
                    metricProgressTask = LoadMetricProgressForIds(metrics.Select(m => m.Id).ToList());
                }

                if (objectives.Count > 0)
                {
                    objectiveProgressTask = LoadObjectiveProgress(objectives.Select(o => o.Id).ToList());
                }

                await Task.WhenAll(metricProgressTask, objectiveProgressTask);
                StateHasChanged();
            }
        }
    }

    private async Task LoadObjectiveProgress(List<Guid> objectiveIds)
    {
        var progressList = await Api.GetObjectiveProgressAsync(objectiveIds);
        if (progressList != null)
        {
            foreach (var progress in progressList)
            {
                objectiveProgressCache[progress.ObjectiveId] = progress;
            }
        }
    }

    private async Task LoadMetricProgressForIds(List<Guid> metricIds)
    {
        var progressList = await Api.GetMetricProgressAsync(metricIds);
        if (progressList != null)
        {
            foreach (var progress in progressList)
            {
                metricProgressCache[progress.MetricId] = progress;
            }
        }
    }

    // ---- Checkin History Modal Methods ----

    private async Task OpenCheckinHistoryModal(Mission mission, MissionMetric metric)
    {
        historyMission = mission;
        historyMetric = metric;
        isCheckinHistoryModalOpen = true;
        isLoadingCheckins = true;
        metricCheckins = new List<MetricCheckin>();
        StateHasChanged();

        try
        {
            var result = await Api.GetMetricCheckinsAsync(metric.Id, null, 1, 50);
            metricCheckins = result?.Items.OrderByDescending(c => c.CheckinDate).ToList() ?? new List<MetricCheckin>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar hist√≥rico de check-ins da m√©trica {metric.Id}: {ex.Message}");
            metricCheckins = new List<MetricCheckin>();
            ToastService.ShowError("Erro ao carregar hist√≥rico", "N√£o foi poss√≠vel carregar o hist√≥rico de check-ins desta m√©trica.");
        }
        finally
        {
            isLoadingCheckins = false;
            StateHasChanged();
        }
    }

    private void CloseCheckinHistoryModal()
    {
        isCheckinHistoryModalOpen = false;
        historyMetric = null;
        historyMission = null;
        metricCheckins = new List<MetricCheckin>();
    }

    private void OpenCheckinFromHistory()
    {
        // Capture values before closing the history modal
        var mission = historyMission;
        var metric = historyMetric;

        // Close history modal first
        isCheckinHistoryModalOpen = false;
        historyMetric = null;
        historyMission = null;
        metricCheckins = new List<MetricCheckin>();

        // Now open checkin modal with captured values
        if (mission != null && metric != null)
        {
            OpenCheckinModalForMetric(mission, metric);
        }
    }

    // ---- Summary Card Methods ----

    private int GetOverallProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.TotalMetrics > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.OverallProgress);
    }

    private int GetExpectedProgressDisplay()
    {
        if (missions is null || !missionProgress.Any()) return 0;
        var activeProgress = missionProgress.Values.Where(p => p.ExpectedProgress > 0).ToList();
        if (!activeProgress.Any()) return 0;
        return (int)activeProgress.Average(p => p.ExpectedProgress);
    }

    private int GetActiveMissionsCount()
    {
        return missions?.Items.Count(m => m.Status == MissionStatus.Active) ?? 0;
    }

    private int GetOutdatedMetricsCount()
    {
        return missionProgress.Values.Sum(p => p.OutdatedMetrics);
    }

    // ---- Checkin Modal Methods ----

    private void OpenCheckinModalForMetric(Mission mission, MissionMetric metric)
    {
        checkinMission = mission;
        selectedCheckinMetric = metric;
        isCheckinModalOpen = true;
    }

    private void CloseCheckinModal()
    {
        isCheckinModalOpen = false;
        checkinMission = null;
        selectedCheckinMetric = null;
    }

    private async Task HandleCheckinSubmit(CreateMetricCheckinRequest request)
    {
        if (request.ConfidenceLevel < 1 || request.ConfidenceLevel > 5)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione o n√≠vel de confian√ßa (1-5).");
            return;
        }

        await UiOps.RunAsync(
            async () =>
            {
                await Api.CreateMetricCheckinAsync(request);
                ToastService.ShowSuccess("Check-in criado", "O check-in foi registrado com sucesso.");
                var missionId = checkinMission?.Id;
                CloseCheckinModal();
                await LoadProgress();
                if (missionId.HasValue)
                {
                    await LoadMetricProgress(missionId.Value);
                }
            },
            "Erro ao criar check-in",
            "N√£o foi poss√≠vel criar o check-in. Verifique os dados e tente novamente.");
    }

    // ---- Mission Edit/Delete Methods ----

    private (MissionScopeType scopeType, Guid scopeId) GetMissionScope(Mission mission)
    {
        if (mission.CollaboratorId.HasValue)
            return (MissionScopeType.Collaborator, mission.CollaboratorId.Value);
        if (mission.TeamId.HasValue)
            return (MissionScopeType.Team, mission.TeamId.Value);
        if (mission.WorkspaceId.HasValue)
            return (MissionScopeType.Workspace, mission.WorkspaceId.Value);
        return (MissionScopeType.Organization, mission.OrganizationId);
    }

    private async Task OpenEditWizard(Mission mission)
    {
        isEditMode = true;
        editingMissionId = mission.Id;

        var (scopeType, scopeId) = GetMissionScope(mission);

        // Load metrics and objectives in parallel
        var metricsTask = Api.GetMissionMetricsByMissionIdAsync(mission.Id);
        var objectivesTask = Api.GetMissionObjectivesAsync(mission.Id);
        await Task.WhenAll(metricsTask, objectivesTask);

        var apiMetrics = metricsTask.Result?.Items.ToList() ?? new List<MissionMetric>();
        var apiObjectives = objectivesTask.Result?.Items.ToList() ?? new List<MissionObjective>();

        // Convert objectives to TempObjective with OriginalId
        var tempObjs = apiObjectives.Select(o => new TempObjective(
            TempId: Guid.NewGuid().ToString(),
            Name: o.Name,
            Description: o.Description,
            OriginalId: o.Id
        )).ToList();

        // Build a map from original objective ID to TempId
        var objectiveIdToTempId = tempObjs
            .Where(o => o.OriginalId.HasValue)
            .ToDictionary(o => o.OriginalId!.Value, o => o.TempId);

        // Convert metrics to TempMetric with OriginalId and resolved ObjectiveTempId
        var tempMets = apiMetrics.Select(m =>
        {
            string? objTempId = null;
            if (m.MissionObjectiveId.HasValue && objectiveIdToTempId.TryGetValue(m.MissionObjectiveId.Value, out var tid))
            {
                objTempId = tid;
            }
            return new TempMetric(
                OriginalId: m.Id,
                Name: m.Name,
                Type: m.Type.ToString(),
                Details: GetMetricDetailsFromModel(m),
                QuantitativeType: m.QuantitativeType?.ToString(),
                MinValue: m.MinValue,
                MaxValue: m.MaxValue,
                TargetText: m.TargetText,
                Unit: m.Unit?.ToString(),
                ObjectiveTempId: objTempId);
        }).ToList();

        wizardInitialModel = new MissionWizardModel
        {
            Name = mission.Name,
            Description = mission.Description,
            StartDate = mission.StartDate,
            EndDate = mission.EndDate,
            ScopeTypeValue = scopeType.ToString(),
            ScopeId = scopeId.ToString(),
            StatusValue = mission.Status.ToString(),
            Metrics = tempMets,
            Objectives = tempObjs
        };

        isWizardOpen = true;
    }

    private async Task UpdateMissionFromResult(Guid missionId, MissionWizardResult result)
    {
        if (!Enum.TryParse<MissionScopeType>(result.ScopeTypeValue, out var scopeType)) return;
        if (!Guid.TryParse(result.ScopeId, out var scopeId)) return;

        await UiOps.RunAsync(
            async () =>
            {
                // 1. Update mission
                var updateRequest = new UpdateMissionRequest
                {
                    Name = result.Name,
                    Description = result.Description,
                    StartDate = result.StartDate,
                    EndDate = result.EndDate,
                    ScopeType = scopeType,
                    ScopeId = scopeId
                };

                if (Enum.TryParse<MissionStatus>(result.StatusValue, out var status))
                {
                    updateRequest.Status = status;
                }

                await Api.UpdateMissionAsync(missionId, updateRequest);

                var failedCount = 0;

                // 2. Process objectives: delete, update, create
                foreach (var id in result.DeletedObjectiveIds)
                {
                    try { await Api.DeleteMissionObjectiveAsync(id); }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao excluir objetivo {id}: {ex.Message}");
                        failedCount++;
                    }
                }

                var objectiveIdMap = new Dictionary<string, Guid>();

                // Update existing objectives
                foreach (var obj in result.Objectives.Where(o => o.OriginalId.HasValue))
                {
                    objectiveIdMap[obj.TempId] = obj.OriginalId!.Value;
                    try
                    {
                        await Api.UpdateMissionObjectiveAsync(obj.OriginalId!.Value, new UpdateMissionObjectiveRequest
                        {
                            Name = obj.Name,
                            Description = obj.Description
                        });
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao atualizar objetivo {obj.OriginalId}: {ex.Message}");
                        failedCount++;
                    }
                }

                // Create new objectives
                foreach (var obj in result.Objectives.Where(o => !o.OriginalId.HasValue))
                {
                    try
                    {
                        var created = await Api.CreateMissionObjectiveAsync(new CreateMissionObjectiveRequest
                        {
                            MissionId = missionId,
                            Name = obj.Name,
                            Description = obj.Description
                        });
                        if (created != null)
                        {
                            objectiveIdMap[obj.TempId] = created.Id;
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao criar objetivo '{obj.Name}': {ex.Message}");
                        failedCount++;
                    }
                }

                // 3. Process metrics: delete, update, create
                foreach (var id in result.DeletedMetricIds)
                {
                    try { await Api.DeleteMissionMetricAsync(id); }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao excluir m√©trica {id}: {ex.Message}");
                        failedCount++;
                    }
                }

                foreach (var metric in result.Metrics.Where(m => m.OriginalId.HasValue))
                {
                    try
                    {
                        var request = BuildUpdateMetricRequest(metric);
                        if (request != null)
                        {
                            await Api.UpdateMissionMetricAsync(metric.OriginalId!.Value, request);
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao atualizar m√©trica {metric.OriginalId}: {ex.Message}");
                        failedCount++;
                    }
                }

                foreach (var metric in result.Metrics.Where(m => !m.OriginalId.HasValue))
                {
                    try
                    {
                        var request = BuildCreateMetricRequest(missionId, metric);
                        if (request != null)
                        {
                            if (metric.ObjectiveTempId is not null && objectiveIdMap.TryGetValue(metric.ObjectiveTempId, out var realObjectiveId))
                            {
                                request.MissionObjectiveId = realObjectiveId;
                            }
                            await Api.CreateMissionMetricAsync(request);
                        }
                        else { failedCount++; }
                    }
                    catch (Exception ex)
                    {
                        Console.Error.WriteLine($"Erro ao criar m√©trica '{metric.Name}': {ex.Message}");
                        failedCount++;
                    }
                }

                if (failedCount > 0)
                {
                    ToastService.ShowError("Erro ao salvar", $"{failedCount} item(ns) n√£o puderam ser salvos.");
                }

                // Invalidate caches
                missionMetricsCache.Remove(missionId);
                missionObjectivesCache.Remove(missionId);
                await LoadMissions();

                // Reload expanded card if open
                if (expandedMissions.Contains(missionId))
                {
                    var reloadMetricsTask = Api.GetMissionMetricsByMissionIdAsync(missionId);
                    var reloadObjectivesTask = Api.GetMissionObjectivesAsync(missionId);
                    await Task.WhenAll(reloadMetricsTask, reloadObjectivesTask);

                    missionMetricsCache[missionId] = reloadMetricsTask.Result?.Items.ToList() ?? new List<MissionMetric>();
                    missionObjectivesCache[missionId] = reloadObjectivesTask.Result?.Items.ToList() ?? new List<MissionObjective>();

                    if (missionMetricsCache[missionId].Count > 0)
                    {
                        await LoadMetricProgress(missionId);
                    }

                    var objIds = missionObjectivesCache[missionId].Select(o => o.Id).ToList();
                    if (objIds.Count > 0)
                    {
                        await LoadObjectiveProgress(objIds);
                    }
                }

                ToastService.ShowSuccess("Miss√£o atualizada", "As altera√ß√µes foram salvas com sucesso.");
                CloseWizard();
            },
            "Erro ao atualizar",
            "N√£o foi poss√≠vel atualizar a miss√£o. Verifique os dados e tente novamente.");
    }

    private async Task HandleDeleteClick(Guid missionId)
    {
        if (deletingMissionId == missionId)
        {
            await DeleteMission(missionId);
        }
        else
        {
            ArmMissionDeleteConfirmation(missionId);
        }
    }

    private async Task DeleteMission(Guid missionId)
    {
        try
        {
            await UiOps.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionAsync(missionId);
                    ToastService.ShowSuccess("Miss√£o exclu√≠da", "A miss√£o foi removida com sucesso.");
                    await LoadMissions();
                },
            "Erro ao excluir",
            "N√£o foi poss√≠vel excluir a miss√£o. Tente novamente.");
        }
        finally
        {
            ClearMissionDeleteConfirmation();
        }
    }

    private static string GetMetricDetailsFromModel(MissionMetric m)
    {
        if (m.Type == MetricType.Qualitative)
            return m.TargetText ?? "";

        var unitLabel = m.Unit?.ToString() switch
        {
            "Integer" or "Decimal" => "un",
            "Percentage" => "%",
            "Hours" => "h",
            "Points" => "pts",
            _ => ""
        };
        return m.QuantitativeType?.ToString() switch
        {
            "KeepAbove" => $"Acima de {m.MinValue} {unitLabel}",
            "KeepBelow" => $"Abaixo de {m.MaxValue} {unitLabel}",
            "KeepBetween" => $"Entre {m.MinValue} e {m.MaxValue} {unitLabel}",
            "Achieve" => $"Atingir {m.MaxValue} {unitLabel}",
            "Reduce" => $"Reduzir para {m.MaxValue} {unitLabel}",
            _ => ""
        };
    }

    private CreateMissionMetricRequest? BuildCreateMetricRequest(Guid missionId, TempMetric metric)
    {
        if (!EnumParsingHelper.TryParseEnum<MetricType>(metric.Type, out var metricType))
            return null;

        var request = new CreateMissionMetricRequest
        {
            MissionId = missionId,
            Name = metric.Name,
            Type = metricType,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };

        if (metricType == MetricType.Quantitative)
        {
            if (!string.IsNullOrEmpty(metric.QuantitativeType) &&
                EnumParsingHelper.TryParseEnum<QuantitativeMetricType>(metric.QuantitativeType, out var qType))
                request.QuantitativeType = qType;
            if (!string.IsNullOrEmpty(metric.Unit) &&
                EnumParsingHelper.TryParseEnum<MetricUnit>(metric.Unit, out var unit))
                request.Unit = unit;
        }

        return request;
    }

    private UpdateMissionMetricRequest? BuildUpdateMetricRequest(TempMetric metric)
    {
        if (!EnumParsingHelper.TryParseEnum<MetricType>(metric.Type, out var metricType))
            return null;

        var request = new UpdateMissionMetricRequest
        {
            Name = metric.Name,
            Type = metricType,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };

        if (metricType == MetricType.Quantitative)
        {
            if (!string.IsNullOrEmpty(metric.QuantitativeType) &&
                EnumParsingHelper.TryParseEnum<QuantitativeMetricType>(metric.QuantitativeType, out var qType))
                request.QuantitativeType = qType;
            if (!string.IsNullOrEmpty(metric.Unit) &&
                EnumParsingHelper.TryParseEnum<MetricUnit>(metric.Unit, out var unit))
                request.Unit = unit;
        }

        return request;
    }

    private void ArmMissionDeleteConfirmation(Guid missionId)
    {
        deletingMissionId = missionId;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = new System.Threading.Timer(
            _ => InvokeAsync(() =>
            {
                deletingMissionId = null;
                StateHasChanged();
            }),
            null,
            3000,
            Timeout.Infinite);
    }

    private void ClearMissionDeleteConfirmation()
    {
        deletingMissionId = null;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = null;
    }


    // ---- Objective Methods ----

    private void ToggleObjectiveExpand(Guid objectiveId)
    {
        if (!expandedObjectives.Add(objectiveId))
        {
            expandedObjectives.Remove(objectiveId);
        }
    }

}
