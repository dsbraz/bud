@page "/mission-templates"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps
@implements IDisposable

<ManagementPageHeader
    Kicker="Configurações"
    Title="Modelos de missão"
    Subtitle="Gerencie modelos de missão da organização."
    PrimaryActionText="Novo modelo"
    OnPrimaryAction="OpenCreateModal" />

<div class="workspaces-filter-bar">
    <div class="workspaces-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@if (showFilterPanel)
{
    <div class="workspaces-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar modelos..." />
            </div>
        </div>
    </div>
}

<div class="workspaces-table-container">
    <PagedTableSection
        IsLoading="@(templates is null)"
        IsEmpty="@(templates is not null && templates.Items.Count == 0)"
        Total="@(templates?.Total ?? 0)"
        EmptyText="Nenhum modelo encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Descrição</th>
                    <th style="text-align: center;">Objetivos</th>
                    <th style="text-align: center;">Métricas</th>
                    <th style="text-align: center;">Status</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var template in templates!.Items)
                {
                    var isDeleting = deletingTemplateId == template.Id;
                    <tr>
                        <td>@template.Name</td>
                        <td>@(template.Description ?? "—")</td>
                        <td style="text-align: center;">@template.Objectives.Count</td>
                        <td style="text-align: center;">@template.Metrics.Count</td>
                        <td style="text-align: center;">
                            <span class="badge @(template.IsActive ? "badge-active" : "badge-inactive")">
                                @(template.IsActive ? "Ativo" : "Inativo")
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar modelo"
                                OnEdit="@(() => OpenEditModal(template))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir modelo"
                                OnDelete="@(() => HandleDeleteClick(template.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="@(isEditing ? "Editar modelo" : "Criar modelo")" Size="lg" OnClose="CloseModal">
        <ChildContent>
            <div class="wizard-tabs">
                <button type="button" class="wizard-tab @(wizardStep == 1 ? "active" : "")" @onclick="() => wizardStep = 1">
                    <span class="wizard-tab-number">1</span>
                    <span>Missão</span>
                </button>
                <div class="wizard-tab-separator"></div>
                <button type="button" class="wizard-tab @(wizardStep == 2 ? "active" : "")" @onclick="() => wizardStep = 2">
                    <span class="wizard-tab-number">2</span>
                    <span>Métricas</span>
                    @{ var directMetricCount = tempMetrics.Count(m => m.ObjectiveTempId is null); }
                    @if (directMetricCount > 0)
                    {
                        <span class="wizard-tab-badge">@directMetricCount</span>
                    }
                </button>
                <div class="wizard-tab-separator"></div>
                <button type="button" class="wizard-tab @(wizardStep == 3 ? "active" : "")" @onclick="() => wizardStep = 3">
                    <span class="wizard-tab-number">3</span>
                    <span>Objetivos</span>
                    @if (tempObjectives.Count > 0)
                    {
                        <span class="wizard-tab-badge">@tempObjectives.Count</span>
                    }
                </button>
            </div>

            @if (wizardStep == 1)
            {
                <div>
                    <div class="mission-header">
                        <input type="text" class="mission-title-input" @bind="formName" placeholder="Nome do template" />
                        <input type="text" class="mission-subtitle-input" @bind="formDescription" placeholder="Descrição do template" />
                    </div>
                </div>
            }

            @if (wizardStep == 2)
            {
                <div class="wizard-tab-content">
                    <div class="mission-metrics-section">
                        <div class="mission-metrics-section-header">
                            <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18 9l-5 5-4-4-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <h3>Métricas diretas</h3>
                        </div>

                        @if (tempObjectives.Count > 0)
                        {
                            <p class="wizard-tab-hint">Métricas que não pertencem a nenhum objetivo. Para adicionar métricas a um objetivo, use a aba Objetivos.</p>
                        }

                        <MetricFormFields Model="newMetricModel" OnSave="AddMetricFromForm" OnCancel="CancelAddMetricForm" ShowAddButton="true" />

                        @{
                            var directMetrics = tempMetrics
                                .Select((m, idx) => (Metric: m, Index: idx))
                                .Where(x => x.Metric.ObjectiveTempId is null)
                                .ToList();
                        }

                        @if (directMetrics.Any())
                        {
                            <div class="metrics-list">
                                @foreach (var (metric, metricIndex) in directMetrics)
                                {
                                    @if (editingTempMetricIndex == metricIndex)
                                    {
                                        <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                            <MetricFormFields Model="editTempMetricModel" OnSave="SaveTempMetric" OnCancel="CancelTempMetric" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="metric-item">
                                            <div class="metric-info">
                                                <div class="metric-name">@metric.Name</div>
                                                <div class="metric-details">@metric.Details</div>
                                            </div>
                                            <CrudRowActions
                                                EditTitle="Editar métrica"
                                                OnEdit="@(() => StartTempMetric(metricIndex))"
                                                IsDeleteConfirming="false"
                                                DeleteTitle="Excluir métrica"
                                                OnDelete="@(() => RemoveMetric(metric))" />
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </div>
            }

            @if (wizardStep == 3)
            {
                <div class="wizard-tab-content">
                    <div class="mission-metrics-section">
                        <div class="mission-metrics-section-header">
                            <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="6" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="2" stroke-linecap="round"/>
                            </svg>
                            <h3>Objetivos</h3>
                        </div>

                        @if (tempObjectives.Count > 0)
                        {
                            <p class="wizard-tab-hint">Organize as métricas do template em objetivos. Cada objetivo pode ter suas próprias métricas.</p>
                        }

                        @if (showObjectiveForm)
                        {
                            <div class="wizard-objective-form">
                                <div class="form-row">
                                    <label>Nome do objetivo</label>
                                    <input type="text" class="input" @bind="tempObjectiveName" placeholder="Ex: Aumentar engajamento, Reduzir churn..." maxlength="200" />
                                </div>
                                <div class="form-row">
                                    <label>Descrição (opcional)</label>
                                    <textarea class="input" @bind="tempObjectiveDescription" placeholder="Breve descrição do objetivo" maxlength="1000" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <label>Dimensão (opcional)</label>
                                    <select class="input" @bind="tempObjectiveDimensionId">
                                        <option value="">Sem dimensão</option>
                                        @foreach (var dimension in objectiveDimensions.OrderBy(d => d.Name))
                                        {
                                            <option value="@dimension.Id">@dimension.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="form-actions" style="margin-top: var(--spacing-3);">
                                    <button type="button" class="button tertiary" @onclick="CancelAddObjective">Cancelar</button>
                                    <button type="button" class="button primary" @onclick="AddTempObjective">Salvar objetivo</button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <button type="button" class="metrics-add-button" @onclick="() => showObjectiveForm = true">
                                <span>Adicionar objetivo</span>
                                <span class="metrics-add-icon">+</span>
                            </button>
                        }

                        @if (tempObjectives.Count > 0)
                        {
                            <div class="metrics-list">
                                @for (var i = 0; i < tempObjectives.Count; i++)
                                {
                                    var index = i;
                                    var obj = tempObjectives[index];

                                    @if (editingTempObjectiveIndex == index)
                                    {
                                        <div class="wizard-objective-card">
                                            <div class="form-row">
                                                <label>Nome</label>
                                                <input type="text" class="input" @bind="editingObjectiveName" maxlength="200" />
                                            </div>
                                            <div class="form-row">
                                                <label>Descrição</label>
                                                <textarea class="input" @bind="editingObjectiveDescription" maxlength="1000" rows="2"></textarea>
                                            </div>
                                            <div class="form-row">
                                                <label>Dimensão (opcional)</label>
                                                <select class="input" @bind="editingObjectiveDimensionId">
                                                    <option value="">Sem dimensão</option>
                                                    @foreach (var dimension in objectiveDimensions.OrderBy(d => d.Name))
                                                    {
                                                        <option value="@dimension.Id">@dimension.Name</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="form-actions" style="margin-top: var(--spacing-3);">
                                                <button type="button" class="button tertiary" @onclick="CancelEditTempObjective">Cancelar</button>
                                                <button type="button" class="button primary" @onclick="SaveEditTempObjective">Salvar</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="wizard-objective-card">
                                            <div class="wizard-objective-header">
                                                <div class="wizard-objective-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                                                        <circle cx="12" cy="12" r="6" stroke-linecap="round"/>
                                                        <circle cx="12" cy="12" r="2" stroke-linecap="round"/>
                                                    </svg>
                                                </div>
                                                <div class="metric-info">
                                                    <div class="metric-name">@obj.Name</div>
                                                    @if (!string.IsNullOrWhiteSpace(obj.Description))
                                                    {
                                                        <div class="metric-details">@obj.Description</div>
                                                    }
                                                    @if (obj.ObjectiveDimensionId.HasValue)
                                                    {
                                                        var dimensionName = objectiveDimensions
                                                            .FirstOrDefault(d => d.Id == obj.ObjectiveDimensionId.Value)
                                                            ?.Name;
                                                        if (!string.IsNullOrWhiteSpace(dimensionName))
                                                        {
                                                            <div class="metric-details">Dimensão: @dimensionName</div>
                                                        }
                                                    }
                                                </div>
                                                <CrudRowActions
                                                    EditTitle="Editar objetivo"
                                                    OnEdit="@(() => StartEditTempObjective(index))"
                                                    IsDeleteConfirming="false"
                                                    DeleteTitle="Excluir objetivo"
                                                    OnDelete="@(() => RemoveTempObjective(index))" />
                                            </div>

                                            @if (addingMetricToObjectiveTempId == obj.TempId)
                                            {
                                                <div style="margin-top: var(--spacing-3);">
                                                    <MetricFormFields Model="newMetricModel" OnSave="AddMetricToObjective" OnCancel="CancelAddMetricToObjective" />
                                                </div>
                                            }
                                            else
                                            {
                                                <button type="button" class="metrics-add-button" style="margin-top: var(--spacing-3);" @onclick="() => StartAddMetricToObjective(obj.TempId)">
                                                    <span>Adicionar métrica</span>
                                                    <span class="metrics-add-icon">+</span>
                                                </button>
                                            }

                                            @{
                                                var objMetrics = tempMetrics
                                                    .Select((m, idx) => (Metric: m, Index: idx))
                                                    .Where(x => x.Metric.ObjectiveTempId == obj.TempId)
                                                    .ToList();
                                            }

                                            @if (objMetrics.Any())
                                            {
                                                <div class="metrics-list" style="margin-top: var(--spacing-3);">
                                                    @foreach (var (metric, metricIndex) in objMetrics)
                                                    {
                                                        @if (editingTempMetricIndex == metricIndex)
                                                        {
                                                            <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                                                <MetricFormFields Model="editTempMetricModel" OnSave="SaveTempMetric" OnCancel="CancelTempMetric" />
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="metric-item">
                                                                <div class="metric-info">
                                                                    <div class="metric-name">@metric.Name</div>
                                                                    <div class="metric-details">@metric.Details</div>
                                                                </div>
                                                                <CrudRowActions
                                                                    EditTitle="Editar métrica"
                                                                    OnEdit="@(() => StartTempMetric(metricIndex))"
                                                                    IsDeleteConfirming="false"
                                                                    DeleteTitle="Excluir métrica"
                                                                    OnDelete="@(() => RemoveMetric(metric))" />
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    @if (wizardStep > 1)
                    {
                        <button class="button tertiary" type="button" @onclick="() => wizardStep--">Voltar</button>
                    }
                    @if (wizardStep < 3)
                    {
                        <button class="button secondary" type="button" @onclick="() => wizardStep++">Próximo</button>
                    }
                    else
                    {
                        <button class="button primary" type="button" @onclick="SaveTemplate">@(isEditing ? "Salvar alterações" : "Criar")</button>
                    }
                </div>
            </div>
        </Footer>
    </Modal>
}

@code {
    private PagedResult<MissionTemplate>? templates;
    private string? search;
    private bool showFilterPanel;
    private bool isModalOpen;
    private bool isEditing;
    private int wizardStep = 1;
    private Guid? editingTemplateId;

    private string formName = string.Empty;
    private string? formDescription;
    private bool formIsActive = true;

    private List<TempMetric> tempMetrics = [];
    private MetricFormFields.MetricFormModel newMetricModel = new();
    private MetricFormFields.MetricFormModel editTempMetricModel = new();
    private int? editingTempMetricIndex;

    private List<TempObjective> tempObjectives = [];
    private string tempObjectiveName = string.Empty;
    private string? tempObjectiveDescription;
    private string? tempObjectiveDimensionId;
    private int? editingTempObjectiveIndex;
    private string editingObjectiveName = string.Empty;
    private string? editingObjectiveDescription;
    private string? editingObjectiveDimensionId;
    private string? addingMetricToObjectiveTempId;
    private bool showObjectiveForm;

    private IReadOnlyList<ObjectiveDimension> objectiveDimensions = [];

    private Guid? deletingTemplateId;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
        await LoadObjectiveDimensions();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadTemplates();
            await LoadObjectiveDimensions();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar modelos por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar modelos", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadTemplates()
    {
        templates = await Api.GetMissionTemplatesAsync(search, 1, 20) ?? new PagedResult<MissionTemplate>();
    }

    private async Task LoadObjectiveDimensions()
    {
        objectiveDimensions = (await Api.GetObjectiveDimensionsAsync(null, 1, 200))?.Items ?? [];
    }

    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;
    private bool HasActiveFilters() => !string.IsNullOrEmpty(search);

    private async Task ClearFilters()
    {
        search = null;
        await LoadTemplates();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadTemplates();
    }

    private void OpenCreateModal()
    {
        wizardStep = 1;
        isEditing = false;
        editingTemplateId = null;
        formName = string.Empty;
        formDescription = null;
        formIsActive = true;
        ResetWizardCollections();
        isModalOpen = true;
    }

    private void OpenEditModal(MissionTemplate template)
    {
        wizardStep = 1;
        isEditing = true;
        editingTemplateId = template.Id;
        formName = template.Name;
        formDescription = template.Description;
        formIsActive = template.IsActive;

        var objectiveIdToTempId = template.Objectives
            .OrderBy(o => o.OrderIndex)
            .ToDictionary(o => o.Id, _ => Guid.NewGuid().ToString());

        tempObjectives = template.Objectives
            .OrderBy(o => o.OrderIndex)
            .Select(o => new TempObjective(
                objectiveIdToTempId[o.Id],
                o.Name,
                o.Description,
                o.Id,
                o.ObjectiveDimensionId))
            .ToList();

        tempMetrics = template.Metrics
            .OrderBy(m => m.OrderIndex)
            .Select(m => new TempMetric(
                null,
                m.Name,
                m.Type.ToString(),
                BuildMetricDetails(m),
                m.QuantitativeType?.ToString(),
                m.MinValue,
                m.MaxValue,
                m.TargetText,
                m.Unit?.ToString(),
                m.MissionTemplateObjectiveId.HasValue && objectiveIdToTempId.TryGetValue(m.MissionTemplateObjectiveId.Value, out var objectiveTempId)
                    ? objectiveTempId
                    : null))
            .ToList();

        ResetWizardForms();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
        isEditing = false;
        editingTemplateId = null;
    }

    private async Task SaveTemplate()
    {
        if (string.IsNullOrWhiteSpace(formName))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome do modelo.");
            return;
        }

        FlushPendingMetric();

        if (isEditing && editingTemplateId.HasValue)
        {
            await UpdateTemplate();
        }
        else
        {
            await CreateTemplate();
        }
    }

    private async Task CreateTemplate()
    {
        var request = BuildCreateRequest();

        await UiOps.RunAsync(
            async () =>
            {
                await Api.CreateMissionTemplateAsync(request);
                await LoadTemplates();
                ToastService.ShowSuccess("Modelo criado com sucesso!", $"O modelo '{formName}' foi criado.");
                CloseModal();
            },
            "Erro ao criar modelo",
            "Não foi possível criar o modelo. Verifique os dados e tente novamente.");
    }

    private async Task UpdateTemplate()
    {
        if (!editingTemplateId.HasValue)
        {
            return;
        }

        var request = BuildUpdateRequest();

        await UiOps.RunAsync(
            async () =>
            {
                await Api.UpdateMissionTemplateAsync(editingTemplateId.Value, request);
                await LoadTemplates();
                ToastService.ShowSuccess("Modelo atualizado", "As alterações foram salvas com sucesso.");
                CloseModal();
            },
            "Erro ao atualizar modelo",
            "Não foi possível atualizar o modelo. Verifique os dados e tente novamente.");
    }

    private CreateMissionTemplateRequest BuildCreateRequest()
    {
        var (objectives, metrics) = BuildTemplatePayload();
        return new CreateMissionTemplateRequest
        {
            Name = formName.Trim(),
            Description = string.IsNullOrWhiteSpace(formDescription) ? null : formDescription.Trim(),
            Objectives = objectives,
            Metrics = metrics
        };
    }

    private UpdateMissionTemplateRequest BuildUpdateRequest()
    {
        var (objectives, metrics) = BuildTemplatePayload();
        return new UpdateMissionTemplateRequest
        {
            Name = formName.Trim(),
            Description = string.IsNullOrWhiteSpace(formDescription) ? null : formDescription.Trim(),
            IsActive = formIsActive,
            Objectives = objectives,
            Metrics = metrics
        };
    }

    private (List<MissionTemplateObjectiveDto> Objectives, List<MissionTemplateMetricDto> Metrics) BuildTemplatePayload()
    {
        var objectiveIdByTempId = new Dictionary<string, Guid>();

        var objectives = tempObjectives
            .Select((objective, index) =>
            {
                var objectiveId = objective.OriginalId ?? Guid.NewGuid();
                objectiveIdByTempId[objective.TempId] = objectiveId;

                return new MissionTemplateObjectiveDto
                {
                    Id = objectiveId,
                    Name = objective.Name,
                    Description = objective.Description,
                    ObjectiveDimensionId = objective.ObjectiveDimensionId,
                    OrderIndex = index
                };
            })
            .ToList();

        var metrics = tempMetrics
            .Select((metric, index) => new MissionTemplateMetricDto
            {
                Name = metric.Name,
                Type = Enum.Parse<MetricType>(metric.Type),
                OrderIndex = index,
                QuantitativeType = ParseOptionalEnum<QuantitativeMetricType>(metric.QuantitativeType),
                MinValue = metric.MinValue,
                MaxValue = metric.MaxValue,
                Unit = ParseOptionalEnum<MetricUnit>(metric.Unit),
                TargetText = metric.TargetText,
                MissionTemplateObjectiveId = metric.ObjectiveTempId is not null && objectiveIdByTempId.TryGetValue(metric.ObjectiveTempId, out var objectiveId)
                    ? objectiveId
                    : null
            })
            .ToList();

        return (objectives, metrics);
    }

    private static TEnum? ParseOptionalEnum<TEnum>(string? value)
        where TEnum : struct, Enum
        => Enum.TryParse<TEnum>(value, out var parsed) ? parsed : null;

    private static string BuildMetricDetails(MissionTemplateMetric metric)
    {
        return metric.Type == MetricType.Quantitative
            ? BuildQuantitativeDetails(metric.QuantitativeType?.ToString(), metric.MinValue, metric.MaxValue, metric.Unit?.ToString())
            : metric.TargetText ?? string.Empty;
    }

    private static string BuildQuantitativeDetails(string? quantitativeType, decimal? minValue, decimal? maxValue, string? unit)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(quantitativeType))
        {
            parts.Add(quantitativeType);
        }
        if (!string.IsNullOrWhiteSpace(unit))
        {
            parts.Add(unit);
        }
        if (minValue.HasValue)
        {
            parts.Add($"Min: {minValue}");
        }
        if (maxValue.HasValue)
        {
            parts.Add($"Max: {maxValue}");
        }

        return string.Join(" — ", parts);
    }

    private void ResetWizardCollections()
    {
        tempMetrics = [];
        tempObjectives = [];
        ResetWizardForms();
    }

    private void ResetWizardForms()
    {
        newMetricModel = new();
        editTempMetricModel = new();
        editingTempMetricIndex = null;

        tempObjectiveName = string.Empty;
        tempObjectiveDescription = null;
        tempObjectiveDimensionId = null;
        editingTempObjectiveIndex = null;
        editingObjectiveName = string.Empty;
        editingObjectiveDescription = null;
        editingObjectiveDimensionId = null;
        addingMetricToObjectiveTempId = null;
        showObjectiveForm = false;
    }

    private void FlushPendingMetric()
    {
        if (TryBuildTempMetric(newMetricModel, null, null, out var metric))
        {
            tempMetrics.Add(metric);
            newMetricModel.Clear();
        }
    }

    private void AddMetricFromForm()
    {
        if (!TryBuildTempMetric(newMetricModel, null, null, out var metric))
        {
            return;
        }

        tempMetrics.Add(metric);
        newMetricModel.Clear();
    }

    private void CancelAddMetricForm() => newMetricModel.Clear();

    private void RemoveMetric(TempMetric metric)
    {
        tempMetrics.Remove(metric);
    }

    private void StartAddMetricToObjective(string objectiveTempId)
    {
        addingMetricToObjectiveTempId = objectiveTempId;
        newMetricModel.Clear();
    }

    private void AddMetricToObjective()
    {
        if (!TryBuildTempMetric(newMetricModel, null, addingMetricToObjectiveTempId, out var metric))
        {
            return;
        }

        tempMetrics.Add(metric);
        ResetAddMetricToObjectiveState();
    }

    private void CancelAddMetricToObjective()
    {
        ResetAddMetricToObjectiveState();
    }

    private void StartTempMetric(int index)
    {
        var metric = tempMetrics[index];
        editingTempMetricIndex = index;
        editTempMetricModel = new MetricFormFields.MetricFormModel
        {
            Name = metric.Name,
            TypeValue = metric.Type,
            QuantitativeTypeValue = metric.QuantitativeType,
            UnitValue = metric.Unit,
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };
    }

    private void CancelTempMetric()
    {
        editingTempMetricIndex = null;
        editTempMetricModel.Clear();
    }

    private void SaveTempMetric()
    {
        if (editingTempMetricIndex is null)
        {
            return;
        }

        var existing = tempMetrics[editingTempMetricIndex.Value];
        if (!TryBuildTempMetric(editTempMetricModel, existing.OriginalId, existing.ObjectiveTempId, out var updatedMetric))
        {
            return;
        }

        tempMetrics[editingTempMetricIndex.Value] = updatedMetric;
        CancelTempMetric();
    }

    private bool TryBuildTempMetric(
        MetricFormFields.MetricFormModel model,
        Guid? originalId,
        string? objectiveTempId,
        out TempMetric metric)
    {
        metric = default!;
        if (!ValidateMetricModel(model))
        {
            return false;
        }

        metric = new TempMetric(
            OriginalId: originalId,
            Name: model.Name,
            Type: model.TypeValue!,
            Details: BuildMetricDetails(model),
            QuantitativeType: model.QuantitativeTypeValue,
            MinValue: model.MinValue,
            MaxValue: model.MaxValue,
            TargetText: model.TargetText,
            Unit: model.UnitValue,
            ObjectiveTempId: objectiveTempId);
        return true;
    }

    private static string BuildMetricDetails(MetricFormFields.MetricFormModel model)
    {
        return model.TypeValue == "Quantitative"
            ? BuildQuantitativeDetails(model.QuantitativeTypeValue, model.MinValue, model.MaxValue, model.UnitValue)
            : model.TargetText ?? string.Empty;
    }

    private void ResetAddMetricToObjectiveState()
    {
        addingMetricToObjectiveTempId = null;
        newMetricModel.Clear();
    }

    private bool ValidateMetricModel(MetricFormFields.MetricFormModel model)
    {
        if (string.IsNullOrWhiteSpace(model.Name) || string.IsNullOrWhiteSpace(model.TypeValue))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome e tipo da métrica.");
            return false;
        }

        return true;
    }

    private void AddTempObjective()
    {
        if (string.IsNullOrWhiteSpace(tempObjectiveName))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome do objetivo.");
            return;
        }

        tempObjectives.Add(new TempObjective(
            TempId: Guid.NewGuid().ToString(),
            Name: tempObjectiveName.Trim(),
            Description: string.IsNullOrWhiteSpace(tempObjectiveDescription) ? null : tempObjectiveDescription.Trim(),
            OriginalId: null,
            ObjectiveDimensionId: ParseOptionalGuid(tempObjectiveDimensionId)));

        tempObjectiveName = string.Empty;
        tempObjectiveDescription = null;
        tempObjectiveDimensionId = null;
        showObjectiveForm = false;
    }

    private void CancelAddObjective()
    {
        tempObjectiveName = string.Empty;
        tempObjectiveDescription = null;
        tempObjectiveDimensionId = null;
        showObjectiveForm = false;
    }

    private void StartEditTempObjective(int index)
    {
        var objective = tempObjectives[index];
        editingTempObjectiveIndex = index;
        editingObjectiveName = objective.Name;
        editingObjectiveDescription = objective.Description;
        editingObjectiveDimensionId = objective.ObjectiveDimensionId?.ToString();
    }

    private void SaveEditTempObjective()
    {
        if (editingTempObjectiveIndex is null || string.IsNullOrWhiteSpace(editingObjectiveName))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome do objetivo.");
            return;
        }

        var previous = tempObjectives[editingTempObjectiveIndex.Value];
        tempObjectives[editingTempObjectiveIndex.Value] = previous with
        {
            Name = editingObjectiveName.Trim(),
            Description = string.IsNullOrWhiteSpace(editingObjectiveDescription) ? null : editingObjectiveDescription.Trim(),
            ObjectiveDimensionId = ParseOptionalGuid(editingObjectiveDimensionId)
        };

        CancelEditTempObjective();
    }

    private void CancelEditTempObjective()
    {
        editingTempObjectiveIndex = null;
        editingObjectiveName = string.Empty;
        editingObjectiveDescription = null;
        editingObjectiveDimensionId = null;
    }

    private void RemoveTempObjective(int index)
    {
        var objective = tempObjectives[index];
        tempObjectives.RemoveAt(index);
        tempMetrics.RemoveAll(m => m.ObjectiveTempId == objective.TempId);

        if (editingTempObjectiveIndex == index)
        {
            CancelEditTempObjective();
        }

        if (addingMetricToObjectiveTempId == objective.TempId)
        {
            ResetAddMetricToObjectiveState();
        }
    }

    private static Guid? ParseOptionalGuid(string? value)
        => Guid.TryParse(value, out var parsed) ? parsed : null;

    private void HandleDeleteClick(Guid templateId)
    {
        if (deletingTemplateId == templateId)
        {
            _ = DeleteTemplate(templateId);
        }
        else
        {
            deletingTemplateId = templateId;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingTemplateId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite);
        }
    }

    private async Task DeleteTemplate(Guid templateId)
    {
        try
        {
            await UiOps.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionTemplateAsync(templateId);
                    ToastService.ShowSuccess("Modelo excluído", "O modelo foi removido com sucesso.");
                    await LoadTemplates();
                },
                "Erro ao excluir",
                "Não foi possível excluir o modelo. Tente novamente.");
        }
        finally
        {
            deletingTemplateId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
