@page "/mission-templates"
@implements IDisposable

<ManagementPageHeader
    Kicker="Configurações"
    Title="Modelos de missão"
    Subtitle="Gerencie modelos de missão da organização."
    PrimaryActionText="Novo modelo"
    OnPrimaryAction="OpenCreateModal" />

<div class="workspaces-filter-bar">
    <div class="workspaces-filter-left">
        <button class="filter-chip @(_showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@if (_showFilterPanel)
{
    <div class="workspaces-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="_search" @onkeyup="OnSearchKeyUp" placeholder="Buscar modelos..." />
            </div>
        </div>
    </div>
}

<div class="workspaces-table-container">
    <PagedTableSection
        IsLoading="@(_templates is null)"
        IsEmpty="@(_templates is not null && _templates.Items.Count == 0)"
        Total="@(_templates?.Total ?? 0)"
        EmptyText="Nenhum modelo encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Descrição</th>
                    <th style="text-align: center;">Objetivos</th>
                    <th style="text-align: center;">Métricas</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var template in _templates!.Items)
                {
                    var isDeleting = _deletingTemplateId == template.Id;
                    <tr>
                        <td>@template.Name</td>
                        <td>@(template.Description ?? "—")</td>
                        <td style="text-align: center;">@template.Objectives.Count</td>
                        <td style="text-align: center;">@template.Metrics.Count</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar modelo"
                                OnEdit="@(() => OpenEditModal(template))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir modelo"
                                OnDelete="@(() => HandleDeleteClick(template.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

<MissionWizardModal IsOpen="_isWizardOpen"
                    IsEditMode="_isEditMode"
                    Mode="WizardMode.Template"
                    InitialModel="_wizardInitialModel"
                    ObjectiveDimensions="_objectiveDimensions"
                    OnClose="CloseWizard"
                    OnSave="HandleWizardSave" />
