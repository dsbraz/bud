@page "/mission-templates"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<ManagementMenu />

<ManagementPageHeader
    Kicker="Configura√ß√µes"
    Title="Templates de Miss√£o"
    Subtitle="Gerencie templates de miss√£o da organiza√ß√£o."
    PrimaryActionText="Novo template"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros *@
<div class="workspaces-filter-bar">
    <div class="workspaces-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expans√≠vel *@
@if (showFilterPanel)
{
    <div class="workspaces-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar templates..." />
            </div>
        </div>
    </div>
}

@* Lista de Templates *@
<div class="workspaces-table-container">
    <PagedTableSection
        IsLoading="@(templates is null)"
        IsEmpty="@(templates is not null && templates.Items.Count == 0)"
        Total="@(templates?.Total ?? 0)"
        EmptyText="Nenhum template encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Descri√ß√£o</th>
                    <th style="text-align: center;">M√©tricas</th>
                    <th style="text-align: center;">Status</th>
                    <th style="width: 120px; text-align: center;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var template in templates!.Items)
                {
                    var isDeleting = deletingTemplateId == template.Id;
                    <tr>
                        <td>@template.Name</td>
                        <td>@(template.Description ?? "‚Äî")</td>
                        <td style="text-align: center;">@template.Metrics.Count</td>
                        <td style="text-align: center;">
                            <span class="badge @(template.IsActive ? "badge-active" : "badge-inactive")">
                                @(template.IsActive ? "Ativo" : "Inativo")
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar template"
                                OnEdit="@(() => OpenEditModal(template))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir template"
                                OnDelete="@(() => HandleDeleteClick(template.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="@(isEditing ? "Editar template" : "Criar template")" Size="lg" OnClose="CloseModal">
        <ChildContent>
            @* Header Section - Template Name & Description *@
            <div class="mission-header">
                <input type="text" class="mission-title-input" @bind="formName" placeholder="Nome do template" />
                <input type="text" class="mission-subtitle-input" @bind="formDescription" placeholder="Adicionar breve descri√ß√£o" />
            </div>

            @* Metadata Chips *@
            <div class="chips-container">
                <div class="chip" @onclick="() => showPatternFields = !showPatternFields">
                    <span class="chip-icon">üìù</span>
                    <span>Padr√µes</span>
                </div>
                @if (isEditing)
                {
                    <div class="chip" @onclick="() => showStatusSelector = !showStatusSelector">
                        <span class="chip-icon">üìä</span>
                        <span>@(formIsActive == "true" ? "Ativo" : "Inativo")</span>
                    </div>
                }
            </div>

            @* Pattern Fields (hidden by default) *@
            @if (showPatternFields)
            {
                <div class="form-row">
                    <label>Padr√£o de nome da miss√£o</label>
                    <input type="text" class="input" @bind="formMissionNamePattern" placeholder="Ex: OKR ‚Äî " />
                </div>
                <div class="form-row">
                    <label>Padr√£o de descri√ß√£o da miss√£o</label>
                    <input type="text" class="input" @bind="formMissionDescriptionPattern" placeholder="Ex: Miss√£o seguindo framework OKR" />
                </div>
            }

            @* Status Selector (hidden by default) *@
            @if (isEditing && showStatusSelector)
            {
                <div class="form-row">
                    <label>Status</label>
                    <select class="input" @bind="formIsActive">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>
            }

            @* Metrics Section *@
            <div class="mission-metrics-section">
                @if (!showMetricForm)
                {
                    <button type="button" class="metrics-add-button" @onclick="() => showMetricForm = true">
                        <span>Adicionar item</span>
                        <span class="metrics-add-icon">+</span>
                    </button>
                }
                else
                {
                    <div class="metrics-form-container">
                        <div class="metrics-form-header">
                            <div class="form-row">
                                <label>Nome da m√©trica</label>
                                <input type="text" class="input" @bind="newMetricName" placeholder="Ex: Taxa de convers√£o, NPS, etc." />
                            </div>
                        </div>

                        <div class="metrics-form-selectors">
                            <div class="metrics-selector-btn">
                                <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                </svg>
                                <select @bind="newMetricType">
                                    <option value="">Tipo de m√©trica</option>
                                    <option value="Quantitative">Quantitativa</option>
                                    <option value="Qualitative">Qualitativa</option>
                                </select>
                                <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                </svg>
                            </div>

                            @if (newMetricType == "Quantitative")
                            {
                                <div class="metrics-selector-btn">
                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                    </svg>
                                    <select @bind="newMetricQuantitativeType">
                                        <option value="">Modo de mensura√ß√£o</option>
                                        <option value="KeepAbove">‚Üë Manter acima</option>
                                        <option value="KeepBelow">‚Üì Manter abaixo</option>
                                        <option value="KeepBetween">‚Üï Manter entre</option>
                                        <option value="Achieve">‚Üí Atingir</option>
                                        <option value="Reduce">‚Üò Reduzir</option>
                                    </select>
                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                    </svg>
                                </div>
                            }
                        </div>

                        @if (newMetricType == "Qualitative")
                        {
                            <div class="form-row">
                                <label>Descri√ß√£o do objetivo</label>
                                <input type="text" class="input" @bind="newMetricTargetText" placeholder="Descreva o objetivo qualitativo desta m√©trica" />
                            </div>
                        }

                        @if (newMetricType == "Quantitative" && !string.IsNullOrEmpty(newMetricQuantitativeType))
                        {
                            <div class="metrics-form-inputs">
                                <div class="metrics-input-field">
                                    <select @bind="newMetricUnit">
                                        <option value="">Unidade de medida</option>
                                        <option value="Integer">Inteiro</option>
                                        <option value="Decimal">Decimal</option>
                                        <option value="Percentage">Percentual</option>
                                        <option value="Hours">Horas</option>
                                        <option value="Points">Pontos</option>
                                    </select>
                                </div>

                                @if (newMetricQuantitativeType == "KeepAbove" || newMetricQuantitativeType == "KeepBetween")
                                {
                                    <div class="metrics-input-field">
                                        <input type="number" @bind="newMetricMinValue" placeholder="Valor m√≠nimo" />
                                    </div>
                                }

                                @if (newMetricQuantitativeType == "KeepBelow" || newMetricQuantitativeType == "KeepBetween" || newMetricQuantitativeType == "Achieve" || newMetricQuantitativeType == "Reduce")
                                {
                                    <div class="metrics-input-field">
                                        <input type="number" @bind="newMetricMaxValue" placeholder="@GetMaxValuePlaceholder(newMetricQuantitativeType)" />
                                    </div>
                                }
                            </div>
                        }

                        <div class="form-actions" style="margin-top: var(--spacing-3);">
                            <button type="button" class="button tertiary" @onclick="CancelAddMetric">Cancelar</button>
                            <button type="button" class="button primary" @onclick="AddMetric">Salvar m√©trica</button>
                        </div>
                    </div>
                }

                @if (formMetrics.Any())
                {
                    <div class="metrics-list">
                        @for (var i = 0; i < formMetrics.Count; i++)
                        {
                            var index = i;
                            var metric = formMetrics[index];

                            @if (editingMetricIndex == index)
                            {
                                @* Inline edit form ‚Äî same visual as Missions edit modal *@
                                <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                    <div class="metrics-form-container">
                                        <div class="form-row">
                                            <label>Nome da m√©trica</label>
                                            <input type="text" class="input" @bind="editMetricName" placeholder="Nome da m√©trica" />
                                        </div>

                                        <div class="metrics-form-selectors">
                                            <div class="metrics-selector-btn">
                                                <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                                                </svg>
                                                <select value="@editMetricType" @onchange="OnEditMetricTypeChanged">
                                                    <option value="">Tipo de m√©trica</option>
                                                    <option value="Quantitative">Quantitativa</option>
                                                    <option value="Qualitative">Qualitativa</option>
                                                </select>
                                                <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                </svg>
                                            </div>

                                            @if (editMetricType == "Quantitative")
                                            {
                                                <div class="metrics-selector-btn">
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                                                    </svg>
                                                    <select @bind="editMetricQuantitativeType">
                                                        <option value="">Modo de mensura√ß√£o</option>
                                                        <option value="KeepAbove">‚Üë Manter acima</option>
                                                        <option value="KeepBelow">‚Üì Manter abaixo</option>
                                                        <option value="KeepBetween">‚Üï Manter entre</option>
                                                        <option value="Achieve">‚Üí Atingir</option>
                                                        <option value="Reduce">‚Üò Reduzir</option>
                                                    </select>
                                                    <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                                                    </svg>
                                                </div>
                                            }
                                        </div>

                                        @if (editMetricType == "Qualitative")
                                        {
                                            <div class="form-row">
                                                <label>Descri√ß√£o do objetivo</label>
                                                <input type="text" class="input" @bind="editMetricTargetText" placeholder="Descreva o objetivo qualitativo desta m√©trica" />
                                            </div>
                                        }

                                        @if (editMetricType == "Quantitative" && !string.IsNullOrEmpty(editMetricQuantitativeType))
                                        {
                                            <div class="metrics-form-inputs">
                                                <div class="metrics-input-field">
                                                    <select @bind="editMetricUnit">
                                                        <option value="">Unidade de medida</option>
                                                        <option value="Integer">Inteiro</option>
                                                        <option value="Decimal">Decimal</option>
                                                        <option value="Percentage">Percentual</option>
                                                        <option value="Hours">Horas</option>
                                                        <option value="Points">Pontos</option>
                                                    </select>
                                                </div>

                                                @if (editMetricQuantitativeType == "KeepAbove" || editMetricQuantitativeType == "KeepBetween")
                                                {
                                                    <div class="metrics-input-field">
                                                        <input type="number" @bind="editMetricMinValue" placeholder="Valor m√≠nimo" />
                                                    </div>
                                                }

                                                @if (editMetricQuantitativeType == "KeepBelow" || editMetricQuantitativeType == "KeepBetween" || editMetricQuantitativeType == "Achieve" || editMetricQuantitativeType == "Reduce")
                                                {
                                                    <div class="metrics-input-field">
                                                        <input type="number" @bind="editMetricMaxValue" placeholder="@GetMaxValuePlaceholder(editMetricQuantitativeType)" />
                                                    </div>
                                                }
                                            </div>
                                        }

                                        <div class="form-actions" style="margin-top: var(--spacing-3);">
                                            <button type="button" class="button tertiary" @onclick="CancelEditMetric">Cancelar</button>
                                            <button type="button" class="button primary" @onclick="SaveEditMetric">Salvar m√©trica</button>
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="metric-item">
                                    <div class="metric-info">
                                        <div class="metric-name">@metric.Name</div>
                                        <div class="metric-details">@GetMetricDescription(metric)</div>
                                    </div>
                                    <CrudRowActions
                                        EditTitle="Editar m√©trica"
                                        OnEdit="@(() => StartEditMetric(index))"
                                        IsDeleteConfirming="false"
                                        DeleteTitle="Excluir m√©trica"
                                        OnDelete="@(() => RemoveMetric(metric))" />
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    <button class="button primary" type="button" @onclick="SaveTemplate">@(isEditing ? "Salvar altera√ß√µes" : "Criar")</button>
                </div>
            </div>
        </Footer>
    </Modal>
}

@code {
    private PagedResult<MissionTemplate>? templates;
    private string? search;
    private bool showFilterPanel;
    private bool isModalOpen;
    private bool isEditing;
    private Guid? editingTemplateId;

    // Form fields
    private string formName = string.Empty;
    private string? formDescription;
    private string? formMissionNamePattern;
    private string? formMissionDescriptionPattern;
    private string formIsActive = "true";
    private List<MissionTemplateMetricDto> formMetrics = new();

    // Chip toggle states
    private bool showPatternFields;
    private bool showStatusSelector;

    // Metric form fields (add new)
    private bool showMetricForm;
    private string newMetricName = string.Empty;
    private string? newMetricType;
    private string? newMetricQuantitativeType;
    private string? newMetricUnit;
    private decimal? newMetricMinValue;
    private decimal? newMetricMaxValue;
    private string? newMetricTargetText;

    // Metric edit fields
    private int? editingMetricIndex;
    private string editMetricName = string.Empty;
    private string? editMetricType;
    private string? editMetricQuantitativeType;
    private string? editMetricUnit;
    private decimal? editMetricMinValue;
    private decimal? editMetricMaxValue;
    private string? editMetricTargetText;

    // Delete state
    private Guid? deletingTemplateId;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadTemplates();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar templates por troca de organiza√ß√£o: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar templates", "N√£o foi poss√≠vel atualizar os dados da organiza√ß√£o selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadTemplates()
    {
        templates = await Api.GetMissionTemplatesAsync(search, 1, 20) ?? new PagedResult<MissionTemplate>();
    }

    // Filter methods
    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;
    private bool HasActiveFilters() => !string.IsNullOrEmpty(search);

    private async Task ClearFilters()
    {
        search = null;
        await LoadTemplates();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadTemplates();
    }

    // Create/Edit modal
    private void OpenCreateModal()
    {
        isEditing = false;
        editingTemplateId = null;
        formName = string.Empty;
        formDescription = null;
        formMissionNamePattern = null;
        formMissionDescriptionPattern = null;
        formIsActive = "true";
        formMetrics = new();
        showMetricForm = false;
        showPatternFields = false;
        showStatusSelector = false;
        ClearMetricForm();
        isModalOpen = true;
    }

    private void OpenEditModal(MissionTemplate template)
    {
        isEditing = true;
        editingTemplateId = template.Id;
        formName = template.Name;
        formDescription = template.Description;
        formMissionNamePattern = template.MissionNamePattern;
        formMissionDescriptionPattern = template.MissionDescriptionPattern;
        formIsActive = template.IsActive.ToString().ToLower();
        formMetrics = template.Metrics.Select(m => new MissionTemplateMetricDto
        {
            Name = m.Name,
            Type = m.Type,
            OrderIndex = m.OrderIndex,
            QuantitativeType = m.QuantitativeType,
            MinValue = m.MinValue,
            MaxValue = m.MaxValue,
            Unit = m.Unit,
            TargetText = m.TargetText
        }).ToList();
        showMetricForm = false;
        showPatternFields = false;
        showStatusSelector = false;
        ClearMetricForm();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
        isEditing = false;
        editingTemplateId = null;
    }

    private async Task SaveTemplate()
    {
        if (string.IsNullOrWhiteSpace(formName))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome do template.");
            return;
        }

        if (isEditing && editingTemplateId.HasValue)
        {
            await UpdateTemplate();
        }
        else
        {
            await CreateTemplate();
        }
    }

    private async Task CreateTemplate()
    {
        var request = new CreateMissionTemplateRequest
        {
            Name = formName,
            Description = formDescription,
            MissionNamePattern = formMissionNamePattern,
            MissionDescriptionPattern = formMissionDescriptionPattern,
            Metrics = formMetrics
        };

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.CreateMissionTemplateAsync(request);
                await LoadTemplates();
                ToastService.ShowSuccess("Template criado com sucesso!", $"O template '{formName}' foi criado.");
                CloseModal();
            },
            ToastService,
            "Erro ao criar template",
            "N√£o foi poss√≠vel criar o template. Verifique os dados e tente novamente.",
            operationContext: "cria√ß√£o de template",
            unexpectedErrorMessage: "N√£o foi poss√≠vel criar o template. Tente novamente.");
    }

    private async Task UpdateTemplate()
    {
        if (!editingTemplateId.HasValue) return;

        var request = new UpdateMissionTemplateRequest
        {
            Name = formName,
            Description = formDescription,
            MissionNamePattern = formMissionNamePattern,
            MissionDescriptionPattern = formMissionDescriptionPattern,
            IsActive = formIsActive == "true",
            Metrics = formMetrics
        };

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.UpdateMissionTemplateAsync(editingTemplateId.Value, request);
                await LoadTemplates();
                ToastService.ShowSuccess("Template atualizado", "As altera√ß√µes foram salvas com sucesso.");
                CloseModal();
            },
            ToastService,
            "Erro ao atualizar template",
            "N√£o foi poss√≠vel atualizar o template. Verifique os dados e tente novamente.",
            operationContext: "atualiza√ß√£o de template",
            unexpectedErrorMessage: "N√£o foi poss√≠vel atualizar o template. Tente novamente.");
    }

    // Metric form methods
    private void CancelAddMetric()
    {
        showMetricForm = false;
        ClearMetricForm();
    }

    private void AddMetric()
    {
        if (string.IsNullOrWhiteSpace(newMetricName) || string.IsNullOrEmpty(newMetricType))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome e tipo da m√©trica.");
            return;
        }

        var metric = new MissionTemplateMetricDto
        {
            Name = newMetricName,
            Type = Enum.Parse<MetricType>(newMetricType),
            OrderIndex = formMetrics.Count,
            TargetText = newMetricTargetText
        };

        if (newMetricType == "Quantitative")
        {
            if (!string.IsNullOrEmpty(newMetricQuantitativeType))
                metric.QuantitativeType = Enum.Parse<QuantitativeMetricType>(newMetricQuantitativeType);
            if (!string.IsNullOrEmpty(newMetricUnit))
                metric.Unit = Enum.Parse<MetricUnit>(newMetricUnit);
            metric.MinValue = newMetricMinValue;
            metric.MaxValue = newMetricMaxValue;
        }

        formMetrics.Add(metric);
        showMetricForm = false;
        ClearMetricForm();
    }

    private void RemoveMetric(MissionTemplateMetricDto metric)
    {
        formMetrics.Remove(metric);
        // Reindex
        for (int i = 0; i < formMetrics.Count; i++)
            formMetrics[i].OrderIndex = i;
    }

    private void ClearMetricForm()
    {
        newMetricName = string.Empty;
        newMetricType = null;
        newMetricQuantitativeType = null;
        newMetricUnit = null;
        newMetricMinValue = null;
        newMetricMaxValue = null;
        newMetricTargetText = null;
    }

    private static string GetMetricDescription(MissionTemplateMetricDto metric)
    {
        if (metric.Type == MetricType.Qualitative)
            return $"Qualitativa ‚Äî {metric.TargetText}";

        var parts = new List<string> { "Quantitativa" };
        if (metric.QuantitativeType.HasValue)
            parts.Add(MissionMetricDisplayHelper.GetQuantitativeTypeLabel(metric.QuantitativeType.Value));
        if (metric.Unit.HasValue)
            parts.Add(MissionMetricDisplayHelper.GetUnitLabel(metric.Unit.Value));
        if (metric.MinValue.HasValue)
            parts.Add($"Min: {metric.MinValue}");
        if (metric.MaxValue.HasValue)
            parts.Add($"Max: {metric.MaxValue}");
        return string.Join(" ‚Äî ", parts);
    }

    private static string GetMaxValuePlaceholder(string? quantitativeType) => quantitativeType switch
    {
        "KeepBelow" or "KeepBetween" => "Valor m√°ximo",
        "Achieve" => "Valor alvo",
        "Reduce" => "Valor alvo",
        _ => "Valor m√°ximo"
    };

    // Metric edit methods
    private void StartEditMetric(int index)
    {
        var metric = formMetrics[index];
        editingMetricIndex = index;
        editMetricName = metric.Name;
        editMetricType = metric.Type.ToString();
        editMetricQuantitativeType = metric.QuantitativeType?.ToString();
        editMetricUnit = metric.Unit?.ToString();
        editMetricMinValue = metric.MinValue;
        editMetricMaxValue = metric.MaxValue;
        editMetricTargetText = metric.TargetText;
    }

    private void CancelEditMetric()
    {
        editingMetricIndex = null;
        editMetricName = string.Empty;
        editMetricType = null;
        editMetricQuantitativeType = null;
        editMetricUnit = null;
        editMetricMinValue = null;
        editMetricMaxValue = null;
        editMetricTargetText = null;
    }

    private void SaveEditMetric()
    {
        if (editingMetricIndex is null) return;

        if (string.IsNullOrWhiteSpace(editMetricName) || string.IsNullOrEmpty(editMetricType))
        {
            ToastService.ShowError("Erro de valida√ß√£o", "Informe o nome e tipo da m√©trica.");
            return;
        }

        var metric = formMetrics[editingMetricIndex.Value];
        metric.Name = editMetricName;
        metric.Type = Enum.Parse<MetricType>(editMetricType);
        metric.TargetText = editMetricTargetText;

        if (editMetricType == "Quantitative")
        {
            metric.QuantitativeType = !string.IsNullOrEmpty(editMetricQuantitativeType)
                ? Enum.Parse<QuantitativeMetricType>(editMetricQuantitativeType) : null;
            metric.Unit = !string.IsNullOrEmpty(editMetricUnit)
                ? Enum.Parse<MetricUnit>(editMetricUnit) : null;
            metric.MinValue = editMetricMinValue;
            metric.MaxValue = editMetricMaxValue;
        }
        else
        {
            metric.QuantitativeType = null;
            metric.Unit = null;
            metric.MinValue = null;
            metric.MaxValue = null;
        }

        CancelEditMetric();
    }

    private void OnEditMetricTypeChanged(ChangeEventArgs e)
    {
        editMetricType = e.Value?.ToString();
        editMetricTargetText = null;
        editMetricMinValue = null;
        editMetricMaxValue = null;
        editMetricQuantitativeType = null;
        editMetricUnit = null;
    }

    // Delete methods
    private void HandleDeleteClick(Guid templateId)
    {
        if (deletingTemplateId == templateId)
        {
            _ = DeleteTemplate(templateId);
        }
        else
        {
            deletingTemplateId = templateId;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingTemplateId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteTemplate(Guid templateId)
    {
        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionTemplateAsync(templateId);
                    ToastService.ShowSuccess("Template exclu√≠do", "O template foi removido com sucesso.");
                    await LoadTemplates();
                },
                ToastService,
                "Erro ao excluir",
                "N√£o foi poss√≠vel excluir o template. Tente novamente.",
                operationContext: "exclus√£o de template",
                unexpectedErrorMessage: "N√£o foi poss√≠vel excluir o template. Tente novamente.");
        }
        finally
        {
            deletingTemplateId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
