@page "/mission-templates"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<ManagementMenu />

<ManagementPageHeader
    Kicker="Configurações"
    Title="Templates de Missão"
    Subtitle="Gerencie templates de missão da organização."
    PrimaryActionText="Novo template"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros *@
<div class="workspaces-filter-bar">
    <div class="workspaces-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expansível *@
@if (showFilterPanel)
{
    <div class="workspaces-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar templates..." />
            </div>
        </div>
    </div>
}

@* Lista de Templates *@
<div class="workspaces-table-container">
    <PagedTableSection
        IsLoading="@(templates is null)"
        IsEmpty="@(templates is not null && templates.Items.Count == 0)"
        Total="@(templates?.Total ?? 0)"
        EmptyText="Nenhum template encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Descrição</th>
                    <th style="text-align: center;">Métricas</th>
                    <th style="text-align: center;">Status</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var template in templates!.Items)
                {
                    var isDeleting = deletingTemplateId == template.Id;
                    <tr>
                        <td>@template.Name</td>
                        <td>@(template.Description ?? "—")</td>
                        <td style="text-align: center;">@template.Metrics.Count</td>
                        <td style="text-align: center;">
                            <span class="badge @(template.IsActive ? "badge-active" : "badge-inactive")">
                                @(template.IsActive ? "Ativo" : "Inativo")
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar template"
                                OnEdit="@(() => OpenEditModal(template))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir template"
                                OnDelete="@(() => HandleDeleteClick(template.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="@(isEditing ? "Editar template" : "Criar template")" Size="lg" OnClose="CloseModal">
        <ChildContent>
            @* Template Info *@
            <div class="mission-header">
                <input type="text" class="mission-title-input" @bind="formName" placeholder="Nome do template" />
                <input type="text" class="mission-subtitle-input" @bind="formDescription" placeholder="Adicionar breve descrição" />
            </div>

            @if (isEditing)
            {
                <div class="form-row">
                    <label>Status</label>
                    <select class="input" @bind="formIsActive">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>
            }

            @* Mission Patterns Section *@
            <div class="mission-metrics-section">
                <div class="mission-metrics-section-header">
                    <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="14 2 14 8 20 8" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="16" y1="13" x2="8" y2="13" stroke-linecap="round"/>
                        <line x1="16" y1="17" x2="8" y2="17" stroke-linecap="round"/>
                    </svg>
                    <h3>Padrões da missão</h3>
                </div>

                <div class="form-row">
                    <label>Padrão de nome da missão</label>
                    <input type="text" class="input" @bind="formMissionNamePattern" placeholder="Ex: OKR — " />
                </div>
                <div class="form-row">
                    <label>Padrão de descrição da missão</label>
                    <input type="text" class="input" @bind="formMissionDescriptionPattern" placeholder="Ex: Missão seguindo framework OKR" />
                </div>
            </div>

            @* Metrics Section *@
            <div class="mission-metrics-section">
                <div class="mission-metrics-section-header">
                    <svg class="mission-metrics-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18 9l-5 5-4-4-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h3>Métricas da missão</h3>
                </div>

                <MetricFormFields Model="newMetricModel" OnSave="AddMetric" OnCancel="CancelAddMetric" ShowAddButton="true" />

                @if (formMetrics.Any())
                {
                    <div class="metrics-list">
                        @for (var i = 0; i < formMetrics.Count; i++)
                        {
                            var index = i;
                            var metric = formMetrics[index];

                            @if (editingMetricIndex == index)
                            {
                                @* Inline edit form — same visual as Missions edit modal *@
                                <div class="metric-item" style="flex-direction: column; align-items: stretch;">
                                    <MetricFormFields Model="editMetricModel" OnSave="SaveEditMetric" OnCancel="CancelEditMetric" />
                                </div>
                            }
                            else
                            {
                                <div class="metric-item">
                                    <div class="metric-info">
                                        <div class="metric-name">@metric.Name</div>
                                        <div class="metric-details">@GetMetricDescription(metric)</div>
                                    </div>
                                    <CrudRowActions
                                        EditTitle="Editar métrica"
                                        OnEdit="@(() => StartEditMetric(index))"
                                        IsDeleteConfirming="false"
                                        DeleteTitle="Excluir métrica"
                                        OnDelete="@(() => RemoveMetric(metric))" />
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </ChildContent>
        <Footer>
            <div class="modal-footer-actions">
                <div class="modal-footer-secondary">
                    <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                </div>
                <div class="modal-footer-primary">
                    <button class="button primary" type="button" @onclick="SaveTemplate">@(isEditing ? "Salvar alterações" : "Criar")</button>
                </div>
            </div>
        </Footer>
    </Modal>
}

@code {
    private PagedResult<MissionTemplate>? templates;
    private string? search;
    private bool showFilterPanel;
    private bool isModalOpen;
    private bool isEditing;
    private Guid? editingTemplateId;

    // Form fields
    private string formName = string.Empty;
    private string? formDescription;
    private string? formMissionNamePattern;
    private string? formMissionDescriptionPattern;
    private string formIsActive = "true";
    private List<MissionTemplateMetricDto> formMetrics = new();

    // Metric form fields (add new)
    private MetricFormFields.MetricFormModel newMetricModel = new();

    // Metric edit fields
    private int? editingMetricIndex;
    private MetricFormFields.MetricFormModel editMetricModel = new();

    // Delete state
    private Guid? deletingTemplateId;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadTemplates();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar templates por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar templates", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadTemplates()
    {
        templates = await Api.GetMissionTemplatesAsync(search, 1, 20) ?? new PagedResult<MissionTemplate>();
    }

    // Filter methods
    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;
    private bool HasActiveFilters() => !string.IsNullOrEmpty(search);

    private async Task ClearFilters()
    {
        search = null;
        await LoadTemplates();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadTemplates();
    }

    // Create/Edit modal
    private void OpenCreateModal()
    {
        isEditing = false;
        editingTemplateId = null;
        formName = string.Empty;
        formDescription = null;
        formMissionNamePattern = null;
        formMissionDescriptionPattern = null;
        formIsActive = "true";
        formMetrics = new();
        newMetricModel.Clear();
        isModalOpen = true;
    }

    private void OpenEditModal(MissionTemplate template)
    {
        isEditing = true;
        editingTemplateId = template.Id;
        formName = template.Name;
        formDescription = template.Description;
        formMissionNamePattern = template.MissionNamePattern;
        formMissionDescriptionPattern = template.MissionDescriptionPattern;
        formIsActive = template.IsActive.ToString().ToLower();
        formMetrics = template.Metrics.Select(m => new MissionTemplateMetricDto
        {
            Name = m.Name,
            Type = m.Type,
            OrderIndex = m.OrderIndex,
            QuantitativeType = m.QuantitativeType,
            MinValue = m.MinValue,
            MaxValue = m.MaxValue,
            Unit = m.Unit,
            TargetText = m.TargetText
        }).ToList();
        newMetricModel.Clear();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
        isEditing = false;
        editingTemplateId = null;
    }

    private async Task SaveTemplate()
    {
        if (string.IsNullOrWhiteSpace(formName))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome do template.");
            return;
        }

        if (isEditing && editingTemplateId.HasValue)
        {
            await UpdateTemplate();
        }
        else
        {
            await CreateTemplate();
        }
    }

    private async Task CreateTemplate()
    {
        var request = new CreateMissionTemplateRequest
        {
            Name = formName,
            Description = formDescription,
            MissionNamePattern = formMissionNamePattern,
            MissionDescriptionPattern = formMissionDescriptionPattern,
            Metrics = formMetrics
        };

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.CreateMissionTemplateAsync(request);
                await LoadTemplates();
                ToastService.ShowSuccess("Template criado com sucesso!", $"O template '{formName}' foi criado.");
                CloseModal();
            },
            ToastService,
            "Erro ao criar template",
            "Não foi possível criar o template. Verifique os dados e tente novamente.",
            operationContext: "criação de template",
            unexpectedErrorMessage: "Não foi possível criar o template. Tente novamente.");
    }

    private async Task UpdateTemplate()
    {
        if (!editingTemplateId.HasValue) return;

        var request = new UpdateMissionTemplateRequest
        {
            Name = formName,
            Description = formDescription,
            MissionNamePattern = formMissionNamePattern,
            MissionDescriptionPattern = formMissionDescriptionPattern,
            IsActive = formIsActive == "true",
            Metrics = formMetrics
        };

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.UpdateMissionTemplateAsync(editingTemplateId.Value, request);
                await LoadTemplates();
                ToastService.ShowSuccess("Template atualizado", "As alterações foram salvas com sucesso.");
                CloseModal();
            },
            ToastService,
            "Erro ao atualizar template",
            "Não foi possível atualizar o template. Verifique os dados e tente novamente.",
            operationContext: "atualização de template",
            unexpectedErrorMessage: "Não foi possível atualizar o template. Tente novamente.");
    }

    // Metric form methods
    private void CancelAddMetric()
    {
        newMetricModel.Clear();
    }

    private void AddMetric()
    {
        if (string.IsNullOrWhiteSpace(newMetricModel.Name) || string.IsNullOrEmpty(newMetricModel.TypeValue))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome e tipo da métrica.");
            return;
        }

        var metric = new MissionTemplateMetricDto
        {
            Name = newMetricModel.Name,
            Type = Enum.Parse<MetricType>(newMetricModel.TypeValue),
            OrderIndex = formMetrics.Count,
            TargetText = newMetricModel.TargetText
        };

        if (newMetricModel.TypeValue == "Quantitative")
        {
            if (!string.IsNullOrEmpty(newMetricModel.QuantitativeTypeValue))
                metric.QuantitativeType = Enum.Parse<QuantitativeMetricType>(newMetricModel.QuantitativeTypeValue);
            if (!string.IsNullOrEmpty(newMetricModel.UnitValue))
                metric.Unit = Enum.Parse<MetricUnit>(newMetricModel.UnitValue);
            metric.MinValue = newMetricModel.MinValue;
            metric.MaxValue = newMetricModel.MaxValue;
        }

        formMetrics.Add(metric);
        newMetricModel.Clear();
    }

    private void RemoveMetric(MissionTemplateMetricDto metric)
    {
        formMetrics.Remove(metric);
        // Reindex
        for (int i = 0; i < formMetrics.Count; i++)
            formMetrics[i].OrderIndex = i;
    }

    private static string GetMetricDescription(MissionTemplateMetricDto metric)
    {
        if (metric.Type == MetricType.Qualitative)
            return $"Qualitativa — {metric.TargetText}";

        var parts = new List<string> { "Quantitativa" };
        if (metric.QuantitativeType.HasValue)
            parts.Add(MissionMetricDisplayHelper.GetQuantitativeTypeLabel(metric.QuantitativeType.Value));
        if (metric.Unit.HasValue)
            parts.Add(MissionMetricDisplayHelper.GetUnitLabel(metric.Unit.Value));
        if (metric.MinValue.HasValue)
            parts.Add($"Min: {metric.MinValue}");
        if (metric.MaxValue.HasValue)
            parts.Add($"Max: {metric.MaxValue}");
        return string.Join(" — ", parts);
    }

    // Metric edit methods
    private void StartEditMetric(int index)
    {
        var metric = formMetrics[index];
        editingMetricIndex = index;
        editMetricModel = new MetricFormFields.MetricFormModel
        {
            Name = metric.Name,
            TypeValue = metric.Type.ToString(),
            QuantitativeTypeValue = metric.QuantitativeType?.ToString(),
            UnitValue = metric.Unit?.ToString(),
            MinValue = metric.MinValue,
            MaxValue = metric.MaxValue,
            TargetText = metric.TargetText
        };
    }

    private void CancelEditMetric()
    {
        editingMetricIndex = null;
        editMetricModel.Clear();
    }

    private void SaveEditMetric()
    {
        if (editingMetricIndex is null) return;

        if (string.IsNullOrWhiteSpace(editMetricModel.Name) || string.IsNullOrEmpty(editMetricModel.TypeValue))
        {
            ToastService.ShowError("Erro de validação", "Informe o nome e tipo da métrica.");
            return;
        }

        var metric = formMetrics[editingMetricIndex.Value];
        metric.Name = editMetricModel.Name;
        metric.Type = Enum.Parse<MetricType>(editMetricModel.TypeValue);
        metric.TargetText = editMetricModel.TargetText;

        if (editMetricModel.TypeValue == "Quantitative")
        {
            metric.QuantitativeType = !string.IsNullOrEmpty(editMetricModel.QuantitativeTypeValue)
                ? Enum.Parse<QuantitativeMetricType>(editMetricModel.QuantitativeTypeValue) : null;
            metric.Unit = !string.IsNullOrEmpty(editMetricModel.UnitValue)
                ? Enum.Parse<MetricUnit>(editMetricModel.UnitValue) : null;
            metric.MinValue = editMetricModel.MinValue;
            metric.MaxValue = editMetricModel.MaxValue;
        }
        else
        {
            metric.QuantitativeType = null;
            metric.Unit = null;
            metric.MinValue = null;
            metric.MaxValue = null;
        }

        CancelEditMetric();
    }

    // Delete methods
    private void HandleDeleteClick(Guid templateId)
    {
        if (deletingTemplateId == templateId)
        {
            _ = DeleteTemplate(templateId);
        }
        else
        {
            deletingTemplateId = templateId;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingTemplateId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteTemplate(Guid templateId)
    {
        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.DeleteMissionTemplateAsync(templateId);
                    ToastService.ShowSuccess("Template excluído", "O template foi removido com sucesso.");
                    await LoadTemplates();
                },
                ToastService,
                "Erro ao excluir",
                "Não foi possível excluir o template. Tente novamente.",
                operationContext: "exclusão de template",
                unexpectedErrorMessage: "Não foi possível excluir o template. Tente novamente.");
        }
        finally
        {
            deletingTemplateId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
