@page "/"
@page "/dashboard"
@implements IDisposable
@inject ApiClient Api
@inject AuthState AuthState
@inject OrganizationContext OrgContext
@inject NavigationManager Navigation

@if (dashboard is null)
{
    <p class="muted">Carregando...</p>
}
else
{
    <div class="dashboard-grid">
        @* Left Column: Team Health *@
        <div class="dashboard-section">
            <h2 class="dashboard-section-title">Saúde do time</h2>

            @* Leader + Team Members *@
            <div class="dashboard-leader-row">
                <div class="dashboard-leader-col">
                    <div class="dashboard-section-label">Gestor(a)</div>
                    <div class="dashboard-leader-info">
                        @if (dashboard.TeamHealth.Leader is not null)
                        {
                            <div class="dashboard-avatar">@dashboard.TeamHealth.Leader.Initials</div>
                            <div>
                                <div class="dashboard-leader-name">@dashboard.TeamHealth.Leader.FullName</div>
                                <div class="dashboard-leader-role">@dashboard.TeamHealth.Leader.TeamName</div>
                            </div>
                        }
                        else
                        {
                            <div class="dashboard-avatar">?</div>
                            <div>
                                <div class="dashboard-leader-name">Sem gestor definido</div>
                                <div class="dashboard-leader-role">-</div>
                            </div>
                        }
                    </div>
                </div>

                @if (dashboard.TeamHealth.TeamMembers.Count > 0)
                {
                    <div class="dashboard-team-col">
                        <div class="dashboard-section-label">Time</div>
                        <div class="avatar-stack">
                            @foreach (var member in dashboard.TeamHealth.TeamMembers.Take(5))
                            {
                                <div class="dashboard-avatar-sm" title="@member.FullName">@member.Initials</div>
                            }
                            @if (dashboard.TeamHealth.TeamMembers.Count > 5)
                            {
                                <div class="avatar-stack-more">+@(dashboard.TeamHealth.TeamMembers.Count - 5)</div>
                            }
                        </div>
                    </div>
                }
            </div>

            @* Engagement *@
            <div>
                <h3 class="dashboard-section-title" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-3);">Engajamento</h3>
                <div class="engagement-container">
                    <div class="engagement-score-box @dashboard.TeamHealth.Engagement.Level">
                        <div class="engagement-score-value">@dashboard.TeamHealth.Engagement.Score</div>
                        <div class="engagement-score-label">de 100</div>
                    </div>
                    <div class="engagement-tip">
                        <svg class="engagement-tip-icon" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M176,232a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,232Zm40-128a87.55,87.55,0,0,1-33.64,69.21A16.24,16.24,0,0,0,176,186v6a16,16,0,0,1-16,16H96a16,16,0,0,1-16-16v-6a16,16,0,0,0-6.23-12.66A87.59,87.59,0,0,1,40,104.5C39.74,56.83,78.26,17.14,125.88,16A88,88,0,0,1,216,104Z"/>
                        </svg>
                        <div class="engagement-tip-text">@dashboard.TeamHealth.Engagement.Tip</div>
                    </div>
                </div>
            </div>

            @* Indicators *@
            <div>
                <h3 class="dashboard-section-title" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-3);">Indicadores</h3>
                <div class="indicators-grid">
                    @{ var indicators = new (string Label, IndicatorDto Data)[]
                        {
                            ("Acesso semanal", dashboard.TeamHealth.Indicators.WeeklyAccess),
                            ("Missões atualizadas", dashboard.TeamHealth.Indicators.MissionsUpdated),
                            ("Formulários respondidos", dashboard.TeamHealth.Indicators.FormsResponded)
                        };
                    }
                    @foreach (var ind in indicators)
                    {
                        <div class="indicator-card @(ind.Data.IsPlaceholder ? "placeholder" : "")">
                            <div class="indicator-value">@(ind.Data.Percentage)%</div>
                            <div class="indicator-label">@ind.Label</div>
                            @if (!ind.Data.IsPlaceholder)
                            {
                                var deltaClass = ind.Data.DeltaPercentage > 0 ? "positive"
                                    : ind.Data.DeltaPercentage < 0 ? "negative"
                                    : "neutral";
                                <div class="indicator-delta @deltaClass">
                                    @if (ind.Data.DeltaPercentage > 0)
                                    {
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 256 256">
                                            <path d="M205.66,117.66a8,8,0,0,1-11.32,0L136,59.31V216a8,8,0,0,1-16,0V59.31L61.66,117.66a8,8,0,0,1-11.32-11.32l80-80a8,8,0,0,1,11.32,0l80,80A8,8,0,0,1,205.66,117.66Z"/>
                                        </svg>
                                    }
                                    else if (ind.Data.DeltaPercentage < 0)
                                    {
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 256 256">
                                            <path d="M205.66,149.66l-80,80a8,8,0,0,1-11.32,0l-80-80a8,8,0,0,1,11.32-11.32L104,196.69V40a8,8,0,0,1,16,0V196.69l58.34-58.35a8,8,0,0,1,11.32,11.32Z"/>
                                        </svg>
                                    }
                                    <span>@(ind.Data.DeltaPercentage > 0 ? "+" : "")@(ind.Data.DeltaPercentage)%</span>
                                </div>
                            }
                            else
                            {
                                <div class="indicator-delta neutral">Em breve</div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Right Column: Pending Tasks *@
        <div class="dashboard-section">
            <h2 class="dashboard-section-title">Minhas tarefas</h2>

            @if (dashboard.PendingTasks.Count == 0)
            {
                <div class="task-list-empty">
                    <svg width="32" height="32" fill="currentColor" viewBox="0 0 256 256" style="margin-bottom: 8px; opacity: 0.4;">
                        <path d="M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"/>
                    </svg>
                    <div>Nenhuma tarefa pendente. Tudo em dia!</div>
                </div>
            }
            else
            {
                <div class="task-list">
                    @foreach (var task in dashboard.PendingTasks)
                    {
                        <a class="task-card" href="@task.NavigateUrl">
                            <div class="task-card-icon">
                                @if (task.TaskType == "mission_checkin")
                                {
                                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 256 256">
                                        <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216ZM172.24,99.76a6,6,0,0,1,0,8.48l-48,48a6,6,0,0,1-8.48,0l-24-24a6,6,0,0,1,8.48-8.48L120,143.51l43.76-43.75A6,6,0,0,1,172.24,99.76Z"/>
                                    </svg>
                                }
                            </div>
                            <div class="task-card-content">
                                <div class="task-card-title">@task.Title</div>
                                <div class="task-card-description">@task.Description</div>
                            </div>
                            <div class="task-card-arrow">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"/>
                                </svg>
                            </div>
                        </a>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    private MyDashboardResponse? dashboard;

    protected override async Task OnInitializedAsync()
    {
        await AuthState.EnsureInitializedAsync();
        OrgContext.OnOrganizationChanged += OnOrganizationChanged;
        await LoadDashboard();
    }

    private async Task LoadDashboard()
    {
        dashboard = await Api.GetMyDashboardAsync() ?? new MyDashboardResponse();
    }

    private void OnOrganizationChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await LoadDashboard();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= OnOrganizationChanged;
    }
}
