@page "/collaborators"
@inject ApiClient Api
@inject ToastService ToastService

<ManagementMenu />

<div class="page-header">
    <div>
        <div class="page-kicker">Gestão</div>
        <h1>Colaboradores</h1>
        <p class="page-subtitle">Cadastre colaboradores vinculados às equipes.</p>
    </div>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Novo colaborador
    </button>
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Equipe</label>
            <select class="input" @bind="selectedTeamId" @bind:after="LoadCollaborators">
                <option value="">Todas</option>
                @foreach (var team in teams)
                {
                    <option value="@team.Id">@team.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadCollaborators">Atualizar</button>
        </div>
    </div>

    @if (collaborators is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (collaborators.Items.Count == 0)
    {
        <p class="muted">Nenhum colaborador encontrado.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Perfil</th>
                    <th>Líder</th>
                    <th>Equipe</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var collaborator in collaborators.Items)
                {
                    var team = teams.FirstOrDefault(t => t.Id == collaborator.TeamId);
                    var leader = collaborator.LeaderId.HasValue
                        ? allCollaborators.FirstOrDefault(c => c.Id == collaborator.LeaderId.Value)
                        : null;
                    <tr>
                        <td>@collaborator.FullName</td>
                        <td>@collaborator.Email</td>
                        <td>@GetRoleLabel(collaborator.Role)</td>
                        <td>@(leader?.FullName ?? "—")</td>
                        <td>@(team?.Name ?? "—")</td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @collaborators.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar colaborador" OnClose="CloseModal">
        <EditForm Model="@newCollaborator" OnValidSubmit="CreateCollaborator">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Equipe</label>
                <select class="input" @bind="createTeamId">
                    <option value="">Selecione</option>
                    @foreach (var team in teams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Nome completo</label>
                <InputText class="input" @bind-Value="newCollaborator.FullName" />
            </div>
            <div class="form-row">
                <label>E-mail</label>
                <InputText class="input" @bind-Value="newCollaborator.Email" />
            </div>
            <div class="form-row">
                <label>Perfil</label>
                <InputSelect class="input" @bind-Value="newCollaborator.Role">
                    <option value="@CollaboratorRole.IndividualContributor">Contribuidor individual</option>
                    <option value="@CollaboratorRole.Leader">Lider</option>
                </InputSelect>
            </div>
            <div class="form-row">
                <label>Líder (opcional)</label>
                <select class="input" @bind="createLeaderId">
                    <option value="">Nenhum</option>
                    @foreach (var leader in leaders)
                    {
                        <option value="@leader.Id">@leader.FullName - @leader.TeamName</option>
                    }
                </select>
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@code {
    private CreateCollaboratorRequest newCollaborator = new();
    private List<Team> teams = new();
    private List<LeaderCollaboratorResponse> leaders = new();
    private List<Collaborator> allCollaborators = new();
    private PagedResult<Collaborator>? collaborators;
    private string? search;
    private string? selectedTeamId;
    private string? createTeamId;
    private string? createLeaderId;
    private bool isModalOpen = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTeams();
        await LoadLeaders();
        await LoadCollaborators();
        await LoadAllCollaborators();
    }

    private async Task LoadTeams()
    {
        var result = await Api.GetTeamsAsync(null, null, null, 1, 200);
        teams = result?.Items.ToList() ?? new List<Team>();
    }

    private async Task LoadLeaders()
    {
        leaders = await Api.GetLeadersAsync() ?? new List<LeaderCollaboratorResponse>();
    }

    private async Task LoadAllCollaborators()
    {
        var result = await Api.GetCollaboratorsAsync(null, null, 1, 1000);
        allCollaborators = result?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task LoadCollaborators()
    {
        var filterTeamId = Guid.TryParse(selectedTeamId, out var parsedTeamId)
            ? parsedTeamId
            : (Guid?)null;
        collaborators = await Api.GetCollaboratorsAsync(filterTeamId, search, 1, 20) ?? new PagedResult<Collaborator>();
    }

    private void OpenCreateModal()
    {
        newCollaborator = new CreateCollaboratorRequest();
        createTeamId = null;
        createLeaderId = null;
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateCollaborator()
    {
        if (!Guid.TryParse(createTeamId, out var teamId))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Selecione uma equipe.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newCollaborator.FullName))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Informe o nome completo.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newCollaborator.Email))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Informe o e-mail.");
            return;
        }

        newCollaborator.TeamId = teamId;
        newCollaborator.LeaderId = Guid.TryParse(createLeaderId, out var leaderId) ? leaderId : null;

        try
        {
            await Api.CreateCollaboratorAsync(newCollaborator);
            var createdCollaboratorName = newCollaborator.FullName;
            newCollaborator = new CreateCollaboratorRequest();
            createTeamId = null;
            createLeaderId = null;
            await LoadCollaborators();
            await LoadAllCollaborators();

            ToastService.ShowSuccess("Colaborador criado com sucesso!", $"O colaborador '{createdCollaboratorName}' foi criado.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao criar colaborador", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }

    private static string GetRoleLabel(CollaboratorRole role) => role switch
    {
        CollaboratorRole.Leader => "Lider",
        _ => "Contribuidor individual"
    };
}
