@page "/collaborators"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps
@implements IDisposable

<ManagementPageHeader
    Kicker="Pessoas"
    Title="Colaboradores"
    Subtitle="Gerencie colaboradores e vínculos de liderança."
    PrimaryActionText="Novo colaborador"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros Compacta *@
<div class="collaborators-filter-bar">
    <div class="collaborators-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M28 6H4L14 17.6V26L18 28V17.6L28 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Filtrar</span>
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(!string.IsNullOrEmpty(selectedTeamId) ? "active" : "")" @onclick="ToggleTeamDropdown">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M16 14C18.2091 14 20 12.2091 20 10C20 7.79086 18.2091 6 16 6C13.7909 6 12 7.79086 12 10C12 12.2091 13.7909 14 16 14Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 28V26C8 23.7909 9.79086 22 12 22H20C22.2091 22 24 23.7909 24 26V28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>@GetTeamFilterLabel()</span>
            </button>
            @if (showTeamDropdown)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Equipe</label>
                        <select class="input" @bind="selectedTeamId" @bind:after="ApplyTeamFilter">
                            <option value="">Todas</option>
                            @foreach (var team in teams)
                            {
                                <option value="@team.Id">@team.Name</option>
                            }
                        </select>
                    </div>
                </div>
            }
        </div>
        @if (HasActiveFilters())
        {
            <button class="filter-chip-clear" @onclick="ClearFilters">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 16L22 12M22 12L18 8M22 12L26 8M22 12L18 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 8L10 28H14L12 18L6 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Limpar filtro</span>
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expandido *@
@if (showFilterPanel)
{
    <div class="collaborators-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Equipe</label>
                <select class="input" @bind="selectedTeamId" @bind:after="LoadCollaborators">
                    <option value="">Todas</option>
                    @foreach (var team in teams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar colaboradores..." />
            </div>
        </div>
    </div>
}

<SummaryCards CssClass="collaborators-summary">
    <StatCard Value="@GetTotalCollaboratorsCount().ToString()" Label="Total de colaboradores" />
    <StatCard Value="@GetLeadersCount().ToString()" Label="Líderes" />
    <StatCard Value="@GetContributorsCount().ToString()" Label="Contribuidores individuais" />
</SummaryCards>

@* Lista de Colaboradores *@
<div class="collaborators-table-container">
    <PagedTableSection
        IsLoading="@(collaborators is null)"
        IsEmpty="@(collaborators is not null && collaborators.Items.Count == 0)"
        Total="@(collaborators?.Total ?? 0)"
        EmptyText="Nenhum colaborador encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Perfil</th>
                    <th>Líder</th>
                    <th class="th-actions">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var collaborator in collaborators!.Items)
                {
                    var leader = collaborator.LeaderId.HasValue
                        ? allCollaborators.FirstOrDefault(c => c.Id == collaborator.LeaderId.Value)
                        : null;
                    var isDeleting = deletingCollaboratorId == collaborator.Id;
                    <tr @onclick="() => OpenDetailsModal(collaborator)" style="cursor: pointer;">
                        <td>@collaborator.FullName</td>
                        <td>@collaborator.Email</td>
                        <td>@GetRoleLabel(collaborator.Role)</td>
                        <td>@(leader?.FullName ?? "—")</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar colaborador"
                                OnEdit="@(async () => await OpenEditModal(collaborator))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir colaborador"
                                OnDelete="@(() => HandleDeleteClick(collaborator.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="Criar colaborador" Size="lg" OnClose="CloseModal">
        <EditForm Model="@newCollaborator" OnValidSubmit="CreateCollaborator">
            <DataAnnotationsValidator />
            <CollaboratorFormFields
                @bind-FullName="newCollaborator.FullName"
                @bind-Email="newCollaborator.Email"
                @bind-Role="newCollaborator.Role"
                @bind-LeaderId="createLeaderId"
                Leaders="leaders"
                ShowTeams="true"
                AvailableTeams="availableTeamsForCreate"
                AssignedTeams="assignedTeamsForCreate"
                AssignedTeamsChanged="OnCreateTeamsChanged"
                OnAvailableTeamsSearch="SearchAvailableTeamsForCreateAsync" />
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar colaborador" Size="lg" OnClose="CloseEditModal">
        <EditForm Model="@editCollaborator" OnValidSubmit="UpdateCollaborator">
            <DataAnnotationsValidator />
            <CollaboratorFormFields
                @bind-FullName="editCollaborator.FullName"
                @bind-Email="editCollaborator.Email"
                @bind-Role="editCollaborator.Role"
                @bind-LeaderId="editLeaderId"
                Leaders="leaders"
                ExcludeLeaderId="selectedCollaborator?.Id"
                ShowTeams="true"
                AvailableTeams="availableTeamsForEdit"
                AssignedTeams="assignedTeamsForEdit"
                AssignedTeamsChanged="OnTeamsChanged"
                OnAvailableTeamsSearch="SearchAvailableTeamsAsync" />
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsCollaborator != null)
{
    <Modal Title="@($"Detalhes: {detailsCollaborator.FullName}")" Size="lg" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Espaços de trabalho</h3>
                @if (detailsCollaboratorTeams == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else
                {
                    var uniqueWorkspaces = detailsCollaboratorTeams
                        .Where(t => !string.IsNullOrEmpty(t.WorkspaceName))
                        .Select(t => t.WorkspaceName)
                        .Distinct()
                        .ToList();

                    @if (uniqueWorkspaces.Count == 0)
                    {
                        <p class="muted">Nenhum workspace vinculado.</p>
                    }
                    else
                    {
                        <ul class="detail-list">
                            @foreach (var workspaceName in uniqueWorkspaces)
                            {
                                <li class="detail-list-item">
                                    <span class="detail-name">@workspaceName</span>
                                </li>
                            }
                        </ul>
                    }
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Equipes</h3>
                @if (detailsCollaboratorTeams == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsCollaboratorTeams.Count == 0)
                {
                    <p class="muted">Nenhuma equipe atribuída.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var team in detailsCollaboratorTeams)
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@team.Name</span>
                                </div>
                                <span class="detail-email">@team.WorkspaceName</span>
                            </li>
                        }
                    </ul>
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Liderados</h3>
                @if (detailsSubordinates == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsSubordinates.Count == 0)
                {
                    <p class="muted">Nenhum liderado encontrado.</p>
                }
                else
                {
                    <div class="org-chart">
                        <ul class="org-chart-list">
                            @foreach (var node in detailsSubordinates)
                            {
                                @RenderOrgChartNode(node)
                            }
                        </ul>
                    </div>
                }
            </div>
        </ChildContent>
    </Modal>
}

