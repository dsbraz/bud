@page "/collaborators"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<div class="page-header">
    <div>
        <div class="page-kicker">Pessoas</div>
        <h1>Colaboradores</h1>
        <p class="page-subtitle">Cadastre colaboradores vinculados às equipes.</p>
    </div>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Novo colaborador
    </button>
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Equipe</label>
            <select class="input" @bind="selectedTeamId" @bind:after="LoadCollaborators">
                <option value="">Todas</option>
                @foreach (var team in teams)
                {
                    <option value="@team.Id">@team.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadCollaborators">Atualizar</button>
        </div>
    </div>

    @if (collaborators is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (collaborators.Items.Count == 0)
    {
        <p class="muted">Nenhum colaborador encontrado.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Perfil</th>
                    <th>Líder</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var collaborator in collaborators.Items)
                {
                    var leader = collaborator.LeaderId.HasValue
                        ? allCollaborators.FirstOrDefault(c => c.Id == collaborator.LeaderId.Value)
                        : null;
                    var isDeleting = deletingCollaboratorId == collaborator.Id;
                    <tr @onclick="() => OpenDetailsModal(collaborator)" style="cursor: pointer;">
                        <td>@collaborator.FullName</td>
                        <td>@collaborator.Email</td>
                        <td>@GetRoleLabel(collaborator.Role)</td>
                        <td>@(leader?.FullName ?? "—")</td>
                        <td style="text-align: center;">
                            <div class="table-actions">
                                <button class="button-icon" @onclick="async () => await OpenEditModal(collaborator)"
                                        @onclick:stopPropagation="true"
                                        title="Editar colaborador">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M11.334 2.00004C11.5091 1.82494 11.7169 1.68605 11.9457 1.59129C12.1745 1.49653 12.4197 1.44775 12.6673 1.44775C12.9149 1.44775 13.1601 1.49653 13.3889 1.59129C13.6177 1.68605 13.8256 1.82494 14.0007 2.00004C14.1758 2.17513 14.3147 2.383 14.4094 2.61178C14.5042 2.84055 14.553 3.08575 14.553 3.33337C14.553 3.58099 14.5042 3.82619 14.4094 4.05497C14.3147 4.28374 14.1758 4.49161 14.0007 4.66671L5.00065 13.6667L1.33398 14.6667L2.33398 11L11.334 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="button-icon @(isDeleting ? "danger" : "")"
                                        @onclick="() => HandleDeleteClick(collaborator.Id)"
                                        @onclick:stopPropagation="true"
                                        title="@(isDeleting ? "Clique novamente para confirmar" : "Excluir colaborador")">
                                    @if (isDeleting)
                                    {
                                        <span style="font-size: 11px; white-space: nowrap;">Confirmar?</span>
                                    }
                                    else
                                    {
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M5.33398 4.00004V2.66671C5.33398 2.31309 5.47446 1.97395 5.72451 1.7239C5.97456 1.47385 6.3137 1.33337 6.66732 1.33337H9.33398C9.6876 1.33337 10.0268 1.47385 10.2768 1.7239C10.5269 1.97395 10.6673 2.31309 10.6673 2.66671V4.00004M12.6673 4.00004V13.3334C12.6673 13.687 12.5269 14.0261 12.2768 14.2762C12.0268 14.5262 11.6876 14.6667 11.334 14.6667H4.66732C4.3137 14.6667 3.97456 14.5262 3.72451 14.2762C3.47446 14.0261 3.33398 13.687 3.33398 13.3334V4.00004H12.6673Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    }
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @collaborators.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar colaborador" OnClose="CloseModal">
        <EditForm Model="@newCollaborator" OnValidSubmit="CreateCollaborator">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome completo</label>
                <InputText class="input" @bind-Value="newCollaborator.FullName" />
            </div>
            <div class="form-row">
                <label>E-mail</label>
                <InputText class="input" @bind-Value="newCollaborator.Email" />
            </div>
            <div class="form-row">
                <label>Perfil</label>
                <InputSelect class="input" @bind-Value="newCollaborator.Role">
                    <option value="@CollaboratorRole.IndividualContributor">Contribuidor individual</option>
                    <option value="@CollaboratorRole.Leader">Lider</option>
                </InputSelect>
            </div>
            <div class="form-row">
                <label>Líder (opcional)</label>
                <select class="input" @bind="createLeaderId">
                    <option value="">Nenhum</option>
                    @foreach (var leader in leaders)
                    {
                        <option value="@leader.Id">@leader.FullName - @leader.TeamName</option>
                    }
                </select>
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar colaborador" Size="lg" OnClose="CloseEditModal">
        <EditForm Model="@editCollaborator" OnValidSubmit="UpdateCollaborator">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome completo</label>
                <InputText class="input" @bind-Value="editCollaborator.FullName" placeholder="Nome do colaborador" />
                <ValidationMessage For="() => editCollaborator.FullName" />
            </div>
            <div class="form-row">
                <label>E-mail</label>
                <InputText class="input" @bind-Value="editCollaborator.Email" type="email" placeholder="email@exemplo.com" />
                <ValidationMessage For="() => editCollaborator.Email" />
            </div>
            <div class="form-row">
                <label>Perfil</label>
                <InputSelect class="input" @bind-Value="editCollaborator.Role">
                    <option value="@CollaboratorRole.IndividualContributor">Contribuidor individual</option>
                    <option value="@CollaboratorRole.Leader">Líder</option>
                </InputSelect>
                <ValidationMessage For="() => editCollaborator.Role" />
            </div>
            <div class="form-row">
                <label>Líder (opcional)</label>
                <select class="input" @bind="editLeaderId">
                    <option value="">Nenhum</option>
                    @foreach (var leader in leaders)
                    {
                        @if (leader.Id != selectedCollaborator?.Id)
                        {
                            <option value="@leader.Id">@leader.FullName - @leader.TeamName</option>
                        }
                    }
                </select>
                <small class="form-hint">
                    O líder pode ser alterado para qualquer colaborador com função de Líder.
                </small>
            </div>
            <div class="form-row" style="margin-top: var(--spacing-4);">
                <label>Equipes</label>
                <TransferList TItem="TeamSummaryDto"
                    AvailableItems="@availableTeamsForEdit"
                    AssignedItems="@assignedTeamsForEdit"
                    AssignedItemsChanged="OnTeamsChanged"
                    OnAvailableSearch="SearchAvailableTeamsAsync"
                    GetKey="@(t => t.Id)"
                    GetDisplayText="@(t => t.Name)"
                    GetSecondaryText="@(t => t.WorkspaceName)"
                    AvailableTitle="Equipes disponíveis"
                    AssignedTitle="Equipes atribuídas"
                    SearchPlaceholder="Buscar equipe..."
                    EmptyAvailableMessage="Nenhuma equipe disponível."
                    EmptyAssignedMessage="Nenhuma equipe atribuída." />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsCollaborator != null)
{
    <Modal Title="@($"Detalhes: {detailsCollaborator.FullName}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Workspaces</h3>
                @if (detailsCollaboratorTeams == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else
                {
                    var uniqueWorkspaces = detailsCollaboratorTeams
                        .Where(t => !string.IsNullOrEmpty(t.WorkspaceName))
                        .Select(t => t.WorkspaceName)
                        .Distinct()
                        .ToList();

                    @if (uniqueWorkspaces.Count == 0)
                    {
                        <p class="muted">Nenhum workspace vinculado.</p>
                    }
                    else
                    {
                        <ul class="detail-list">
                            @foreach (var workspaceName in uniqueWorkspaces)
                            {
                                <li class="detail-list-item">
                                    <span class="detail-name">@workspaceName</span>
                                </li>
                            }
                        </ul>
                    }
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Equipes</h3>
                @if (detailsCollaboratorTeams == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsCollaboratorTeams.Count == 0)
                {
                    <p class="muted">Nenhuma equipe atribuída.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var team in detailsCollaboratorTeams)
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@team.Name</span>
                                </div>
                                <span class="detail-email">@team.WorkspaceName</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private CreateCollaboratorRequest newCollaborator = new();
    private List<Team> teams = new();
    private List<Workspace> workspaces = new();
    private List<LeaderCollaboratorResponse> leaders = new();
    private List<Collaborator> allCollaborators = new();
    private PagedResult<Collaborator>? collaborators;
    private string? search;
    private string? selectedTeamId;
    private string? createLeaderId;
    private bool isModalOpen = false;

    // Estado do modal de edição
    private bool isEditModalOpen = false;
    private Collaborator? selectedCollaborator = null;
    private UpdateCollaboratorRequest editCollaborator = new();
    private string? editLeaderId;
    private List<TeamSummaryDto> availableTeamsForEdit = new();
    private List<TeamSummaryDto> assignedTeamsForEdit = new();
    private bool teamsModified = false;

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Collaborator? detailsCollaborator = null;
    private List<TeamSummaryDto>? detailsCollaboratorTeams = null;

    // Estado de confirmação de exclusão
    private Guid? deletingCollaboratorId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadTeams();
        await LoadWorkspaces();
        await LoadLeaders();
        await LoadCollaborators();
        await LoadAllCollaborators();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private async void HandleOrganizationChanged()
    {
        await LoadTeams();
        await LoadWorkspaces();
        await LoadLeaders();
        await LoadCollaborators();
        await LoadAllCollaborators();
        StateHasChanged();
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadTeams()
    {
        var result = await Api.GetTeamsAsync(null, null, null, 1, 200);
        teams = result?.Items.ToList() ?? new List<Team>();
    }

    private async Task LoadWorkspaces()
    {
        var result = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, null, 1, 200);
        workspaces = result?.Items.ToList() ?? new List<Workspace>();
    }

    private async Task LoadLeaders()
    {
        leaders = await Api.GetLeadersAsync(OrgContext.SelectedOrganizationId) ?? new List<LeaderCollaboratorResponse>();
    }

    private async Task LoadAllCollaborators()
    {
        var result = await Api.GetCollaboratorsAsync(null, null, 1, 1000);
        allCollaborators = result?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task LoadCollaborators()
    {
        var filterTeamId = Guid.TryParse(selectedTeamId, out var parsedTeamId)
            ? parsedTeamId
            : (Guid?)null;
        collaborators = await Api.GetCollaboratorsAsync(filterTeamId, search, 1, 20) ?? new PagedResult<Collaborator>();
    }

    private void OpenCreateModal()
    {
        newCollaborator = new CreateCollaboratorRequest();
        createLeaderId = null;
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateCollaborator()
    {
        if (string.IsNullOrWhiteSpace(newCollaborator.FullName))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Informe o nome completo.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newCollaborator.Email))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Informe o e-mail.");
            return;
        }

        // TeamId sempre null (colaboradores são criados sem equipe)
        newCollaborator.TeamId = null;
        newCollaborator.LeaderId = Guid.TryParse(createLeaderId, out var leaderId) ? leaderId : null;

        try
        {
            await Api.CreateCollaboratorAsync(newCollaborator);
            var createdCollaboratorName = newCollaborator.FullName;
            newCollaborator = new CreateCollaboratorRequest();
            createLeaderId = null;
            await LoadCollaborators();
            await LoadAllCollaborators();

            ToastService.ShowSuccess("Colaborador criado com sucesso!", $"O colaborador '{createdCollaboratorName}' foi criado.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao criar colaborador", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }

    private async Task OpenEditModal(Collaborator collaborator)
    {
        selectedCollaborator = collaborator;
        editCollaborator = new UpdateCollaboratorRequest
        {
            FullName = collaborator.FullName,
            Email = collaborator.Email,
            Role = collaborator.Role,
            LeaderId = collaborator.LeaderId
        };
        editLeaderId = collaborator.LeaderId?.ToString() ?? "";

        // Load teams for TransferList
        assignedTeamsForEdit = await Api.GetCollaboratorTeamsAsync(collaborator.Id) ?? new();
        availableTeamsForEdit = await Api.GetAvailableTeamsForCollaboratorAsync(collaborator.Id) ?? new();
        teamsModified = false;

        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedCollaborator = null;
        editCollaborator = new();
        editLeaderId = null;
        availableTeamsForEdit = new();
        assignedTeamsForEdit = new();
        teamsModified = false;
    }

    private async Task OpenDetailsModal(Collaborator collaborator)
    {
        detailsCollaborator = collaborator;
        detailsCollaboratorTeams = null;
        isDetailsModalOpen = true;

        // Carregar equipes do colaborador via API
        detailsCollaboratorTeams = await Api.GetCollaboratorTeamsAsync(collaborator.Id) ?? new();
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        detailsCollaborator = null;
        detailsCollaboratorTeams = null;
    }

    private async Task UpdateCollaborator()
    {
        if (selectedCollaborator == null) return;

        editCollaborator.LeaderId = Guid.TryParse(editLeaderId, out var leaderId) ? leaderId : null;

        try
        {
            var result = await Api.UpdateCollaboratorAsync(selectedCollaborator.Id, editCollaborator);
            if (result != null)
            {
                // Update teams if modified
                if (teamsModified)
                {
                    await Api.UpdateCollaboratorTeamsAsync(selectedCollaborator.Id, new UpdateCollaboratorTeamsRequest
                    {
                        TeamIds = assignedTeamsForEdit.Select(t => t.Id).ToList()
                    });
                }

                ToastService.ShowSuccess("Colaborador atualizado", "As alterações foram salvas com sucesso.");
                CloseEditModal();
                await LoadCollaborators();
                await LoadAllCollaborators();
            }
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao atualizar", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }

    private async Task HandleDeleteClick(Guid collaboratorId)
    {
        if (deletingCollaboratorId == collaboratorId)
        {
            // Segundo clique - executar exclusão
            await DeleteCollaborator(collaboratorId);
        }
        else
        {
            // Primeiro clique - mostrar confirmação
            deletingCollaboratorId = collaboratorId;

            // Reset após 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingCollaboratorId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteCollaborator(Guid collaboratorId)
    {
        try
        {
            await Api.DeleteCollaboratorAsync(collaboratorId);
            ToastService.ShowSuccess("Colaborador excluído", "O colaborador foi removido com sucesso.");
            await LoadCollaborators();
            await LoadAllCollaborators();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao excluir", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
        finally
        {
            deletingCollaboratorId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }

    private static string GetRoleLabel(CollaboratorRole role) => role switch
    {
        CollaboratorRole.Leader => "Lider",
        _ => "Contribuidor individual"
    };

    private void OnTeamsChanged(List<TeamSummaryDto> teams)
    {
        assignedTeamsForEdit = teams;
        teamsModified = true;
    }

    private async Task SearchAvailableTeamsAsync(string search)
    {
        if (selectedCollaborator == null) return;
        availableTeamsForEdit = await Api.GetAvailableTeamsForCollaboratorAsync(selectedCollaborator.Id, search) ?? new();
    }
}
