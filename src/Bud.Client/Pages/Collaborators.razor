@page "/collaborators"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<ManagementPageHeader
    Kicker="Gestão"
    Title="Colaboradores"
    Subtitle="Gerencie colaboradores e vínculos de liderança."
    PrimaryActionText="Novo colaborador"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros Compacta *@
<div class="collaborators-filter-bar">
    <div class="collaborators-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                <path d="M28 6H4L14 17.6V26L18 28V17.6L28 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Filtrar</span>
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(!string.IsNullOrEmpty(selectedTeamId) ? "active" : "")" @onclick="ToggleTeamDropdown">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M16 14C18.2091 14 20 12.2091 20 10C20 7.79086 18.2091 6 16 6C13.7909 6 12 7.79086 12 10C12 12.2091 13.7909 14 16 14Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 28V26C8 23.7909 9.79086 22 12 22H20C22.2091 22 24 23.7909 24 26V28" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>@GetTeamFilterLabel()</span>
            </button>
            @if (showTeamDropdown)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Equipe</label>
                        <select class="input" @bind="selectedTeamId" @bind:after="ApplyTeamFilter">
                            <option value="">Todas</option>
                            @foreach (var team in teams)
                            {
                                <option value="@team.Id">@team.Name</option>
                            }
                        </select>
                    </div>
                </div>
            }
        </div>
        @if (HasActiveFilters())
        {
            <button class="filter-chip-clear" @onclick="ClearFilters">
                <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
                    <path d="M26 16L22 12M22 12L18 8M22 12L26 8M22 12L18 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 8L10 28H14L12 18L6 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Limpar filtro</span>
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expandido *@
@if (showFilterPanel)
{
    <div class="collaborators-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Equipe</label>
                <select class="input" @bind="selectedTeamId" @bind:after="LoadCollaborators">
                    <option value="">Todas</option>
                    @foreach (var team in teams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar colaboradores..." />
            </div>
        </div>
    </div>
}

<CollaboratorsSummaryCards
    TotalCollaborators="GetTotalCollaboratorsCount()"
    Leaders="GetLeadersCount()"
    Contributors="GetContributorsCount()" />

@* Lista de Colaboradores *@
<div class="collaborators-table-container">
    <PagedTableSection
        IsLoading="@(collaborators is null)"
        IsEmpty="@(collaborators is not null && collaborators.Items.Count == 0)"
        Total="@(collaborators?.Total ?? 0)"
        EmptyText="Nenhum colaborador encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Perfil</th>
                    <th>Líder</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var collaborator in collaborators!.Items)
                {
                    var leader = collaborator.LeaderId.HasValue
                        ? allCollaborators.FirstOrDefault(c => c.Id == collaborator.LeaderId.Value)
                        : null;
                    var isDeleting = deletingCollaboratorId == collaborator.Id;
                    <tr @onclick="() => OpenDetailsModal(collaborator)" style="cursor: pointer;">
                        <td>@collaborator.FullName</td>
                        <td>@collaborator.Email</td>
                        <td>@GetRoleLabel(collaborator.Role)</td>
                        <td>@(leader?.FullName ?? "—")</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar colaborador"
                                OnEdit="@(async () => await OpenEditModal(collaborator))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir colaborador"
                                OnDelete="@(() => HandleDeleteClick(collaborator.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="Criar colaborador" OnClose="CloseModal">
        <EditForm Model="@newCollaborator" OnValidSubmit="CreateCollaborator">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome completo</label>
                <InputText class="input" @bind-Value="newCollaborator.FullName" />
            </div>
            <div class="form-row">
                <label>E-mail</label>
                <InputText class="input" @bind-Value="newCollaborator.Email" />
            </div>
            <div class="form-row">
                <label>Perfil</label>
                <InputSelect class="input" @bind-Value="newCollaborator.Role">
                    <option value="@CollaboratorRole.IndividualContributor">Contribuidor individual</option>
                    <option value="@CollaboratorRole.Leader">Lider</option>
                </InputSelect>
            </div>
            <div class="form-row">
                <label>Líder (opcional)</label>
                <select class="input" @bind="createLeaderId">
                    <option value="">Nenhum</option>
                    @foreach (var leader in leaders)
                    {
                        <option value="@leader.Id">@leader.FullName - @leader.TeamName</option>
                    }
                </select>
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar colaborador" Size="lg" OnClose="CloseEditModal">
        <EditForm Model="@editCollaborator" OnValidSubmit="UpdateCollaborator">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome completo</label>
                <InputText class="input" @bind-Value="editCollaborator.FullName" placeholder="Nome do colaborador" />
                <ValidationMessage For="() => editCollaborator.FullName" />
            </div>
            <div class="form-row">
                <label>E-mail</label>
                <InputText class="input" @bind-Value="editCollaborator.Email" type="email" placeholder="email@exemplo.com" />
                <ValidationMessage For="() => editCollaborator.Email" />
            </div>
            <div class="form-row">
                <label>Perfil</label>
                <InputSelect class="input" @bind-Value="editCollaborator.Role">
                    <option value="@CollaboratorRole.IndividualContributor">Contribuidor individual</option>
                    <option value="@CollaboratorRole.Leader">Líder</option>
                </InputSelect>
                <ValidationMessage For="() => editCollaborator.Role" />
            </div>
            <div class="form-row">
                <label>Líder (opcional)</label>
                <select class="input" @bind="editLeaderId">
                    <option value="">Nenhum</option>
                    @foreach (var leader in leaders)
                    {
                        @if (leader.Id != selectedCollaborator?.Id)
                        {
                            <option value="@leader.Id">@leader.FullName - @leader.TeamName</option>
                        }
                    }
                </select>
                <small class="form-hint">
                    O líder pode ser alterado para qualquer colaborador com função de Líder.
                </small>
            </div>
            <div class="form-row" style="margin-top: var(--spacing-4);">
                <label>Equipes</label>
                <TransferList TItem="TeamSummaryDto"
                    AvailableItems="@availableTeamsForEdit"
                    AssignedItems="@assignedTeamsForEdit"
                    AssignedItemsChanged="OnTeamsChanged"
                    OnAvailableSearch="SearchAvailableTeamsAsync"
                    GetKey="@(t => t.Id)"
                    GetDisplayText="@(t => t.Name)"
                    GetSecondaryText="@(t => t.WorkspaceName)"
                    AvailableTitle="Equipes disponíveis"
                    AssignedTitle="Equipes atribuídas"
                    SearchPlaceholder="Buscar equipe..."
                    EmptyAvailableMessage="Nenhuma equipe disponível."
                    EmptyAssignedMessage="Nenhuma equipe atribuída." />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsCollaborator != null)
{
    <Modal Title="@($"Detalhes: {detailsCollaborator.FullName}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Workspaces</h3>
                @if (detailsCollaboratorTeams == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else
                {
                    var uniqueWorkspaces = detailsCollaboratorTeams
                        .Where(t => !string.IsNullOrEmpty(t.WorkspaceName))
                        .Select(t => t.WorkspaceName)
                        .Distinct()
                        .ToList();

                    @if (uniqueWorkspaces.Count == 0)
                    {
                        <p class="muted">Nenhum workspace vinculado.</p>
                    }
                    else
                    {
                        <ul class="detail-list">
                            @foreach (var workspaceName in uniqueWorkspaces)
                            {
                                <li class="detail-list-item">
                                    <span class="detail-name">@workspaceName</span>
                                </li>
                            }
                        </ul>
                    }
                }
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">Equipes</h3>
                @if (detailsCollaboratorTeams == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsCollaboratorTeams.Count == 0)
                {
                    <p class="muted">Nenhuma equipe atribuída.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var team in detailsCollaboratorTeams)
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@team.Name</span>
                                </div>
                                <span class="detail-email">@team.WorkspaceName</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private CreateCollaboratorRequest newCollaborator = new();
    private List<Team> teams = new();
    private List<Workspace> workspaces = new();
    private List<LeaderCollaboratorResponse> leaders = new();
    private List<Collaborator> allCollaborators = new();
    private PagedResult<Collaborator>? collaborators;
    private string? search;
    private string? selectedTeamId;
    private string? createLeaderId;
    private bool isModalOpen = false;

    // Filter panel state
    private bool showFilterPanel = false;
    private bool showTeamDropdown = false;

    // Estado do modal de edição
    private bool isEditModalOpen = false;
    private Collaborator? selectedCollaborator = null;
    private UpdateCollaboratorRequest editCollaborator = new();
    private string? editLeaderId;
    private List<TeamSummaryDto> availableTeamsForEdit = new();
    private List<TeamSummaryDto> assignedTeamsForEdit = new();
    private bool teamsModified = false;

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Collaborator? detailsCollaborator = null;
    private List<TeamSummaryDto>? detailsCollaboratorTeams = null;

    // Estado de confirmação de exclusão
    private Guid? deletingCollaboratorId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadTeams();
        await LoadWorkspaces();
        await LoadLeaders();
        await LoadCollaborators();
        await LoadAllCollaborators();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadTeams();
            await LoadWorkspaces();
            await LoadLeaders();
            await LoadCollaborators();
            await LoadAllCollaborators();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar colaboradores por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar colaboradores", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadTeams()
    {
        var result = await Api.GetTeamsAsync(null, null, null, 1, 100);
        teams = result?.Items.ToList() ?? new List<Team>();
    }

    private async Task LoadWorkspaces()
    {
        var result = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, null, 1, 100);
        workspaces = result?.Items.ToList() ?? new List<Workspace>();
    }

    private async Task LoadLeaders()
    {
        leaders = await Api.GetLeadersAsync(OrgContext.SelectedOrganizationId) ?? new List<LeaderCollaboratorResponse>();
    }

    private async Task LoadAllCollaborators()
    {
        var result = await Api.GetCollaboratorsAsync(null, null, 1, 100);
        allCollaborators = result?.Items.ToList() ?? new List<Collaborator>();
    }

    private async Task LoadCollaborators()
    {
        var filterTeamId = Guid.TryParse(selectedTeamId, out var parsedTeamId)
            ? parsedTeamId
            : (Guid?)null;
        collaborators = await Api.GetCollaboratorsAsync(filterTeamId, search, 1, 20) ?? new PagedResult<Collaborator>();
    }

    // Filter methods
    private void ToggleFilterPanel()
    {
        showFilterPanel = !showFilterPanel;
    }

    private void ToggleTeamDropdown()
    {
        showTeamDropdown = !showTeamDropdown;
    }

    private async Task ApplyTeamFilter()
    {
        showTeamDropdown = false;
        await LoadCollaborators();
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(selectedTeamId) || !string.IsNullOrEmpty(search);
    }

    private async Task ClearFilters()
    {
        selectedTeamId = null;
        search = null;
        await LoadCollaborators();
    }

    private string GetTeamFilterLabel()
    {
        if (Guid.TryParse(selectedTeamId, out var teamId))
        {
            var team = teams.FirstOrDefault(t => t.Id == teamId);
            if (team != null)
            {
                return team.Name;
            }
        }
        return "Todas as equipes";
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadCollaborators();
        }
    }

    // Summary card methods
    private int GetTotalCollaboratorsCount()
    {
        return allCollaborators.Count;
    }

    private int GetLeadersCount()
    {
        return allCollaborators.Count(c => c.Role == CollaboratorRole.Leader);
    }

    private int GetContributorsCount()
    {
        return allCollaborators.Count(c => c.Role == CollaboratorRole.IndividualContributor);
    }

    private void OpenCreateModal()
    {
        newCollaborator = new CreateCollaboratorRequest();
        createLeaderId = null;
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateCollaborator()
    {
        if (string.IsNullOrWhiteSpace(newCollaborator.FullName))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Informe o nome completo.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newCollaborator.Email))
        {
            ToastService.ShowError("Erro ao criar colaborador", "Informe o e-mail.");
            return;
        }

        // TeamId sempre null (colaboradores são criados sem equipe)
        newCollaborator.TeamId = null;
        newCollaborator.LeaderId = Guid.TryParse(createLeaderId, out var leaderId) ? leaderId : null;

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.CreateCollaboratorAsync(newCollaborator);
                var createdCollaboratorName = newCollaborator.FullName;
                newCollaborator = new CreateCollaboratorRequest();
                createLeaderId = null;
                await LoadCollaborators();
                await LoadAllCollaborators();

                ToastService.ShowSuccess("Colaborador criado com sucesso!", $"O colaborador '{createdCollaboratorName}' foi criado.");
                CloseModal();
            },
            ToastService,
            "Erro ao criar colaborador",
            "Não foi possível criar o colaborador. Verifique os dados e tente novamente.",
            operationContext: "criação de colaborador",
            unexpectedErrorMessage: "Não foi possível criar o colaborador. Tente novamente.");
    }

    private async Task OpenEditModal(Collaborator collaborator)
    {
        selectedCollaborator = collaborator;
        editCollaborator = new UpdateCollaboratorRequest
        {
            FullName = collaborator.FullName,
            Email = collaborator.Email,
            Role = collaborator.Role,
            LeaderId = collaborator.LeaderId
        };
        editLeaderId = collaborator.LeaderId?.ToString() ?? "";

        // Load teams for TransferList
        assignedTeamsForEdit = await Api.GetCollaboratorTeamsAsync(collaborator.Id) ?? new();
        availableTeamsForEdit = await Api.GetAvailableTeamsForCollaboratorAsync(collaborator.Id) ?? new();
        teamsModified = false;

        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedCollaborator = null;
        editCollaborator = new();
        editLeaderId = null;
        availableTeamsForEdit = new();
        assignedTeamsForEdit = new();
        teamsModified = false;
    }

    private async Task OpenDetailsModal(Collaborator collaborator)
    {
        detailsCollaborator = collaborator;
        detailsCollaboratorTeams = null;
        isDetailsModalOpen = true;

        // Carregar equipes do colaborador via API
        detailsCollaboratorTeams = await Api.GetCollaboratorTeamsAsync(collaborator.Id) ?? new();
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        detailsCollaborator = null;
        detailsCollaboratorTeams = null;
    }

    private async Task UpdateCollaborator()
    {
        if (selectedCollaborator == null) return;

        editCollaborator.LeaderId = Guid.TryParse(editLeaderId, out var leaderId) ? leaderId : null;

        await UiOperationRunner.RunAsync(
            async () =>
            {
                var result = await Api.UpdateCollaboratorAsync(selectedCollaborator.Id, editCollaborator);
                if (result != null)
                {
                    // Update teams if modified
                    if (teamsModified)
                    {
                        await Api.UpdateCollaboratorTeamsAsync(selectedCollaborator.Id, new UpdateCollaboratorTeamsRequest
                        {
                            TeamIds = assignedTeamsForEdit.Select(t => t.Id).ToList()
                        });
                    }

                    ToastService.ShowSuccess("Colaborador atualizado", "As alterações foram salvas com sucesso.");
                    CloseEditModal();
                    await LoadCollaborators();
                    await LoadAllCollaborators();
                }
            },
            ToastService,
            "Erro ao atualizar",
            "Não foi possível atualizar o colaborador. Verifique os dados e tente novamente.",
            operationContext: "atualização de colaborador",
            unexpectedErrorMessage: "Não foi possível atualizar o colaborador. Tente novamente.");
    }

    private async Task HandleDeleteClick(Guid collaboratorId)
    {
        if (deletingCollaboratorId == collaboratorId)
        {
            // Segundo clique - executar exclusão
            await DeleteCollaborator(collaboratorId);
        }
        else
        {
            // Primeiro clique - mostrar confirmação
            deletingCollaboratorId = collaboratorId;

            // Reset após 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingCollaboratorId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteCollaborator(Guid collaboratorId)
    {
        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.DeleteCollaboratorAsync(collaboratorId);
                    ToastService.ShowSuccess("Colaborador excluído", "O colaborador foi removido com sucesso.");
                    await LoadCollaborators();
                    await LoadAllCollaborators();
                },
                ToastService,
                "Erro ao excluir",
                "Não foi possível excluir o colaborador. Tente novamente.",
                operationContext: "exclusão de colaborador",
                unexpectedErrorMessage: "Não foi possível excluir o colaborador. Tente novamente.");
        }
        finally
        {
            deletingCollaboratorId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }

    private static string GetRoleLabel(CollaboratorRole role) => role switch
    {
        CollaboratorRole.Leader => "Lider",
        _ => "Contribuidor individual"
    };

    private void OnTeamsChanged(List<TeamSummaryDto> teams)
    {
        assignedTeamsForEdit = teams;
        teamsModified = true;
    }

    private async Task SearchAvailableTeamsAsync(string search)
    {
        if (selectedCollaborator == null) return;
        availableTeamsForEdit = await Api.GetAvailableTeamsForCollaboratorAsync(selectedCollaborator.Id, search) ?? new();
    }
}
