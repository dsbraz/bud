@page "/mission-metrics"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps
@implements IDisposable

<MissionsMenu />

<ManagementPageHeader
    Kicker="Gestão"
    Title="Métricas"
    Subtitle="Defina métricas para suas missões."
    PrimaryActionText="Nova métrica"
    OnPrimaryAction="OpenCreateModal" />

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Missão</label>
            <select class="input" @bind="filterMissionId" @bind:after="LoadMetrics">
                <option value="">Todas</option>
                @foreach (var mission in missions)
                {
                    <option value="@mission.Id">@mission.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadMetrics">Atualizar</button>
        </div>
    </div>

    <PagedTableSection
        IsLoading="@(metrics is null)"
        IsEmpty="@(metrics is not null && metrics.Items.Count == 0)"
        Total="@(metrics?.Total ?? 0)"
        EmptyText="Nenhuma métrica encontrada.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Alvo</th>
                    <th>Progresso</th>
                    <th>Confiança</th>
                    <th>Missão</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var metric in metrics!.Items)
                {
                    var isDeleting = deletingMetricId == metric.Id;
                    var progress = metricProgress.GetValueOrDefault(metric.Id);
                    <tr>
                        <td>@metric.Name</td>
                        <td>@GetMetricTypeLabel(metric.Type)</td>
                        <td>@GetTargetLabel(metric)</td>
                        <td>
                            @if (progress is null || !progress.HasCheckins)
                            {
                                <span class="muted">—</span>
                            }
                            else
                            {
                                var statusClass = GetProgressStatusClass(progress);
                                <div class="mission-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill @statusClass" style="width: @($"{progress.Progress:F0}%")"></div>
                                    </div>
                                    <span class="progress-label">@($"{progress.Progress:F0}%")</span>
                                </div>
                            }
                        </td>
                        <td>
                            @if (progress is null || !progress.HasCheckins)
                            {
                                <span class="confidence-badge no-data">Sem dados</span>
                            }
                            else
                            {
                                var (confClass, confLabel) = GetConfidenceDisplay(progress.Confidence);
                                <span class="confidence-badge @confClass">@GetConfidenceStarsText(progress.Confidence) @confLabel</span>
                            }
                        </td>
                        <td>@GetMissionName(metric.MissionId)</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                EditTitle="Editar métrica"
                                OnEdit="@(() => OpenEditMetricModal(metric))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir métrica"
                                OnDelete="@(() => HandleDeleteMetricClick(metric.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="Nova métrica" OnClose="CloseModal" Size="lg">
        <EditForm Model="@newMetric" OnValidSubmit="CreateMetric">
            <DataAnnotationsValidator />
            <div class="metrics-form-container">
                <div class="metrics-form-header">
                    <div class="form-row">
                        <label>Missão</label>
                        <select class="input" @bind="createMissionId">
                            <option value="">Selecione uma missão</option>
                            @foreach (var mission in missions)
                            {
                                <option value="@mission.Id">@mission.Name</option>
                            }
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Nome da métrica</label>
                        <InputText class="input" placeholder="Ex: Taxa de conversão, NPS, etc." @bind-Value="newMetric.Name" />
                    </div>
                </div>

                <div class="metrics-form-selectors">
                    <div class="metrics-selector-btn">
                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                        </svg>
                        <select value="@createMetricTypeValue" @onchange="OnMetricTypeChanged">
                            <option value="">Tipo de métrica</option>
                            @foreach (var metricType in Enum.GetValues<MetricType>())
                            {
                                <option value="@metricType">@GetMetricTypeLabel(metricType)</option>
                            }
                        </select>
                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                        </svg>
                    </div>

                    @if (createMetricTypeValue == nameof(MetricType.Quantitative))
                    {
                        <div class="metrics-selector-btn">
                            <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                            </svg>
                            <select @bind="createQuantitativeTypeValue">
                                <option value="">Modo de mensuração</option>
                                @foreach (var qType in Enum.GetValues<QuantitativeMetricType>())
                                {
                                    <option value="@qType">@GetQuantitativeTypeIcon(qType) @GetQuantitativeTypeLabel(qType)</option>
                                }
                            </select>
                            <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                            </svg>
                        </div>
                    }
                </div>

                @if (createMetricTypeValue == nameof(MetricType.Qualitative))
                {
                    <div class="form-row">
                        <label>Descrição do objetivo</label>
                        <InputText class="input" placeholder="Descreva o objetivo qualitativo desta métrica" @bind-Value="newMetric.TargetText" />
                    </div>
                }

                @if (createMetricTypeValue == nameof(MetricType.Quantitative) && !string.IsNullOrEmpty(createQuantitativeTypeValue))
                {
                    <div class="metrics-form-inputs">
                        <div class="metrics-input-field">
                            <select @bind="createMetricUnitValue">
                                <option value="">Unidade de medida</option>
                                @foreach (var unit in Enum.GetValues<MetricUnit>())
                                {
                                    <option value="@unit">@GetUnitLabel(unit)</option>
                                }
                            </select>
                        </div>

                        @if (createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepAbove) ||
                             createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween))
                        {
                            <div class="metrics-input-field">
                                <InputNumber placeholder="Valor mínimo" @bind-Value="newMetric.MinValue" />
                            </div>
                        }

                        @if (createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBelow) ||
                             createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween) ||
                             createQuantitativeTypeValue == nameof(QuantitativeMetricType.Achieve) ||
                             createQuantitativeTypeValue == nameof(QuantitativeMetricType.Reduce))
                        {
                            <div class="metrics-input-field">
                                <InputNumber placeholder="@GetMaxValuePlaceholderForMetrics(createQuantitativeTypeValue)" @bind-Value="newMetric.MaxValue" />
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="form-actions" style="margin-top: var(--spacing-6);">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Criar métrica</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen && selectedMetric != null)
{
    <Modal Title="Editar métrica" OnClose="CloseEditMetricModal" Size="lg">
        <EditForm Model="@editMetric" OnValidSubmit="UpdateMetric">
            <DataAnnotationsValidator />
            <div class="metrics-form-container">
                <div class="metrics-form-header">
                    <div class="form-row">
                        <label>Nome da métrica</label>
                        <InputText class="input" @bind-Value="editMetric.Name" />
                    </div>
                </div>

                <div class="metrics-form-selectors">
                    <div class="metrics-selector-btn">
                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/>
                        </svg>
                        <select value="@editMetricTypeValue" @onchange="OnEditMetricTypeChanged">
                            <option value="">Tipo de métrica</option>
                            @foreach (var metricType in Enum.GetValues<MetricType>())
                            {
                                <option value="@metricType">@GetMetricTypeLabel(metricType)</option>
                            }
                        </select>
                        <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                        </svg>
                    </div>

                    @if (editMetricTypeValue == nameof(MetricType.Quantitative))
                    {
                        <div class="metrics-selector-btn">
                            <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 10h14M10 3v14" stroke-linecap="round"/>
                            </svg>
                            <select @bind="editQuantitativeTypeValue">
                                <option value="">Modo de mensuração</option>
                                @foreach (var qType in Enum.GetValues<QuantitativeMetricType>())
                                {
                                    <option value="@qType">@GetQuantitativeTypeIcon(qType) @GetQuantitativeTypeLabel(qType)</option>
                                }
                            </select>
                            <svg class="metrics-selector-icon" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                            </svg>
                        </div>
                    }
                </div>

                @if (editMetricTypeValue == nameof(MetricType.Qualitative))
                {
                    <div class="form-row">
                        <label>Descrição do objetivo</label>
                        <InputText class="input" placeholder="Descreva o objetivo qualitativo desta métrica" @bind-Value="editMetric.TargetText" />
                    </div>
                }

                @if (editMetricTypeValue == nameof(MetricType.Quantitative) && !string.IsNullOrEmpty(editQuantitativeTypeValue))
                {
                    <div class="metrics-form-inputs">
                        <div class="metrics-input-field">
                            <select @bind="editMetricUnitValue">
                                <option value="">Unidade de medida</option>
                                @foreach (var unit in Enum.GetValues<MetricUnit>())
                                {
                                    <option value="@unit">@GetUnitLabel(unit)</option>
                                }
                            </select>
                        </div>

                        @if (editQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepAbove) ||
                             editQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween))
                        {
                            <div class="metrics-input-field">
                                <InputNumber placeholder="Valor mínimo" @bind-Value="editMetric.MinValue" />
                            </div>
                        }

                        @if (editQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBelow) ||
                             editQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween) ||
                             editQuantitativeTypeValue == nameof(QuantitativeMetricType.Achieve) ||
                             editQuantitativeTypeValue == nameof(QuantitativeMetricType.Reduce))
                        {
                            <div class="metrics-input-field">
                                <InputNumber placeholder="@GetMaxValuePlaceholderForMetrics(editQuantitativeTypeValue)" @bind-Value="editMetric.MaxValue" />
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="form-actions" style="margin-top: var(--spacing-6);">
                <button class="button tertiary" type="button" @onclick="CloseEditMetricModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

