@page "/mission-metrics"
@inject ApiClient Api
@inject ToastService ToastService

<MissionsMenu />

<div class="page-header">
    <div>
        <div class="page-kicker">Gestão</div>
        <h1>Métricas</h1>
        <p class="page-subtitle">Defina métricas para suas missões.</p>
    </div>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Nova métrica
    </button>
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Missão</label>
            <select class="input" @bind="filterMissionId" @bind:after="LoadMetrics">
                <option value="">Todas</option>
                @foreach (var mission in missions)
                {
                    <option value="@mission.Id">@mission.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadMetrics">Atualizar</button>
        </div>
    </div>

    @if (metrics is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (metrics.Items.Count == 0)
    {
        <p class="muted">Nenhuma métrica encontrada.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Alvo</th>
                    <th>Missão</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var metric in metrics.Items)
                {
                    <tr>
                        <td>@metric.Name</td>
                        <td>@GetMetricTypeLabel(metric.Type)</td>
                        <td>@GetTargetLabel(metric)</td>
                        <td>@GetMissionName(metric.MissionId)</td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @metrics.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar métrica" OnClose="CloseModal">
        <EditForm Model="@newMetric" OnValidSubmit="CreateMetric">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Missão</label>
                <select class="input" @bind="createMissionId">
                    <option value="">Selecione</option>
                    @foreach (var mission in missions)
                    {
                        <option value="@mission.Id">@mission.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newMetric.Name" />
            </div>
            <div class="form-row">
                <label>Tipo</label>
                <select class="input" value="@createMetricTypeValue" @onchange="OnMetricTypeChanged">
                    <option value="">Selecione</option>
                    @foreach (var metricType in Enum.GetValues<MetricType>())
                    {
                        <option value="@metricType">@GetMetricTypeLabel(metricType)</option>
                    }
                </select>
            </div>
            @if (createMetricTypeValue == nameof(MetricType.Qualitative))
            {
                <div class="form-row">
                    <label>Texto alvo</label>
                    <InputText class="input" @bind-Value="newMetric.TargetText" />
                </div>
            }
            @if (createMetricTypeValue == nameof(MetricType.Quantitative))
            {
                <div class="form-row">
                    <label>Tipo de métrica</label>
                    <select class="input" @bind="createQuantitativeTypeValue">
                        <option value="">Selecione</option>
                        @foreach (var qType in Enum.GetValues<QuantitativeMetricType>())
                        {
                            <option value="@qType">@GetQuantitativeTypeLabel(qType)</option>
                        }
                    </select>
                </div>
                @if (createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepAbove))
                {
                    <div class="form-row">
                        <label>Valor mínimo</label>
                        <InputNumber class="input" @bind-Value="newMetric.MinValue" />
                    </div>
                }
                @if (createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBelow))
                {
                    <div class="form-row">
                        <label>Valor máximo</label>
                        <InputNumber class="input" @bind-Value="newMetric.MaxValue" />
                    </div>
                }
                @if (createQuantitativeTypeValue == nameof(QuantitativeMetricType.KeepBetween))
                {
                    <div class="form-row">
                        <label>Valor mínimo</label>
                        <InputNumber class="input" @bind-Value="newMetric.MinValue" />
                    </div>
                    <div class="form-row">
                        <label>Valor máximo</label>
                        <InputNumber class="input" @bind-Value="newMetric.MaxValue" />
                    </div>
                }
                <div class="form-row">
                    <label>Unidade</label>
                    <select class="input" @bind="createMetricUnitValue">
                        <option value="">Selecione</option>
                        @foreach (var unit in Enum.GetValues<MetricUnit>())
                        {
                            <option value="@unit">@GetUnitLabel(unit)</option>
                        }
                    </select>
                </div>
            }
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@code {
    private CreateMissionMetricRequest newMetric = new();
    private PagedResult<MissionMetric>? metrics;
    private List<Mission> missions = new();
    private string? createMissionId;
    private string? createMetricTypeValue;
    private string? createQuantitativeTypeValue;
    private string? createMetricUnitValue;
    private string? filterMissionId;
    private string? search;
    private bool isModalOpen = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadMissions();
        await LoadMetrics();
    }

    private async Task LoadMissions()
    {
        var result = await Api.GetMissionsAsync(null, null, null, 1, 200);
        missions = result?.Items.ToList() ?? new List<Mission>();
    }

    private async Task LoadMetrics()
    {
        var missionId = Guid.TryParse(filterMissionId, out var parsedMissionId)
            ? parsedMissionId
            : (Guid?)null;

        metrics = await Api.GetMissionMetricsAsync(missionId, search, 1, 20) ?? new PagedResult<MissionMetric>();
    }

    private async Task OnMetricTypeChanged(ChangeEventArgs e)
    {
        createMetricTypeValue = e.Value?.ToString();
        newMetric.TargetText = null;
        newMetric.MinValue = null;
        newMetric.MaxValue = null;
        newMetric.QuantitativeType = null;
        createQuantitativeTypeValue = null;
        createMetricUnitValue = null;
        await InvokeAsync(StateHasChanged);
    }

    private void OpenCreateModal()
    {
        newMetric = new CreateMissionMetricRequest();
        createMissionId = null;
        createMetricTypeValue = null;
        createQuantitativeTypeValue = null;
        createMetricUnitValue = null;
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateMetric()
    {
        if (!Guid.TryParse(createMissionId, out var missionId))
        {
            ToastService.ShowError("Erro ao criar métrica", "Selecione uma missão.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newMetric.Name))
        {
            ToastService.ShowError("Erro ao criar métrica", "Informe o nome da métrica.");
            return;
        }

        if (!Enum.TryParse<MetricType>(createMetricTypeValue, out var metricType))
        {
            ToastService.ShowError("Erro ao criar métrica", "Selecione o tipo da metrica.");
            return;
        }

        newMetric.MissionId = missionId;
        newMetric.Type = metricType;

        if (metricType == MetricType.Qualitative)
        {
            if (string.IsNullOrWhiteSpace(newMetric.TargetText))
            {
                ToastService.ShowError("Erro ao criar métrica", "Informe o texto alvo.");
                return;
            }
        }
        else
        {
            if (!Enum.TryParse<QuantitativeMetricType>(createQuantitativeTypeValue, out var quantitativeType))
            {
                ToastService.ShowError("Erro ao criar métrica", "Selecione o tipo de métrica quantitativa.");
                return;
            }

            newMetric.QuantitativeType = quantitativeType;

            if (quantitativeType == QuantitativeMetricType.KeepAbove && newMetric.MinValue is null)
            {
                ToastService.ShowError("Erro ao criar métrica", "Informe o valor mínimo.");
                return;
            }

            if (quantitativeType == QuantitativeMetricType.KeepBelow && newMetric.MaxValue is null)
            {
                ToastService.ShowError("Erro ao criar métrica", "Informe o valor máximo.");
                return;
            }

            if (quantitativeType == QuantitativeMetricType.KeepBetween)
            {
                if (newMetric.MinValue is null || newMetric.MaxValue is null)
                {
                    ToastService.ShowError("Erro ao criar métrica", "Informe os valores mínimo e máximo.");
                    return;
                }

                if (newMetric.MinValue >= newMetric.MaxValue)
                {
                    ToastService.ShowError("Erro ao criar métrica", "O valor mínimo deve ser menor que o valor máximo.");
                    return;
                }
            }

            if (!Enum.TryParse<MetricUnit>(createMetricUnitValue, out var metricUnit))
            {
                ToastService.ShowError("Erro ao criar métrica", "Selecione a unidade.");
                return;
            }

            newMetric.Unit = metricUnit;
        }

        await Api.CreateMissionMetricAsync(newMetric);
        var createdMetricName = newMetric.Name;
        newMetric = new CreateMissionMetricRequest();
        createMissionId = null;
        createMetricTypeValue = null;
        createQuantitativeTypeValue = null;
        createMetricUnitValue = null;
        await LoadMetrics();

        ToastService.ShowSuccess("Métrica criada com sucesso!", $"A métrica '{createdMetricName}' foi criada.");
        CloseModal();
    }

    private string GetMissionName(Guid missionId)
    {
        return missions.FirstOrDefault(m => m.Id == missionId)?.Name ?? "—";
    }

    private static string GetMetricTypeLabel(MetricType type) => type switch
    {
        MetricType.Qualitative => "Qualitativa",
        MetricType.Quantitative => "Quantitativa",
        _ => type.ToString()
    };

    private static string GetQuantitativeTypeLabel(QuantitativeMetricType type) => type switch
    {
        QuantitativeMetricType.KeepAbove => "Manter acima",
        QuantitativeMetricType.KeepBelow => "Manter abaixo",
        QuantitativeMetricType.KeepBetween => "Manter entre",
        _ => type.ToString()
    };

    private static string GetUnitLabel(MetricUnit unit) => unit switch
    {
        MetricUnit.Integer => "Inteiro",
        MetricUnit.Decimal => "Decimal",
        MetricUnit.Percentage => "Percentual",
        MetricUnit.Hours => "Horas",
        MetricUnit.Points => "Pontos",
        _ => unit.ToString()
    };

    private static string GetTargetLabel(MissionMetric metric)
    {
        if (metric.Type == MetricType.Qualitative)
        {
            return metric.TargetText ?? "—";
        }

        var unit = metric.Unit.HasValue ? GetUnitLabel(metric.Unit.Value) : "";
        var quantType = metric.QuantitativeType.HasValue ? GetQuantitativeTypeLabel(metric.QuantitativeType.Value) : "—";

        return metric.QuantitativeType switch
        {
            QuantitativeMetricType.KeepAbove => $"{quantType} {metric.MinValue} {unit}",
            QuantitativeMetricType.KeepBelow => $"{quantType} {metric.MaxValue} {unit}",
            QuantitativeMetricType.KeepBetween => $"{quantType} {metric.MinValue} e {metric.MaxValue} {unit}",
            _ => "—"
        };
    }
}
