@page "/metric-checkins"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<MissionsMenu />

<ManagementPageHeader
    Kicker="Gestão"
    Title="Check-ins"
    Subtitle="Registre o progresso das suas métricas."
    PrimaryActionText="Novo check-in"
    OnPrimaryAction="OpenCreateModal" />

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Missão</label>
            <select class="input" @bind="filterMissionId" @bind:after="OnMissionFilterChanged">
                <option value="">Todas</option>
                @foreach (var mission in missions)
                {
                    <option value="@mission.Id">@mission.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Métrica</label>
            <select class="input" @bind="filterMetricId" @bind:after="LoadCheckins">
                <option value="">Todas</option>
                @foreach (var metric in filterMetrics)
                {
                    <option value="@metric.Id">@metric.Name</option>
                }
            </select>
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadCheckins">Atualizar</button>
        </div>
    </div>

    <PagedTableSection
        IsLoading="@(checkins is null)"
        IsEmpty="@(checkins is not null && checkins.Items.Count == 0)"
        Total="@(checkins?.Total ?? 0)"
        EmptyText="Nenhum check-in encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Métrica</th>
                    <th>Valor</th>
                    <th>Confiança</th>
                    <th>Nota</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var checkin in checkins!.Items)
                {
                    var isDeleting = deletingCheckinId == checkin.Id;
                    <tr>
                        <td>@checkin.CheckinDate.ToString("dd/MM/yyyy")</td>
                        <td>@GetMetricName(checkin.MissionMetricId)</td>
                        <td>@GetCheckinValue(checkin)</td>
                        <td>
                            <span class="confidence-stars">@GetConfidenceStars(checkin.ConfidenceLevel)</span>
                        </td>
                        <td class="note-cell">@(checkin.Note ?? "—")</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                EditTitle="Editar check-in"
                                OnEdit="@(() => OpenEditModal(checkin))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir check-in"
                                OnDelete="@(() => HandleDeleteClick(checkin.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isCreateModalOpen)
{
    <Modal Title="Novo check-in" OnClose="CloseCreateModal" Size="lg">
        <div class="metrics-form-container">
            <div class="metrics-form-header">
                <div class="form-row">
                    <label>Missão</label>
                    <select class="input" @bind="createMissionId" @bind:after="OnCreateMissionChanged">
                        <option value="">Selecione uma missão</option>
                        @foreach (var mission in missions)
                        {
                            <option value="@mission.Id">@mission.Name</option>
                        }
                    </select>
                </div>
                <div class="form-row">
                    <label>Métrica</label>
                    <select class="input" @bind="createMetricId" @bind:after="OnCreateMetricChanged">
                        <option value="">Selecione uma métrica</option>
                        @foreach (var metric in createMetrics)
                        {
                            <option value="@metric.Id">@metric.Name (@GetMetricTypeLabel(metric.Type))</option>
                        }
                    </select>
                </div>
            </div>

            @if (selectedCreateMetric != null)
            {
                @if (selectedCreateMetric.Type == MetricType.Quantitative)
                {
                    <div class="form-row">
                        <label>Valor atual @GetTargetHint(selectedCreateMetric)</label>
                        <InputNumber class="input" @bind-Value="newCheckin.Value" placeholder="Ex: 42" />
                    </div>
                }
                else
                {
                    <div class="form-row">
                        <label>Texto de progresso</label>
                        <InputText class="input" @bind-Value="newCheckin.Text" placeholder="Descreva o progresso atual" />
                    </div>
                }
            }

            <div class="form-row">
                <label>Data do check-in</label>
                <InputDate class="input" @bind-Value="createCheckinDate" />
            </div>

            <div class="form-row">
                <label>Nível de confiança</label>
                <div class="confidence-selector">
                    @for (int i = 1; i <= 5; i++)
                    {
                        var level = i;
                        <button type="button"
                                class="confidence-btn @(newCheckin.ConfidenceLevel >= level ? "active" : "")"
                                @onclick="() => newCheckin.ConfidenceLevel = level">
                            @level
                        </button>
                    }
                </div>
            </div>

            <div class="form-row">
                <label>Nota (opcional)</label>
                <InputText class="input" @bind-Value="newCheckin.Note" placeholder="Contexto adicional sobre o progresso" />
            </div>
        </div>

        <div class="form-actions" style="margin-top: var(--spacing-6);">
            <button class="button tertiary" type="button" @onclick="CloseCreateModal">Cancelar</button>
            <button class="button primary" @onclick="CreateCheckin">Criar check-in</button>
        </div>
    </Modal>
}

@if (isEditModalOpen && selectedCheckin != null)
{
    <Modal Title="Editar check-in" OnClose="CloseEditModal" Size="lg">
        <div class="metrics-form-container">
            @if (editMetricType == MetricType.Quantitative)
            {
                <div class="form-row">
                    <label>Valor atual</label>
                    <InputNumber class="input" @bind-Value="editCheckin.Value" />
                </div>
            }
            else
            {
                <div class="form-row">
                    <label>Texto de progresso</label>
                    <InputText class="input" @bind-Value="editCheckin.Text" placeholder="Descreva o progresso atual" />
                </div>
            }

            <div class="form-row">
                <label>Data do check-in</label>
                <InputDate class="input" @bind-Value="editCheckinDate" />
            </div>

            <div class="form-row">
                <label>Nível de confiança</label>
                <div class="confidence-selector">
                    @for (int i = 1; i <= 5; i++)
                    {
                        var level = i;
                        <button type="button"
                                class="confidence-btn @(editCheckin.ConfidenceLevel >= level ? "active" : "")"
                                @onclick="() => editCheckin.ConfidenceLevel = level">
                            @level
                        </button>
                    }
                </div>
            </div>

            <div class="form-row">
                <label>Nota (opcional)</label>
                <InputText class="input" @bind-Value="editCheckin.Note" placeholder="Contexto adicional" />
            </div>
        </div>

        <div class="form-actions" style="margin-top: var(--spacing-6);">
            <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
            <button class="button primary" @onclick="UpdateCheckin">Salvar alterações</button>
        </div>
    </Modal>
}

@code {
    private PagedResult<MetricCheckin>? checkins;
    private List<Mission> missions = new();
    private List<MissionMetric> allMetrics = new();
    private List<MissionMetric> filterMetrics = new();

    private string? filterMissionId;
    private string? filterMetricId;

    // Create modal
    private bool isCreateModalOpen;
    private CreateMetricCheckinRequest newCheckin = new();
    private DateOnly createCheckinDate = DateOnly.FromDateTime(DateTime.Today);
    private string? createMissionId;
    private string? createMetricId;
    private List<MissionMetric> createMetrics = new();
    private MissionMetric? selectedCreateMetric;

    // Edit modal
    private bool isEditModalOpen;
    private MetricCheckin? selectedCheckin;
    private UpdateMetricCheckinRequest editCheckin = new();
    private DateOnly editCheckinDate;
    private MetricType editMetricType;

    // Delete confirmation
    private Guid? deletingCheckinId;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadMissions();
        await LoadAllMetrics();
        await LoadCheckins();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                filterMissionId = null;
                filterMetricId = null;
                await LoadMissions();
                await LoadAllMetrics();
                await LoadCheckins();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar check-ins por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar check-ins", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadMissions()
    {
        try
        {
            var result = await Api.GetMissionsAsync(null, null, null, 1, 100);
            missions = result?.Items.ToList() ?? new List<Mission>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar missões para check-ins: {ex.Message}");
            missions = new List<Mission>();
            ToastService.ShowError("Erro ao carregar missões", "Não foi possível carregar as missões.");
        }
    }

    private async Task LoadAllMetrics()
    {
        try
        {
            var result = await Api.GetMissionMetricsAsync(null, null, 1, 100);
            allMetrics = result?.Items.ToList() ?? new List<MissionMetric>();
            UpdateFilterMetrics();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar métricas para check-ins: {ex.Message}");
            allMetrics = new List<MissionMetric>();
            filterMetrics = new List<MissionMetric>();
            ToastService.ShowError("Erro ao carregar métricas", "Não foi possível carregar as métricas.");
        }
    }

    private void UpdateFilterMetrics()
    {
        if (Guid.TryParse(filterMissionId, out var missionId))
        {
            filterMetrics = allMetrics.Where(m => m.MissionId == missionId).ToList();
        }
        else
        {
            filterMetrics = allMetrics.ToList();
        }
    }

    private async Task LoadCheckins()
    {
        try
        {
            var metricId = Guid.TryParse(filterMetricId, out var parsedMetricId)
                ? parsedMetricId
                : (Guid?)null;
            var missionId = Guid.TryParse(filterMissionId, out var parsedMissionId)
                ? parsedMissionId
                : (Guid?)null;

            checkins = await Api.GetMetricCheckinsAsync(metricId, metricId.HasValue ? null : missionId, 1, 20)
                       ?? new PagedResult<MetricCheckin>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao carregar check-ins: {ex.Message}");
            checkins = new PagedResult<MetricCheckin>();
            ToastService.ShowError("Erro ao carregar check-ins", "Não foi possível carregar os check-ins.");
        }
    }

    private async Task OnMissionFilterChanged()
    {
        filterMetricId = null;
        UpdateFilterMetrics();
        await LoadCheckins();
    }

    // ---- Create ----

    private void OpenCreateModal()
    {
        newCheckin = new CreateMetricCheckinRequest { ConfidenceLevel = 3 };
        createCheckinDate = DateOnly.FromDateTime(DateTime.Today);
        createMissionId = null;
        createMetricId = null;
        createMetrics = new List<MissionMetric>();
        selectedCreateMetric = null;
        isCreateModalOpen = true;
    }

    private void CloseCreateModal() => isCreateModalOpen = false;

    private async Task OnCreateMissionChanged()
    {
        createMetricId = null;
        selectedCreateMetric = null;

        if (Guid.TryParse(createMissionId, out var missionId))
        {
            try
            {
                var result = await Api.GetMissionMetricsByMissionIdAsync(missionId);
                createMetrics = result?.Items.ToList() ?? new List<MissionMetric>();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erro ao carregar métricas da missão selecionada: {ex.Message}");
                createMetrics = new List<MissionMetric>();
            }
        }
        else
        {
            createMetrics = new List<MissionMetric>();
        }
    }

    private void OnCreateMetricChanged()
    {
        if (Guid.TryParse(createMetricId, out var metricId))
        {
            selectedCreateMetric = createMetrics.FirstOrDefault(m => m.Id == metricId);
        }
        else
        {
            selectedCreateMetric = null;
        }
    }

    private async Task CreateCheckin()
    {
        if (selectedCreateMetric is null)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione uma métrica.");
            return;
        }

        newCheckin.MissionMetricId = selectedCreateMetric.Id;
        newCheckin.CheckinDate = createCheckinDate.ToDateTime(TimeOnly.FromDateTime(DateTime.UtcNow), DateTimeKind.Utc);

        if (newCheckin.ConfidenceLevel < 1 || newCheckin.ConfidenceLevel > 5)
        {
            ToastService.ShowError("Erro ao criar check-in", "Selecione o nível de confiança (1-5).");
            return;
        }

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.CreateMetricCheckinAsync(newCheckin);
                ToastService.ShowSuccess("Check-in criado", "O check-in foi registrado com sucesso.");
                CloseCreateModal();
                await LoadCheckins();
            },
            ToastService,
            "Erro ao criar check-in",
            "Não foi possível criar o check-in. Verifique os dados e tente novamente.",
            "criação de check-in");
    }

    // ---- Edit ----

    private void OpenEditModal(MetricCheckin checkin)
    {
        selectedCheckin = checkin;
        editCheckin = new UpdateMetricCheckinRequest
        {
            Value = checkin.Value,
            Text = checkin.Text,
            CheckinDate = checkin.CheckinDate,
            Note = checkin.Note,
            ConfidenceLevel = checkin.ConfidenceLevel
        };
        editCheckinDate = DateOnly.FromDateTime(checkin.CheckinDate);
        editMetricType = allMetrics.FirstOrDefault(m => m.Id == checkin.MissionMetricId)?.Type ?? MetricType.Quantitative;
        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedCheckin = null;
    }

    private async Task UpdateCheckin()
    {
        if (selectedCheckin is null) return;

        editCheckin.CheckinDate = editCheckinDate.ToDateTime(TimeOnly.FromDateTime(DateTime.UtcNow), DateTimeKind.Utc);

        await UiOperationRunner.RunAsync(
            async () =>
            {
                await Api.UpdateMetricCheckinAsync(selectedCheckin.Id, editCheckin);
                ToastService.ShowSuccess("Check-in atualizado", "As alterações foram salvas com sucesso.");
                CloseEditModal();
                await LoadCheckins();
            },
            ToastService,
            "Erro ao atualizar",
            "Não foi possível atualizar o check-in. Verifique os dados e tente novamente.",
            "atualização de check-in");
    }

    // ---- Delete ----

    private async Task HandleDeleteClick(Guid checkinId)
    {
        if (deletingCheckinId == checkinId)
        {
            await DeleteCheckin(checkinId);
        }
        else
        {
            ArmDeleteConfirmation(checkinId);
        }
    }

    private async Task DeleteCheckin(Guid checkinId)
    {
        try
        {
            await UiOperationRunner.RunAsync(
                async () =>
                {
                    await Api.DeleteMetricCheckinAsync(checkinId);
                    ToastService.ShowSuccess("Check-in excluído", "O check-in foi removido com sucesso.");
                    await LoadCheckins();
                },
                ToastService,
                "Erro ao excluir",
                "Não foi possível excluir o check-in. Tente novamente.",
                "exclusão de check-in");
        }
        finally
        {
            ClearDeleteConfirmation();
        }
    }

    private void ArmDeleteConfirmation(Guid checkinId)
    {
        deletingCheckinId = checkinId;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = new System.Threading.Timer(
            _ => InvokeAsync(() =>
            {
                deletingCheckinId = null;
                StateHasChanged();
            }),
            null,
            3000,
            Timeout.Infinite);
    }

    private void ClearDeleteConfirmation()
    {
        deletingCheckinId = null;
        deleteConfirmTimer?.Dispose();
        deleteConfirmTimer = null;
    }

    // ---- Helpers ----

    private string GetMetricName(Guid metricId)
    {
        return allMetrics.FirstOrDefault(m => m.Id == metricId)?.Name ?? "—";
    }

    private static string GetCheckinValue(MetricCheckin checkin)
    {
        if (checkin.Value.HasValue)
            return checkin.Value.Value.ToString("G");
        if (!string.IsNullOrWhiteSpace(checkin.Text))
            return checkin.Text.Length > 50 ? checkin.Text[..50] + "..." : checkin.Text;
        return "—";
    }

    private static string GetConfidenceStars(int level)
    {
        return new string('★', level) + new string('☆', 5 - level);
    }

    private static string GetMetricTypeLabel(MetricType type) => MissionMetricDisplayHelper.GetMetricTypeLabel(type);

    private static string GetTargetHint(MissionMetric metric) => MissionMetricDisplayHelper.GetCheckinTargetHint(metric, useAbbreviatedUnit: true);
}
