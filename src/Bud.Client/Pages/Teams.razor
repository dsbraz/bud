@page "/teams"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<ManagementMenu />

@* Header *@
<div class="teams-page-header">
    <h1 class="teams-page-title">Equipes</h1>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Nova equipe
    </button>
</div>

@* Barra de Filtros *@
<div class="teams-filter-bar">
    <div class="teams-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(!string.IsNullOrEmpty(selectedWorkspaceId) ? "active" : "")" @onclick="ToggleWorkspaceDropdown">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <rect x="2" y="3" width="12" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M5 7H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M5 10H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>@GetWorkspaceFilterLabel()</span>
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            @if (showWorkspaceDropdown)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Workspace</label>
                        <select class="input" @bind="selectedWorkspaceId">
                            <option value="">Todos os workspaces</option>
                            @foreach (var workspace in workspaces)
                            {
                                <option value="@workspace.Id">@workspace.Name</option>
                            }
                        </select>
                    </div>
                    <button class="button small" @onclick="ApplyWorkspaceFilter">Aplicar</button>
                </div>
            }
        </div>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expansível *@
@if (showFilterPanel)
{
    <div class="teams-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar equipes..." />
            </div>
        </div>
    </div>
}

@* Cards de Resumo *@
<div class="teams-summary">
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetTotalTeamsCount()</div>
        <div class="summary-card-label">Total de equipes</div>
    </div>
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetRootTeamsCount()</div>
        <div class="summary-card-label">Equipes raiz</div>
    </div>
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetSubTeamsCount()</div>
        <div class="summary-card-label">Subequipes</div>
    </div>
</div>

@* Lista de Equipes *@
<div class="teams-table-container">
    @if (teams is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (teams.Items.Count == 0)
    {
        <p class="muted">Nenhuma equipe encontrada.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Workspace</th>
                    <th>Equipe pai</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var team in teams.Items)
                {
                    var workspace = workspaces.FirstOrDefault(w => w.Id == team.WorkspaceId);
                    var parent = allTeams.FirstOrDefault(t => t.Id == team.ParentTeamId);
                    var isDeleting = deletingTeamId == team.Id;
                    <tr @onclick="() => OpenDetailsModal(team)" style="cursor: pointer;">
                        <td>@team.Name</td>
                        <td>@(workspace?.Name ?? "—")</td>
                        <td>@(parent?.Name ?? "—")</td>
                        <td style="text-align: center;">
                            <div class="table-actions">
                                <button class="button-icon" @onclick="() => OpenEditModal(team)"
                                        @onclick:stopPropagation="true"
                                        title="Editar equipe">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M11.334 2.00004C11.5091 1.82494 11.7169 1.68605 11.9457 1.59129C12.1745 1.49653 12.4197 1.44775 12.6673 1.44775C12.9149 1.44775 13.1601 1.49653 13.3889 1.59129C13.6177 1.68605 13.8256 1.82494 14.0007 2.00004C14.1758 2.17513 14.3147 2.383 14.4094 2.61178C14.5042 2.84055 14.553 3.08575 14.553 3.33337C14.553 3.58099 14.5042 3.82619 14.4094 4.05497C14.3147 4.28374 14.1758 4.49161 14.0007 4.66671L5.00065 13.6667L1.33398 14.6667L2.33398 11L11.334 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="button-icon @(isDeleting ? "danger" : "")"
                                        @onclick="() => HandleDeleteClick(team.Id)"
                                        @onclick:stopPropagation="true"
                                        title="@(isDeleting ? "Clique novamente para confirmar" : "Excluir equipe")">
                                    @if (isDeleting)
                                    {
                                        <span style="font-size: 11px; white-space: nowrap;">Confirmar?</span>
                                    }
                                    else
                                    {
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M5.33398 4.00004V2.66671C5.33398 2.31309 5.47446 1.97395 5.72451 1.7239C5.97456 1.47385 6.3137 1.33337 6.66732 1.33337H9.33398C9.6876 1.33337 10.0268 1.47385 10.2768 1.7239C10.5269 1.97395 10.6673 2.31309 10.6673 2.66671V4.00004M12.6673 4.00004V13.3334C12.6673 13.687 12.5269 14.0261 12.2768 14.2762C12.0268 14.5262 11.6876 14.6667 11.334 14.6667H4.66732C4.3137 14.6667 3.97456 14.5262 3.72451 14.2762C3.47446 14.0261 3.33398 13.687 3.33398 13.3334V4.00004H12.6673Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    }
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @teams.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar equipe" OnClose="CloseModal">
        <EditForm Model="@newTeam" OnValidSubmit="CreateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Workspace</label>
                <select class="input" value="@createWorkspaceId" @onchange="OnCreateWorkspaceChanged">
                    <option value="">Selecione</option>
                    @foreach (var workspace in workspaces)
                    {
                        <option value="@workspace.Id">@workspace.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="createParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in parentTeams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newTeam.Name" />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar equipe" Size="lg" OnClose="CloseEditModal">
        <EditForm Model="@editTeam" OnValidSubmit="UpdateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="editTeam.Name" />
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="editParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in editParentTeams)
                    {
                        @if (team.Id != selectedTeam?.Id)
                        {
                            <option value="@team.Id">@team.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="form-row" style="margin-top: var(--spacing-4);">
                <label>Colaboradores</label>
                <TransferList TItem="CollaboratorSummaryDto"
                    AvailableItems="@availableCollaboratorsForEdit"
                    AssignedItems="@assignedCollaboratorsForEdit"
                    AssignedItemsChanged="OnCollaboratorsChanged"
                    OnAvailableSearch="SearchAvailableCollaboratorsAsync"
                    GetKey="@(c => c.Id)"
                    GetDisplayText="@(c => c.FullName)"
                    GetSecondaryText="@(c => c.Email)"
                    AvailableTitle="Colaboradores disponíveis"
                    AssignedTitle="Colaboradores atribuídos"
                    SearchPlaceholder="Buscar colaborador..."
                    EmptyAvailableMessage="Nenhum colaborador disponível."
                    EmptyAssignedMessage="Nenhum colaborador atribuído." />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsTeam != null)
{
    <Modal Title="@($"Detalhes: {detailsTeam.Name}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Colaboradores</h3>
                @if (detailsTeamCollaborators == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsTeamCollaborators.Count == 0)
                {
                    <p class="muted">Nenhum colaborador vinculado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var collaborator in detailsTeamCollaborators)
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@collaborator.FullName</span>
                                </div>
                                <span class="detail-email">@collaborator.Email</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private CreateTeamRequest newTeam = new();
    private List<Workspace> workspaces = new();
    private List<Team> parentTeams = new();
    private List<Team> allTeams = new();
    private List<Collaborator> collaborators = new();
    private PagedResult<Team>? teams;
    private string? search;
    private string? selectedWorkspaceId;
    private string? createWorkspaceId;
    private string? createParentTeamId;
    private bool isModalOpen = false;
    private bool showFilterPanel = false;
    private bool showWorkspaceDropdown = false;

    // Estado do modal de edição
    private bool isEditModalOpen = false;
    private Team? selectedTeam = null;
    private UpdateTeamRequest editTeam = new();
    private string? editParentTeamId;
    private List<Team> editParentTeams = new();
    private List<CollaboratorSummaryDto> availableCollaboratorsForEdit = new();
    private List<CollaboratorSummaryDto> assignedCollaboratorsForEdit = new();
    private bool collaboratorsModified = false;

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Team? detailsTeam = null;
    private List<CollaboratorSummaryDto>? detailsTeamCollaborators = null;

    // Estado de confirmação de exclusão
    private Guid? deletingTeamId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkspaces();
        await LoadTeams();
        await LoadCollaborators();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private async void HandleOrganizationChanged()
    {
        await LoadWorkspaces();
        await LoadTeams();
        await LoadCollaborators();
        StateHasChanged();
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadWorkspaces()
    {
        var result = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, null, 1, 100);
        workspaces = result?.Items.ToList() ?? new List<Workspace>();
    }

    private async Task LoadTeams()
    {
        var filterWorkspaceId = Guid.TryParse(selectedWorkspaceId, out var parsedWorkspaceId)
            ? parsedWorkspaceId
            : (Guid?)null;
        teams = await Api.GetTeamsAsync(filterWorkspaceId, null, search, 1, 20) ?? new PagedResult<Team>();

        var allTeamsResult = await Api.GetTeamsAsync(null, null, null, 1, 200);
        allTeams = allTeamsResult?.Items.ToList() ?? new List<Team>();
    }

    private async Task LoadCollaborators()
    {
        var result = await Api.GetCollaboratorsAsync(null, null, 1, 1000);
        collaborators = result?.Items.ToList() ?? new List<Collaborator>();
    }

    // Filter methods
    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;
    private void ToggleWorkspaceDropdown() => showWorkspaceDropdown = !showWorkspaceDropdown;

    private async Task ApplyWorkspaceFilter()
    {
        showWorkspaceDropdown = false;
        await LoadTeams();
    }

    private bool HasActiveFilters() => !string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(selectedWorkspaceId);

    private async Task ClearFilters()
    {
        search = null;
        selectedWorkspaceId = null;
        await LoadTeams();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadTeams();
    }

    private string GetWorkspaceFilterLabel()
    {
        if (string.IsNullOrEmpty(selectedWorkspaceId))
            return "Todos os workspaces";

        var workspace = workspaces.FirstOrDefault(w => w.Id.ToString() == selectedWorkspaceId);
        return workspace?.Name ?? "Todos os workspaces";
    }

    // Summary methods
    private int GetTotalTeamsCount() => teams?.Total ?? 0;
    private int GetRootTeamsCount() => allTeams.Count(t => t.ParentTeamId == null);
    private int GetSubTeamsCount() => allTeams.Count(t => t.ParentTeamId != null);

    private async Task OpenDetailsModal(Team team)
    {
        detailsTeam = team;
        detailsTeamCollaborators = null;
        isDetailsModalOpen = true;

        // Carregar colaboradores da equipe via API
        detailsTeamCollaborators = await Api.GetTeamCollaboratorSummariesAsync(team.Id) ?? new();
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        detailsTeam = null;
        detailsTeamCollaborators = null;
    }

    private async Task OnCreateWorkspaceChanged(ChangeEventArgs e)
    {
        createWorkspaceId = e.Value?.ToString();
        createParentTeamId = null;
        parentTeams.Clear();

        if (Guid.TryParse(createWorkspaceId, out var workspaceId))
        {
            var result = await Api.GetTeamsAsync(workspaceId, null, null, 1, 200);
            parentTeams = result?.Items.ToList() ?? new List<Team>();
        }
    }

    private void OpenCreateModal()
    {
        newTeam = new CreateTeamRequest();
        createWorkspaceId = null;
        createParentTeamId = null;
        parentTeams.Clear();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateTeam()
    {
        if (!Guid.TryParse(createWorkspaceId, out var workspaceId))
        {
            ToastService.ShowError("Erro ao criar equipe", "Selecione um workspace.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newTeam.Name))
        {
            ToastService.ShowError("Erro ao criar equipe", "Informe o nome da equipe.");
            return;
        }

        newTeam.WorkspaceId = workspaceId;
        newTeam.ParentTeamId = Guid.TryParse(createParentTeamId, out var parentId) ? parentId : null;

        try
        {
            await Api.CreateTeamAsync(newTeam);
            var createdTeamName = newTeam.Name;
            newTeam = new CreateTeamRequest();
            createWorkspaceId = null;
            createParentTeamId = null;
            parentTeams.Clear();
            await LoadTeams();

            ToastService.ShowSuccess("Equipe criada com sucesso!", $"A equipe '{createdTeamName}' foi criada.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao criar equipe", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }

    private async Task OpenEditModal(Team team)
    {
        selectedTeam = team;
        editTeam = new UpdateTeamRequest
        {
            Name = team.Name,
            ParentTeamId = team.ParentTeamId
        };
        editParentTeamId = team.ParentTeamId?.ToString() ?? "";

        // Carregar equipes do mesmo workspace para seleção de equipe pai
        var result = await Api.GetTeamsAsync(team.WorkspaceId, null, null, 1, 200);
        editParentTeams = result?.Items.ToList() ?? new List<Team>();

        // Load collaborators for TransferList
        assignedCollaboratorsForEdit = await Api.GetTeamCollaboratorSummariesAsync(team.Id) ?? new();
        availableCollaboratorsForEdit = await Api.GetAvailableCollaboratorsForTeamAsync(team.Id) ?? new();
        collaboratorsModified = false;

        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedTeam = null;
        editTeam = new();
        editParentTeamId = null;
        editParentTeams.Clear();
        availableCollaboratorsForEdit = new();
        assignedCollaboratorsForEdit = new();
        collaboratorsModified = false;
    }

    private async Task UpdateTeam()
    {
        if (selectedTeam == null) return;

        editTeam.ParentTeamId = Guid.TryParse(editParentTeamId, out var parentId) ? parentId : null;

        try
        {
            var result = await Api.UpdateTeamAsync(selectedTeam.Id, editTeam);
            if (result != null)
            {
                // Update collaborators if modified
                if (collaboratorsModified)
                {
                    await Api.UpdateTeamCollaboratorsAsync(selectedTeam.Id, new UpdateTeamCollaboratorsRequest
                    {
                        CollaboratorIds = assignedCollaboratorsForEdit.Select(c => c.Id).ToList()
                    });
                }

                ToastService.ShowSuccess("Equipe atualizada", "As alterações foram salvas com sucesso.");
                CloseEditModal();
                await LoadTeams();
                await LoadCollaborators();
            }
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao atualizar", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }

    private void OnCollaboratorsChanged(List<CollaboratorSummaryDto> collaborators)
    {
        assignedCollaboratorsForEdit = collaborators;
        collaboratorsModified = true;
    }

    private async Task SearchAvailableCollaboratorsAsync(string search)
    {
        if (selectedTeam == null) return;
        availableCollaboratorsForEdit = await Api.GetAvailableCollaboratorsForTeamAsync(selectedTeam.Id, search) ?? new();
    }

    private void HandleDeleteClick(Guid teamId)
    {
        if (deletingTeamId == teamId)
        {
            // Segundo clique - executar exclusão
            _ = DeleteTeam(teamId);
        }
        else
        {
            // Primeiro clique - mostrar confirmação
            deletingTeamId = teamId;

            // Reset após 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingTeamId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteTeam(Guid teamId)
    {
        try
        {
            await Api.DeleteTeamAsync(teamId);
            ToastService.ShowSuccess("Equipe excluída", "A equipe foi removida com sucesso.");
            await LoadTeams();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao excluir", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
        finally
        {
            deletingTeamId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
