@page "/teams"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps
@implements IDisposable

<ManagementPageHeader
    Kicker="Pessoas"
    Title="Equipes"
    Subtitle="Gerencie equipes e subequipes."
    PrimaryActionText="Nova equipe"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros *@
<div class="teams-filter-bar">
    <div class="teams-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(!string.IsNullOrEmpty(selectedWorkspaceId) ? "active" : "")" @onclick="ToggleWorkspaceDropdown">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <rect x="2" y="3" width="12" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M5 7H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M5 10H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>@GetWorkspaceFilterLabel()</span>
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            @if (showWorkspaceDropdown)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Espaço de trabalho</label>
                        <select class="input" @bind="selectedWorkspaceId">
                            <option value="">Todos os espaços de trabalho</option>
                            @foreach (var workspace in workspaces)
                            {
                                <option value="@workspace.Id">@workspace.Name</option>
                            }
                        </select>
                    </div>
                    <button class="button small" @onclick="ApplyWorkspaceFilter">Aplicar</button>
                </div>
            }
        </div>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expansível *@
@if (showFilterPanel)
{
    <div class="teams-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar equipes..." />
            </div>
        </div>
    </div>
}

<SummaryCards CssClass="teams-summary">
    <StatCard Value="@GetTotalTeamsCount().ToString()" Label="Total de equipes" />
    <StatCard Value="@GetRootTeamsCount().ToString()" Label="Equipes raiz" />
    <StatCard Value="@GetSubTeamsCount().ToString()" Label="Subequipes" />
</SummaryCards>

@* Lista de Equipes *@
<div class="teams-table-container">
    <PagedTableSection
        IsLoading="@(teams is null)"
        IsEmpty="@(teams is not null && teams.Items.Count == 0)"
        Total="@(teams?.Total ?? 0)"
        EmptyText="Nenhuma equipe encontrada.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Líder</th>
                    <th>Espaço de trabalho</th>
                    <th>Equipe pai</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var team in teams!.Items)
                {
                    var workspace = workspaces.FirstOrDefault(w => w.Id == team.WorkspaceId);
                    var parent = allTeams.FirstOrDefault(t => t.Id == team.ParentTeamId);
                    var isDeleting = deletingTeamId == team.Id;
                    <tr @onclick="() => OpenDetailsModal(team)" style="cursor: pointer;">
                        <td>@team.Name</td>
                        <td>@(team.Leader?.FullName ?? "—")</td>
                        <td>@(workspace?.Name ?? "—")</td>
                        <td>@(parent?.Name ?? "—")</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar equipe"
                                OnEdit="@(() => OpenEditModal(team))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir equipe"
                                OnDelete="@(() => HandleDeleteClick(team.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="Criar equipe" Size="lg" OnClose="CloseModal">
        <EditForm Model="@newTeam" OnValidSubmit="CreateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Espaço de trabalho</label>
                <select class="input" value="@createWorkspaceId" @onchange="OnCreateWorkspaceChanged">
                    <option value="">Selecione</option>
                    @foreach (var workspace in workspaces)
                    {
                        <option value="@workspace.Id">@workspace.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="createParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in parentTeams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newTeam.Name" />
            </div>
            <TeamCollaboratorSelector
                Leaders="@createLeaders"
                LeaderId="@createLeaderId"
                LeaderIdChanged="@((v) => createLeaderId = v)"
                AvailableCollaborators="@availableCollaboratorsForCreate"
                AssignedCollaborators="@assignedCollaboratorsForCreate"
                AssignedCollaboratorsChanged="OnCreateCollaboratorsChanged"
                OnAvailableSearch="SearchAvailableCollaboratorsForCreateAsync" />
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar equipe" Size="lg" OnClose="CloseEditModal">
        <EditForm Model="@editTeam" OnValidSubmit="UpdateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="editTeam.Name" />
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="editParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in editParentTeams)
                    {
                        @if (team.Id != selectedTeam?.Id)
                        {
                            <option value="@team.Id">@team.Name</option>
                        }
                    }
                </select>
            </div>
            <TeamCollaboratorSelector
                Leaders="@editLeaders"
                LeaderId="@editLeaderId"
                LeaderIdChanged="@((v) => editLeaderId = v)"
                AvailableCollaborators="@availableCollaboratorsForEdit"
                AssignedCollaborators="@assignedCollaboratorsForEdit"
                AssignedCollaboratorsChanged="OnCollaboratorsChanged"
                OnAvailableSearch="SearchAvailableCollaboratorsAsync" />
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsTeam != null)
{
    <Modal Title="@($"Detalhes: {detailsTeam.Name}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Colaboradores</h3>
                @if (detailsTeamCollaborators == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsTeamCollaborators.Count == 0)
                {
                    <p class="muted">Nenhum colaborador vinculado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var collaborator in detailsTeamCollaborators)
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@collaborator.FullName</span>
                                </div>
                                <span class="detail-email">@collaborator.Email</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

