@page "/teams"
@inject ApiClient Api
@inject ToastService ToastService

<ManagementMenu />

<div class="page-header">
    <div>
        <div class="page-kicker">Gestão</div>
        <h1>Equipes</h1>
        <p class="page-subtitle">Crie equipes e subequipes por workspace.</p>
    </div>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Nova equipe
    </button>
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Workspace</label>
            <select class="input" @bind="selectedWorkspaceId" @bind:after="LoadTeams">
                <option value="">Todos</option>
                @foreach (var workspace in workspaces)
                {
                    <option value="@workspace.Id">@workspace.Name</option>
                }
            </select>
        </div>
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadTeams">Atualizar</button>
        </div>
    </div>

    @if (teams is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (teams.Items.Count == 0)
    {
        <p class="muted">Nenhuma equipe encontrada.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Workspace</th>
                    <th>Equipe pai</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var team in teams.Items)
                {
                    var workspace = workspaces.FirstOrDefault(w => w.Id == team.WorkspaceId);
                    var parent = allTeams.FirstOrDefault(t => t.Id == team.ParentTeamId);
                    <tr>
                        <td>@team.Name</td>
                        <td>@(workspace?.Name ?? "—")</td>
                        <td>@(parent?.Name ?? "—")</td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @teams.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar equipe" OnClose="CloseModal">
        <EditForm Model="@newTeam" OnValidSubmit="CreateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Workspace</label>
                <select class="input" value="@createWorkspaceId" @onchange="OnCreateWorkspaceChanged">
                    <option value="">Selecione</option>
                    @foreach (var workspace in workspaces)
                    {
                        <option value="@workspace.Id">@workspace.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="createParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in parentTeams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newTeam.Name" />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@code {
    private CreateTeamRequest newTeam = new();
    private List<Workspace> workspaces = new();
    private List<Team> parentTeams = new();
    private List<Team> allTeams = new();
    private PagedResult<Team>? teams;
    private string? search;
    private string? selectedWorkspaceId;
    private string? createWorkspaceId;
    private string? createParentTeamId;
    private bool isModalOpen = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkspaces();
        await LoadTeams();
    }

    private async Task LoadWorkspaces()
    {
        var result = await Api.GetWorkspacesAsync(null, null, 1, 100);
        workspaces = result?.Items.ToList() ?? new List<Workspace>();
    }

    private async Task LoadTeams()
    {
        var filterWorkspaceId = Guid.TryParse(selectedWorkspaceId, out var parsedWorkspaceId)
            ? parsedWorkspaceId
            : (Guid?)null;
        teams = await Api.GetTeamsAsync(filterWorkspaceId, null, search, 1, 20) ?? new PagedResult<Team>();

        var allTeamsResult = await Api.GetTeamsAsync(null, null, null, 1, 200);
        allTeams = allTeamsResult?.Items.ToList() ?? new List<Team>();
    }

    private async Task OnCreateWorkspaceChanged(ChangeEventArgs e)
    {
        createWorkspaceId = e.Value?.ToString();
        createParentTeamId = null;
        parentTeams.Clear();

        if (Guid.TryParse(createWorkspaceId, out var workspaceId))
        {
            var result = await Api.GetTeamsAsync(workspaceId, null, null, 1, 200);
            parentTeams = result?.Items.ToList() ?? new List<Team>();
        }
    }

    private void OpenCreateModal()
    {
        newTeam = new CreateTeamRequest();
        createWorkspaceId = null;
        createParentTeamId = null;
        parentTeams.Clear();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateTeam()
    {
        if (!Guid.TryParse(createWorkspaceId, out var workspaceId))
        {
            ToastService.ShowError("Erro ao criar equipe", "Selecione um workspace.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newTeam.Name))
        {
            ToastService.ShowError("Erro ao criar equipe", "Informe o nome da equipe.");
            return;
        }

        newTeam.WorkspaceId = workspaceId;
        newTeam.ParentTeamId = Guid.TryParse(createParentTeamId, out var parentId) ? parentId : null;

        await Api.CreateTeamAsync(newTeam);
        var createdTeamName = newTeam.Name;
        newTeam = new CreateTeamRequest();
        createWorkspaceId = null;
        createParentTeamId = null;
        parentTeams.Clear();
        await LoadTeams();

        ToastService.ShowSuccess("Equipe criada com sucesso!", $"A equipe '{createdTeamName}' foi criada.");
        CloseModal();
    }
}
