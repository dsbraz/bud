@page "/teams"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps
@implements IDisposable

<ManagementMenu />

<ManagementPageHeader
    Kicker="Gestão"
    Title="Equipes"
    Subtitle="Gerencie equipes e subequipes."
    PrimaryActionText="Nova equipe"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros *@
<div class="teams-filter-bar">
    <div class="teams-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        <div class="filter-chip-wrapper">
            <button class="filter-chip @(!string.IsNullOrEmpty(selectedWorkspaceId) ? "active" : "")" @onclick="ToggleWorkspaceDropdown">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <rect x="2" y="3" width="12" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M5 7H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M5 10H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>@GetWorkspaceFilterLabel()</span>
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            @if (showWorkspaceDropdown)
            {
                <div class="filter-dropdown">
                    <div class="filter-dropdown-row">
                        <label>Espaço de trabalho</label>
                        <select class="input" @bind="selectedWorkspaceId">
                            <option value="">Todos os espaços de trabalho</option>
                            @foreach (var workspace in workspaces)
                            {
                                <option value="@workspace.Id">@workspace.Name</option>
                            }
                        </select>
                    </div>
                    <button class="button small" @onclick="ApplyWorkspaceFilter">Aplicar</button>
                </div>
            }
        </div>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expansível *@
@if (showFilterPanel)
{
    <div class="teams-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar equipes..." />
            </div>
        </div>
    </div>
}

<SummaryCards CssClass="teams-summary">
    <StatCard Value="@GetTotalTeamsCount().ToString()" Label="Total de equipes" />
    <StatCard Value="@GetRootTeamsCount().ToString()" Label="Equipes raiz" />
    <StatCard Value="@GetSubTeamsCount().ToString()" Label="Subequipes" />
</SummaryCards>

@* Lista de Equipes *@
<div class="teams-table-container">
    <PagedTableSection
        IsLoading="@(teams is null)"
        IsEmpty="@(teams is not null && teams.Items.Count == 0)"
        Total="@(teams?.Total ?? 0)"
        EmptyText="Nenhuma equipe encontrada.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Líder</th>
                    <th>Espaço de trabalho</th>
                    <th>Equipe pai</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var team in teams!.Items)
                {
                    var workspace = workspaces.FirstOrDefault(w => w.Id == team.WorkspaceId);
                    var parent = allTeams.FirstOrDefault(t => t.Id == team.ParentTeamId);
                    var isDeleting = deletingTeamId == team.Id;
                    <tr @onclick="() => OpenDetailsModal(team)" style="cursor: pointer;">
                        <td>@team.Name</td>
                        <td>@(team.Leader?.FullName ?? "—")</td>
                        <td>@(workspace?.Name ?? "—")</td>
                        <td>@(parent?.Name ?? "—")</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar equipe"
                                OnEdit="@(() => OpenEditModal(team))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir equipe"
                                OnDelete="@(() => HandleDeleteClick(team.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="Criar equipe" Size="lg" OnClose="CloseModal">
        <EditForm Model="@newTeam" OnValidSubmit="CreateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Espaço de trabalho</label>
                <select class="input" value="@createWorkspaceId" @onchange="OnCreateWorkspaceChanged">
                    <option value="">Selecione</option>
                    @foreach (var workspace in workspaces)
                    {
                        <option value="@workspace.Id">@workspace.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="createParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in parentTeams)
                    {
                        <option value="@team.Id">@team.Name</option>
                    }
                </select>
            </div>
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newTeam.Name" />
            </div>
            <TeamCollaboratorSelector
                Leaders="@createLeaders"
                LeaderId="@createLeaderId"
                LeaderIdChanged="@((v) => createLeaderId = v)"
                AvailableCollaborators="@availableCollaboratorsForCreate"
                AssignedCollaborators="@assignedCollaboratorsForCreate"
                AssignedCollaboratorsChanged="OnCreateCollaboratorsChanged"
                OnAvailableSearch="SearchAvailableCollaboratorsForCreateAsync" />
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar equipe" Size="lg" OnClose="CloseEditModal">
        <EditForm Model="@editTeam" OnValidSubmit="UpdateTeam">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="editTeam.Name" />
            </div>
            <div class="form-row">
                <label>Equipe pai (opcional)</label>
                <select class="input" @bind="editParentTeamId">
                    <option value="">Nenhuma</option>
                    @foreach (var team in editParentTeams)
                    {
                        @if (team.Id != selectedTeam?.Id)
                        {
                            <option value="@team.Id">@team.Name</option>
                        }
                    }
                </select>
            </div>
            <TeamCollaboratorSelector
                Leaders="@editLeaders"
                LeaderId="@editLeaderId"
                LeaderIdChanged="@((v) => editLeaderId = v)"
                AvailableCollaborators="@availableCollaboratorsForEdit"
                AssignedCollaborators="@assignedCollaboratorsForEdit"
                AssignedCollaboratorsChanged="OnCollaboratorsChanged"
                OnAvailableSearch="SearchAvailableCollaboratorsAsync" />
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsTeam != null)
{
    <Modal Title="@($"Detalhes: {detailsTeam.Name}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Colaboradores</h3>
                @if (detailsTeamCollaborators == null)
                {
                    <p class="muted">Carregando...</p>
                }
                else if (detailsTeamCollaborators.Count == 0)
                {
                    <p class="muted">Nenhum colaborador vinculado.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var collaborator in detailsTeamCollaborators)
                        {
                            <li class="detail-list-item">
                                <div class="detail-collab-main">
                                    <span class="detail-name">@collaborator.FullName</span>
                                </div>
                                <span class="detail-email">@collaborator.Email</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private CreateTeamRequest newTeam = new();
    private List<Workspace> workspaces = new();
    private List<Team> parentTeams = new();
    private List<Team> allTeams = new();
    private List<Collaborator> collaborators = new();
    private PagedResult<Team>? teams;
    private string? search;
    private string? selectedWorkspaceId;
    private string? createWorkspaceId;
    private string? createParentTeamId;
    private bool isModalOpen = false;
    private bool showFilterPanel = false;
    private bool showWorkspaceDropdown = false;

    // Estado do modal de criação — líder + colaboradores
    private List<LeaderCollaboratorResponse> createLeaders = new();
    private string createLeaderId = "";
    private List<CollaboratorSummaryDto> availableCollaboratorsForCreate = new();
    private List<CollaboratorSummaryDto> assignedCollaboratorsForCreate = new();

    // Estado do modal de edição
    private bool isEditModalOpen = false;
    private Team? selectedTeam = null;
    private UpdateTeamRequest editTeam = new();
    private string? editParentTeamId;
    private List<Team> editParentTeams = new();
    private List<LeaderCollaboratorResponse> editLeaders = new();
    private string editLeaderId = "";
    private List<CollaboratorSummaryDto> availableCollaboratorsForEdit = new();
    private List<CollaboratorSummaryDto> assignedCollaboratorsForEdit = new();
    private bool collaboratorsModified = false;

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Team? detailsTeam = null;
    private List<CollaboratorSummaryDto>? detailsTeamCollaborators = null;

    // Estado de confirmação de exclusão
    private Guid? deletingTeamId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkspaces();
        await LoadTeams();
        await LoadCollaborators();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadWorkspaces();
            await LoadTeams();
            await LoadCollaborators();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar equipes por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar equipes", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadWorkspaces()
    {
        var result = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, null, 1, 100);
        workspaces = result?.Items.ToList() ?? new List<Workspace>();
    }

    private async Task LoadTeams()
    {
        var filterWorkspaceId = Guid.TryParse(selectedWorkspaceId, out var parsedWorkspaceId)
            ? parsedWorkspaceId
            : (Guid?)null;
        teams = await Api.GetTeamsAsync(filterWorkspaceId, null, search, 1, 20) ?? new PagedResult<Team>();

        var allTeamsResult = await Api.GetTeamsAsync(null, null, null, 1, 100);
        allTeams = allTeamsResult?.Items.ToList() ?? new List<Team>();
    }

    private async Task LoadCollaborators()
    {
        var result = await Api.GetCollaboratorsAsync(null, null, 1, 100);
        collaborators = result?.Items.ToList() ?? new List<Collaborator>();
    }

    // Filter methods
    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;
    private void ToggleWorkspaceDropdown() => showWorkspaceDropdown = !showWorkspaceDropdown;

    private async Task ApplyWorkspaceFilter()
    {
        showWorkspaceDropdown = false;
        await LoadTeams();
    }

    private bool HasActiveFilters() => !string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(selectedWorkspaceId);

    private async Task ClearFilters()
    {
        search = null;
        selectedWorkspaceId = null;
        await LoadTeams();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadTeams();
    }

    private string GetWorkspaceFilterLabel()
    {
        if (string.IsNullOrEmpty(selectedWorkspaceId))
            return "Todos os espaços de trabalho";

        var workspace = workspaces.FirstOrDefault(w => w.Id.ToString() == selectedWorkspaceId);
        return workspace?.Name ?? "Todos os espaços de trabalho";
    }

    // Summary methods
    private int GetTotalTeamsCount() => teams?.Total ?? 0;
    private int GetRootTeamsCount() => allTeams.Count(t => t.ParentTeamId == null);
    private int GetSubTeamsCount() => allTeams.Count(t => t.ParentTeamId != null);

    private async Task OpenDetailsModal(Team team)
    {
        detailsTeam = team;
        detailsTeamCollaborators = null;
        isDetailsModalOpen = true;

        // Carregar colaboradores da equipe via API
        detailsTeamCollaborators = await Api.GetTeamCollaboratorSummariesAsync(team.Id) ?? new();
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        detailsTeam = null;
        detailsTeamCollaborators = null;
    }

    private async Task OnCreateWorkspaceChanged(ChangeEventArgs e)
    {
        createWorkspaceId = e.Value?.ToString();
        createParentTeamId = null;
        parentTeams.Clear();

        if (Guid.TryParse(createWorkspaceId, out var workspaceId))
        {
            var result = await Api.GetTeamsAsync(workspaceId, null, null, 1, 100);
            parentTeams = result?.Items.ToList() ?? new List<Team>();
        }
    }

    private async Task OpenCreateModal()
    {
        newTeam = new CreateTeamRequest();
        createWorkspaceId = null;
        createParentTeamId = null;
        createLeaderId = "";
        parentTeams.Clear();
        assignedCollaboratorsForCreate = new();

        createLeaders = await Api.GetLeadersAsync() ?? new();
        availableCollaboratorsForCreate = await Api.GetCollaboratorSummariesAsync() ?? new();

        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateTeam()
    {
        if (!Guid.TryParse(createWorkspaceId, out var workspaceId))
        {
            ToastService.ShowError("Erro ao criar equipe", "Selecione um espaço de trabalho.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newTeam.Name))
        {
            ToastService.ShowError("Erro ao criar equipe", "Informe o nome da equipe.");
            return;
        }

        if (!Guid.TryParse(createLeaderId, out var leaderId))
        {
            ToastService.ShowError("Erro ao criar equipe", "Selecione um líder para a equipe.");
            return;
        }

        newTeam.WorkspaceId = workspaceId;
        newTeam.LeaderId = leaderId;
        newTeam.ParentTeamId = Guid.TryParse(createParentTeamId, out var parentId) ? parentId : null;

        if (!assignedCollaboratorsForCreate.Any(c => c.Id == leaderId))
        {
            ToastService.ShowError("Erro ao criar equipe", "O líder da equipe deve estar incluído na lista de membros.");
            return;
        }

        await UiOps.RunAsync(
            async () =>
            {
                var createdTeam = await Api.CreateTeamAsync(newTeam);
                var createdTeamName = newTeam.Name;

                if (createdTeam != null && assignedCollaboratorsForCreate.Count > 0)
                {
                    await Api.UpdateTeamCollaboratorsAsync(createdTeam.Id, new UpdateTeamCollaboratorsRequest
                    {
                        CollaboratorIds = assignedCollaboratorsForCreate.Select(c => c.Id).ToList()
                    });
                }

                newTeam = new CreateTeamRequest();
                createWorkspaceId = null;
                createParentTeamId = null;
                createLeaderId = "";
                parentTeams.Clear();
                assignedCollaboratorsForCreate = new();
                await LoadTeams();

                ToastService.ShowSuccess("Equipe criada com sucesso!", $"A equipe '{createdTeamName}' foi criada.");
                CloseModal();
            },
            "Erro ao criar equipe",
            "Não foi possível criar a equipe. Verifique os dados e tente novamente.");
    }

    private async Task OpenEditModal(Team team)
    {
        selectedTeam = team;
        editTeam = new UpdateTeamRequest
        {
            Name = team.Name,
            ParentTeamId = team.ParentTeamId
        };
        editParentTeamId = team.ParentTeamId?.ToString() ?? "";
        editLeaderId = team.LeaderId.ToString();

        // Carregar equipes do mesmo workspace para seleção de equipe pai
        var result = await Api.GetTeamsAsync(team.WorkspaceId, null, null, 1, 100);
        editParentTeams = result?.Items.ToList() ?? new List<Team>();

        // Load leaders and collaborators
        editLeaders = await Api.GetLeadersAsync() ?? new();
        assignedCollaboratorsForEdit = await Api.GetTeamCollaboratorSummariesAsync(team.Id) ?? new();
        availableCollaboratorsForEdit = await Api.GetAvailableCollaboratorsForTeamAsync(team.Id) ?? new();
        collaboratorsModified = false;

        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedTeam = null;
        editTeam = new();
        editParentTeamId = null;
        editLeaderId = "";
        editParentTeams.Clear();
        editLeaders = new();
        availableCollaboratorsForEdit = new();
        assignedCollaboratorsForEdit = new();
        collaboratorsModified = false;
    }

    private async Task UpdateTeam()
    {
        if (selectedTeam == null) return;

        if (!Guid.TryParse(editLeaderId, out var leaderId))
        {
            ToastService.ShowError("Erro ao atualizar", "Selecione um líder para a equipe.");
            return;
        }

        editTeam.ParentTeamId = Guid.TryParse(editParentTeamId, out var parentId) ? parentId : null;
        editTeam.LeaderId = leaderId;

        if (collaboratorsModified && !assignedCollaboratorsForEdit.Any(c => c.Id == leaderId))
        {
            ToastService.ShowError("Erro ao atualizar", "O líder da equipe deve estar incluído na lista de membros.");
            return;
        }

        await UiOps.RunAsync(
            async () =>
            {
                var result = await Api.UpdateTeamAsync(selectedTeam.Id, editTeam);
                if (result != null)
                {
                    if (collaboratorsModified)
                    {
                        await Api.UpdateTeamCollaboratorsAsync(selectedTeam.Id, new UpdateTeamCollaboratorsRequest
                        {
                            CollaboratorIds = assignedCollaboratorsForEdit.Select(c => c.Id).ToList()
                        });
                    }

                    ToastService.ShowSuccess("Equipe atualizada", "As alterações foram salvas com sucesso.");
                    CloseEditModal();
                    await LoadTeams();
                    await LoadCollaborators();
                }
            },
            "Erro ao atualizar",
            "Não foi possível atualizar a equipe. Verifique os dados e tente novamente.");
    }

    private void OnCreateCollaboratorsChanged(List<CollaboratorSummaryDto> collaborators)
    {
        assignedCollaboratorsForCreate = collaborators;
    }

    private async Task SearchAvailableCollaboratorsForCreateAsync(string search)
    {
        availableCollaboratorsForCreate = await Api.GetCollaboratorSummariesAsync(search) ?? new();
    }

    private void OnCollaboratorsChanged(List<CollaboratorSummaryDto> collaborators)
    {
        assignedCollaboratorsForEdit = collaborators;
        collaboratorsModified = true;
    }

    private async Task SearchAvailableCollaboratorsAsync(string search)
    {
        if (selectedTeam == null) return;
        availableCollaboratorsForEdit = await Api.GetAvailableCollaboratorsForTeamAsync(selectedTeam.Id, search) ?? new();
    }

    private void HandleDeleteClick(Guid teamId)
    {
        if (deletingTeamId == teamId)
        {
            // Segundo clique - executar exclusão
            _ = DeleteTeam(teamId);
        }
        else
        {
            // Primeiro clique - mostrar confirmação
            deletingTeamId = teamId;

            // Reset após 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingTeamId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteTeam(Guid teamId)
    {
        try
        {
            await UiOps.RunAsync(
                async () =>
                {
                    await Api.DeleteTeamAsync(teamId);
                    ToastService.ShowSuccess("Equipe excluída", "A equipe foi removida com sucesso.");
                    await LoadTeams();
                },
                "Erro ao excluir",
                "Não foi possível excluir a equipe. Tente novamente.");
        }
        finally
        {
            deletingTeamId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
