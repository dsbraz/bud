@page "/workspaces"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<ManagementMenu />

@* Header *@
<div class="workspaces-page-header">
    <h1 class="workspaces-page-title">Workspaces</h1>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Novo workspace
    </button>
</div>

@* Barra de Filtros *@
<div class="workspaces-filter-bar">
    <div class="workspaces-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expansível *@
@if (showFilterPanel)
{
    <div class="workspaces-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar workspaces..." />
            </div>
        </div>
    </div>
}

@* Cards de Resumo *@
<div class="workspaces-summary">
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetTotalWorkspacesCount()</div>
        <div class="summary-card-label">Total de workspaces</div>
    </div>
    <div class="summary-card" style="align-items: center; text-align: center;">
        <div class="summary-card-value">@GetTotalTeamsCount()</div>
        <div class="summary-card-label">Equipes</div>
    </div>
</div>

@* Lista de Workspaces *@
<div class="workspaces-table-container">
    @if (workspaces is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (workspaces.Items.Count == 0)
    {
        <p class="muted">Nenhum workspace encontrado.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Organização</th>
                    <th>ID</th>
                    <th style="width: 120px; text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var workspace in workspaces.Items)
                {
                    var org = organizations.FirstOrDefault(o => o.Id == workspace.OrganizationId);
                    var isDeleting = deletingWorkspaceId == workspace.Id;
                    <tr @onclick="() => OpenDetailsModal(workspace)" style="cursor: pointer;">
                        <td>@workspace.Name</td>
                        <td>@(org?.Name ?? "—")</td>
                        <td class="mono">@workspace.Id</td>
                        <td style="text-align: center;">
                            <div class="table-actions">
                                <button class="button-icon" @onclick="() => OpenEditModal(workspace)"
                                        @onclick:stopPropagation="true"
                                        title="Editar workspace">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M11.334 2.00004C11.5091 1.82494 11.7169 1.68605 11.9457 1.59129C12.1745 1.49653 12.4197 1.44775 12.6673 1.44775C12.9149 1.44775 13.1601 1.49653 13.3889 1.59129C13.6177 1.68605 13.8256 1.82494 14.0007 2.00004C14.1758 2.17513 14.3147 2.383 14.4094 2.61178C14.5042 2.84055 14.553 3.08575 14.553 3.33337C14.553 3.58099 14.5042 3.82619 14.4094 4.05497C14.3147 4.28374 14.1758 4.49161 14.0007 4.66671L5.00065 13.6667L1.33398 14.6667L2.33398 11L11.334 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="button-icon @(isDeleting ? "danger" : "")"
                                        @onclick="() => HandleDeleteClick(workspace.Id)"
                                        @onclick:stopPropagation="true"
                                        title="@(isDeleting ? "Clique novamente para confirmar" : "Excluir workspace")">
                                    @if (isDeleting)
                                    {
                                        <span style="font-size: 11px; white-space: nowrap;">Confirmar?</span>
                                    }
                                    else
                                    {
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M5.33398 4.00004V2.66671C5.33398 2.31309 5.47446 1.97395 5.72451 1.7239C5.97456 1.47385 6.3137 1.33337 6.66732 1.33337H9.33398C9.6876 1.33337 10.0268 1.47385 10.2768 1.7239C10.5269 1.97395 10.6673 2.31309 10.6673 2.66671V4.00004M12.6673 4.00004V13.3334C12.6673 13.687 12.5269 14.0261 12.2768 14.2762C12.0268 14.5262 11.6876 14.6667 11.334 14.6667H4.66732C4.3137 14.6667 3.97456 14.5262 3.72451 14.2762C3.47446 14.0261 3.33398 13.687 3.33398 13.3334V4.00004H12.6673Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    }
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @workspaces.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar workspace" OnClose="CloseModal">
        <EditForm Model="@newWorkspace" OnValidSubmit="CreateWorkspace">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newWorkspace.Name" />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar workspace" OnClose="CloseEditModal">
        <EditForm Model="@editWorkspace" OnValidSubmit="UpdateWorkspace">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="editWorkspace.Name" />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsWorkspace != null)
{
    var workspaceTeams = teams.Where(t => t.WorkspaceId == detailsWorkspace.Id).ToList();

    <Modal Title="@($"Detalhes: {detailsWorkspace.Name}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Equipes</h3>
                @if (workspaceTeams.Count == 0)
                {
                    <p class="muted">Nenhuma equipe vinculada.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var team in workspaceTeams)
                        {
                            <li class="detail-list-item">
                                <span class="detail-name">@team.Name</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private CreateWorkspaceRequest newWorkspace = new();
    private List<Organization> organizations = new();
    private List<Team> teams = new();
    private PagedResult<Workspace>? workspaces;
    private string? search;
    private bool isModalOpen = false;
    private bool showFilterPanel = false;

    // Estado do modal de edição
    private bool isEditModalOpen = false;
    private Workspace? selectedWorkspace = null;
    private UpdateWorkspaceRequest editWorkspace = new();

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Workspace? detailsWorkspace = null;

    // Estado de confirmação de exclusão
    private Guid? deletingWorkspaceId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizations();
        await LoadWorkspaces();
        await LoadTeams();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadWorkspaces();
            await LoadTeams();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar workspaces por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar workspaces", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadOrganizations()
    {
        var result = await Api.GetOrganizationsAsync(null, 1, 100);
        organizations = result?.Items.ToList() ?? new List<Organization>();
    }

    private async Task LoadWorkspaces()
    {
        workspaces = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, search, 1, 20) ?? new PagedResult<Workspace>();
    }

    private async Task LoadTeams()
    {
        var result = await Api.GetTeamsAsync(null, null, null, 1, 100);
        teams = result?.Items.ToList() ?? new List<Team>();
    }

    // Filter methods
    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;

    private bool HasActiveFilters() => !string.IsNullOrEmpty(search);

    private async Task ClearFilters()
    {
        search = null;
        await LoadWorkspaces();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadWorkspaces();
    }

    // Summary methods
    private int GetTotalWorkspacesCount() => workspaces?.Total ?? 0;
    private int GetTotalTeamsCount() => teams.Count;

    private void OpenDetailsModal(Workspace workspace)
    {
        detailsWorkspace = workspace;
        isDetailsModalOpen = true;
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        detailsWorkspace = null;
    }

    private void OpenCreateModal()
    {
        newWorkspace = new CreateWorkspaceRequest();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateWorkspace()
    {
        if (!OrgContext.SelectedOrganizationId.HasValue)
        {
            ToastService.ShowError("Erro ao criar workspace", "Selecione uma organização específica no menu lateral. Não é possível criar workspaces com 'TODOS' selecionado.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newWorkspace.Name))
        {
            ToastService.ShowError("Erro ao criar workspace", "Informe o nome do workspace.");
            return;
        }

        newWorkspace.OrganizationId = OrgContext.SelectedOrganizationId.Value;

        try
        {
            await Api.CreateWorkspaceAsync(newWorkspace);
            var workspaceName = newWorkspace.Name;
            newWorkspace = new CreateWorkspaceRequest();
            await LoadWorkspaces();

            ToastService.ShowSuccess("Workspace criado com sucesso!", $"O workspace '{workspaceName}' foi criado.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            Console.Error.WriteLine($"Erro HTTP ao criar workspace: {ex.Message}");
            ToastService.ShowError("Erro ao criar workspace", "Não foi possível criar o workspace. Verifique os dados e tente novamente.");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro inesperado ao criar workspace: {ex.Message}");
            ToastService.ShowError("Erro inesperado", "Não foi possível criar o workspace. Tente novamente.");
        }
    }

    private void OpenEditModal(Workspace workspace)
    {
        selectedWorkspace = workspace;
        editWorkspace = new UpdateWorkspaceRequest
        {
            Name = workspace.Name
        };
        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedWorkspace = null;
        editWorkspace = new();
    }

    private async Task UpdateWorkspace()
    {
        if (selectedWorkspace == null) return;

        try
        {
            var result = await Api.UpdateWorkspaceAsync(selectedWorkspace.Id, editWorkspace);
            if (result != null)
            {
                ToastService.ShowSuccess("Workspace atualizado", "As alterações foram salvas com sucesso.");
                CloseEditModal();
                await LoadWorkspaces();
            }
        }
        catch (HttpRequestException ex)
        {
            Console.Error.WriteLine($"Erro HTTP ao atualizar workspace: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar", "Não foi possível atualizar o workspace. Verifique os dados e tente novamente.");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro inesperado ao atualizar workspace: {ex.Message}");
            ToastService.ShowError("Erro inesperado", "Não foi possível atualizar o workspace. Tente novamente.");
        }
    }

    private void HandleDeleteClick(Guid workspaceId)
    {
        if (deletingWorkspaceId == workspaceId)
        {
            // Segundo clique - executar exclusão
            _ = DeleteWorkspace(workspaceId);
        }
        else
        {
            // Primeiro clique - mostrar confirmação
            deletingWorkspaceId = workspaceId;

            // Reset após 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingWorkspaceId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteWorkspace(Guid workspaceId)
    {
        try
        {
            await Api.DeleteWorkspaceAsync(workspaceId);
            ToastService.ShowSuccess("Workspace excluído", "O workspace foi removido com sucesso.");
            await LoadWorkspaces();
        }
        catch (HttpRequestException ex)
        {
            Console.Error.WriteLine($"Erro HTTP ao excluir workspace: {ex.Message}");
            ToastService.ShowError("Erro ao excluir", "Não foi possível excluir o workspace. Tente novamente.");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro inesperado ao excluir workspace: {ex.Message}");
            ToastService.ShowError("Erro inesperado", "Não foi possível excluir o workspace. Tente novamente.");
        }
        finally
        {
            deletingWorkspaceId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
