@page "/workspaces"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@inject UiOperationService UiOps
@implements IDisposable

<ManagementPageHeader
    Kicker="Pessoas"
    Title="Espaços de trabalho"
    Subtitle="Gerencie espaços de trabalho por organização."
    PrimaryActionText="Novo espaço de trabalho"
    OnPrimaryAction="OpenCreateModal" />

@* Barra de Filtros *@
<div class="workspaces-filter-bar">
    <div class="workspaces-filter-left">
        <button class="filter-chip @(showFilterPanel ? "active" : "")" @onclick="ToggleFilterPanel">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M14.6667 2H1.33334L6.66668 8.30667V12.6667L9.33334 14V8.30667L14.6667 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filtrar
        </button>
        @if (HasActiveFilters())
        {
            <button class="filter-chip" @onclick="ClearFilters">
                Limpar filtro
            </button>
        }
    </div>
</div>

@* Painel de Filtros Expansível *@
@if (showFilterPanel)
{
    <div class="workspaces-filter-panel">
        <div class="filter-panel-row">
            <div class="filter-panel-field">
                <label>Busca</label>
                <InputText class="input" @bind-Value="search" @onkeyup="OnSearchKeyUp" placeholder="Buscar espaços de trabalho..." />
            </div>
        </div>
    </div>
}

<SummaryCards CssClass="workspaces-summary">
    <StatCard Value="@GetTotalWorkspacesCount().ToString()" Label="Total de espaços de trabalho" />
    <StatCard Value="@GetTotalTeamsCount().ToString()" Label="Equipes" />
</SummaryCards>

@* Lista de Workspaces *@
<div class="workspaces-table-container">
    <PagedTableSection
        IsLoading="@(workspaces is null)"
        IsEmpty="@(workspaces is not null && workspaces.Items.Count == 0)"
        Total="@(workspaces?.Total ?? 0)"
        EmptyText="Nenhum espaço de trabalho encontrado.">
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Organização</th>
                    <th>ID</th>
                    <th class="th-actions">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var workspace in workspaces!.Items)
                {
                    var org = organizations.FirstOrDefault(o => o.Id == workspace.OrganizationId);
                    var isDeleting = deletingWorkspaceId == workspace.Id;
                    <tr @onclick="() => OpenDetailsModal(workspace)" style="cursor: pointer;">
                        <td>@workspace.Name</td>
                        <td>@(org?.Name ?? "—")</td>
                        <td class="mono">@workspace.Id</td>
                        <td style="text-align: center;">
                            <CrudRowActions
                                StopPropagation="true"
                                EditTitle="Editar espaço de trabalho"
                                OnEdit="@(() => OpenEditModal(workspace))"
                                IsDeleteConfirming="@isDeleting"
                                DeleteTitle="Excluir espaço de trabalho"
                                OnDelete="@(() => HandleDeleteClick(workspace.Id))" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </PagedTableSection>
</div>

@if (isModalOpen)
{
    <Modal Title="Criar espaço de trabalho" OnClose="CloseModal">
        <EditForm Model="@newWorkspace" OnValidSubmit="CreateWorkspace">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newWorkspace.Name" />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isEditModalOpen)
{
    <Modal Title="Editar espaço de trabalho" OnClose="CloseEditModal">
        <EditForm Model="@editWorkspace" OnValidSubmit="UpdateWorkspace">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="editWorkspace.Name" />
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseEditModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar alterações</button>
            </div>
        </EditForm>
    </Modal>
}

@if (isDetailsModalOpen && detailsWorkspace != null)
{
    var workspaceTeams = teams.Where(t => t.WorkspaceId == detailsWorkspace.Id).ToList();

    <Modal Title="@($"Detalhes: {detailsWorkspace.Name}")" OnClose="CloseDetailsModal">
        <ChildContent>
            <div class="detail-section">
                <h3 class="detail-section-title">Equipes</h3>
                @if (workspaceTeams.Count == 0)
                {
                    <p class="muted">Nenhuma equipe vinculada.</p>
                }
                else
                {
                    <ul class="detail-list">
                        @foreach (var team in workspaceTeams)
                        {
                            <li class="detail-list-item">
                                <span class="detail-name">@team.Name</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </ChildContent>
    </Modal>
}

@code {
    private CreateWorkspaceRequest newWorkspace = new();
    private List<Organization> organizations = new();
    private List<Team> teams = new();
    private PagedResult<Workspace>? workspaces;
    private string? search;
    private bool isModalOpen = false;
    private bool showFilterPanel = false;

    // Estado do modal de edição
    private bool isEditModalOpen = false;
    private Workspace? selectedWorkspace = null;
    private PatchWorkspaceRequest editWorkspace = new();

    // Estado do modal de detalhes
    private bool isDetailsModalOpen = false;
    private Workspace? detailsWorkspace = null;

    // Estado de confirmação de exclusão
    private Guid? deletingWorkspaceId = null;
    private System.Threading.Timer? deleteConfirmTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizations();
        await LoadWorkspaces();
        await LoadTeams();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private void HandleOrganizationChanged()
    {
        _ = HandleOrganizationChangedAsync();
    }

    private async Task HandleOrganizationChangedAsync()
    {
        try
        {
            await LoadWorkspaces();
            await LoadTeams();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Erro ao atualizar espaços de trabalho por troca de organização: {ex.Message}");
            ToastService.ShowError("Erro ao atualizar espaços de trabalho", "Não foi possível atualizar os dados da organização selecionada.");
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
        deleteConfirmTimer?.Dispose();
    }

    private async Task LoadOrganizations()
    {
        var result = await Api.GetOrganizationsAsync(null, 1, 100);
        organizations = result?.Items.ToList() ?? new List<Organization>();
    }

    private async Task LoadWorkspaces()
    {
        workspaces = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, search, 1, 20) ?? new PagedResult<Workspace>();
    }

    private async Task LoadTeams()
    {
        var result = await Api.GetTeamsAsync(null, null, null, 1, 100);
        teams = result?.Items.ToList() ?? new List<Team>();
    }

    // Filter methods
    private void ToggleFilterPanel() => showFilterPanel = !showFilterPanel;

    private bool HasActiveFilters() => !string.IsNullOrEmpty(search);

    private async Task ClearFilters()
    {
        search = null;
        await LoadWorkspaces();
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadWorkspaces();
    }

    // Summary methods
    private int GetTotalWorkspacesCount() => workspaces?.Total ?? 0;
    private int GetTotalTeamsCount() => teams.Count;

    private void OpenDetailsModal(Workspace workspace)
    {
        detailsWorkspace = workspace;
        isDetailsModalOpen = true;
    }

    private void CloseDetailsModal()
    {
        isDetailsModalOpen = false;
        detailsWorkspace = null;
    }

    private void OpenCreateModal()
    {
        newWorkspace = new CreateWorkspaceRequest();
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateWorkspace()
    {
        if (!OrgContext.SelectedOrganizationId.HasValue)
        {
            ToastService.ShowError("Erro ao criar espaço de trabalho", "Selecione uma organização específica no menu lateral. Não é possível criar espaços de trabalho com 'TODOS' selecionado.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newWorkspace.Name))
        {
            ToastService.ShowError("Erro ao criar espaço de trabalho", "Informe o nome do espaço de trabalho.");
            return;
        }

        newWorkspace.OrganizationId = OrgContext.SelectedOrganizationId.Value;

        await UiOps.RunAsync(
            async () =>
            {
                await Api.CreateWorkspaceAsync(newWorkspace);
                var workspaceName = newWorkspace.Name;
                newWorkspace = new CreateWorkspaceRequest();
                await LoadWorkspaces();

                ToastService.ShowSuccess("Espaço de trabalho criado com sucesso!", $"O espaço de trabalho '{workspaceName}' foi criado.");
                CloseModal();
            },
            "Erro ao criar espaço de trabalho",
            "Não foi possível criar o espaço de trabalho. Verifique os dados e tente novamente.");
    }

    private void OpenEditModal(Workspace workspace)
    {
        selectedWorkspace = workspace;
        editWorkspace = new PatchWorkspaceRequest
        {
            Name = workspace.Name
        };
        isEditModalOpen = true;
    }

    private void CloseEditModal()
    {
        isEditModalOpen = false;
        selectedWorkspace = null;
        editWorkspace = new();
    }

    private async Task UpdateWorkspace()
    {
        if (selectedWorkspace == null) return;

        await UiOps.RunAsync(
            async () =>
            {
                var result = await Api.UpdateWorkspaceAsync(selectedWorkspace.Id, editWorkspace);
                if (result != null)
                {
                    ToastService.ShowSuccess("Espaço de trabalho atualizado", "As alterações foram salvas com sucesso.");
                    CloseEditModal();
                    await LoadWorkspaces();
                }
            },
            "Erro ao atualizar",
            "Não foi possível atualizar o espaço de trabalho. Verifique os dados e tente novamente.");
    }

    private void HandleDeleteClick(Guid workspaceId)
    {
        if (deletingWorkspaceId == workspaceId)
        {
            // Segundo clique - executar exclusão
            _ = DeleteWorkspace(workspaceId);
        }
        else
        {
            // Primeiro clique - mostrar confirmação
            deletingWorkspaceId = workspaceId;

            // Reset após 3 segundos
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = new System.Threading.Timer(
                _ => InvokeAsync(() =>
                {
                    deletingWorkspaceId = null;
                    StateHasChanged();
                }),
                null,
                3000,
                Timeout.Infinite
            );
        }
    }

    private async Task DeleteWorkspace(Guid workspaceId)
    {
        try
        {
            await UiOps.RunAsync(
                async () =>
                {
                    await Api.DeleteWorkspaceAsync(workspaceId);
                    ToastService.ShowSuccess("Espaço de trabalho excluído", "O espaço de trabalho foi removido com sucesso.");
                    await LoadWorkspaces();
                },
                "Erro ao excluir",
                "Não foi possível excluir o espaço de trabalho. Tente novamente.");
        }
        finally
        {
            deletingWorkspaceId = null;
            deleteConfirmTimer?.Dispose();
            deleteConfirmTimer = null;
        }
    }
}
