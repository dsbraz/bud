@page "/workspaces"
@inject ApiClient Api
@inject ToastService ToastService
@inject OrganizationContext OrgContext
@implements IDisposable

<ManagementMenu />

<div class="page-header">
    <div>
        <div class="page-kicker">Configurações</div>
        <h1>Workspaces</h1>
        <p class="page-subtitle">Crie workspaces vinculados às organizações.</p>
    </div>
    <button class="button primary" @onclick="OpenCreateModal">
        <span class="button-icon-text">+</span>
        Novo workspace
    </button>
</div>

<div class="card">
    <div class="card-filters">
        <div class="form-row">
            <label>Busca</label>
            <InputText class="input" @bind-Value="search" />
        </div>
        <div class="form-row" style="align-self: flex-end;">
            <button class="button" @onclick="LoadWorkspaces">Atualizar</button>
        </div>
    </div>

    @if (workspaces is null)
    {
        <p class="muted">Carregando...</p>
    }
    else if (workspaces.Items.Count == 0)
    {
        <p class="muted">Nenhum workspace encontrado.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Visibilidade</th>
                    <th>Organização</th>
                    <th>ID</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var workspace in workspaces.Items)
                {
                    var org = organizations.FirstOrDefault(o => o.Id == workspace.OrganizationId);
                    <tr>
                        <td>@workspace.Name</td>
                        <td>@(workspace.Visibility == Visibility.Public ? "Pública" : "Privada")</td>
                        <td>@(org?.Name ?? "—")</td>
                        <td class="mono">@workspace.Id</td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="muted" style="margin-top: var(--spacing-4);">Total: @workspaces.Total</p>
    }
</div>

@if (isModalOpen)
{
    <Modal Title="Criar workspace" OnClose="CloseModal">
        <EditForm Model="@newWorkspace" OnValidSubmit="CreateWorkspace">
            <DataAnnotationsValidator />
            <div class="form-row">
                <label>Nome</label>
                <InputText class="input" @bind-Value="newWorkspace.Name" />
            </div>
            <div class="form-row">
                <label>Visibilidade</label>
                <select class="input" @bind="createVisibility">
                    <option value="">Selecione</option>
                    <option value="Public">Pública</option>
                    <option value="Private">Privada</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="button tertiary" type="button" @onclick="CloseModal">Cancelar</button>
                <button class="button primary" type="submit">Salvar</button>
            </div>
        </EditForm>
    </Modal>
}

@code {
    private CreateWorkspaceRequest newWorkspace = new();
    private List<Organization> organizations = new();
    private PagedResult<Workspace>? workspaces;
    private string? search;
    private string? createVisibility;
    private bool isModalOpen = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizations();
        await LoadWorkspaces();
        OrgContext.OnOrganizationChanged += HandleOrganizationChanged;
    }

    private async void HandleOrganizationChanged()
    {
        await LoadWorkspaces();
        StateHasChanged();
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= HandleOrganizationChanged;
    }

    private async Task LoadOrganizations()
    {
        var result = await Api.GetOrganizationsAsync(null, 1, 100);
        organizations = result?.Items.ToList() ?? new List<Organization>();
    }

    private async Task LoadWorkspaces()
    {
        workspaces = await Api.GetWorkspacesAsync(OrgContext.SelectedOrganizationId, search, 1, 20) ?? new PagedResult<Workspace>();
    }

    private void OpenCreateModal()
    {
        newWorkspace = new CreateWorkspaceRequest();
        createVisibility = null;
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

    private async Task CreateWorkspace()
    {
        if (!OrgContext.SelectedOrganizationId.HasValue)
        {
            ToastService.ShowError("Erro ao criar workspace", "Selecione uma organização específica no menu lateral. Não é possível criar workspaces com 'TODOS' selecionado.");
            return;
        }

        if (string.IsNullOrWhiteSpace(newWorkspace.Name))
        {
            ToastService.ShowError("Erro ao criar workspace", "Informe o nome do workspace.");
            return;
        }

        if (string.IsNullOrEmpty(createVisibility) ||
            !Enum.TryParse<Visibility>(createVisibility, out var visibility))
        {
            ToastService.ShowError("Erro ao criar workspace", "Selecione a visibilidade do workspace.");
            return;
        }

        newWorkspace.OrganizationId = OrgContext.SelectedOrganizationId.Value;
        newWorkspace.Visibility = visibility;

        try
        {
            await Api.CreateWorkspaceAsync(newWorkspace);
            var workspaceName = newWorkspace.Name;
            newWorkspace = new CreateWorkspaceRequest();
            createVisibility = null;
            await LoadWorkspaces();

            ToastService.ShowSuccess("Workspace criado com sucesso!", $"O workspace '{workspaceName}' foi criado.");
            CloseModal();
        }
        catch (HttpRequestException ex)
        {
            ToastService.ShowError("Erro ao criar workspace", ex.Message);
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Erro inesperado", ex.Message);
        }
    }
}
